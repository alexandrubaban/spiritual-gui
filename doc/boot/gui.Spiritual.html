<!DOCTYPE html><html lang="en"><head><title>boot/gui.Spiritual</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="boot/gui.Spiritual"><meta name="groc-project-path" content="src/boot/gui.Spiritual.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/boot/gui.Spiritual.js</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="guispiritual">gui.Spiritual</h1>

<p>An instance of gui.Spiritual may be referenced as "gui" inside all windows.
@param {Window} win Potentially a web worker global scope.</p></div></div><div class="code"><div class="wrapper"><span class="nx">gui</span><span class="p">.</span><span class="nx">Spiritual</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">Spiritual</span> <span class="p">(</span> <span class="nx">win</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_construct</span> <span class="p">(</span> <span class="nx">win</span> <span class="p">);</span>
<span class="p">};</span>

<span class="nx">gui</span><span class="p">.</span><span class="nx">Spiritual</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The constructor gui.Spiritual does not exist after first instance gets declared, 
but we may keep something newable allocated by referencing the constructor here. <br />
@type {function}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">constructor</span><span class="o">:</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Spiritual</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Uniquely identifies this instance of gui.Spiritual. All 
local instances of gui.Spirit gets stamped with a copy.
@todo rename "guikey"?
@type {String}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">signature</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Usually the window object. Occasionally a web worker scope.
@type {Window}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">context</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Spirit management mode. Mathces native|jquery|optimize. 
Note that this will deprecate as soon as iOS supports 
a mechanism for grabbing the native innerHTML setter.
@type {String}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">mode</span> <span class="o">:</span> <span class="s2">&quot;optimize&quot;</span><span class="p">,</span> <span class="c1">// recommended setting for iOS support</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Development mode?
@type {boolean}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">debug</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Identification.
@returns {String}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">toString</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;[namespace gui]&quot;</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Channel spirits on startup.
@see {gui.Guide}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">go</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_ready</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">gui</span><span class="p">.</span><span class="nx">World</span><span class="p">.</span><span class="nx">descend</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="p">);</span>
    <span class="nx">gui</span><span class="p">.</span><span class="nx">Tick</span><span class="p">.</span><span class="nx">add</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">TICK_DESTRUCT_DETACHED</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">signature</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_configs</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_configs</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">config</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">channel</span> <span class="p">(</span> <span class="nx">config</span><span class="p">.</span><span class="nx">select</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">klass</span> <span class="p">);</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get spirit for argument (argument expected to be a spiritkey for now).
@todo fuzzy argument resolver to accept DOM elements and ID strings.
@param {object} arg
@returns {gui.Spirit}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">get</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">spirit</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">inside</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spirits</span><span class="p">.</span><span class="nx">inside</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">outside</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spirits</span><span class="p">.</span><span class="nx">outside</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">of</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">))</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;string&quot;</span> <span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">KeyMaster</span><span class="p">.</span><span class="nx">isKey</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">))</span> <span class="p">{</span>
          <span class="nx">spirit</span> <span class="o">=</span> <span class="nx">inside</span> <span class="p">[</span> <span class="nx">arg</span> <span class="p">]</span> <span class="o">||</span> <span class="nx">outside</span> <span class="p">[</span> <span class="nx">arg</span> <span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="cm">/* lookup spirit by element id */</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;TODO&quot;</span> <span class="o">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">spirit</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Register module.
@param {String} name
@param {object} module</p></div></div><div class="code"><div class="wrapper">  <span class="nx">module</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">module</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isString</span> <span class="p">(</span> <span class="nx">name</span> <span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="p">(</span> <span class="s2">&quot;Module requires a name&quot;</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">base</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">gui</span><span class="p">.</span><span class="nx">Spirit</span><span class="p">;</span> <span class="c1">// modules extend gui.Spirit, use init() to extend subclass</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>addins (@todo all sorts of "decorators" instead)</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isObject</span> <span class="p">(</span> <span class="nx">module</span><span class="p">.</span><span class="nx">addins</span> <span class="p">))</span> <span class="p">{</span>
      <span class="nx">gui</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span> <span class="nx">module</span><span class="p">.</span><span class="nx">addins</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">base</span><span class="p">.</span><span class="nx">addin</span> <span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>plugins</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isObject</span> <span class="p">(</span> <span class="nx">module</span><span class="p">.</span><span class="nx">plugins</span> <span class="p">))</span> <span class="p">{</span>
      <span class="nx">gui</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span> <span class="nx">module</span><span class="p">.</span><span class="nx">plugins</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">plugin</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isDefined</span> <span class="p">(</span> <span class="nx">plugin</span> <span class="p">))</span> <span class="p">{</span>
          <span class="nx">base</span><span class="p">.</span><span class="nx">plugin</span> <span class="p">(</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">plugin</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="p">(</span> <span class="s2">&quot;Undefined plugin for prefix: &quot;</span> <span class="o">+</span> <span class="nx">prefix</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>channels</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isArray</span> <span class="p">(</span> <span class="nx">module</span><span class="p">.</span><span class="nx">channels</span> <span class="p">))</span> <span class="p">{</span>
      <span class="nx">module</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">channel</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">channel</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
        <span class="kd">var</span> <span class="nx">klass</span> <span class="o">=</span> <span class="nx">channel</span> <span class="p">[</span> <span class="mi">1</span> <span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">channel</span> <span class="p">(</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">klass</span> <span class="p">);</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_modulelife</span> <span class="p">(</span> <span class="nx">module</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_modules</span> <span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">module</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Has module? In a multi frame setup, modules may be 
loaded only for the local instance of gui.Spiritual.
@param {String} name
@returns {boolean}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">hasModule</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isDefined</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_modules</span> <span class="p">[</span> <span class="nx">name</span> <span class="p">]);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Channel spirits to CSS selectors in this window 
and windows that import us via the portal method.
@param {String} select CSS selector
@param {object} klass Spirit constructor (as object or string)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">channel</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">select</span><span class="p">,</span> <span class="nx">klass</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">spirit</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_ready</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">klass</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">spirit</span> <span class="o">=</span> <span class="nx">gui</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">lookup</span> <span class="p">(</span> <span class="nx">klass</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">spirit</span> <span class="o">=</span> <span class="nx">klass</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isFunction</span> <span class="p">(</span> <span class="nx">spirit</span> <span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">.</span><span class="nx">push</span> <span class="p">([</span> <span class="nx">select</span><span class="p">,</span> <span class="nx">spirit</span> <span class="p">]);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;Unknown Spirit for selector: &quot;</span> <span class="o">+</span> <span class="nx">select</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// wait for method ready to invoke.</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_configs</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_configs</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_configs</span><span class="p">.</span><span class="nx">push</span> <span class="p">({</span>
        <span class="nx">select</span> <span class="o">:</span> <span class="nx">select</span><span class="p">,</span>
        <span class="nx">klass</span> <span class="o">:</span> <span class="nx">klass</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Transfer Spirit world to a parallel window in three easy steps.
1) Extend Element.prototype in window
2) Declare local ui object in window
3) Declare spirit world objects, pointing back to this window
@param {Window} sub An external window.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">portal</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">sub</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">sub</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create remote gui object then portal gui namespaces and members.</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">subgui</span> <span class="o">=</span> <span class="nx">sub</span><span class="p">.</span><span class="nx">gui</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="p">)(</span> <span class="nx">sub</span> <span class="p">);</span>
      <span class="kd">var</span> <span class="nx">indexes</span> <span class="o">=</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Portal custom namespaces and members.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">subgui</span><span class="p">.</span><span class="nx">_spaces</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spaces</span><span class="p">.</span><span class="nx">slice</span> <span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_spaces</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">ns</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>declare (nested) namespace in external context @todo use gui.Object.assert</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">external</span> <span class="o">=</span> <span class="nx">sub</span><span class="p">,</span> <span class="nx">internal</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
        <span class="nx">ns</span><span class="p">.</span><span class="nx">split</span> <span class="p">(</span> <span class="s2">&quot;.&quot;</span> <span class="p">).</span><span class="nx">forEach</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">part</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isDefined</span> <span class="p">(</span> <span class="nx">external</span> <span class="p">[</span> <span class="nx">part</span> <span class="p">]))</span> <span class="p">{</span>
           <span class="nx">external</span> <span class="p">[</span> <span class="nx">part</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">internal</span> <span class="p">[</span> <span class="nx">part</span> <span class="p">];</span>
          <span class="p">}</span>
          <span class="nx">external</span> <span class="o">=</span> <span class="nx">external</span> <span class="p">[</span> <span class="nx">part</span> <span class="p">];</span>
          <span class="nx">internal</span> <span class="o">=</span> <span class="nx">internal</span> <span class="p">[</span> <span class="nx">part</span> <span class="p">];</span>
        <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>channel spirits from this namespace preserving local channeling order</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">_index</span> <span class="p">(</span> 
          <span class="nx">internal</span><span class="p">,</span> 
          <span class="nx">external</span><span class="p">,</span> 
          <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span> 
        <span class="p">).</span><span class="nx">forEach</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">){</span>
          <span class="nx">indexes</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">);</span> 
        <span class="p">});</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Portal modules to initialize the sub context @todo portal only the relevant init method?</p></div></div><div class="code"><div class="wrapper">      <span class="nx">gui</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_modules</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">module</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_modulelife</span> <span class="p">(</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">subgui</span><span class="p">.</span><span class="nx">context</span> <span class="p">);</span>
        <span class="nx">subgui</span><span class="p">.</span><span class="nx">_modules</span> <span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">module</span><span class="p">;</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Sort channels</p></div></div><div class="code"><div class="wrapper">      <span class="nx">indexes</span><span class="p">.</span><span class="nx">sort</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span><span class="p">;</span> 
       <span class="p">}).</span><span class="nx">forEach</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
         <span class="nx">subgui</span><span class="p">.</span><span class="nx">_channels</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span> <span class="p">[</span> <span class="nx">i</span> <span class="p">]);</span> 
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Here we go</p></div></div><div class="code"><div class="wrapper">      <span class="nx">gui</span><span class="p">.</span><span class="nx">Guide</span><span class="p">.</span><span class="nx">observe</span> <span class="p">(</span> <span class="nx">sub</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Kickstart Spiritual manuallay. Use this if you lazyload (module-require) 
Spiritual after the document.DOMContentLoaded and window.onload events fire.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">kickstart</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">readyState</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;interactive&quot;</span> <span class="o">:</span>
      <span class="k">case</span> <span class="s2">&quot;complete&quot;</span> <span class="o">:</span>
        <span class="nx">gui</span><span class="p">.</span><span class="nx">Broadcast</span><span class="p">.</span><span class="nx">dispatchGlobal</span> <span class="p">(</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">BROADCAST_KICKSTART</span> <span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Members of given namespace will be migrated 
to descendant iframes via the portal method.
@param {String} ns</p></div></div><div class="code"><div class="wrapper">  <span class="nx">namespace</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">ns</span> <span class="p">)</span> <span class="p">{</span> 
    <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isString</span> <span class="p">(</span> <span class="nx">ns</span> <span class="p">))</span> <span class="p">{</span> <span class="c1">// @todo must it be a string?</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_spaces</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">ns</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="p">(</span> <span class="s2">&quot;Expected a string: gui.namespace&quot;</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>List spiritual namespaces (returns a copy).
@return {Array<String>}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">namespaces</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spaces</span><span class="p">.</span><span class="nx">slice</span> <span class="p">();</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Spirit implementation for DOM element.
Spirit may be local to containing window.
1) Test for element "gui" attribute
2) Test if element matches selectors 
@param {Element} element
@returns {function} Spirit constructor</p></div></div><div class="code"><div class="wrapper">  <span class="nx">evaluate</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">element</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">element</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="nx">Node</span><span class="p">.</span><span class="nx">ELEMENT_NODE</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">win</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">defaultView</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">att</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span> <span class="p">(</span> <span class="s2">&quot;gui&quot;</span> <span class="p">);</span> <span class="c1">// @todo &quot;data-gui&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>test for "gui" attribute in markup. "[" accounts for {gui.Spirit#<strong>debug</strong>}</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isString</span> <span class="p">(</span> <span class="nx">att</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">att</span><span class="p">.</span><span class="nx">startsWith</span> <span class="p">(</span> <span class="s2">&quot;[&quot;</span> <span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">att</span> <span class="o">!==</span> <span class="s2">&quot;&quot;</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">// no spirit for empty string</span>
          <span class="nx">res</span> <span class="o">=</span> <span class="nx">win</span><span class="p">.</span><span class="nx">gui</span><span class="p">.</span><span class="nx">_inlines</span> <span class="p">[</span> <span class="nx">att</span> <span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isDefined</span> <span class="p">(</span> <span class="nx">res</span> <span class="p">))</span> <span class="p">{</span>
            <span class="nx">res</span> <span class="o">=</span> <span class="nx">gui</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">lookup</span> <span class="p">(</span> <span class="nx">att</span><span class="p">,</span> <span class="nx">win</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">res</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">win</span><span class="p">.</span><span class="nx">gui</span><span class="p">.</span><span class="nx">_inlines</span> <span class="p">[</span> <span class="nx">att</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="p">(</span> <span class="nx">att</span> <span class="o">+</span> <span class="s2">&quot; is not defined.&quot;</span> <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// channel spirit via CSS selectors</span>
        <span class="nx">win</span><span class="p">.</span><span class="nx">gui</span><span class="p">.</span><span class="nx">_channels</span><span class="p">.</span><span class="nx">every</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">def</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">select</span> <span class="o">=</span> <span class="nx">def</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
          <span class="kd">var</span> <span class="nx">spirit</span> <span class="o">=</span> <span class="nx">def</span> <span class="p">[</span> <span class="mi">1</span> <span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">SpiritCSS</span><span class="p">.</span><span class="nx">matches</span> <span class="p">(</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">select</span> <span class="p">))</span> <span class="p">{</span>
            <span class="nx">res</span> <span class="o">=</span> <span class="nx">spirit</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">res</span> <span class="o">===</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Broadcast event details globally. Use this if you stopPropagate <br />
an event for personal reasons and don't want to keep it a secret.
@param {String} message gui.BROADCAST_MOUSECLICK or similar
@param @optional {object} arg This could well be a MouseEvent</p></div></div><div class="code"><div class="wrapper">  <span class="nx">broadcast</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">of</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">).</span><span class="nx">endsWith</span> <span class="p">(</span> <span class="s2">&quot;event&quot;</span> <span class="p">))</span> <span class="p">{</span>
      <span class="nx">arg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">EventSummary</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">gui</span><span class="p">.</span><span class="nx">Broadcast</span><span class="p">.</span><span class="nx">dispatchGlobal</span> <span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">arg</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log channels to console.
@todo deprecate this (create gui.Developer).</p></div></div><div class="code"><div class="wrapper">  <span class="nx">debugchannels</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span> <span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">channel</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">out</span> <span class="o">+=</span> <span class="s2">&quot;\n&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="p">[</span> <span class="mi">1</span> <span class="p">];</span>
    <span class="p">});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span> <span class="p">(</span> <span class="nx">out</span> <span class="o">+</span> <span class="s2">&quot;\n\n&quot;</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Terminate spirit management.
@param {gui.Spirit} spirit</p></div></div><div class="code"><div class="wrapper">  <span class="nx">destruct</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">spirit</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">all</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spirits</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">spirit</span><span class="p">.</span><span class="nx">spiritkey</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">all</span><span class="p">.</span><span class="nx">inside</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
    <span class="k">delete</span> <span class="nx">all</span><span class="p">.</span><span class="nx">outside</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
  <span class="p">},</span>
  
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>INTERNALS .....................................................................................................</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Register spirit in document (framework internal method).
@todo move? rename? 
@param {gui.Spirit} spirit</p></div></div><div class="code"><div class="wrapper">  <span class="nx">inside</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">spirit</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">all</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spirits</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">spirit</span><span class="p">.</span><span class="nx">spiritkey</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">all</span><span class="p">.</span><span class="nx">inside</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">])</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">all</span><span class="p">.</span><span class="nx">outside</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">])</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">all</span><span class="p">.</span><span class="nx">outside</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">all</span><span class="p">.</span><span class="nx">inside</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">spirit</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Register spirit outside document (scheduled for destruction).
@todo move? rename?
@param {gui.Spirit} spirit</p></div></div><div class="code"><div class="wrapper">  <span class="nx">outside</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">spirit</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">all</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spirits</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">spirit</span><span class="p">.</span><span class="nx">spiritkey</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">all</span><span class="p">.</span><span class="nx">outside</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">])</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">all</span><span class="p">.</span><span class="nx">inside</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">])</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">all</span><span class="p">.</span><span class="nx">inside</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">all</span><span class="p">.</span><span class="nx">outside</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">spirit</span><span class="p">;</span>
      <span class="nx">gui</span><span class="p">.</span><span class="nx">Tick</span><span class="p">.</span><span class="nx">dispatch</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">TICK_DESTRUCT_DETACHED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">signature</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle tick.
@param {gui.Tick} tick</p></div></div><div class="code"><div class="wrapper">  <span class="nx">ontick</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">tick</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>@todo do we want to loose track of potential non-exited spirit?</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">tick</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">TICK_DESTRUCT_DETACHED</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">gui</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spirits</span><span class="p">.</span><span class="nx">outside</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">spirit</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">spirit</span><span class="p">.</span><span class="nx">onexit</span> <span class="p">()</span> <span class="o">!==</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">// spirit may prevent destruction</span>
          <span class="nx">spirit</span><span class="p">.</span><span class="nx">ondestruct</span> <span class="p">();</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_spirits</span><span class="p">.</span><span class="nx">outside</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Invoked by the gui.Guide on window.unload (synchronized as final event).
@todo figure out of any of this manual garbage dumping works.
@todo naming clash with method "destruct"
@todo Think of more stuff to cleanup here...</p></div></div><div class="code"><div class="wrapper">  <span class="nx">nameDestructAlreadyUsed</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">gui</span><span class="p">.</span><span class="nx">Tick</span><span class="p">.</span><span class="nx">remove</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">TICK_DESTRUCT_DETACHED</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">signature</span> <span class="p">);</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spiritualaid</span><span class="p">;</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_document</span><span class="p">;</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">;</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_inlines</span><span class="p">;</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spaces</span><span class="p">;</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_modules</span><span class="p">;</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_spirits</span><span class="p">;</span>
  <span class="p">},</span>
  
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>PRIVATES ......................................................................................................</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Document context.
@type {Document}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_document</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Lisitng CSS selectors associated to Spirit constructors. 
Order is important: First spirit to match selector is it. 
Note that each window maintains a version of gui._channels.
@type {Array<Array<String,function>>}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_channels</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cache Spirits resolved by lookup of "gui" attribute.
@type {Map<String,function>}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_inlines</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Hm...</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_spaces</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>@type {boolean}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_ready</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>@type {Array<object>}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_configs</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>@type {Map<String,object>}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_modules</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Tracking spirits by spiritkey (detached spirits are subject to destruction).
@type {Map<String,Map<String,gui.Spirit>>}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_spirits</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
 </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The constructor gui.SpiritualAid does not exist after first instance gets declared, 
but we may keep something newable allocated by referencing the constructor here.
@type {gui.SpiritualAid}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_spiritualaid</span> <span class="o">:</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">SpiritualAid</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Construction time again.
@param {Window} win</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_construct</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">win</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>patching features</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">_spiritualaid</span><span class="p">.</span><span class="nx">polyfill</span> <span class="p">(</span> <span class="nx">win</span> <span class="p">);</span>    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>generate signature</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">signature</span> <span class="o">=</span> <span class="s2">&quot;sig&quot;</span> <span class="o">+</span> <span class="nb">String</span> <span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span> <span class="p">()).</span><span class="nx">split</span> <span class="p">(</span> <span class="s2">&quot;.&quot;</span> <span class="p">)[</span> <span class="mi">1</span> <span class="p">];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>basic setup</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">win</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_document</span> <span class="o">=</span> <span class="nx">win</span><span class="p">.</span><span class="nb">document</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_inlines</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_modules</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_spaces</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;gui&quot;</span> <span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_spirits</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">inside</span> <span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="p">(</span> <span class="kc">null</span> <span class="p">),</span> <span class="c1">// spirits positioned in page DOM (&quot;entered&quot; and &quot;attached&quot;)</span>
      <span class="nx">outside</span> <span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="p">(</span> <span class="kc">null</span> <span class="p">)</span> <span class="c1">// spirits removed from page DOM (currently &quot;detached&quot;)</span>
    <span class="p">};</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Reference local objects in remote window context while collecting channel indexes.
@param {object} internal This gui.Spiritual instance
@param {object} external New gui.Spiritual instance
@param {Array<object>} channels
@returns {Array<number>}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_index</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">internal</span><span class="p">,</span> <span class="nx">external</span><span class="p">,</span> <span class="nx">channels</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">indexes</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">function</span> <span class="nx">index</span> <span class="p">(</span> <span class="nx">def</span> <span class="p">)</span> <span class="p">{</span> <span class="cm">/* isolated from loop to pass JsHint */</span>
      <span class="k">switch</span> <span class="p">(</span> <span class="nx">def</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s2">&quot;signature&quot;</span> <span class="o">:</span>
        <span class="k">case</span> <span class="s2">&quot;context&quot;</span> <span class="o">:</span>
          <span class="cm">/* must be kept unique in each window context */</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span> <span class="o">:</span>
          <span class="kd">var</span> <span class="nx">thing</span> <span class="o">=</span> <span class="nx">external</span> <span class="p">[</span> <span class="nx">def</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">internal</span> <span class="p">[</span> <span class="nx">def</span> <span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isSpiritConstructor</span> <span class="p">(</span> <span class="nx">thing</span> <span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">thing</span><span class="p">.</span><span class="nx">portals</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">channels</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">index</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">channel</span> <span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">===</span> <span class="nx">thing</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">indexes</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">index</span> <span class="p">);</span>
                <span class="p">}</span>
              <span class="p">});</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">def</span> <span class="k">in</span> <span class="nx">internal</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span> <span class="p">(</span> <span class="nx">def</span> <span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">def</span><span class="p">.</span><span class="nx">startsWith</span> <span class="p">(</span> <span class="s2">&quot;_&quot;</span> <span class="p">))</span> <span class="p">{</span>
          <span class="nx">index</span> <span class="p">(</span> <span class="nx">def</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">indexes</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>@param {object} module
@param {Window} context</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_modulelife</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">context</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>invoke init now?</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isFunction</span> <span class="p">(</span> <span class="nx">module</span><span class="p">.</span><span class="nx">init</span> <span class="p">))</span> <span class="p">{</span>
      <span class="nx">module</span><span class="p">.</span><span class="nx">init</span> <span class="p">(</span> <span class="nx">context</span> <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>invoke ready before document is spiritualized?</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isFunction</span> <span class="p">(</span> <span class="nx">module</span><span class="p">.</span><span class="nx">ready</span> <span class="p">))</span> <span class="p">{</span>
      <span class="nx">gui</span><span class="p">.</span><span class="nx">Broadcast</span><span class="p">.</span><span class="nx">addGlobal</span> <span class="p">(</span>
        <span class="nx">gui</span><span class="p">.</span><span class="nx">BROADCAST_WILL_SPIRITUALIZE</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">onbroadcast</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">b</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">b</span><span class="p">.</span><span class="nx">data</span> <span class="o">===</span> <span class="nx">context</span><span class="p">.</span><span class="nx">gui</span><span class="p">.</span><span class="nx">signature</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">module</span><span class="p">.</span><span class="nx">ready</span> <span class="p">(</span> <span class="nx">context</span> <span class="p">);</span>
              <span class="nx">gui</span><span class="p">.</span><span class="nx">Broadcast</span><span class="p">.</span><span class="nx">removeGlobal</span> <span class="p">(</span> 
                <span class="nx">gui</span><span class="p">.</span><span class="nx">BROADCAST_WILL_SPIRITUALIZE</span><span class="p">,</span> 
                <span class="k">this</span>
              <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>@todo comment required to explain this stunt</p></div></div><div class="code"><div class="wrapper"><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="p">(</span> <span class="nx">gui</span> <span class="p">).</span><span class="nx">forEach</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">gui</span><span class="p">.</span><span class="nx">Spiritual</span><span class="p">.</span><span class="nx">prototype</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">gui</span> <span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>@todo comment even more required!</p></div></div><div class="code"><div class="wrapper"><span class="nx">gui</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Spiritual</span> <span class="p">(</span> <span class="nb">window</span> <span class="p">);</span></div></div></div></div></body></html>