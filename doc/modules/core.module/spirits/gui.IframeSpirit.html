<!DOCTYPE html><html lang="en"><head><title>modules/core.module/spirits/gui.IframeSpirit</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="modules/core.module/spirits/gui.IframeSpirit"><meta name="groc-project-path" content="src/modules/core.module/spirits/gui.IframeSpirit.js"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/modules/core.module/spirits/gui.IframeSpirit.js</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="guiiframespirit">gui.IframeSpirit</h1>

<p>@extends {gui.Spirit}
Spirit of the iframe.</p></div></div><div class="code"><div class="wrapper"><span class="nx">gui</span><span class="p">.</span><span class="nx">IframeSpirit</span> <span class="o">=</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Spirit</span><span class="p">.</span><span class="nx">infuse</span> <span class="p">(</span> <span class="s2">&quot;gui.IframeSpirit&quot;</span><span class="p">,</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Signs iframe URLs with a unique identifier eg. to 
relay spirit actions from across exotic domains.
@type {String}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">signature</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Construct.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">onconstruct</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">.</span><span class="nx">onconstruct</span> <span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">signature</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">signature</span> <span class="o">=</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">IframeSpirit</span><span class="p">.</span><span class="nx">generateSignature</span> <span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get or set iframe source.
See also method path.
@param {String} src</p></div></div><div class="code"><div class="wrapper">  <span class="nx">src</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">src</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isString</span> <span class="p">(</span> <span class="nx">src</span> <span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">IframeSpirit</span><span class="p">.</span><span class="nx">isExternal</span> <span class="p">(</span> <span class="nx">src</span> <span class="p">))</span> <span class="p">{</span>
        <span class="nx">src</span> <span class="o">=</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">IframeSpirit</span><span class="p">.</span><span class="nx">sign</span> <span class="p">(</span> <span class="nx">src</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">signature</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">src</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">src</span><span class="p">;</span>
  <span class="p">}</span>
  
  
<span class="p">},</span> <span class="p">{</span> <span class="c1">// RECURRING  ...........................................................</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Summon spirit.
@param {Document} doc
@param {String} src
@returns {gui.IframeSpirit}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">summon</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">doc</span><span class="p">,</span> <span class="nx">src</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Unique key stamped into iframe SRC.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">sig</span> <span class="o">=</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">IframeSpirit</span><span class="p">.</span><span class="nx">generateSignature</span> <span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>To avoid problems with the browser back button 
and iframe history, better set iframe src now. </p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">iframe</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">createElement</span> <span class="p">(</span> <span class="s2">&quot;iframe&quot;</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">isString</span> <span class="p">(</span> <span class="nx">src</span> <span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isExternal</span> <span class="p">(</span> <span class="nx">src</span> <span class="p">))</span> <span class="p">{</span>
        <span class="nx">src</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sign</span> <span class="p">(</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">sig</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">iframe</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">src</span><span class="p">;</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">iframe</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">IframeSpirit</span><span class="p">.</span><span class="nx">SRC_DEFAULT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">spirit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">animate</span> <span class="p">(</span> <span class="nx">iframe</span> <span class="p">);</span>
    <span class="nx">spirit</span><span class="p">.</span><span class="nx">signature</span> <span class="o">=</span> <span class="nx">sig</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">spirit</span><span class="p">;</span>
  <span class="p">}</span>


<span class="p">},</span> <span class="p">{</span> <span class="c1">// STATIC ................................................................</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The stuff going on here has to do with a future project 
about supporting cross-doman spiritualized websites</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Presumably harmless iframe source. The issue here is that "about:blank" 
may raise security concerns for some browsers when running HTTPS setup.
@type {String} </p></div></div><div class="code"><div class="wrapper">  <span class="nx">SRC_DEFAULT</span> <span class="o">:</span> <span class="s2">&quot;javascript:void(false);&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Overwrite this property to create a parameter name for <br />
signing that looks somewhat less like a spyware attack.
@type {String}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">KEY_SIGNATURE</span> <span class="o">:</span> <span class="s2">&quot;spiritual-signature&quot;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate unique signature (for this session).
@returns {String}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">generateSignature</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">gui</span><span class="p">.</span><span class="nx">KeyMaster</span><span class="p">.</span><span class="nx">generateKey</span> <span class="p">().</span><span class="nx">replace</span> <span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;sig&quot;</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Sign URL with signature.
@param {String} url
@param @optional {String} signature
@returns {String}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">sign</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">signature</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">setParam</span> <span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">KEY_SIGNATURE</span><span class="p">,</span> <span class="nx">signature</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">generateSignature</span> <span class="p">());</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove signature from URL (prettyfied for end user). 
@param {String} url
@param {String} sign
@returns {String}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">unsign</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">url</span> <span class="p">)</span> <span class="p">{</span> 
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">setParam</span> <span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">KEY_SIGNATURE</span><span class="p">,</span> <span class="kc">null</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extract querystring parameter value from URL.
@param {String} url
@param {String} name
@returns {String} String or null</p></div></div><div class="code"><div class="wrapper">  <span class="nx">getParam</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="sr">/(\[|\])/g</span><span class="p">,</span> <span class="s2">&quot;\\$1&quot;</span> <span class="p">);</span> <span class="c1">// was: name = name.replace ( /[\[]/, &quot;\\\[&quot; ).replace( /[\]]/, &quot;\\\]&quot; ); (http://stackoverflow.com/questions/2338547/why-does-jslint-returns-bad-escapement-on-this-line-of-code)</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span> <span class="p">(</span> <span class="s2">&quot;[\\?&amp;]&quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;=([^&amp;#]*)&quot;</span> <span class="p">).</span><span class="nx">exec</span> <span class="p">(</span> <span class="nx">url</span> <span class="p">);</span>
    <span class="k">return</span> <span class="nx">results</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">results</span> <span class="p">[</span> <span class="mi">1</span> <span class="p">];</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add or remove querystring parameter from URL. If the parameter 
already exists, we'll replace it's (first ancountered!) value. 
@todo Something simpler
@param {String} url
@param {String} name
@param {String} value Use null to remove
@returns {String} String</p></div></div><div class="code"><div class="wrapper">  <span class="nx">setParam</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">cut</span><span class="p">,</span> <span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span> <span class="p">(</span> <span class="nx">name</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span> <span class="p">(</span> <span class="s2">&quot;?&quot;</span> <span class="p">)</span> <span class="o">&gt;-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">cut</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">split</span> <span class="p">(</span> <span class="s2">&quot;?&quot;</span> <span class="p">);</span>
      <span class="nx">url</span> <span class="o">=</span> <span class="nx">cut</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
      <span class="nx">params</span> <span class="o">=</span> <span class="nx">cut</span> <span class="p">[</span> <span class="mi">1</span> <span class="p">].</span><span class="nx">split</span> <span class="p">(</span> <span class="s2">&quot;&amp;&quot;</span> <span class="p">);</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">every</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">param</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">split</span> <span class="p">(</span> <span class="s2">&quot;=&quot;</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">x</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">===</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">index</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">x</span> <span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="nx">params</span> <span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">join</span> <span class="p">(</span> <span class="s2">&quot;=&quot;</span> <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">index</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">remove</span> <span class="p">(</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">index</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">params</span> <span class="p">[</span> <span class="nx">params</span><span class="p">.</span><span class="nx">length</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">].</span><span class="nx">join</span> <span class="p">(</span> <span class="s2">&quot;=&quot;</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">url</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">params</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="nx">params</span><span class="p">.</span><span class="nx">join</span> <span class="p">(</span> <span class="s2">&quot;&amp;&quot;</span> <span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Is external address?
@returns {boolean}</p></div></div><div class="code"><div class="wrapper">  <span class="nx">isExternal</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">url</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="p">(</span> <span class="s2">&quot;a&quot;</span> <span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">host</span> <span class="o">!==</span> <span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div></div></body></html>