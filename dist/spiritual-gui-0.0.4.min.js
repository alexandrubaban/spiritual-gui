/*
 * Spiritual GUI 0.0.4
 * (c) 2013 Wunderbyte
 * Spiritual is freely distributable under the MIT license.
 */
var gui={version:"0.0.4",MODE_NATIVE:"native",MODE_JQUERY:"jquery",MODE_OPTIMIZE:"optimize",MODE_MANAGED:"managed",BROADCAST_KICKSTART:"gui-broadcast-kickstart",BROADCAST_DOMCONTENT:"gui-broadcast-document-domcontentloaded",BROADCAST_ONLOAD:"gui-broadcast-window-onload",BROADCAST_UNLOAD:"gui-broadcast-window-unload",BROADCAST_WILL_SPIRITUALIZE:"gui-broadcast-will-spiritualize",BROADCAST_DID_SPIRITUALIZE:"gui-broadcast-did-spiritualize",BROADCAST_MOUSECLICK:"gui-broadcast-mouseevent-click",BROADCAST_MOUSEMOVE:"gui-broadcast-mouseevent-mousemove",BROADCAST_MOUSEDOWN:"gui-broadcast-mouseevent-mousedown",BROADCAST_MOUSEUP:"gui-broadcast-mouseevent-mouseup",BROADCAST_SCROLL:"gui-broadcast-window-scroll",BROADCAST_RESIZE:"gui-broadcast-window-resize",BROADCAST_RESIZE_END:"gui-broadcast-window-resize-end",BROADCAST_POPSTATE:"gui-broadcast-window-popstate",BROADCAST_HASHCHANGE:"gui-broadcast-window-hashchange",BROADCAST_LOADING_CHANNELS:"gui-broadcast-loading-channels",BROADCAST_CHANNELS_LOADED:"gui-broadcast-channels-loaded",BROADCAST_TWEEN:"gui-broadcast-tween",BROADCAST_ORIENTATIONCHANGE:"gui-broadcast-orientationchange",BROADCAST_TOUCHSTART:"gui-broadcast-touchstart",BROADCAST_TOUCHEND:"gui-broadcast-touchend",BROADCAST_TOUCHCANCEL:"gui-broadcast-touchcancel",BROADCAST_TOUCHLEAVE:"gui-broadcast-touchleave",BROADCAST_TOUCHMOVE:"gui-broadcast-touchmove",BROADCAST_DRAG_START:"gui-broadcast-drag-start",BROADCAST_DRAG_END:"gui-broadcast-drag-end",BROADCAST_DRAG_DROP:"gui-broadcast-drag-drop",BROADCAST_COMMAND:"gui-broadcast-command",BROADCAST_OUTPUT:"gui-broadcast-output",BROADCAST_INPUT:"gui-broadcast-input",BROADCAST_DATA_PUB:"gui-broadcast-data-pub",BROADCAST_DATA_SUB:"gui-broadcast-data-sub",BROADCAST_SCRIPT_INVOKE:"gui-broadcast-spiritscript-invoke",BROADCAST_ATTENTION_ON:"gui-broadcast-attention-on",BROADCAST_ATTENTION_OFF:"gui-broadcast-attention-off",BROADCAST_ATTENTION_GO:"gui-broadcast-attention-go",ACTION_DOCUMENT_CONSTRUCT:"gui-action-document-construct",ACTION_DOCUMENT_READY:"gui-action-document-ready",ACTION_DOCUMENT_ONLOAD:"gui-action-document-onload",ACTION_DOCUMENT_UNLOAD:"gui-action-document-unload",ACTION_DOCUMENT_FIT:"gui-action-document-fit",ACTION_DOCUMENT_DONE:"gui-action-document-done",ACTION_WINDOW_LOADING:"gui-action-window-loading",ACTION_WINDOW_LOADED:"gui-action-window-loaded",LIFE_CONSTRUCT:"gui-life-construct",LIFE_CONFIGURE:"gui-life-configure",LIFE_ENTER:"gui-life-enter",LIFE_ATTACH:"gui-life-attach",LIFE_READY:"gui-life-ready",LIFE_SHOW:"gui-life-show",LIFE_HIDE:"gui-life-hide",LIFE_DETACH:"gui-life-detach",LIFE_EXIT:"gui-life-exit",LIFE_DESTRUCT:"life-destruct",TICK_DESTRUCT_DETACHED:"gui-tick-destruct-detached",TICK_SCRIPT_UPDATE:"gui-tick-spiritscript-update",TICK_COLLECT_INPUT:"gui-tick-collect-input",TICK_SPIRIT_NULL:"gui-tick-spirit-null",TICK_FIT:"gui-tick-fit",CRAWLER_ATTACH:"gui-crawler-attach",CRAWLER_DETACH:"gui-crawler-detach",CRAWLER_DISPOSE:"gui-crawler-dispose",CRAWLER_ACTION:"gui-crawler-action",CRAWLER_VISIBLE:"gui-crawler-visible",CRAWLER_INVISIBLE:"gui-crawler-invisible",CLASS_INVISIBLE:"_gui-invisible",CLASS_HIDDEN:"_gui-hidden",orientation:0,ORIENTATION_PORTRAIT:0,ORIENTATION_LANDSCAPE:1};gui.SpiritualAid={polyfill:function(e,t){"use strict";this._strings(e),this._arrays(e),this._functions(e),this._globals(e),this._extras(e),t||this._effects(e)},_extend:function(e,t){Object.keys(t).forEach(function(n){var r=t[n];e[n]===undefined&&(!r.get||!r.set)&&(e[n]=r)})},_strings:function(e){this._extend(e.String.prototype,{trim:function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")},repeat:function(t){return(new e.Array(t+1)).join(this)},startsWith:function(e){return this.indexOf(e)===0},endsWith:function(e){e=String(e);var t=this.lastIndexOf(e);return t>=0&&t===this.length-e.length},contains:function(e){return this.indexOf(e)>-1},toArray:function(){return this.split("")}})},_arrays:function(e){this._extend(e.Array.prototype,{remove:function(t,n){return this.splice(t,!n||1+n-t+(!(n<0^t>=0)&&(n<0||-1)*this.length)),this.length}}),this._extend(e.Array,{every:function(t,n,r){var i=!0,s=t.length>>>0;for(var o=0;o<s;o++)if(t[o]!==undefined&&!n.call(r,t[o],o,t)){i=!1;break}return i},forEach:function(t,n,r){var i=t.length>>>0;for(var s=0;s<i;s++)t[s]!==undefined&&n.call(r,t[s],s,t)},map:function(t,n,r){var i=[],s=t.length>>>0;for(var o=0;o<s;o++)t[o]!==undefined&&i.push(n.call(r,t[o],o,t));return i},isArray:function(n){return e.Object.prototype.toString.call(n)==="[object Array]"},concat:function(e,t){function n(e){return e}return this.map(e,n).concat(this.map(t,n))}})},_functions:function(e){this._extend(e.Function.prototype,{bind:function(n){if(typeof this!="function")throw new e.TypeError("Function bind not callable");var r=e.Array.prototype.slice,i=r.call(arguments,1),s=this,o=function(){},u=function(){return s.apply(this instanceof o?this:n||e,i.concat(r.call(arguments)))};return o.prototype=this.prototype,u.prototype=new o,u}})},_globals:function(e){this._extend(e,{console:{log:function(){},debug:function(){},warn:function(){},error:function(){}},Map:function(){function e(){this._map=Object.create(null)}return e.prototype={isNative:!1,get:function(t){return this._map[t]},set:function(t,n){this._map[t]=n},has:function(t){return this._map[t]!==undefined},"delete":function(t){delete this._map[t]},size:function(){return Object.keys(this._map).length}},e}(),Set:function(){function e(){this._map=Object.create(null)}return e.prototype={isNative:!1,add:function(t){this._map[t]=!0},has:function(t){return this._map[t]===!0},"delete":function(t){delete this._map[t]},size:function(){return Object.keys(this._map).length}},e}(),WeakMap:function(){function t(){function n(n){return a(n)&&(e.splice(u,1),t.splice(u,1)),-1<u}function r(e,n){return a(e)?t[u]:n}function a(t){return u=o.call(e,t),-1<u}function f(n,r){a(n)?t[u]=r:t[e.push(n)-1]=r}var e=[],t=[];return s(i,{isNative:{value:!1},"delete":{value:n},del:{value:n},get:{value:r},has:{value:a},set:{value:f}})}function n(){}var r=e.Object,i=t.prototype,s=r.create,o=[].indexOf,u;return t.prototype=n.prototype=i=new t,t}()})},_effects:function(e){this._extend(e,{requestAnimationFrame:function(){var t=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(){var e=0;return function(t,n){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}}();return t}(),setImmediate:function(){var t=[],n=1,r="spiritual:emulated:setimmediate";return e.addEventListener("message",function(n){n.data===r&&t.length&&(t.shift().apply(e),n.stopPropagation())},!1),function(s){return t.push(s),e.postMessage(r,"*"),n++}}()})},_extras:function(e){this._extend(e.Map.prototype,{del:function(t){return this["delete"](t)}}),this._extend(e.Set.prototype,{del:function(t){return this["delete"](t)}}),this._extend(e.console,{debug:e.console.log}),this._extend(XMLHttpRequest.prototype,{overrideMimeType:function(){}}),this._extend(e.XMLHttpRequest,{UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4})}},gui.Spiritual=function(t){this._construct(t)},gui.Spiritual.prototype={constructor:gui.Spiritual,signature:null,context:null,mode:"optimize",debug:!1,toString:function(){return"[namespace gui]"},go:function(){this._gone=!0;if(this.debug)switch(this.mode){case gui.MODE_JQUERY:gui.Tick.next(function(){gui.Observer.observe(this.context)},this);break;default:gui.Observer.observe(this.context)}switch(this.mode){case gui.MODE_NATIVE:case gui.MODE_JQUERY:case gui.MODE_OPTIMIZE:case gui.MODE_MANAGED:gui.DOMChanger.change(this.context)}gui.Tick.add(gui.TICK_DESTRUCT_DETACHED,this,this.signature),this._configs!==null&&this._configs.forEach(function(e){this.channel(e.select,e.klass)},this)},get:function(e){var t=null,n=this._spirits.inside,r=this._spirits.outside;switch(gui.Type.of(e)){case"string":if(gui.KeyMaster.isKey(e))t=n[e]||r[e]||null;else{var i=this._document.querySelector(e);t=i?i.spirit:null}break;case"TODO":}return t},module:function(e,t){if(!gui.Type.isString(e))throw new Error("Module requires a name");var n=this.context.gui.Spirit;gui.Type.isObject(t.addins)&&gui.Object.each(t.addins,function(e,t){n.addin(e,t)},this),gui.Type.isObject(t.plugins)&&gui.Object.each(t.plugins,function(e,t){gui.Type.isDefined(t)?n.plugin(e,t):console.error("Undefined plugin for prefix: "+e)},this),gui.Type.isArray(t.channels)&&t.channels.forEach(function(e){var t=e[0],n=e[1];this.channel(t,n)},this),this._modulelife(t,this.context),this._modules[e]=t},hasModule:function(e){return gui.Type.isDefined(this._modules[e])},channel:function(e,t){var n=null;if(this._gone){typeof t=="string"?n=gui.Object.lookup(t,this.context):n=t;if(!gui.Type.isFunction(n))throw"Unknown Spirit for selector: "+e;this._channels.push([e,n])}else this._configs||(this._configs=[]),this._configs.push({select:e,klass:t})},portal:function(e){if(e!==this.context){var t=e.gui=new this.constructor(e),n=[];t._spaces=this._spaces.slice(),this._spaces.forEach(function(t){var r=e,i=this.context;t.split(".").forEach(function(e){gui.Type.isDefined(r[e])||(r[e]=i[e]),r=r[e],i=i[e]}),this._index(i,r,this._channels).forEach(function(e){n.push(e)})},this),gui.Object.each(this._modules,function(e,n){this._modulelife(n,t.context),t._modules[e]=n},this),n.sort(function(e,t){return e-t}).forEach(function(e){t._channels.push(this._channels[e])},this),gui.Guide.observe(e)}},kickstart:function(){switch(document.readyState){case"interactive":case"complete":gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_KICKSTART)}},namespace:function(e){if(!gui.Type.isString(e))throw new TypeError("Expected a string: gui.namespace");this._spaces.push(e)},namespaces:function(){return this._spaces.slice()},evaluate:function(e){var t=null;if(e.nodeType===Node.ELEMENT_NODE){var n=e.ownerDocument,r=n.defaultView,i=e.getAttribute("gui");gui.Type.isString(i)&&!i.startsWith("[")?i!==""&&(t=r.gui._inlines[i],gui.Type.isDefined(t)||(t=gui.Object.lookup(i,r)),t?r.gui._inlines[i]=t:console.error(i+" is not defined.")):r.gui._channels.every(function(n){var r=n[0],i=n[1];return gui.CSSPlugin.matches(e,r)&&(t=i),t===null},this)}return t},broadcast:function(e,t){gui.Type.of(t).endsWith("event")&&(t=new gui.EventSummary(t)),gui.Broadcast.dispatchGlobal(this,e,t)},debugchannels:function(){var e=this._document.location.toString();this._channels.forEach(function(t){e+="\n"+t[0]+" : "+t[1]}),console.debug(e+"\n\n")},destruct:function(e){var t=this._spirits,n=e.spiritkey;delete t.inside[n],delete t.outside[n]},inside:function(e){var t=this._spirits,n=e.spiritkey;t.inside[n]||(t.outside[n]&&delete t.outside[n],t.inside[n]=e)},outside:function(e){var t=this._spirits,n=e.spiritkey;t.outside[n]||(t.inside[n]&&delete t.inside[n],t.outside[n]=e,gui.Tick.dispatch(gui.TICK_DESTRUCT_DETACHED,0,this.signature))},ontick:function(e){e.type===gui.TICK_DESTRUCT_DETACHED&&(gui.Object.each(this._spirits.outside,function(e,t){t.onexit()!==!1&&t.ondestruct()},this),this._spirits.outside=Object.create(null))},nameDestructAlreadyUsed:function(){gui.Tick.remove(gui.TICK_DESTRUCT_DETACHED,this,this.signature),["_spiritualaid","context","_document","_channels","_inlines","_spaces","_modules","_spirits"].forEach(function(e){delete this[e]},this)},_document:null,_channels:null,_inlines:null,_spaces:null,_gone:!1,_configs:null,_modules:null,_spirits:null,_spiritualaid:gui.SpiritualAid,_construct:function(e){this._spiritualaid.polyfill(e),this.signature="sig"+String(Math.random()).split(".")[1],this.context=e,this._document=e.document,this._inlines=Object.create(null),this._modules=Object.create(null),this._channels=[],this._spaces=["gui"],this._spirits={inside:Object.create(null),outside:Object.create(null)}},_index:function(e,t,n){function i(i){switch(i){case"signature":case"context":break;default:var s=t[i]=e[i];gui.Type.isSpiritConstructor(s)&&s.portals&&n.forEach(function(e,t){e[1]===s&&r.push(t)})}}var r=[];for(var s in e)this.constructor.prototype.hasOwnProperty(s)||s.startsWith("_")||i(s);return r},_modulelife:function(e,t){gui.Type.isFunction(e.init)&&e.init(t),gui.Type.isFunction(e.ready)&&gui.Broadcast.addGlobal(gui.BROADCAST_WILL_SPIRITUALIZE,{onbroadcast:function(n){n.data===t.gui.signature&&(e.ready(t),gui.Broadcast.removeGlobal(gui.BROADCAST_WILL_SPIRITUALIZE,this))}})}},Object.keys(gui).forEach(function(e){gui.Spiritual.prototype[e]=gui[e]}),gui=new gui.Spiritual(window),gui.Arguments={match:function(){var e=Array.prototype.slice.call(arguments),t=e.shift();if(gui.Type.isArguments(t))return e.every(function(e,n){return this._matches(e,t[n],n)},this);throw new Error("Expected an Arguments object")},validate:function(){this._validate=!0;var e=this.match.apply(this,arguments);return this._validate=!1,e},_validate:!1,_xtract:function(e,t){return t?e.slice(1,-1):e},_matches:function(e,t,n){var r=!e.startsWith("("),i=this._xtract(e,!r).split("|"),s=gui.Type.of(t),o=e==="*"||!r&&s==="undefined"||!r&&i.indexOf("*")>-1||i.indexOf(s)>-1;return!o&&this._validate&&this._error(n,e,s),o},_error:function(e,t,n){console.error("Argument "+e+": "+"Expected "+t+", got "+n)}},gui.Exemplar={create:function(){var e=this._breakdown_base(arguments),t=e.name||"Anonymous",n=this._create(e.proto,t);return this._name(n,t),gui.Object.extend(n.prototype,e.expando),gui.Object.extend(n,e.statics),n.__recurring__=Object.create(null),n.__extenders__=[],e.recurring&&gui.Object.each(e.recurring,function(e,t){n[e]=n.__recurring__[e]=t}),n},breakdown:function(e){var t=gui.Type.isString(e[0]);return{name:t?e[0]:null,expando:e[t?1:0]||Object.create(null),recurring:e[t?2:1]||Object.create(null),statics:e[t?3:2]||Object.create(null)}},extend:function(){var e=gui.Exemplar.breakdown(arguments);return this.__super__=this.__super__||new gui.Super(this),gui.Exemplar._extend(this,e.expando,e.recurring,e.statics,e.name)},children:function(e,t,n){e.__extenders__.forEach(function(e){t.call(n,e)},n)},descendants:function(e,t,n){e.__extenders__.forEach(function(e){t.call(n,e),gui.Exemplar.descendants(e,t,n)},n)},family:function(e,t,n){t.call(n,e),this.descendants(e,t,n)},addin:function(e,t,n){this.prototype[e]===undefined||n?(this.prototype[e]=t,gui.Exemplar.family(this,function(t){var n=t.__super__;n!==null&&gui.Super.stubOne(n,t.prototype,e)})):console.error("Addin naming collision in "+this+": "+e)},_breakdown_base:function(e){var t=gui.Type.isString(e[0]);return{name:t?e[0]:null,proto:e[t?1:0]||{},expando:e[t?2:1]||{},recurring:e[t?3:2]||{},statics:e[t?4:3]||{}}},_extend:function(e,t,n,r,i){i=i||"Anonymous";var s=this._create(e.prototype,i);return this._name(s,i),e.__extenders__.push(s),s.__extenders__=[],gui.Object.extend(s,r),s.__recurring__=gui.Object.copy(e.__recurring__),gui.Object.extend(s.__recurring__,n),gui.Object.each(s.__recurring__,function(e,t){s[e]=t}),gui.Super.stamp(e,s,t),s},_create:function(e,t){var n=this._constructor(t);return n.prototype=Object.create(e),n.prototype.constructor=n,n.__super__=null,["extend","addin"].forEach(function(e){n[e]=this[e]},this),n},_constructor:function(e){if(e.contains(".")){var t=e.lastIndexOf(".");e=e.substring(t+1)}var n=Function,r=new n("return function "+e+" () {"+"var con = this.__construct__ || this.onconstruct;"+"if ( gui.Type.isFunction ( con )) {"+"con.apply ( this, arguments );"+"}"+"}");return r()},_name:function(e,t){this._nameIt(e,"function",t),this._nameIt(e.prototype,"object",t)},_nameIt:function(e,t,n){e.hasOwnProperty("toString")||(e.toString=function r(){return"["+t+" "+n+"]"}),e.hasOwnProperty("displayName")||Object.defineProperty(e,"displayName",{enumerable:!1,configurable:!0,get:function(){return n}})}},gui.Interface={validate:function(e,t){var n=!0,r=e.toString(),i=gui.Type.of(t);switch(i){case"null":case"string":case"number":case"boolean":case"undefined":throw new Error("Expected "+r+", got "+i+": "+t);default:try{var s=null,o=null;n=Object.keys(e).every(function(n){return s=n,o=gui.Type.of(e[n]),gui.Type.of(t[n])===o});if(!n)throw new Error("Expected "+r+". A required "+i+' "'+s+'" is missing')}catch(u){throw new Error("Expected "+r)}}return n}},gui.Combinator={before:function(e){return function(t){return function(){return e.apply(this,arguments),t.apply(this,arguments)}}},after:function(e){return function(t){return function(){var n=t.apply(this,arguments);return e.apply(this,arguments),n}}},around:function(e){return function(t){return function(){var n,r,i,s=this,o=gui.Combinator._slice;return n=1<=arguments.length?o.call(arguments,0):[],i=void 0,r=function(){return i=t.apply(s,n)},e.apply(this,[r].concat(n)),i}}},provided:function(e){return function(t,n){return function(){if(e.apply(this,arguments))return t.apply(this,arguments);if(n)return n.apply(this,arguments)}}},_slice:[].slice},gui.Object={create:function(e,t){var n=Object.create(null);return Object.keys(t).forEach(function(e){n[e]={value:t[e],writable:!0,enumerable:!0,configurable:!0}}),Object.create(e,n)},extend:function(t,n){return Object.keys(n).forEach(function(e){var r=Object.getOwnPropertyDescriptor(n,e);Object.defineProperty(t,e,r)}),t},copy:function(e){return this.extend(Object.create(null),e)},each:function(e,t,n){Object.keys(e).forEach(function(r){t.call(n,r,e[r])})},isEmpty:function(e){return Object.keys(e).length===0},lookup:function(e,t){var n,r=t;if(!e.contains("."))n=r[e];else{var i=e.split(".");i.forEach(function(e){r=r[e]}),n=r}return n},assert:function(e,t,n){var r,i=n;if(e.contains(".")){var s=e.split(".");r=s.pop(),s.forEach(function(e){i=i[e]})}else r=e;return i[r]=t,i},methods:function(e){var t=[];for(var n in e)gui.Type.isFunction(e[n])&&(gui.Type.isConstructor(n)||t.push(n));return t},nonmethods:function(e){var t=[];for(var n in e)gui.Type.isFunction(e[n])||t.push(n);return t}},gui.Super=function(t){"use strict";gui.Super.stubAll(this,t.prototype)},gui.Super.prototype=Object.create(null),gui.Super.subject=null,gui.Super.disclaimer="/**\n  * Method was overloaded by the framework. \n  * This is an approximation of the code :) \n  */\n",gui.Super.stubAll=function(e,t){gui.Object.methods(t).forEach(function(n){gui.Super.stubOne(e,t,n)},this)},gui.Super.stubOne=function(e,t,n){var r=e[n]=function(){return t[n].apply(gui.Super.subject,arguments)};r.displayName=n},gui.Super.stamp=function(e,t,n){"use strict";var r=null,i=t.prototype;gui.Type.isObject(n)&&Object.keys(n).forEach(function(s){r=Object.getOwnPropertyDescriptor(n,s);switch(gui.Type.of(r.value)){case"function":gui.Type.isConstructor(r.value)||(r=gui.Super._function(n,s,r,e));break;case"object":var o=r.value;(o.get||o.set)&&Object.keys(o).every(function(e){return e==="get"||e==="set"})&&(r=gui.Super._property(s,o,t))}Object.defineProperty(i,s,r),gui.Type.isFunction(i[s])&&(Object.defineProperty(i[s],"displayName",{enumerable:!1,configurable:!0,get:function(){return s}}),i[s].toString=function(){var e=n[s].toString();return e=e.replace(/\t/g,"  "),gui.Super.disclaimer+e})})},gui.Super._function=function(e,t,n,r){return n.value.__data__||(n.value=function(){var n=gui.Super.subject;gui.Super.subject=this,this._super=r.__super__;var i=e[t].apply(this,arguments);return gui.Super.subject=n,i}),n},gui.Super._property=function(e,t,n){"use strict";return["get","set"].forEach(function(r){var i,s=n.prototype;while(s&&!gui.Type.isDefined(t[r]))s=Object.getPrototypeOf(s),i=Object.getOwnPropertyDescriptor(s,e),i&&(t[r]=i[r])}),{enumerable:!0,configurable:!0,get:t.get||function(){throw new Error(n+" Getting a property that has only a setter: "+e)},set:t.set||function(){throw new Error(n+" Setting a property that has only a getter: "+e)}}},gui.Type={of:function(e){var t={}.toString.call(e).match(this._typeexp)[1].toLowerCase();return t==="domwindow"&&String(typeof e)==="undefined"&&(t="undefined"),t},isDefined:function(e){return this.of(e)!=="undefined"},cast:function(e){var t=String(e);switch(t){case"null":t=null;break;case"true":case"false":t=t==="true";break;default:String(parseInt(t,10))===t?t=parseInt(t,10):String(parseFloat(t))===t&&(t=parseFloat(t))}return t},isConstructor:function(e){return this.isFunction(e)&&Object.keys(e.prototype).length>0},isSpiritConstructor:function(e){return this.isFunction(e)&&this.isBoolean(e.portals)},list:function(e){var t=null;switch(this.of(e)){case"array":t=e;break;case"string":t=e.split(" ");break;case"nodelist":case"arguments":t=Array.prototype.slice.call(e);break;default:t=[e]}return t},_typeexp:/\s([a-zA-Z]+)/},function(){["array","function","object","string","number","boolean","null","arguments"].forEach(function(e){this["is"+e[0].toUpperCase()+e.slice(1)]=function(n){return this.of(n)===e}},this)}.call(gui.Type),gui.Position=function(e,t){this.x=e||0,this.y=t||0},gui.Position.prototype={x:0,y:0,toString:function(){return"[object gui.Position("+this.x+","+this.y+")]"},clone:function(){return new gui.Position(this.x,this.y)}},gui.Position.isEqual=function(e,t){return e.x===t.x&&e.y===t.y},gui.Dimension=function(e,t){this.w=e||0,this.h=t||0},gui.Dimension.prototype={w:0,h:0,toString:function(){return"[object gui.Dimension("+this.w+","+this.h+")]"}},gui.Dimension.isEqual=function(e,t){return e.w===t.w&&e.h===t.h},gui.Geometry=function(e,t,n,r){this.x=e||0,this.y=t||0,this.w=n||0,this.h=r||0},gui.Geometry.prototype={x:0,y:0,w:0,h:0,toString:function(){return"[object gui.Geometry("+this.x+","+this.y+","+this.w+","+this.h+")]"},hitTest:function(e){return gui.Geometry.hitTest(this,e)}},gui.Geometry.isEqual=function(e,t){return e.x===t.x&&e.y===t.y&&e.w===t.w&&e.h===t.h},gui.Geometry.hitTest=function(e,t){function n(e,t){return e.x>=t.x&&e.x<=t.x+t.w}function r(e,t){return e.y>=t.y&&e.y<=t.y+t.h}var i=n(e,t)||n(t,e),s=r(e,t)||r(t,e);return i&&s},gui.URL=function(e,t){var n=e.createElement("a");n.href=t,Object.keys(gui.URL.prototype).forEach(function(e){gui.Type.isString(n[e])&&(this[e]=n[e])},this),this.id=this.hash?this.hash.substring(1):null,this.location=this.href.split("#")[0],this.external=this.location!==String(e.location).split("#")[0]},gui.URL.prototype={hash:null,host:null,hostname:null,href:null,pathname:null,port:null,protocol:null,search:null,id:null,external:!1},gui.Then=function(){},gui.Then.prototype={toString:function(){return"[object gui.Then]"},then:function(e,t){this._callback=e?e:null,this._pointer=t?t:null},now:function(){var e=this._callback,t=this._pointer;e&&(this.then(null,null),e.apply(t,arguments))},_callback:null,_pointer:null},gui.HTMLParser=function(t){if(!t||!t.nodeType)throw new TypeError("Document expected");this._document=t},gui.HTMLParser.prototype={_document:null,parse:function(e,t){var n,r,i,s,o,u=gui.HTMLParser._fixes,a=gui.HTMLParser._comments,f=gui.HTMLParser._firsttag,l=this._document;e=e.trim().replace(a,"");if(n=e.match(f))if(r=u.get(n[1]))e=r.replace("${html}",e);i=l.createElement("div"),i.innerHTML=e;var c=i.childNodes;if(r&&t){var h=t.localName;if(u.has(h)){var p=i;while(p)p=p.firstElementChild,p.localName===h&&(c=p.childNodes,p=null)}}return Array.map(c,function(e){return e})}},gui.HTMLParser._comments=/<!--[\s\S]*?-->/g,gui.HTMLParser._firsttag=/^<([a-z]+)/i,gui.HTMLParser._fixes=new Map,function(){gui.Object.each({td:"<table><tbody><tr>${html}</tr></tbody></table>",tr:"<table><tbody>${html}</tbody></table>",tbody:"<table>${html}</table>",col:"<table><colgroup>${html}</colgroup></table>",option:"<select><option>a</option>${html}</select>"},function(e,t){gui.HTMLParser._fixes.set(e,t)})}(),function(){var e=gui.HTMLParser._fixes;e.set("th",e.get("td")),["thead","tfoot","caption","colgroup"].forEach(function(t){gui.HTMLParser._fixes.set(t,e.get("tbody"))})}(),gui.DOMSerializer=function(){},gui.DOMSerializer.prototype={serialize:function(e){var t=e.ownerDocument.defaultView,n=new t.XMLSerializer;return n.serializeToString(e)},subserialize:function(e){var t=this.serialize(e);return t.contains("</")&&(t=t.slice(t.indexOf(">")+1,t.lastIndexOf("<"))),t}},gui.FileLoader=gui.Exemplar.create("gui.FileLoader",Object.prototype,{onconstruct:function(e){this._cache=gui.FileLoader._cache,this._document=e},load:function(e,t,n){var r=new gui.URL(this._document,e);this._cache.has(r.location)?this._cached(r,t,n):this._request(r,t,n)},onload:function(e,t,n,r){n.call(r,e)},_cache:null,_document:null,_request:function(e,t,n){this._cache.set(e.location,null),(new gui.Request(e.href)).get(function(r,i){this.onload(i,e,t,n),this._cache.set(e.location,i),gui.FileLoader.unqueue(e.location)},this)},_cached:function(e,t,n){var r=this._cache.get(e.location);if(r!==null)this.onload(r,e,t,n);else{var i=this;gui.FileLoader.queue(e.location,function(r){i.onload(r,e,t,n)})}},__construct__:function(e){if(!e||e.nodeType!==Node.DOCUMENT_NODE)throw new TypeError("Document expected");this.onconstruct(e)}},{},{_cache:new Map,_queue:new Map,queue:function(e,t){this._queue[e]=this._queue[e]||[],this._queue[e].push(t)},unqueue:function(e){var t=this._cache.get(e);if(this._queue[e])while(this._queue[e][0])this._queue[e].shift()(t)}}),gui.BlobLoader={loadScript:function(e,t,n,r){var i=new Blob([t],{type:"text/javascript"}),s=e.createElement("script");s.src=this._URL.createObjectURL(i);var o=e.querySelector("head");gui.Observer.suspend(o,function(){o.appendChild(s)}),n&&(s.onload=function(){n.call(r)})},_URL:window.URL||window.webkitURL},gui.EventSummary=function(e){if(!gui.Type.of(e).endsWith("event"))throw new TypeError;this._construct(e)},gui.EventSummary.prototype={event:null,window:null,document:null,documentspirit:null,toString:function(){return"[object gui.EventSummary]"},_construct:function(e){var t=null,n=null,r=e.target,i=r.nodeType;gui.Type.isDefined(i)?(n=i===Node.DOCUMENT_NODE?r:r.ownerDocument,t=n.defaultView):(t=r,n=t.document),this.event=e,this.window=t,this.document=n,this.documentspirit=n.documentElement.spirit}},gui.Crawler=function(e){return this.type=e||null,this},gui.Crawler.prototype={CONTINUE:0,STOP:1,type:null,direction:null,global:!1,ascend:function(e,t){this.direction=gui.Crawler.ASCENDING;var n=e instanceof gui.Spirit?e.element:e;do{if(n.nodeType===Node.DOCUMENT_NODE)if(this.global){n=n.defaultView.frameElement;if(n)try{var r=n.ownerDocument}catch(i){console.warn("@todo Ascend cross domain"),n=null}}else n=null;if(n){var s=this._handleElement(n,t);if(!s)n=n.parentNode;else switch(s){case gui.Crawler.STOP:n=null}}}while(n)},descend:function(e,t){this.direction=gui.Crawler.DESCENDING;var n=e instanceof gui.Spirit?e.element:e;n.nodeType===Node.DOCUMENT_NODE?n=n.documentElement:n.localName==="iframe"&&this.global&&console.log("@todo descend into iframes"),this._descend(n,t,!0)},_descend:function(e,t,n){var r=this._handleElement(e,t);switch(r){case 0:if(e.childElementCount>0)this._descend(e.firstElementChild,t,!1);else if(this.global&&e.localName==="iframe"){try{var i=e.contentDocument}catch(s){console.warn("@todo Descend cross domain")}var o=e.contentDocument.documentElement;o&&o.spirit&&this._descend(o,t,!1)}if(!n){var u=e.nextElementSibling;u!==null&&this._descend(u,t,!1)}}},_handleElement:function(e,t){var n=gui.Crawler.CONTINUE,r=e.spirit;r&&(n=r.oncrawler(this));if(!n&&t){gui.Type.isFunction(t.handleElement)&&(n=t.handleElement(e));switch(n){case 1:break;default:gui.Type.isFunction(t.handleSpirit)&&r&&(n=this._handleSpirit(r,t))}}return n||(n=gui.Crawler.CONTINUE),n},_handleSpirit:function(e,t){return t.handleSpirit(e)}},gui.Crawler.ASCENDING="ascending",gui.Crawler.DESCENDING="descending",gui.Crawler.CONTINUE=0,gui.Crawler.STOP=1,gui.KeyMaster={generateKey:function(){var e=Math.random().toString(),t="key"+e.slice(2,11);return this._keys.has(t)?t=this.generateKey():this._keys.add(t),t},generateGUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e==="x"?t:t&3|8;return n.toString(16)}).toUpperCase()},isKey:function(e){var t=null,n=!1;return gui.Type.isString(e)&&(t=this.extractKey(e),n=t&&t[0]===e),n},extractKey:function(e){return/key\d{9}/.exec(e)},_keys:new Set},gui.Request=function(e,t){e&&this.url(e,t)},gui.Request.prototype={url:function(e,t){return this._url=t?(new gui.URL(t,e)).href:e,this},sync:function(){return this._async=!1,this},async:function(){return this._async=!0,this},accept:function(e){return this._accept=e,this},acceptJSON:function(){return this.accept("application/json")},acceptXML:function(){return this.accept("text/xml")},acceptText:function(){return this.accept("text/plain")},format:function(e){return this._format=e,this},header:function(e,t){return console.warn("@todo request headers"),this},get:function(e,t){var n=this,r=new XMLHttpRequest;r.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&e.call(t,200,n._parse(this.responseText),this.responseText)},r.overrideMimeType(this._accept),r.open("get",this._url,!0),r.send(null)},post:function(){},put:function(){},del:function(){},_async:!0,_url:null,_accept:"text/plain",_format:"application/x-www-form-urlencoded",_parse:function(e){var t=e;try{switch(this._accept){case"application/json":t=JSON.parse(e);break;case"text/xml":t=(new DOMParser).parseFromString(e,"text/xml")}}catch(n){throw console.error(this._accept+" dysfunction at "+this._url),n}return t}},gui.Spirit=gui.Exemplar.create("gui.Spirit",Object.prototype,{element:null,document:null,window:null,spiritkey:null,signature:null,toString:function(){return"[object gui.Spirit]"},onconstruct:function(){this.__plugin__(),this.__debug__(!0),this.life.goconstruct()},onconfigure:function(){this.config.configure(),this.life.goconfigure()},onenter:function(){this.window.gui.inside(this),this.life.goenter()},onattach:function(){this.window.gui.inside(this),this.life.goattach()},onready:function(){this.life.goready()},onvisible:function(){this.life.govisible()},oninvisible:function(){this.life.goinvisible()},ondetach:function(){this.window.gui.outside(this),this.life.godetach()},onexit:function(){return this.life.goexit(),undefined},ondestruct:function(e){this.window.gui.destruct(this),this.life.godestruct(),this.__debug__(!1),this.__destruct__(e)},oncrawler:function(e){return gui.Crawler.CONTINUE},onlife:function(e){},invisible:function(){return gui.Spirit.invisible(this)},visible:function(){return gui.Spirit.visible(this)},dispose:function(e){e||this.dom.remove(),this.ondestruct()},__construct__:function(){},__lazyplugins__:null,__plugin__:function(){this.life=new gui.LifePlugin(this),this.config=new gui.ConfigPlugin(this),this.__lazyplugins__=Object.create(null);var e=[],t=this.constructor.__plugins__;gui.Object.each(t,function(t,n){switch(n){case gui.LifePlugin:case gui.ConfigPlugin:break;default:n.lazy?gui.Plugin.later(n,t,this,this.__lazyplugins__):this[t]=new n(this),e.push(t)}},this),this.life.onconstruct(),this.config.onconstruct(),e.forEach(function(e){this.__lazyplugins__[e]||this[e].onconstruct()},this)},__debug__:function(e){var t;this.window.gui.debug&&(e?this.att.has("gui")||(t="["+this.displayName+"]",this.att.set("gui",t)):(t=this.att.get("gui"),t&&t.startsWith("[")&&this.att.del("gui")))},__destruct__:function(e){var t=this.__lazyplugins__;gui.Object.each(t,function(e){t[e]===!0&&delete this[e]},this),gui.Object.each(this,function(t){var n=this[t];switch(gui.Type.of(n)){case"object":n instanceof gui.Plugin&&n!==this.life&&n.__destruct__(e)}},this),this.life.__destruct__();if(e)this.__null__();else{var n=this,r=gui.TICK_SPIRIT_NULL,i=this,s=this.document.title;gui.Tick.one(r,{ontick:function(){try{n.__null__()}catch(e){}}},this.signature).dispatch(r,0,this.signature)}},__null__:function(){var e=this.element;if(e)try{e.spirit=null}catch(t){}Object.keys(this).forEach(function(e){Object.defineProperty(this,e,gui.Spirit.DENIED)},this)}},{portals:!0,infuse:function(){var e=gui.Exemplar.extend.apply(this,arguments);e.__plugins__=gui.Object.copy(this.__plugins__);var t=gui.Exemplar.breakdown(arguments);return gui.Object.each(e.__plugins__,function(n,r){var i=t.expando[n];switch(gui.Type.of(i)){case"object":var s=r.extend(i);e.plugin(n,s,!0);break;case"undefined":break;default:throw new TypeError(e+": Bad definition: "+n)}},this),e},summon:function(e){return this.possess((e||document).createElement("div"))},possess:function(e){return gui.Guide.possess(e,this)},extend:function(){throw new Error('Spirits must use the "infuse" method and not "extend".\nThis method extends both the spirit and it\'s plugins.')},parse:function(e,t){if(e.nodeType===Node.DOCUMENT_NODE)return(new gui.HTMLParser(e)).parse(t)[0];throw new TypeError(this+".parse() expects a Document")},plugin:function(e,t,n){var r=this.__plugins__,i=this.prototype;if(!i.hasOwnProperty(e)||i.prefix===null||n){if(!r[e]||n)r[e]=t,i.prefix=null,gui.Exemplar.children(this,function(r){r.plugin(e,t,n)})}else console.error("Plugin naming crash in "+this+": "+e)},__plugins__:Object.create(null)},{visible:function(e){return e.life.invisible&&(this._visible(e,!0,e.life.entered),e.css.remove(gui.CLASS_INVISIBLE)),e},invisible:function(e){return e.life.visible&&(this._visible(e,!1,e.life.entered),e.css.add(gui.CLASS_INVISIBLE)),e},_visible:function(e,t,n){var r=new gui.Crawler(t?gui.CRAWLER_VISIBLE:gui.CRAWLER_INVISIBLE);r.global=!0,r.descend(e,{handleSpirit:function(e){return t?e.onvisible():e.oninvisible(),n?gui.Crawler.CONTINUE:gui.Crawler.STOP}})},DENIED:{enumerable:!0,configurable:!0,get:function(){throw new Error(gui.Spirit.DENIAL)},set:function(){throw new Error(gui.Spirit.DENIAL)}},DENIAL:"Attempt to handle destructed spirit"}),gui.Plugin=gui.Exemplar.create("gui.Plugin",Object.prototype,{spirit:null,context:null,onconstruct:function(){},destruct:function(){},handleEvent:function(e){gui.Type.isFunction(this.onevent)&&this.onevent(e)},__construct__:function(e){this.spirit=e||null,this.context=e?e.window:null},__destruct__:function(){this.destruct(),this.spirit!==null&&Object.defineProperty(this,"spirit",gui.Spirit.DENIED)}},{lazy:!0,infuse:function(){throw new Error('Plugins must use the "extend" method and not "infuse".')}},{later:function(e,t,n,r){r[t]=!0,Object.defineProperty(n,t,{enumerable:!0,configurable:!0,get:function(){return r[t]===!0&&(r[t]=new e(n),r[t].onconstruct()),r[t]},set:function(e){r[t]=e}})}}),gui.Tracker=gui.Plugin.extend("gui.Tracker",{_xxx:null,_sig:null,onconstruct:function(){this._super.onconstruct(),this._sig=this.spirit.window.gui.signature,this._xxx=Object.create(null)},toggle:function(e,t){console.error("@todo SpiritTracker#toggle")},contains:function(e){return this._breakdown(e).every(function(e){return this._xxx[e]},this)},destruct:function(){var e,t;this._super.destruct(),gui.Object.each(this._xxx,function(e,t){t.slice(0).forEach(function(t){this._cleanup(e,t)},this)},this)},_cleanup:function(e,t){this._removechecks(e,t)},_addchecks:function(e,t){var n=!1,r=this._xxx[e];return r?n=!this._haschecks(r,t):(r=this._xxx[e]=[],n=!0),n&&r.push(t),n},_removechecks:function(e,t){var n=!1,r=this._xxx[e];if(r){var i=this._checksindex(r,t);i>-1&&(r.remove(i),r.length===0&&delete this._xxx[e],n=!0)}return n},_containschecks:function(e,t){var n=!1,r=this._xxx[e];return r&&(n=this._haschecks(r,t)),n},_haschecks:function(e,t){var n=!1;return e.every(function(e){return e.every(function(e,n){return e===t[n]})&&(n=!0),!n}),n},_checksindex:function(e,t){var n=-1;return e.every(function(e,r){return e.every(function(e,n){return e===t[n]})&&(n=r),n===-1}),n},_breakdown:function(e){var t=null;switch(gui.Type.of(e)){case"array":t=e;break;case"string":t=e.split(" ")}return t}}),gui.Life=function(t,n){this.target=t,this.type=n},gui.Life.prototype={target:null,type:null,toString:function(){return"[object gui.Life]"}},gui.LifePlugin=gui.Tracker.extend("gui.LifePlugin",{constructed:!1,configured:!1,entered:!1,attached:!1,detached:!0,ready:!1,visible:!0,invisible:!1,exited:!1,destructed:!1,_handlers:null,onconstruct:function(){this._super.onconstruct(),this._handlers=Object.create(null)},add:function(e,t){return t=t?t:this.spirit,this._breakdown(e).forEach(function(e){this._addchecks(e,[t])&&(this._handlers[e]||(this._handlers[e]=[]),this._handlers[e].push(t))},this),this.spirit},remove:function(e,t){return t=t?t:this.spirit,this._breakdown(e).forEach(function(e){if(this._removechecks(e,[t])){var n=this._handlers[e].indexOf(e);this._handlers[e].remove(n),this._handlers[e].length===0&&delete this._handlers[e]}},this),this.spirit},dispatch:function(e){var t=this._handlers[e];if(t!==undefined){var n=new gui.Life(this.spirit,e);t.forEach(function(e){e.onlife(n)});switch(e){case gui.Life.ATTACH:case gui.Life.DETACH:case gui.Life.VISIBLE:case gui.Life.INVISIBLE:break;default:delete this._handlers[e]}}}}),function(){var t={construct:gui.Life.CONSTRUCT,configure:gui.Life.CONFIGURE,enter:gui.Life.ENTER,attach:gui.Life.ATTACH,ready:gui.Life.READY,visible:gui.Life.VISIBLE,invisible:gui.Life.INVISIBLE,detach:gui.Life.DETACH,exit:gui.Life.EXIT,destruct:gui.Life.DESTRUCT};gui.Object.each(t,function(e,t){gui.LifePlugin.addin("go"+e,function(){var n=e;switch(e){case"ready":case"visible":case"invisible":break;default:n+="ed"}this[n]=!0;switch(e){case"enter":case"attach":this.detached=!1;break;case"detach":this.attached=!1;break;case"visible":this.invisible=!1;break;case"invisible":this.visible=!1}this.dispatch(t)})})}(),gui.Spirit.plugin("life",gui.LifePlugin),gui.ConfigPlugin=gui.Plugin.extend("gui.ConfigPlugin",{map:null,configure:function(){this.spirit.att.all().forEach(function(e){this.attribute(this._lookup(e.name),e.value)},this)},attribute:function(e,t){var n="gui.",r=this.spirit,i=!0,s=null,o=null;e.startsWith(n)&&(e=e.split(n)[1],s=e,e.indexOf(".")>-1&&(o=e.split("."),o.forEach(function(e,t){gui.Type.isDefined(r)?t<o.length-1?r=r[e]:s=e:i=!1})),i&&gui.Type.isDefined(r[s])?(t=gui.Type.cast(t),gui.Type.isFunction(r[s])?r[s](t):r[s]=t):console.error('No definition for "'+e+'": '+this.spirit.toString()))},_lookup:function(e){var t="gui.";return this.map&&this.map.hasOwnProperty(e)&&(e=this.map[e],e.startsWith(t)||(e=t+e)),e}}),gui.Spirit.plugin("config",gui.ConfigPlugin),gui.Action=function(t,n,r,i,s){this.target=t,this.type=n,this.data=r,this.direction=i||"ascending",this.global=s||!1},gui.Action.prototype={target:null,type:null,data:null,direction:null,global:!1,isConsumed:!1,isCancelled:!1,consumer:null,consume:function(e){this.isConsumed=!0,this.consumer=e},cancel:function(e){this.isCancelled=!0,this.consume(e)},toString:function(){return"[object gui.Action]"}},gui.Action.dispatch=function(t,n,r,i,s){var o=new gui.Action(t,n,r,i,s),u=new gui.Crawler(gui.CRAWLER_ACTION);return u.global=s||!1,u[i||"ascend"](t,{handleSpirit:function(e){var t=gui.Crawler.CONTINUE;return e.action.contains(n)&&(e.action.handleAction(o),o.isConsumed&&(t=gui.Crawler.STOP,o.consumer=e)),t}}),o},gui.ActionPlugin=gui.Tracker.extend("gui.ActionPlugin",{type:null,data:null,add:function(e,t){return gui.Arguments.validate(arguments,"array|string","(object|function)")&&(t=t?t:this.spirit,gui.Interface.validate(gui.IActionHandler,t)&&this._breakdown(e).forEach(function(e){this._addchecks(e,[t,this._global])},this)),this},remove:function(e,t){return gui.Arguments.validate(arguments,"array|string","(object|function)")&&(t=t?t:this.spirit,gui.Interface.validate(gui.IActionHandler,t)&&this._breakdown(e).forEach(function(e){this._removechecks(e,[t,this._global])},this)),this},addGlobal:function(e,t){return this._globalize(function(){return this.add(e,t)})},removeGlobal:function(e,t){return this._globalize(function(){return this.remove(e,t)})},dispatch:function(e,t,n){if(gui.Arguments.validate(arguments,"string","(*)","(string)"))return gui.Action.dispatch(this.spirit,e,t,n||"ascend",this._global)},ascend:function(e,t){return this.dispatch(e,t,"ascend")},descend:function(e,t){return this.dispatch(e,t,"descend")},dispatchGlobal:function(e,t){return this._globalize(function(){return this.dispatch(e,t)})},ascendGlobal:function(e,t){return this._globalize(function(){return this.ascend(e,t)})},descendGlobal:function(e,t){return this._globalize(function(){return this.descend(e,t)})},handleAction:function(e){var t=this._xxx[e.type];t&&t.forEach(function(t){var n=t[0],r=t[1]===e.global;r&&n!==e.target&&n.onaction(e)})},_global:!1,_globalize:function(e){this._global=!0;var t=e.call(this);return this._global=!1,t},_cleanup:function(e,t){if(this._removechecks(e,t)){var n=t[0],r=t[1];r?this.removeGlobal(e,n):this.remove(e,n)}}}),gui.IActionHandler={toString:function(){return"[object IActionHandler]"},onaction:function(e){}},gui.AttPlugin=gui.Plugin.extend("gui.AttPlugin",{get:function(e){return gui.Type.cast(this.spirit.element.getAttribute(e))},set:function(e,t){return t===null?this.del(e):this.__suspended__||this.spirit.element.setAttribute(e,String(t)),this},has:function(e){return this.spirit.element.getAttribute(e)!==null},del:function(e){this.__suspended__||this.spirit.element.removeAttribute(e)},all:function(){return Array.map(this.spirit.element.attributes,function(e){return e})},getup:function(){var e=Object.create(null);return this.all().forEach(function(t){e[t.name]=gui.Type.cast(t.value)}),e},setup:function(e){gui.Object.each(e,function(e,t){this.set(e,t)},this)},__suspended__:!1,__suspend__:function(e){this.__suspended__=!0;var t=e.apply(this,arguments);return this.__suspended__=!1,t}}),gui.BoxPlugin=gui.Plugin.extend("gui.BoxPlugin",{width:0,height:0,localX:0,localY:0,pageX:0,pageY:0,clientX:0,clientY:0}),Object.defineProperties(gui.BoxPlugin.prototype,{width:{get:function(){return this.spirit.element.offsetWidth}},height:{get:function(){return this.spirit.element.offsetHeight}},localX:{get:function(){return this.spirit.element.offsetLeft}},localY:{get:function(){return this.spirit.element.offsetTop}},pageX:{get:function(){return this.clientX+gui.Client.scrollRoot.scrollLeft}},pageY:{get:function(){return this.clientY+gui.Client.scrollRoot.scrollTop}},clientX:{get:function(){return this.spirit.element.getBoundingClientRect().left}},clientY:{get:function(){return this.spirit.element.getBoundingClientRect().top}}}),gui.Broadcast=function(e,t,n,r){this.target=e,this.type=t,this.data=n,this.isGlobal=r},gui.Broadcast.prototype={target:null,type:null,data:null,isGlobal:!1,toString:function(){return"[object gui.Broadcast]"}},gui.Broadcast._globals=Object.create(null),gui.Broadcast._locals=Object.create(null),gui.Broadcast.add=function(e,t,n){return this._add(e,t,n)},gui.Broadcast.remove=function(e,t,n){return this._remove(e,t,n)},gui.Broadcast.dispatch=function(e,t,n,r){return this._dispatch(e,t,n,r)},gui.Broadcast.addGlobal=function(e,t){return this._add(e,t)},gui.Broadcast.removeGlobal=function(e,t){return this._remove(e,t)},gui.Broadcast.dispatchGlobal=function(e,t,n){return this._dispatch(e,t,n)},gui.Broadcast._add=function(e,t,n){if(gui.Arguments.validate(arguments,"array|string","object|function","(string)")&&gui.Interface.validate(gui.IBroadcastHandler,t))if(gui.Type.isArray(e))e.forEach(function(e){this._add(e,t,n)},this);else{var r;n?(r=this._locals[n],r||(r=this._locals[n]=Object.create(null))):r=this._globals,r[e]||(r[e]=[]);var i=r[e];i.indexOf(t)===-1&&i.push(t)}return this},gui.Broadcast._remove=function(e,t,n){if(gui.Interface.validate(gui.IBroadcastHandler,t))if(gui.Type.isArray(e))e.forEach(function(e){this._remove(e,t,n)},this);else{var r=n?this._locals[n][e]:this._globals[e],i=r.indexOf(t);i>-1&&r.remove(i)}return this},gui.Broadcast._dispatch=function(e,t,n,r){var i=!gui.Type.isString(r),s=new gui.Broadcast(e,t,n,i),o=i?this._globals:this._locals[r];if(o){var u=o[t];u&&u.slice().forEach(function(e,t){e.onbroadcast(s)})}},gui.BroadcastPlugin=gui.Tracker.extend("gui.BroadcastPlugin",{add:function(e,t){t=t?t:this.spirit;var n=this._global?null:this._sig;return this._breakdown(e).forEach(function(e){this._addchecks(e,[t,this._global])&&(this._global?gui.Broadcast.addGlobal(e,t):gui.Broadcast.add(e,t,n))},this),this},remove:function(e,t){t=t?t:this.spirit;var n=this._global?null:this._sig;return this._breakdown(e).forEach(function(e){this._removechecks(e,[t,this._global])&&(this._global?gui.Broadcast.removeGlobal(e,t):gui.Broadcast.remove(e,t,n))},this),this},dispatch:function(e,t){var n=null,r=this._global?null:this._sig;return this._breakdown(e).forEach(function(e){this._global?n=gui.Broadcast.dispatchGlobal(this.spirit,e,t):n=gui.Broadcast.dispatch(this.spirit,e,t,r)},this),n},addGlobal:function(e,t){return this._globalize(function(){return this.add(e,t)})},removeGlobal:function(e,t){return this._globalize(function(){return this.remove(e,t)})},dispatchGlobal:function(e,t){return this._globalize(function(){return this.dispatch(e,t)})},_global:!1,_globalize:function(e){this._global=!0;var t=e.call(this);return this._global=!1,t},_cleanup:function(e,t){if(this._removechecks(e,t)){var n=t[0],r=t[1],i=r?null:this._sig;r?gui.Broadcast.removeGlobal(e,n):gui.Broadcast.remove(e,n,this._sig)}}}),gui.IBroadcastHandler={toString:function(){return"[object IBroadcastHandler]"},onbroadcast:function(e){}},gui.CSSPlugin=gui.Plugin.extend("gui.CSSPlugin",{set:function(e,t){return gui.CSSPlugin.set(this.spirit.element,e,t),this},get:function(e){return gui.CSSPlugin.get(this.spirit.element,e)},compute:function(e){return gui.CSSPlugin.compute(this.spirit.element,e)},style:function(e){return gui.CSSPlugin.style(this.spirit.element,e),this},name:function(e){var t=this.spirit.element.className;return e!==undefined&&(this.spirit.element.className=e,t=this.spirit),t},add:function(e){return gui.CSSPlugin.add(this.spirit.element,e),this},remove:function(e){return gui.CSSPlugin.remove(this.spirit.element,e),this},toggle:function(e){return gui.CSSPlugin.toggle(this.spirit.element,e),this},contains:function(e){return gui.CSSPlugin.contains(this.spirit.element,e)},matches:function(e){return gui.CSSPlugin.matches(this.spirit.element,e)}},{},{add:function(e,t){t.indexOf(" ")>-1&&(t=t.split(" "));if(gui.Type.isArray(t))t.forEach(function(t){this.add(e,t)},this);else if(this._supports)e.classList.add(t);else{var n=e.className.split(" ");n.indexOf(t)===-1&&(n.push(t),e.className=n.join(" "))}},remove:function(e,t){t.indexOf(" ")>-1&&(t=t.split(" "));if(gui.Type.isArray(t))t.forEach(function(t){this.remove(e,t)},this);else if(this._supports)e.classList.remove(t);else{var n=e.className.split(" "),r=n.indexOf(t);r>-1&&n.remove(r),e.className=n.join(" ")}},toggle:function(e,t){this._supports?e.classList.toggle(t):this.contains(e,t)?this.remove(e,t):this.add(e,t)},contains:function(e,t){var n=!1;if(this._supports)n=e.classList.contains(t);else{var r=e.className.split(" ");n=r.indexOf(t)>-1}return n},set:function(e,t,n){gui.Type.isNumber(n)&&(n=(this._shorthands[t]||"@").replace("@",n)),n=String(n);switch(t){case"float":t="cssFloat";break;default:n=this._normval(e,n),t=this._normprop(e,t)}return e.style[t]=n,this},get:function(e,t){return this._normval(e.style[this._normprop(e,t)])},style:function(e,t){var n=e instanceof gui.Spirit?e.element:e;return gui.Object.each(t,function(e,t){this.set(n,e,t)},this),e},compute:function(e,t){var n=e instanceof gui.Spirit?e.element:e,r=n.ownerDocument,i=r.defaultView;return t=this._standardcase(this._normprop(n,t)),i.getComputedStyle(n,null).getPropertyValue(t)},matches:function(e,t){return e[this._matchmethod](t)},_vendors:["","-webkit-","-moz-","-ms-","-o-"],_supports:document.documentElement.classList!==undefined,_camelcase:function(e){return e.replace(/-([a-z])/ig,function(e,t){return t.toUpperCase()})},_standardcase:function(e){return e.replace(/[A-Z]/g,function(t,n){return"-"+e.charAt(n).toLowerCase()})},_shorthands:{top:"@px",right:"@px",bottom:"@px",left:"@px",width:"@px",height:"@px",maxWidth:"@px",maxHeight:"@px",minWidth:"@px",minHeight:"@px",textIndent:"@px",fontWeight:"@",opacity:"@",zIndex:"@",position:"@",display:"@",visibility:"@"},_normval:function(e,t){var n=this._vendors;if(t&&t.contains("-beta-")){var r=[];t.split(", ").forEach(function(t){(t=t.trim()).startsWith("-beta-")?n.every(function(i){var s=this._camelcase(t.replace("-beta-",i));return e.style[s]!==undefined?(n.length>2&&(this._vendors=["",i]),r.push(t.replace("-beta-",i)),!1):!0},this):r.push(t)},this),t=r.join(",")}return t},_normprop:function(e,t,n){var r=this._vendors,i=t;return t.startsWith("-beta-")?r.every(function(n){var s=this._camelcase(t.replace("-beta-",n));return e.style[s]!==undefined?(r.length>2&&(this._vendors=["",n]),i=s,!1):!0},this):i=this._camelcase(i),i},_matchmethod:function(){var e=null,t=document.documentElement;return["mozMatchesSelector","webkitMatchesSelector","msMatchesSelector","oMatchesSelector","matchesSelector"].every(function(n){return gui.Type.isDefined(t[n])&&(e=n),e===null}),e}()}),function(){function t(e){Object.defineProperty(gui.CSSPlugin.prototype,e,{enumerable:!0,configurable:!0,get:function(){return parseInt(this.get(e),10)},set:function(n){this.set(e,n)}})}var n=gui.CSSPlugin._shorthands;for(var r in n)n.hasOwnProperty(r)&&t(r)}(),gui.DOMPlugin=gui.Plugin.extend("gui.DOMPlugin",{id:function(e){var t=this;return e!==undefined?this.spirit.element.id=e:(e=this.spirit.element.id,t=e?e:null),t},tag:function(e){var t=null;return e?t=this.spirit.document.createElement(e):t=this.spirit.element.localName,t},title:function(e){var t=this.spirit.element;return gui.Type.isDefined(e)&&(t.title=e?e:""),t.title},embedded:function(){return gui.DOMPlugin.embedded(this.spirit.element)},html:function(e,t){var n=this.spirit,r=n.element;return gui.Type.isString(e)?t?r.insertAdjacentHTML(t,e):gui.DOMPlugin.html(r,e):n=r.innerHTML,n},empty:function(){return this.html("")},text:function(e){var t=this.spirit.element;return gui.Type.isString(e)&&(t.textContent=e),t.textContent},clone:function(){return this.spirit.element.cloneNode(!0)},show:function(){this.spirit.css.remove("_gui-invisible"),this.spirit.visible()},hide:function(){this.spirit.css.add("_gui-invisible"),this.spirit.invisible()},_qualify:function(e){return gui.DOMPlugin._qualify(e,this.spirit.element)}},{},{_thiskeyword:/^this|,this/g,html:function(e,t){var n=gui.Guide;if(e.nodeType===Node.ELEMENT_NODE&&gui.Type.isString(t)){var r=(new gui.HTMLParser(e.ownerDocument)).parse(t,e);n.materializeSub(e),n.suspend(function(){gui.Observer.suspend(e,function(){while(e.firstChild)e.removeChild(e.firstChild);r.forEach(function(t){e.appendChild(t)})})}),n.spiritualizeSub(e)}return e.innerHTML},outerHtml:function(e,t){var n=e.outerHTML,r=gui.Guide;if(!e.nodeType)throw new TypeError;if(gui.Type.isString(t)){var i=(new gui.HTMLParser(e.ownerDocument)).parse(t,e),s=e.parentNode;r.materialize(e),r.suspend(function(){gui.Observer.suspend(s,function(){while(i.length)s.insertBefore(i.pop(),e);s.removeChild(e)})}),r.spiritualizeSub(s),n=e}return n},ordinal:function(e){var t=0,n=e.parentNode.firstElementChild;while(n!==null){if(n===e)break;n=n.nextElementSibling,t++}return t},embedded:function(e){e=e instanceof gui.Spirit?e.element:e;var t=Node.DOCUMENT_POSITION_CONTAINS+Node.DOCUMENT_POSITION_PRECEDING;return e.compareDocumentPosition(e.ownerDocument)===t},qall:function(e,t,n){t=gui.DOMPlugin._qualify(t,e);var r=gui.Type.list(e.querySelectorAll(t));return n&&(r=r.filter(function(e){return e.spirit&&e.spirit instanceof n}).map(function(e){return e.spirit})),r},_qualify:function(e,t){var n=e.trim();switch(t.nodeType){case Node.ELEMENT_NODE:n=e.replace(gui.DOMPlugin._thiskeyword,t.localName);break;case Node.DOCUMENT_NODE:}return n}}),gui.Object.each({q:function(e,t){var n=null;return e=this._qualify(e),t?n=this.qall(e,t)[0]||null:n=this.spirit.element.querySelector(e),n},qall:function(e,t){return e=this._qualify(e),gui.DOMPlugin.qall(this.spirit.element,e,t)},qdoc:function(e,t){var n=this.spirit.document.documentElement;return n.spirit.dom.q.apply(n.spirit.dom,arguments)},qdocall:function(e,t){var n=this.spirit.document.documentElement;return n.spirit.dom.qall.apply(n.spirit.dom,arguments)}},function(t,n){gui.DOMPlugin.addin(t,function(){var e=arguments[0],r=arguments[1];if(gui.Type.isString(e)){if(arguments.length===1||gui.Type.isFunction(r))return n.apply(this,arguments);throw r=gui.Type.of(r),new TypeError("Unknown spirit for query: "+t+"("+e+","+r+")")}throw new TypeError("Bad selector for query: "+t+"("+e+")")})}),gui.Object.each({next:function(e){var t=null,n=null,r=this.spirit.element;if(e)while((r=r.nextElementSibling)!==null){n=r.spirit;if(n!==null&&n instanceof e){t=n;break}}else t=r.nextElementSibling;return t},previous:function(e){var t=null,n=null,r=this.spirit.element;if(e)while((r=r.previousElementSibling)!==null){n=r.spirit;if(n!==null&&n instanceof e){t=n;break}}else t=r.previousElementSibling;return t},first:function(e){var t=null,n=null,r=this.spirit.element.firstElementChild;if(e)while(t===null&&r!==null)n=r.spirit,n!==null&&n instanceof e&&(t=n),r=r.nextElementSibling;else t=r;return t},last:function(e){var t=null,n=null,r=this.spirit.element.lastElementChild;if(e)while(t===null&&r!==null)n=r.spirit,n!==null&&n instanceof e&&(t=n),r=r.previoustElementSibling;else t=r;return t},parent:function(e){var t=this.spirit.element.parentNode;if(e){var n=t.spirit;n&&n instanceof e?t=n:t=null}return t},child:function(e){var t=null,n=null,r=this.spirit.element.firstElementChild;if(r&&e)while(r!==null&&t===null)n=r.spirit,n&&n instanceof e&&(t=n),r=r.nextElementSibling;else t=r;return t},children:function(e){var t=[],n=this.spirit.element,r=n.firstElementChild;if(r){while(r!==null)t.push(r),r=r.nextElementSibling;e&&(t=t.filter(function(t){return t.spirit&&t.spirit instanceof e}).map(function(e){return e.spirit}))}return t},ancestor:function(e){var t=this.parent();return e&&(t=null,(new gui.Crawler).ascend(this.spirit.element,{handleSpirit:function(n){if(n instanceof e)return t=n,gui.Crawler.STOP}})),t},ancestors:function(e){var t=[],n=new gui.Crawler;return e?n.ascend(this.element,{handleSpirit:function(n){n instanceof e&&t.push(n)}}):n.ascend(this.element,{handleElement:function(e){t.push(e)}}),t},descendant:function(e){var t=this.child(),n=this.spirit.element;return e&&(new gui.Crawler).descend(n,{handleSpirit:function(r){if(r instanceof e&&r.element!==n)return t=r,gui.Crawler.STOP}}),t},descendants:function(e){var t=[],n=this.spirit.element;return(new gui.Crawler).descend(n,{handleElement:function(r){!e&&r!==n&&t.push(r)},handleSpirit:function(r){e&&r instanceof e&&r.element!==n&&t.push(r)}}),t}},function(t,n){gui.DOMPlugin.addin(t,function(e){if(!gui.Type.isDefined(e)||gui.Type.isFunction(e))return n.apply(this,arguments);throw new TypeError("Unknown spirit for query: "+t+"("+gui.Type.of(e)+")")})}),gui.Object.each({append:function(e){var t=e,n=this.spirit.element;t.forEach(function(e){n.appendChild(e)})},prepend:function(e){var t=e,n=this.spirit.element,r=n.firstChild;t.reverse().forEach(function(e){n.insertBefore(e,r)})},before:function(e){var t=e,n=this.spirit.element,r=n.parentNode;t.reverse().forEach(function(e){r.insertBefore(e,n)})},after:function(e){var t=e,n=this.spirit.element,r=n.parentNode;t.forEach(function(e){r.insertBefore(e,n.nextSibling)})},remove:function(){var e=this.spirit.element.parentNode;e.removeChild(this.spirit.element)},replace:function(e){this.after(e),this.remove()}},function(t,n){gui.DOMPlugin.addin(t,function(e){var r=Array.map(gui.Type.list(e),function(e){return e&&e instanceof gui.Spirit?e.element:e});if(r.every(function(e){return gui.Type.isNumber(e.nodeType)}))return n.call(this,r),e;throw new TypeError("Bad input for method: "+t+"("+e+")")})}),gui.EventPlugin=gui.Tracker.extend("gui.EventPlugin",{add:function(e,t,n,r){t=t?t:this.spirit.element,n=n?n:this.spirit,r=r?r:!1,t instanceof gui.Spirit&&(t=t.element);if(gui.Interface.validate(gui.IEventHandler,n)){var i=[t,n,r];this._breakdown(e).forEach(function(e){this._addchecks(e,i)&&t.addEventListener(e,n,r)},this)}return this},remove:function(e,t,n,r){t=t?t:this.spirit.element,n=n?n:this.spirit,r=r?r:!1,t instanceof gui.Spirit&&(t=t.element);if(gui.Interface.validate(gui.IEventHandler,n)){var i=[t,n,r];this._breakdown(e).forEach(function(e){this._removechecks(e,i)&&t.removeEventListener(e,n,r)},this)}return this},toggle:function(e,t,n,r){t=t?t:this.spirit.element,n=n?n:this.spirit,r=r?r:!1,t instanceof gui.Spirit&&(t=t.element);var i=[t,n,r];return this._breakdown(e).forEach(function(e){this._contains(e,i)?this.add(e,t,n,r):this.remove(e,t,n,r)},this),this}}),gui.IEventHandler={toString:function(){return"[object IEventHandler]"},handleEvent:function(e){}},gui.Tick=function(e){this.type=e},gui.Tick.prototype={type:null,toString:function(){return"[object gui.Tick]"}},gui.Tick.toString=function(){return"[function gui.Tick]"},gui.Tick._global={types:Object.create(null),handlers:Object.create(null)},gui.Tick._local=Object.create(null),gui.Tick.add=function(e,t,n){n||console.error("SIG REQUIRED for tick of type: "+e);if(gui.Arguments.validate(arguments,"string|array","object|function","string"))return this._add(e,t,!1,n)},gui.Tick.one=function(e,t,n){n||console.error("SIG REQUIRED for tick of type: "+e);if(gui.Arguments.validate(arguments,"string|array","object|function","string"))return this._add(e,t,!0,n)},gui.Tick.next=function(e,t){setImmediate(function(){e.call(t)})},gui.Tick.remove=function(e,t,n){return n||console.error("SIG REQUIRED for tick of type: "+e),this._remove(e,t,n)},gui.Tick.start=function(e,t){console.error("@todo gui.Tick.start")},gui.Tick.stop=function(e){console.error("@todo gui.Tick#stop")},gui.Tick.dispatch=function(e,t,n){return n||console.error("SIG REQUIRED for tick of type: "+e),this._dispatch(e,t,n)},gui.Tick.addGlobal=function(e,t){if(gui.Arguments.validate(arguments,"string|array","object|function"))return this._add(e,t,!1,null)},gui.Tick.oneGlobal=function(e,t){return this.add(e,t,!0,null)},gui.Tick.removeGlobal=function(e,t){return this._remove(e,t,null)},gui.Tick.dispatchGlobal=function(e,t){return this._dispatch(e,t,null)},gui.Tick._add=function(e,t,n,r){if(gui.Type.isArray(e))e.forEach(function(e){this._add(e,t,n,r)},this);else{var i,s,o=r?this._local[r]:this._global;o||(o=this._local[r]={types:Object.create(null),handlers:Object.create(null)}),i=o.handlers[e],i||(i=o.handlers[e]=[]),s=i.indexOf(t),s<0&&(s=i.push(t)-1),n&&(i._one=i._one||{},i._one[s]=!0)}return this},gui.Tick._remove=function(e,t,n){if(gui.Type.isArray(e))e.forEach(function(e){this.remove(e,t,n)},this);else{var r=n?this._local[n]:this._global,i=r.handlers[e];i&&(i.remove(i.indexOf(t)),i.length===0&&delete r.handlers[e])}return this},gui.Tick._dispatch=function(e,t,n){var r=n?this._local[n]:this._global,i=r.types,s=new gui.Tick(e);if(!gui.Type.isDefined(t)){var o=r.handlers[e];if(o){var u=0,a=[];while(u<o.length){try{o[u].ontick(s)}catch(f){if(f.message!==gui.Spirit.DENIAL)throw new Error(f.message)}o._one&&o._one[u]&&(delete o._one[u],a.push(u)),u++}a.forEach(function(e){o.remove(e)})}}else if(!i[e]){var l=this,c=null;t===0?c=setImmediate(function(){l._dispatch(e,undefined,n),delete i[e]}):c=setTimeout(function(){l._dispatch(e,undefined,n),delete i[e]},t),i[e]=c}return s},gui.TickPlugin=gui.Tracker.extend("gui.TickPlugin",{add:function(e,t,n){return t=t?t:this.spirit,gui.Interface.validate(gui.ITickHandler,t)&&this._breakdown(e).forEach(function(e){this._addchecks(e,[t,this._global])&&this._add(e,t,!1)},this),this},one:function(e,t){return this.add(e,t,!0)},next:function(e){gui.Tick.next(e,this.spirit)},remove:function(e,t){return t=t?t:this.spirit,gui.Interface.validate(gui.ITickHandler,t)&&this._breakdown(e).forEach(function(e){this._removechecks(e,[t,this._global])&&gui.Tick.remove(e,t)},this),this},dispatch:function(e,t){return this._dispatch(e,t||0)},_global:!1,_add:function(e,t,n){var r=this.spirit.signature;n?this._global?gui.Tick.oneGlobal(e,t):gui.Tick.one(e,t,r):this._global?gui.Tick.addGlobal(e,t):gui.Tick.add(e,t,r)},_remove:function(e,t){var n=this.spirit.signature;this._global?gui.Tick.removeGlobal(e,t):gui.Tick.remove(e,t,n)},_dispatch:function(e,t){var n,r=this.spirit.signature;return this._global?n=gui.Tick.dispatchGlobal(e,t):n=gui.Tick.dispatch(e,t,r),n},_cleanup:function(e,t){var n=t[0],r=t[1];this._remove(e,[n])&&(r?gui.Tick.removeGlobal(e,n):gui.Tick.remove(e,n,this.signature))}}),gui.ITickHandler={toString:function(){return"[object ITickHandler]"},ontick:function(e){}},gui.Tween=function(e,t){this.type=e,this.data=t},gui.Tween.prototype={type:null,data:null,value:0,done:!1},gui.Tween.dispatchGlobal=function(e,t){function u(){var e=(new Date).getTime(),t=1,n=e-r;if(n<s){t=n/s;if(o!=="none"){t=t*90*Math.PI/180;switch(o){case"ease-in":t=1-Math.cos(t);break;case"ease-out":t=Math.sin(t)}}}t===1?(i.value=1,i.done=!0):(i.value=t,requestAnimationFrame(u)),gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_TWEEN,i)}var n=this,r=(new Date).getTime(),i=new gui.Tween(e,t),s=t?t.duration||200:200,o=t?t.timing||"none":"none";return u(r),i},gui.TweenPlugin=gui.Tracker.extend("gui.TweenPlugin",{add:function(e){var t=this._global?null:this._sig,n=gui.BROADCAST_TWEEN;return this._breakdown(e).forEach(function(e){this._addchecks(e,[this._global])&&(this._global?gui.Broadcast.addGlobal(n,this):gui.Broadcast.add(n,this,t))},this),this},remove:function(e){var t=this._global?null:this._sig,n=gui.BROADCAST_TWEEN;return this._breakdown(e).forEach(function(e){this._removechecks(e,[this._global])},this),this},dispatch:function(e,t){var n=null,r=this._global?null:this._sig;return this._breakdown(e).forEach(function(e){this._global?n=gui.Tween.dispatchGlobal(e,t):n=gui.Tween.dispatch(e,t,r)},this),n},addGlobal:function(e){return this._globalize(function(){return this.add(e)})},removeGlobal:function(e){return this._globalize(function(){return this.remove(e)})},dispatchGlobal:function(e,t){return this._globalize(function(){return this.dispatch(e,t)})},onbroadcast:function(e){switch(e.type){case gui.BROADCAST_TWEEN:var t=e.data;this._containschecks(t.type,[e.isGlobal])&&this.spirit.ontween(t)}},_global:!1,_globalize:function(e){this._global=!0;var t=e.call(this);return this._global=!1,t},_cleanup:function(e,t){var n=gui.BROADCAST_TWEEN;if(this._removechecks(e,t)){var r=t[0],i=r?null:this._sig;r?gui.Broadcast.removeGlobal(n,this):gui.Broadcast.remove(n,this,this._sig)}}}),gui.TransitionPlugin=gui.Plugin.extend("gui.TransitionPlugin",{onevent:function(e){e.type===this._endevent&&e.target===this.spirit.element&&this._transitionend(e)},property:function(e){return e&&this.spirit.css.set("-beta-transition-property",e),this._init()},duration:function(e){return e&&(e=gui.Type.isNumber(e)?this._convert(e):e,this.spirit.css.set("-beta-transition-duration",e)),this._init()},timing:function(e){return e&&this.spirit.css.set("-beta-transition-timing-function",e),this._init()},easeIn:function(){return this.timing("ease-in")},easeOut:function(){return this.timing("ease-out")},easeInOut:function(){return this.timing("ease-in-out")},cubicBezier:function(e,t,n,r){return this.timing("cubic-bezier("+e+","+t+","+n+","+r+")")},none:function(){return this.property("none")},run:function(e){var t=Object.create(null);this._count=0,gui.Object.each(e,function(e,n){gui.Type.isFunction(this[e])?this[e](n):t[e]=n},this);var n=this.spirit.css.compute("-beta-transition-property")==="none",r=this._then=new gui.Then,i=this,s=this.spirit;return(this._count=Object.keys(t).length)&&setImmediate(function(){s.css.style(t),n&&r&&setImmediate(function(){r.now(null)})}),r},_default:1e3,_endevent:null,_count:0,_init:function(){if(this._endevent===null){var e={webkit:"webkitTransitionEnd",explorer:"MSTransitionEnd",gecko:"transitionend",opera:"oTransitionEnd"};this._endevent=e[gui.Client.agent]||"transitionend",this.spirit.event.add(this._endevent,this.spirit.element,this)}return this},_transitionend:function(e){var t=new gui.Transition(e.propertyName,e.elapsedTime);this._ontransition(t),this.spirit.ontransition(t)},_ontransition:function(e){--this._count===0&&this._now()},_now:function(){var e=this._then;e&&e.now(null)},_convert:function(e){return e=e?e:this._default,e/1e3+"s"}}),gui.Transition=function(e,t){this.duration=Math.round(t/1e3),this.type=e},gui.Transition.prototype={type:null,duration:0},gui.AttentionPlugin=gui.Plugin.extend("gui.AttentionPlugin",{trap:function(){return this._trapping||(this._trapping=!0,this._listen(),this._setup()),this},focus:function(){return this._focused||(this._latest?this._latest.focus():this._first()),this},blur:function(){return gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_OFF,this.spirit.spiritkey),this._focused&&this._latest&&this._latest.blur(),this},handleEvent:function(e){switch(e.type){case"blur":case"focusout":this._onblur(e.target);break;case"focus":case"focusin":this._onfocus(e.target)}},onbroadcast:function(e){e.type===gui.BROADCAST_ATTENTION_GO&&e.data===this.spirit.spiritkey&&this.focus()},onlife:function(e){switch(e.type){case gui.LIFE_DESTRUCT:gui.Broadcast.removeGlobal(gui.BROADCAST_ATTENTION_GO,this),gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_OFF,this.spirit.spiritkey)}},_trapping:null,_latest:null,_flag:!1,_setup:function(){["before","after"].forEach(function(e){var t=this._input(e),n=this.spirit.dom;e==="before"?n.prepend(t):n.append(t)},this)},_listen:function(){var e=this.spirit.element;e.addEventListener("focus",this,!0),e.addEventListener("blur",this,!0),this.spirit.life.add(gui.LIFE_DESTRUCT,this),gui.Broadcast.addGlobal(gui.BROADCAST_ATTENTION_GO,this)},_input:function(e){var t=this.spirit.dom,n=this.spirit.document,r=gui.CSSPlugin.style(n.createElement("input"),{position:"absolute",opacity:0,top:-5e3});return r.className="_gui-focus_"+e,r},_first:function(){return this._find(!0)},_last:function(){return this._find(!1)},_find:function(e){var t=null,n=this._elements();return n.length&&(t=n[e?0:n.length-1],t.focus()),t},_elements:function(){return this.spirit.dom.descendants().filter(function(e){return this._focusable(e)?e:undefined},this)},_focusable:function(e){var t=!1;switch(e.localName){case"input":case"textarea":case"select":case"button":case"a":e.tabIndex>-1&&e.type!=="image"&&(e.className.startsWith("_gui-focus")||(t=!0))}return t},_onfocus:function(e){this._focused=!0,this._latest=e,this._flag||(this._didcatch(),this._flat=!0);var t=e.className;t.startsWith("_gui-focus")&&(t.contains("after")?this._first():this._last())},_onblur:function(e){this._focused=!1,gui.Tick.next(function(){this._focused||this._didescape()},this)},_didcatch:function(){gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_ON,this.spirit.spiritkey)},_didescape:function(){this._flag=!1,gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_OFF,this.spirit.spiritkey)}},{_queue:[],_next:function(){var e=this._queue;return e[e.length-1]},onbroadcast:function(e){var t=this._queue;switch(e.type){case gui.BROADCAST_ATTENTION_ON:this._next()!==e.data&&t.push(e.data);break;case gui.BROADCAST_ATTENTION_OFF:t=this._queue=t.filter(function(t){if(t!==e.data)return t}),t.length&&gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_GO,this._next())}}}),function(){gui.Broadcast.addGlobal([gui.BROADCAST_ATTENTION_ON,gui.BROADCAST_ATTENTION_OFF],gui.AttentionPlugin)}(),gui.module("core",{addins:{onaction:function(e){},onbroadcast:function(e){},ontick:function(e){},ontween:function(e){},ontransition:function(e){},onevent:function(e){},handleEvent:function(e){this.onevent(e)}},plugins:{action:gui.ActionPlugin,att:gui.AttPlugin,box:gui.BoxPlugin,broadcast:gui.BroadcastPlugin,css:gui.CSSPlugin,dom:gui.DOMPlugin,event:gui.EventPlugin,tick:gui.TickPlugin,tween:gui.TweenPlugin,transition:gui.TransitionPlugin,attention:gui.AttentionPlugin},channels:[["html","gui.DocumentSpirit"],[".gui-styles","gui.StyleSheetSpirit"],[".gui-iframe","gui.IframeSpirit"],[".gui-window","gui.WindowSpirit"],[".gui-action","gui.ActionSpirit"],[".gui-cover","gui.CoverSpirit"],[".gui-spirit","gui.Spirit"]]}),gui.Client=new function(){function r(){var e=window,t=document,n=t.documentElement,r=t.body,i=null,s=r.appendChild(gui.CSSPlugin.style(t.createElement("div"),{position:"absolute",height:"10px",width:"10px",top:"100%"}));e.scrollBy(0,10),i=r.scrollTop?r:n,this.scrollRoot=i,gui.CSSPlugin.style(s,{position:"fixed",top:"10px"});var o=s.getBoundingClientRect().top===10;this.hasPositionFixed=o,r.removeChild(s),e.scrollBy(0,-10);var u=gui.CSSPlugin.style(document.createElement("p"),{width:"100%",height:"200px"}),a=gui.CSSPlugin.style(document.createElement("div"),{position:"absolute",top:"0",left:"0",visibility:"hidden",width:"200px",height:"150px",overflow:"hidden"});a.appendChild(u),n.appendChild(a);var f=u.offsetWidth;a.style.overflow="scroll";var l=u.offsetWidth;f===l&&(l=a.clientWidth),n.removeChild(a),this.scrollBarSize=f-l}var t=navigator.userAgent.toLowerCase(),n=document.documentElement;this.isExplorer=t.contains("msie"),this.isOpera=t.contains("opera"),this.isWebKit=t.contains("webkit"),this.isChrome=this.isWebKit&&t.contains("chrome"),this.isSafari=this.isWebKit&&!this.isChrome&&t.contains("safari"),this.isGecko=!this.isWebKit&&!this.isOpera&&t.contains("gecko"),this.agent=function(){var e="explorer";return this.isWebKit?e="webkit":this.isGecko?e="gecko":this.isOpera&&(e="opera"),e}.call(this),this.system=function(){var e=null;return["window mobile","windows","ipad","iphone","haiku","os x","linux"].every(function(n){return t.contains(n)&&(n.match(/ipad|iphone/)?e="ios":e=n.replace(/ /g,"")),e===null}),e}(),this.hasTouch=window.ontouchstart!==undefined||this.isChrome,this.hasBlob=window.Blob&&(window.URL||window.webkitURL),this.isMobile=function(){var e=["android","webos","iphone","ipad","ipod","blackberry","windows phone"];return!e.every(function(e){return!t.contains(e)})}(),this.hasTransitions=function(){return!["transition","WebkitTransition","MozTransition","OTransition","msTransition"].every(function(e){return n.style[e]===undefined})}(),this.has3D=function(){return!["perspective","WebkitPerspective","MozPerspective","OPerspective","msPerspective"].every(function(e){return n.style[e]===undefined})}(),this.hasAnimationFrame=function(){var e=window;return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.msRequestAnimationFrame||e.oRequestAnimationFrame?!0:!1}(),this.hasMutations=function(){return!["","WebKit","Moz","O","Ms"].every(function(e){return!gui.Type.isDefined(window[e+"MutationObserver"])})}(),this.STABLETIME=200,this.scrollRoot=null,this.scrollBarSize=0,this.hasPositionFixed=!1,this.onbroadcast=function(e){var t=gui.BROADCAST_WILL_SPIRITUALIZE;e.type===t&&e.target===gui&&(gui.Broadcast.removeGlobal(t,this),r.call(this))}},function(){gui.Broadcast.addGlobal(gui.BROADCAST_WILL_SPIRITUALIZE,gui.Client)}(),gui.DocumentSpirit=gui.Spirit.infuse("gui.DocumentSpirit",{onconstruct:function(){this._super.onconstruct(),this._dimension=new gui.Dimension(0,0),Object.keys(this._messages).forEach(function(e){var t=this.document;switch(e){case"scroll":case"resize":t=this.window}this.event.add(e,t)},this),this.document===document&&this._constructTop(),this.action.addGlobal(gui.ACTION_DOCUMENT_FIT),gui.Type.isDefined(this.touch)&&this.touch.add(gui.SpiritTouch.FINGER_START),this.action.dispatchGlobal(gui.ACTION_DOCUMENT_CONSTRUCT)},onready:function(){this._super.onready(),this.action.dispatchGlobal(gui.ACTION_DOCUMENT_READY),this.document.readyState==="complete"&&!this._isLoaded&&this.onload()},onevent:function(e){this._super.onevent(e);switch(e.type){case"orientationchange":this._onorientationchange();break;default:var t=this._messages[e.type];if(gui.Type.isDefined(t)){switch(e.type){case"resize":var n=this.window===window;n&&this._onresize();break;case"load":this._isLoaded||this._onload()}this._broadcast(t,e)}}},onaction:function(e){this._super.onaction(e);switch(e.type){case gui.ACTION_DOCUMENT_FIT:e.consume(),this.fit(e.data===!0)}},onvisible:function(){this.css.remove(gui.CLASS_INVISIBLE),this._super.onvisible()},oninvisible:function(){this.css.add(gui.CLASS_INVISIBLE),this._super.onvisible()},onload:function(){if(!this._isLoaded){this._isLoaded=!0,this.action.dispatchGlobal(gui.ACTION_DOCUMENT_ONLOAD);var e=this;setTimeout(function(){e.fit(),e.tick.add(gui.TICK_FIT),e.action.dispatchGlobal(gui.ACTION_DOCUMENT_DONE)},gui.Client.STABLETIME)}else console.warn("@todo loaded twice...")},onunload:function(){this.action.dispatchGlobal(gui.ACTION_DOCUMENT_UNLOAD)},ontick:function(e){this._super.ontick(e);switch(e.type){case gui.TICK_FIT:console.log("Fit "+this.document.title+" : "+Math.random()),this.fit(!0)}},fit:function(e){if(this._isLoaded||e){var t=this._getDimension();gui.Dimension.isEqual(this._dimension,t)||(this._dimension=t,this._dispatchFit())}},_isLoaded:!1,_broadcast:function(e,t){switch(t.type){case"mousemove":case"touchmove":try{gui.broadcast(e,t)}catch(n){throw this.event.remove(t.type,t.target),n}break;default:gui.broadcast(e,t)}},_messages:{click:gui.BROADCAST_MOUSECLICK,mousedown:gui.BROADCAST_MOUSEDOWN,mouseup:gui.BROADCAST_MOUSEUP,scroll:gui.BROADCAST_SCROLL,resize:gui.BROADCAST_RESIZE,touchstart:gui.BROADCAST_TOUCHSTART,touchend:gui.BROADCAST_TOUCHEND,touchcancel:gui.BROADCAST_TOUCHCANCEL,touchleave:gui.BROADCAST_TOUCHLEAVE,touchmove:gui.BROADCAST_TOUCHMOVE},_dimension:null,_timeout:null,_dispatchFit:function(){var e=this._dimension;this.action.dispatchGlobal(gui.ACTION_DOCUMENT_FIT,{width:e.w,height:e.h});var t=this.window;gui.Client.isWebKit&&(t.scrollBy(0,1),t.scrollBy(0,-1))},_getDimension:function(){var e=this.document.body.getBoundingClientRect();return new gui.Dimension(e.width,e.height)},_constructTop:function(){this._onorientationchange(),this.event.add("orientationchange",window)},_onresize:function(){this.window.clearTimeout(this._timeout),this._timeout=this.window.setTimeout(function(){gui.broadcast(gui.BROADCAST_RESIZE_END)},gui.DocumentSpirit.TIMEOUT_RESIZE_END)},_onorientationchange:function(){gui.orientation=window.innerWidth>window.innerHeight?1:0,gui.broadcast(gui.BROADCAST_ORIENTATIONCHANGE)}},{},{TIMEOUT_RESIZE_END:50}),gui.WindowSpirit=gui.Spirit.infuse("gui.WindowSpirit",{cover:"fit",fit:!0,style:!0,onenter:function(){this._super.onenter(),this._cover=this.dom.prepend(gui.CoverSpirit.summon(this.document)),this._frame=this.dom.prepend(gui.IframeSpirit.summon(this.document,this._src)),this.action.addGlobal([gui.ACTION_DOCUMENT_DONE,gui.ACTION_DOCUMENT_FIT]),this.style&&this._style()},src:function(e){var t=null;return this.life.entered?(gui.Type.isString(e)&&this._loading(),t=this._frame.src(e)):t=this._src=e,t},onaction:function(e){this._super.onaction(e);switch(e.type){case gui.ACTION_DOCUMENT_DONE:this._loaded(),e.consume();break;case gui.ACTION_DOCUMENT_FIT:if(this.fit){this.css.height=e.data.height,this.action.dispatchGlobal(e.type,e.data.height),this._height=e.data.height;var t="TICK-TEMP";this.tick.one(t).dispatch(t,0)}e.consume()}},ontick:function(e){this._super.ontick(e),e.type==="TICK-TEMP"&&(this.css.height=this._height)},_frame:null,_src:null,_cover:null,_height:0,_loading:function(){this.life.entered&&this.cover&&this._cover.dom.show(),this.action.dispatch(gui.ACTION_WINDOW_LOADING)},_loaded:function(){this.life.entered&&this.cover&&this._cover.dom.hide(),this.action.dispatch(gui.ACTION_WINDOW_LOADED)},_style:function(){this.css.compute("position")==="static"&&(this.css.position="relative"),this.fit&&(this.css.height=0),[this._frame,this._cover].forEach(function(e){e.css.style({position:"absolute",width:"100%",height:"100%"})})}},{summon:function(e,t){var n=e.createElement("div"),r=this.possess(n);return t&&r.src(t),r}}),gui.IframeSpirit=gui.Spirit.infuse("gui.IframeSpirit",{signature:null,onconstruct:function(){this._super.onconstruct(),this.signature===null&&(this.signature=gui.IframeSpirit.generateSignature())},src:function(e){return gui.Type.isString(e)&&(gui.IframeSpirit.isExternal(e)&&(e=gui.IframeSpirit.sign(e,this.signature)),this.element.src=e),this.element.src}},{summon:function(e,t){var n=gui.IframeSpirit.generateSignature(),r=e.createElement("iframe");gui.Type.isString(t)?(this.isExternal(t)||(t=this.sign(t,n)),r.src=t):r.src=gui.IframeSpirit.SRC_DEFAULT;var i=this.possess(r);return i.signature=n,i}},{SRC_DEFAULT:"javascript:void(false);",KEY_SIGNATURE:"spiritual-signature",generateSignature:function(){return gui.KeyMaster.generateKey().replace("key","sig")},sign:function(e,t){return this.setParam(e,this.KEY_SIGNATURE,t||this.generateSignature())},unsign:function(e){return this.setParam(e,this.KEY_SIGNATURE,null)},getParam:function(e,t){t=t.replace(/(\[|\])/g,"\\$1");var n=(new RegExp("[\\?&]"+t+"=([^&#]*)")).exec(e);return n===null?null:n[1]},setParam:function(e,t,n){var r=[],i,s=-1;return t=encodeURIComponent(t),n!==null&&(n=encodeURIComponent(n)),e.indexOf("?")>-1&&(i=e.split("?"),e=i[0],r=i[1].split("&"),r.every(function(e,i){var o=e.split("=");return o[0]===t&&(s=i,n!==null&&(o[1]=n,r[i]=o.join("="))),s<0})),n===null?s>-1&&r.remove(s,s):s<0&&(r[r.length]=[t,n].join("=")),e+(r.length>0?"?"+r.join("&"):"")},isExternal:function(e){var t=document.createElement("a");return t.href=e,t.host!==location.host}}),gui.StyleSheetSpirit=gui.Spirit.infuse("gui.StyleSheetSpirit",{_ATSTATEMENTS:/\@.+\n/g,_channels:null,onconstruct:function(){this._super.onconstruct(),this._channels=[];if(!this.element.disabled){var e=this.element.href;e!==undefined?this._parseExternal(e):(this._parse(this.element.textContent),this.channel())}},_parseExternal:function(e){this._done(!1),(new gui.Request(e)).get(function(e,t){e===200&&this._parse(t),this._done(!0)},this)},_done:function(e){this.broadcast.dispatchGlobal(e?gui.BROADCAST_CHANNELS_LOADED:gui.BROADCAST_LOADING_CHANNELS)},_parse:function(e){var t=[],n="-ui-spirit";if(e.indexOf(n)>-1){var r=[],i=e.split("*/");i.forEach(function(e){r.push(e.split("/*")[0])}),r=r.join("").replace(this._ATSTATEMENTS,""),r.split("}").forEach(function(e){var r=e.split("{"),i=r[0],s=r[1];s&&s.split(";").forEach(function(e){var r=e.split(":"),s=r[0];if(s.trim()===n){var o=r[1].trim();o.split(" ").reverse().forEach(function(e){t.push([i.trim(),e.trim()])})}})}),this._channels=t.reverse()}},channel:function(){this._channels.forEach(function(e){this.window.gui.channel(e[0],e[1])},this)}},{summon:function(e,t){var n=e.createElement("link");return n.className="gui-styles",n.rel="stylesheet",n.href=t?t:"",this.possess(n)}}),gui.ActionSpirit=gui.Spirit.infuse("gui.ActionSpirit",{onenter:function(){this._super.onenter(),this.event.add("click")},onevent:function(e){this._super.onevent(e);switch(e.type){case"click":var t=this.att.get("onaction");if(gui.Type.isString(t)){var n=this.window.Function;(new n(t)).call(this)}}}}),gui.CoverSpirit=gui.Spirit.infuse("gui.CoverSpirit",{show:function(){return this.dom.show(),this},hide:function(){return this.dom.hide(),this},fadeIn:function(e){gui.Client.hasTransitions?(this.transition.none(),this.css.opacity=0,this.show(),this.transition.run({duration:e||250,property:"opacity",opacity:1})):this.show()},fadeOut:function(e){gui.Client.hasTransitions?(this.transition.none(),this.css.opacity=1,this.show(),this.transition.run({duration:e||250,property:"opacity",opacity:0}).then(function(){this.hide()},this)):this.hide()}},{summon:function(e){var t=this.possess(e.createElement("div"));return t.css.add("gui-cover"),t}}),gui.module("jquery",{init:function(e){e===top&&this._spiritualdom()},ready:function(e){var t=e.document.documentElement;if(e.gui.mode===gui.MODE_JQUERY){var n=e.jQuery;n.__rootnode=t,this._instance(n),this._expandos(n),this._overload(n)}},_expandos:function(e){var t=gui.Guide;e.__suspend=!1,["spiritualize","spiritualizeSub","spiritualizeOne","materialize","materializeSub","materializeOne"].forEach(function(t){e.fn["__"+t]=function(){return this.each(function(e,n){gui.Guide[t](n)})}})},_instance:function(e){var t=e.fn.init,n=e.__rootnode.ownerDocument.defaultView;n.gui.debug&&(e.fn.init=function(e,r,i){var s=new t(e,r,i),o=s[0];if(o&&o.nodeType===Node.ELEMENT_NODE&&o.ownerDocument!==n.document)throw new Error("JQuery was used to handle elements in another window. Please use a locally loaded version of JQuery.");return s})},_overload:function(e){var t=this,n=Object.create(null);["after","append","appendTo","before","detach","empty","html","text","insertAfter","insertBefore","prepend","prependTo","remove","replaceAll","replaceWith","unwrap","wrap","wrapAll","wrapInner"].forEach(function(r){n[r]=e.fn[r],e.fn[r]=function(){function a(){return gui.Observer.suspend(e.__rootnode,function(){return n[r].apply(s,o)},s)}var i,s=this,o=arguments,u=arguments.length>0;if(e.__suspend)i=a();else if(r==="text")u&&this.__materializeSub(),i=a();else{var f=function(){return u?e(o[0]):undefined},l=gui.Guide;e.__suspend=!0;switch(r){case"append":case"prepend":i=t._append_prepend.call(this,r==="append",a,e);break;case"after":case"before":i=t._after_before.call(this,r==="after",a,e);break;case"appendTo":i=a(),f().each(function(t,n){e(n).last().__spiritualize()});break;case"prependTo":i=a(),f().each(function(t,n){e(n).first().__spiritualize()});break;case"insertAfter":i=a(),f().next().__spiritualize();break;case"insertBefore":i=a(),f().prev().__spiritualize();break;case"detach":case"remove":this.__materialize(),i=a();break;case"replaceAll":i=t._replaceall_replacewith(this,f(),a);break;case"replaceWith":i=t._replaceall_replacewith(f(),this,a);break;case"empty":this.__materializeSub(),i=a();break;case"html":u&&this.__materializeSub(),i=a(),u&&this.__spiritualizeSub();break;case"unwrap":this.parent().__materializeOne(),i=a();break;case"wrap":case"wrapAll":i=a(),this.parent().__spiritualizeOne();break;case"wrapInner":i=a(),this.__spiritualize()}e.__suspend=!1}return i}})},_spiritualdom:function(){function t(e){var t=e.element,n=t.ownerDocument,r=n.defaultView,i=e.dom.embedded(),s=r.gui.mode===gui.MODE_JQUERY;return{elm:t,doc:n,win:r,dom:i,is$:s}}var e=gui.DOMPlugin.prototype;["html","empty","text"].forEach(function(n){var r=e[n];e[n]=function(e){var i,s=t(this.spirit);return s.is$?(s.dom&&gui.Guide.materializeSub(s.elm),i=gui.Observer.suspend(s.elm,function(){return r.call(this,e)},this),s.dom&&n==="html"&&gui.Guide.spiritualizeSub(s.elm)):i=r.call(this,e),i}}),["remove"].forEach(function(n){var r=e[n];e[n]=function(e){var n,i=t(this.spirit);return i.is$?(i.dom&&gui.Guide.materialize(i.elm),n=gui.Observer.suspend(i.elm,function(){return r.call(this,e)},this)):n=r.call(this,e),n}}),["append","prepend","before","after"].forEach(function(n){var r=e[n];e[n]=function(e){var n,i=t(this.spirit);if(i.is$){n=gui.Observer.suspend(i.elm,function(){return r.call(this,e)},this);if(i.dom){var s=Array.map(gui.Type.list(e),function(e){return e&&e instanceof gui.Spirit?e.element:e});s.forEach(function(e){gui.Guide.spiritualize(e)})}}else n=r.call(this,e);return n}})},_append_prepend:function(e,t){var n="lastElementChild",r="firstElementChild",i="nextElementSibling",s="previousElementSibling",o=Array.map(this,function(t){return t[e?n:r]}),u,a=t();return this.each(function(t,n){(u=o[t])?n=u[e?i:s]:n=n.firstElementChild;while(n)gui.Guide.spiritualize(n),n=n[e?i:s]}),a},_after_before:function(e,t,n){var r="nextElementSibling",i="previousElementSibling",s=[];this.each(function(t,n){while(n&&s.indexOf(n)===-1)s.push(n),n=n[e?r:i]});var o=t(),u,a;return this.each(function(t,n){u=n[e?r:i];while(u&&s.indexOf(u)===-1)gui.Guide.spiritualize(u),u=u[e?r:i]}),o},_replaceall_replacewith:function(e,t,n){var r,i=[],s=[];t.each(function(e,t){gui.Guide.materialize(t),r=t.parentNode,i.indexOf(r)===-1&&(i.push(r),s=s.concat(Array.map(r.children,function(e){return e})))});var o=n();return i.forEach(function(e){e&&Array.forEach(e.children,function(e){s.indexOf(e)===-1&&gui.Guide.spiritualize(e)})}),o}}),gui.DOMChanger={jquery:!1,innerhtml:{global:!1,local:!1,missing:!1},change:function(e){var t=e.Element.prototype;if(gui.Type.isDefined(t.spirit))throw new Error("Spiritual loaded twice?");t.spirit=null;switch(e.gui.mode){case gui.MODE_MANAGED:case gui.MODE_NATIVE:case gui.MODE_OPTIMIZE:this.upgrade(e,gui.DOMCombos.getem());break;case gui.MODE_JQUERY:this._jquery(e)}},upgrade:function(e,t){this._change(e,t)},_jquery:function(e){var t=!1;if(!(t=gui.Type.isDefined(e.jQuery)))throw new Error("Spiritual runs in JQuery mode: Expected JQuery to be loaded first");if(!(t=e.gui.hasModule("jquery")))throw new Error('Spiritual runs in JQuery mode: Expected the "jquery" module');return t},_change:function(t,n){var r=[],i=t.document;this._canchange(t.Element.prototype,t,n)||(!t.HTMLElement||!this._canchange(t.HTMLElement.prototype,t))&&this._tags().forEach(function(e){var s=i.createElement(e),o=s.constructor.prototype;o!==t.Object.prototype&&r.indexOf(o)===-1&&(this._dochange(o,t,n),r.push(o))},this)},_tags:function(){return"a abbr address area article aside audio b base bdi bdo blockquote body br button canvas caption cite code col colgroup command datalist dd del details device dfn div dl dt em fieldset figcaption figure footer form h1 h2 h3 h4 h5 h6 head header hgroup hr html i iframe img input ins kbd keygen label legend li link map menu meta meter nav noscript ol optgroup option output p param pre progress q rp rt ruby s samp script section select small source span strong style submark summary sup table tbody td textarea tfoot th thead time title tr track ul unknown var video wbr".split(" ")},_canchange:function(t,n,r){var i=!1,s="it appears to work",o=t.hasChildNodes;t.hasChildNodes=function(){return s};var u=n.document.documentElement;return u.hasChildNodes()===s&&(t.hasChildNodes=o,this._dochange(t,n,r),i=!0),i},_dochange:function(t,n,r){switch(gui.Client.agent){case"explorer":this.innerhtml.global=!0;break;case"gecko":case"opera":this.innerhtml.global=!0;break;case"webkit":gui.DOMPatcher.canpatch(n)?(this.innerhtml.local=!0,gui.DOMPatcher.patch(n.document)):(this.innerhtml.local=!1,this.innerhtml.missing=!0)}var i=n.document.title;switch(n.gui.mode){case gui.MODE_NATIVE:if(this.innerhtml.missing)throw new Error("Spiritual native mode is not supported on this device.");break;case gui.MODE_OPTIMIZE:this.innerhtml.missing?(n.gui.mode=gui.MODE_JQUERY,this._jquery(n)&&n.gui.debug&&console.debug(i+": Spiritual runs in JQuery mode. To keep spirits "+"in synch, use JQuery or Spiritual to perform DOM updates.")):(n.gui.mode=gui.MODE_NATIVE,n.gui.debug&&console.debug(i+": Spiritual runs in native mode"))}if(n.gui.mode===gui.MODE_NATIVE){var s=n.document.documentElement;gui.Object.each(r,function(e,n){this._docombo(t,e,n,s)},this)}},_docombo:function(e,t,n,r){if(this._ismethod(t))this._domethod(e,t,n);else switch(gui.Client.agent){case"opera":case"gecko":this._doboth(e,t,n,r);break;case"explorer":this._doie(e,t,n,r);break;case"webkit":}},_ismethod:function(e){var t=!1;switch(e){case"appendChild":case"removeChild":case"insertBefore":case"replaceChild":case"setAttribute":case"removeAttribute":t=!0}return t},_domethod:function(e,t,n){var r=e[t];e[t]=n(function(){return r.apply(this,arguments)})},_doie:function(e,t,n,r){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(e,t,{get:function(){return i.get.call(this)},set:n(function(){return i.apply(this,arguments)})})},_doboth:function(e,t,n,r){var i=r.__lookupSetter__(t);e.__defineSetter__(t,n(function(){return i.apply(this,arguments)}))}},gui.DOMCombos={getem:function(){return this._creation||(this._creation=this._create())},_creation:null,_create:function(){var e=gui.Combinator,t=gui.Guide,n=e.provided(function(){return gui.DOMPlugin.embedded(this)}),r=e.provided(function(){return!gui.Type.isNull(this.spirit)}),i=e.after(function(e){t.spiritualize(e)}),s=e.before(function(e){t.materialize(e)}),o=e.after(function(e,n){t.spiritualize(e)}),u=e.before(function(e,n){t.materialize(n)}),a=e.after(function(e,t){this.spirit.att.__suspend__(function(){this.set(e,t)})}),f=e.after(function(e){this.spirit.att.__suspend__(function(){this.del(e)})}),l=e.around(function(e){return gui.Observer.suspend(this,function(){return e.apply(this,arguments)},this)}),c=e.before(function(){t.materializeSub(this)}),h=e.after(function(){t.spiritualizeSub(this)}),p=null,d=e.before(function(){p=this.parentNode,t.materialize(this)}),v=e.after(function(){t.spiritualize(p)}),m=e.after(function(e){gui.Client.isWebKit&&gui.DOMPatcher.patch(e)}),g=e.provided(function(){return this.ownerDocument.defaultView.gui.mode!==gui.MODE_MANAGED}),y=function(e){return e};return{appendChild:function(e){return g(n(i(m(l(e))),y(e)),y(e))},removeChild:function(e){return g(n(s(l(e)),y(e)),y(e))},insertBefore:function(e){return g(n(i(m(l(e))),y(e)),y(e))},replaceChild:function(e){return g(n(u(o(m(l(e)))),y(e)),y(e))},setAttribute:function(e){return g(n(r(a(e),y(e)),y(e)),y(e))},removeAttribute:function(e){return g(n(r(f(e),y(e)),y(e)),y(e))},innerHTML:function(e){return g(n(c(h(l(e))),y(e)),y(e))},outerHTML:function(e){return g(n(d(v(l(e))),y(e)),y(e))},textContent:function(e){return g(n(c(l(e)),y(e)),y(e))}}}},gui.DOMPatcher={canpatch:function(e){var t=e.document.documentElement;try{return Object.defineProperty(t,"innerHTML",this._innerHTML),!0}catch(n){return!1}},patch:function(e){if(!gui.DOMChanger.innerhtml.local)throw new Error("Somehow JQuery mode should have handled this :(");(new gui.Crawler("crawler-webkit-patch")).descend(e,this)},handleElement:function(e){["innerHTML","outerHTML","textContent"].forEach(function(t){Object.defineProperty(e,t,this["_"+t])},this)},_innerHTML:{get:function(){return(new gui.DOMSerializer).subserialize(this)},set:function(e){gui.DOMPlugin.html(this,e)}},_outerHTML:{get:function(){return(new gui.DOMSerializer).serialize(this)},set:function(e){gui.DOMPlugin.outerHtml(this,e)}},_textContent:{get:function(){var e=this,t="";for(e=e.firstChild;e;e=e.nextSibling)switch(e.nodeType){case Node.TEXT_NODE:t+=e.data;break;case Node.ELEMENT_NODE:t+=e.textContent}return t},set:function(e){gui.DOMPlugin.html(this,e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot"))}}},gui.Observer={observes:!1,fails:!1,observe:function(e){var t=e.gui.signature,n=e.document,r=this._observers[t];if(this.observes&&e.gui.debug){if(!gui.Type.isDefined(r)){var i=this._mutationobserver();r=this._observers[t]=new i(function(e){e.forEach(function(e){gui.Observer._handleMutation(e)})})}this._connect(n,!0)}},suspend:function(e,t,n){var r;if(!e.nodeType)throw new TypeError;return this.observes&&++this._suspend===1&&this._connect(e,!1),gui.Type.isFunction(t)&&(r=t.call(n)),this.observes&&this.resume(e),r},resume:function(e){if(!e.nodeType)throw new TypeError;this.observes&&--this._suspend===0&&this._connect(e,!0)},_suspend:0,_observers:Object.create(null),_mutationobserver:function(){return window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver},_connect:function(e,t){var n=e.ownerDocument||e,r=n.defaultView,i=r.gui.signature,s=this._observers[i];s&&(t?s.observe(n,{childList:!0,subtree:!0}):s.disconnect())},_handleMutation:function(e){var t=!1;Array.forEach(e.removedNodes,function(e){e.nodeType===Node.ELEMENT_NODE&&(console.warn("Bad remove:",e),t=!0)}),Array.forEach(e.addedNodes,function(e){e.nodeType===Node.ELEMENT_NODE&&(console.warn("Bad append:",e),t=!0)}),t&&e.target.ownerDocument.defaultView.gui.debug&&console[this.fails?"error":"warn"]("Action required: DOM mutation not intercepted, Spiritual may be out of synch.")}},gui.Guide={toString:function(){return"[object gui.Guide]"},observe:function(e){e.document.addEventListener("DOMContentLoaded",this,!1),e.addEventListener("load",this,!1),e.addEventListener("unload",this,!1)},handleEvent:function(e){var t=new gui.EventSummary(e);switch(e.type){case"DOMContentLoaded":this._ondom(t);break;case"load":this._onload(t);break;case"unload":this._unload(t)}e.currentTarget.removeEventListener(e.type,this,!1),e.stopPropagation()},onbroadcast:function(e){var t=e.data,n=null,r=this._windows[t];switch(e.type){case gui.BROADCAST_KICKSTART:gui.Broadcast.removeGlobal(e.type,this),this._step1(document);break;case gui.BROADCAST_LOADING_CHANNELS:r||(r=this._windows[t]=[],r.__loading__=0),r.push(e.target),r.__loading__++;break;case gui.BROADCAST_CHANNELS_LOADED:if(--r.__loading__===0){while(n=r.shift())n.channel();this._step2(e.target.document)}}},spiritualize:function(e){this._spiritualize(e,!1,!1)},spiritualizeSub:function(e){this._spiritualize(e,!0,!1)},spiritualizeOne:function(e){this._spiritualize(e,!1,!0)},materialize:function(e){this._materialize(e,!1,!1)},materializeSub:function(e){this._materialize(e,!0,!1)},materializeOne:function(e){this._materialize(e,!1,!0)},possess:function(e,t){var n=new t;n.element=e,n.document=e.ownerDocument,n.window=n.document.defaultView,n.spiritkey=gui.KeyMaster.generateKey(),n.signature=n.window.gui.signature,e.spirit=n;if(!!n.life&&!n.life.constructed)throw"Constructed twice: "+n.toString();return n.onconstruct(),n},exorcise:function(e){this._collect(e,!1,gui.CRAWLER_DISPOSE).forEach(function(e){e.life.destructed||e.ondestruct(!0)},this)},suspend:function(e,t){this._suspended=!0;var n=e.call(t);return this._suspended=!1,n},_windows:Object.create(null),_suspended:!1,_handles:function(e){return!this._suspended&&gui.Type.isDefined(e)&&gui.DOMPlugin.embedded(e)&&e.nodeType===Node.ELEMENT_NODE},_ondom:function(e){gui.broadcast(gui.BROADCAST_DOMCONTENT,e),this._step1(e.document)},_onload:function(e){e.documentspirit&&e.documentspirit.onload(),gui.broadcast(gui.BROADCAST_ONLOAD,e)},_unload:function(e){e.documentspirit&&e.documentspirit.onunload(),gui.broadcast(gui.BROADCAST_UNLOAD,e),this.exorcise(e.document),e.window.gui.nameDestructAlreadyUsed()},_step1:function(e){var t=e.defaultView,n=t.gui.signature;this._metatags(t),t.gui.go(),this._stylesheets(t),this._windows[n]||this._step2(e)},_step2:function(e){var t=e.defaultView,n=t.gui.signature;this.spiritualizeOne(e.documentElement),t.gui.mode!==gui.MODE_MANAGED&&(gui.broadcast(gui.BROADCAST_WILL_SPIRITUALIZE,n),this.spiritualizeSub(e.documentElement),gui.broadcast(gui.BROADCAST_DID_SPIRITUALIZE,n))},_metatags:function(e){var t=e.document,n=e.gui.namespaces(),r=t.querySelectorAll("meta[name]");Array.forEach(r,function(t){var r=t.getAttribute("name");n.forEach(function(n){if(r.startsWith(n+".")){var i=gui.Type.cast(t.getAttribute("content"));gui.Object.assert(r,i,e)}})})},_stylesheets:function(e){var t=e.document,n=".gui-styles",r=t.querySelectorAll(n);Array.forEach(r,function(e){this.spiritualizeOne(e)},this)},_collect:function(e,t,n){var r=[];return e.nodeType===Node.ELEMENT_NODE&&(new gui.Crawler(n)).descend(e,{handleSpirit:function(n){if(!t||n.element!==e)n.life.destructed||r.push(n)}}),r},_spiritualize:function(e,t,n){e=e.nodeType===Node.DOCUMENT_NODE?e.documentElement:e;if(this._handles(e)){var r=[],i=[];(new gui.Crawler(gui.CRAWLER_ATTACH)).descend(e,{handleElement:function(i){if(!t||i!==e){var s=i.spirit;s||(s=gui.Guide._evaluate(i)),s!==null&&(s.life.attached||r.push(s))}return n?gui.Crawler.STOP:gui.Crawler.CONTINUE}}),r.forEach(function(e){e.life.configured||e.onconfigure(),this._invisible(e)?e.life.visible&&e.oninvisible():e.life.invisible&&e.onvisible(),e.life.entered||e.onenter(),e.onattach(),e.life.ready||i.push(e)},this),i.reverse().forEach(function(e){e.onready()},this)}},_materialize:function(e,t,n){e=e.nodeType===Node.DOCUMENT_NODE?e.documentElement:e,this._handles(e)&&this._collect(e,t,gui.CRAWLER_DETACH).forEach(function(e){e.life.attached&&!e.life.destructed&&e.ondetach()},this)},_evaluate:function(e){if(!e.spirit){var t=e.ownerDocument,n=t.defaultView,r=n.gui.evaluate(e);r&&this.possess(e,r)}return e.spirit},_invisible:function(e){return e.css.contains(gui.CLASS_INVISIBLE)||e.css.matches("."+gui.CLASS_INVISIBLE+" *")}},function(){gui.Guide.observe(window),gui.Broadcast.addGlobal([gui.BROADCAST_LOADING_CHANNELS,gui.BROADCAST_CHANNELS_LOADED,gui.BROADCAST_KICKSTART],gui.Guide)}();