/*
 * Spiritual GUI 0.0.5
 * (c) 2013 Wunderbyte
 * Spiritual is freely distributable under the MIT license.
 */
window.gui={version:"0.0.5",MODE_NATIVE:"native",MODE_JQUERY:"jquery",MODE_OPTIMIZE:"optimize",MODE_MANAGED:"managed",PARAM_CONTEXTID:"gui-contextid",PARAM_XHOST:"gui-xhost",BROADCAST_KICKSTART:"gui-broadcast-kickstart",BROADCAST_WILL_SPIRITUALIZE:"gui-broadcast-will-spiritualize",BROADCAST_DID_SPIRITUALIZE:"gui-broadcast-did-spiritualize",BROADCAST_MOUSECLICK:"gui-broadcast-mouseevent-click",BROADCAST_MOUSEMOVE:"gui-broadcast-mouseevent-mousemove",BROADCAST_MOUSEDOWN:"gui-broadcast-mouseevent-mousedown",BROADCAST_MOUSEUP:"gui-broadcast-mouseevent-mouseup",BROADCAST_SCROLL:"gui-broadcast-window-scroll",BROADCAST_RESIZE:"gui-broadcast-window-resize",BROADCAST_RESIZE_END:"gui-broadcast-window-resize-end",BROADCAST_POPSTATE:"gui-broadcast-window-popstate",BROADCAST_HASHCHANGE:"gui-broadcast-window-hashchange",BROADCAST_ORIENTATIONCHANGE:"gui-broadcast-orientationchange",BROADCAST_LOADING_CHANNELS:"gui-broadcast-loading-channels",BROADCAST_CHANNELS_LOADED:"gui-broadcast-channels-loaded",BROADCAST_TWEEN:"gui-broadcast-tween",BROADCAST_ATTENTION_ENTER:"gui-broadcast-attention-enter",BROADCAST_ATTENTION_EXIT:"gui-broadcast-attention-exit",BROADCAST_ATTENTION_MOVE:"gui-broadcast-attention-move",ACTION_DOC_ONCONSTRUCT:"gui-action-document-construct",ACTION_DOC_ONDOMCONTENT:"gui-action-document-domcontent",ACTION_DOC_ONLOAD:"gui-action-document-onload",ACTION_DOC_ONSPIRITUALIZED:"gui-action-document-spiritualized",ACTION_DOC_UNLOAD:"gui-action-document-unload",ACTION_DOC_FIT:"gui-action-document-fit",$ACTION_XFRAME_VISIBILITY:"gui-action-xframe-visibility",ACTION_WINDOW_LOADING:"gui-action-window-loading",ACTION_WINDOW_LOADED:"gui-action-window-loaded",LIFE_CONSTRUCT:"gui-life-construct",LIFE_CONFIGURE:"gui-life-configure",LIFE_ENTER:"gui-life-enter",LIFE_ATTACH:"gui-life-attach",LIFE_READY:"gui-life-ready",LIFE_DETACH:"gui-life-detach",LIFE_EXIT:"gui-life-exit",LIFE_ASYNC:"gui-life-async",LIFE_DESTRUCT:"life-destruct",LIFE_VISIBLE:"life-visible",LIFE_INVISIBLE:"life-invisible",LIFE_IFRAME_CONSTRUCT:"gui-life-iframe-construct",LIFE_IFRAME_DOMCONTENT:"gui-life-iframe-domcontent",LIFE_IFRAME_ONLOAD:"gui-life-iframe-construct",LIFE_IFRAME_SPIRITUALIZED:"gui-life-iframe-spiritualized",LIFE_IFRAME_UNLOAD:"gui-life-iframe-unload",$TICK_INSIDE:"gui-tick-spirits-inside",$TICK_OUTSIDE:"gui-tick-spirits-outside",CRAWLER_SPIRITUALIZE:"gui-crawler-spiritualize",CRAWLER_MATERIALIZE:"gui-crawler-materialize",CRAWLER_DETACH:"gui-crawler-detach",CRAWLER_DISPOSE:"gui-crawler-dispose",CRAWLER_ACTION:"gui-crawler-action",CRAWLER_VISIBLE:"gui-crawler-visible",CRAWLER_INVISIBLE:"gui-crawler-invisible",CRAWLER_DOMPATCHER:"gui-crawler-webkit-dompatcher",CLASS_INVISIBLE:"_gui-invisible",CLASS_HIDDEN:"_gui-hidden",CLASS_COVER:"_gui-cover",TIMEOUT_RESIZE_END:250,orientation:0,ORIENTATION_PORTRAIT:0,ORIENTATION_LANDSCAPE:1},gui.URL=function(doc,href){if(!doc||doc.nodeType!==Node.DOCUMENT_NODE)throw new TypeError("Document expected");var val,link=gui.URL._createLink(doc,href);Object.keys(gui.URL.prototype).forEach(function(key){gui.Type.isString(val=link[key])&&("pathname"!==key||val.startsWith("/")||(val="/"+val),this[key]=val)},this),this.id=this.hash?this.hash.substring(1):null,this.location=this.href.split("#")[0],this.external=this.location!==(doc.location+"").split("#")[0]},gui.URL.prototype={hash:null,host:null,hostname:null,href:null,pathname:null,port:null,protocol:null,search:null,id:null,external:!1,toString:function(){return this.href}},gui.URL.absolute=function(base,href){if(base.nodeType===Node.DOCUMENT_NODE)return new gui.URL(base,href).href;if("string"==typeof base){var stack=base.split("/"),parts=href.split("/");return stack.pop(),parts.forEach(function(part){"."!==part&&(".."===part?stack.pop():stack.push(part))}),stack.join("/")}},gui.URL.external=function(src,doc){doc=doc||document;var url=new gui.URL(doc,src);return gui.Client.isExplorer9?(console.debug("TODO: Fix hardcoded assesment of external URL in IE9 (always false): "+src),!1):url.host!==doc.location.host},gui.URL.getParam=function(url,name){name=name.replace(/(\[|\])/g,"\\$1");var results=RegExp("[\\?&]"+name+"=([^&#]*)").exec(url);return null===results?null:results[1]},gui.URL.setParam=function(url,name,value){var cut,params=[],index=-1;return url.indexOf("?")>-1&&(cut=url.split("?"),url=cut[0],params=cut[1].split("&"),params.every(function(param,i){var x=param.split("=");return x[0]===name&&(index=i,null!==value&&(x[1]=value,params[i]=x.join("="))),0>index})),null===value?index>-1&&params.remove(index,index):0>index&&(params[params.length]=[name,value].join("=")),url+(params.length>0?"?"+params.join("&"):"")},gui.URL._createLink=function(doc,href){var link=doc.createElement("a");if(link.href=href||"",gui.Client.isExplorer){var uri=gui.URL.parseUri(link.href);Object.keys(uri).forEach(function(key){link[key]||(link[key]=uri[key])})}return link},gui.URL.parseUri=function(str){for(var o=gui.URL.parseOptions,m=o.parser[o.strictMode?"strict":"loose"].exec(str),uri={},i=14;i--;)uri[o.key[i]]=m[i]||"";return uri[o.q.name]={},uri[o.key[12]].replace(o.q.parser,function($0,$1,$2){$1&&(uri[o.q.name][$1]=$2)}),uri},gui.URL.parseOptions={strictMode:!0,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},gui.KeyMaster={generateKey:function(prefix){prefix="key";var ran=""+Math.random(),key=(prefix||"key")+ran.slice(2,11);return this._keys[key]?key=this.generateKey(prefix):this._keys[key]=!0,key},generateGUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=0|16*Math.random(),v="x"===c?r:8|3&r;return v.toString(16)}).toUpperCase()},isKey:function(string){var hit=null,looks=!1;return gui.Type.isString(string)&&(hit=this.extractKey(string),looks=hit&&hit[0]===string),looks},extractKey:function(string){return/key\d{9}/.exec(string)},_keys:Object.create(null)},gui.SpiritualAid={polyfill:function(win,worker){"use strict";this._strings(win),this._arrays(win),this._functions(win),this._globals(win),this._extras(win),worker||this._effects(win)},_extend:function(what,whit){Object.keys(whit).forEach(function(key){var def=whit[key];void 0===what[key]&&(def.get&&def.set||(what[key]=def))})},_strings:function(win){this._extend(win.String.prototype,{trim:function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")},repeat:function(n){return new win.Array(n+1).join(this)},startsWith:function(sub){return 0===this.indexOf(sub)},endsWith:function(sub){sub+="";var i=this.lastIndexOf(sub);return i>=0&&i===this.length-sub.length},contains:function(sub){return this.indexOf(sub)>-1},toArray:function(){return this.split("")}})},_arrays:function(win){this._extend(win.Array.prototype,{remove:function(from,to){return console.warn("Array.prototype.remove is deprecated. Use gui.Array.remove(array,from,to);"),gui.Array.remove(this,from,to)}}),this._extend(win.Array,{every:function(array,fun,thisp){for(var res=!0,len=array.length>>>0,i=0;len>i;i++)if(void 0!==array[i]&&!fun.call(thisp,array[i],i,array)){res=!1;break}return res},forEach:function(array,fun,thisp){for(var len=array.length>>>0,i=0;len>i;i++)void 0!==array[i]&&fun.call(thisp,array[i],i,array)},map:function(array,fun,thisp){for(var m=[],len=array.length>>>0,i=0;len>i;i++)void 0!==array[i]&&m.push(fun.call(thisp,array[i],i,array));return m},filter:function(array,fun,thisp){return Array.prototype.filter.call(array,fun,thisp)},isArray:function(o){return"[object Array]"===win.Object.prototype.toString.call(o)},concat:function(a1,a2){function map(e){return e}return this.map(a1,map).concat(this.map(a2,map))}})},_functions:function(win){this._extend(win.Function.prototype,{bind:function(oThis){if("function"!=typeof this)throw new win.TypeError("Function bind not callable");var fSlice=win.Array.prototype.slice,aArgs=fSlice.call(arguments,1),fToBind=this,Fnop=function(){},fBound=function(){return fToBind.apply(this instanceof Fnop?this:oThis||win,aArgs.concat(fSlice.call(arguments)))};return Fnop.prototype=this.prototype,fBound.prototype=new Fnop,fBound}})},_globals:function(win){this._extend(win,{console:{log:function(){},debug:function(){},warn:function(){},error:function(){}},Map:function(){function Map(){this._map=Object.create(null)}return Map.prototype={isNative:!1,get:function(key){return this._map[key]},set:function(key,val){this._map[key]=val},has:function(key){return void 0!==this._map[key]},"delete":function(key){delete this._map[key]},size:function(){return Object.keys(this._map).length}},Map}(),Set:function(){function Set(){this._map=Object.create(null)}return Set.prototype={isNative:!1,add:function(key){this._map[key]=!0},has:function(key){return this._map[key]===!0},"delete":function(key){delete this._map[key]},size:function(){return Object.keys(this._map).length}},Set}(),WeakMap:function(){function WeakMap(){function del(key){return has(key)&&(keys.splice(i,1),values.splice(i,1)),i>-1}function get(key,d3fault){return has(key)?values[i]:d3fault}function has(key){return i=indexOf.call(keys,key),i>-1}function set(key,value){has(key)?values[i]=value:values[keys.push(key)-1]=value}var keys=[],values=[];return create(WeakMapPrototype,{isNative:{value:!1},"delete":{value:del},del:{value:del},get:{value:get},has:{value:has},set:{value:set}})}function WeakMapInstance(){}var i,Object=win.Object,WeakMapPrototype=WeakMap.prototype,create=Object.create,indexOf=[].indexOf;return WeakMap.prototype=WeakMapInstance.prototype=WeakMapPrototype=new WeakMap,WeakMap}()})},_effects:function(win){this._extend(win,{requestAnimationFrame:function(){var func=win.requestAnimationFrame||win.webkitRequestAnimationFrame||win.mozRequestAnimationFrame||win.oRequestAnimationFrame||win.msRequestAnimationFrame||function(){var lastTime=0;return function(callback){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}}();return func}(),setImmediate:function(){var list=[],handle=1,name="spiritual:emulated:setimmediate";return win.addEventListener("message",function(e){e.data===name&&list.length&&(list.shift().apply(win),e.stopPropagation())},!1),function(func){return list.push(func),win.postMessage(name,"*"),handle++}}()})},_extras:function(win){this._extend(win.Map.prototype,{del:function(key){return this["delete"](key)}}),this._extend(win.Set.prototype,{del:function(key){return this["delete"](key)}}),this._extend(win.console,{debug:win.console.log}),this._extend(XMLHttpRequest.prototype,{overrideMimeType:function(){}}),this._extend(win.XMLHttpRequest,{UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4})}},gui.Spiritual=function(win){this._construct(win)},gui.Spiritual.prototype={constructor:gui.Spiritual,$contextid:null,context:null,window:null,document:null,mode:"optimize",debug:!1,autostart:!0,hosted:!1,portalled:!1,xhost:null,toString:function(){return"[namespace gui]"},go:function(){switch(this._gone=!0,this.debug&&(this.mode===gui.MODE_JQUERY?gui.Tick.next(function(){gui.Observer.observe(this.context)},this):gui.Observer.observe(this.context)),this.mode){case gui.MODE_NATIVE:case gui.MODE_JQUERY:case gui.MODE_OPTIMIZE:case gui.MODE_MANAGED:gui.DOMChanger.change(this.context)}gui.Tick.add([gui.$TICK_INSIDE,gui.$TICK_OUTSIDE],this,this.$contextid),null!==this._configs&&this._configs.forEach(function(config){this.channel(config.select,config.klass)},this)},get:function(arg){var spirit=null,inside=this._spirits.inside,outside=this._spirits.outside;switch(gui.Type.of(arg)){case"string":if(gui.KeyMaster.isKey(arg))spirit=inside[arg]||outside[arg]||null;else{var element=this.document.querySelector(arg);spirit=element?element.spirit:null}break;case"TODO":}return spirit},module:function(name,module){if(!gui.Type.isString(name))throw Error("Module requires a name");return module=this._modules[name]=new(gui.Module.extend(name,module))(this.context)},hasModule:function(name){return gui.Type.isDefined(this._modules[name])},channel:function(select,klass){var spirit=null;if(this._gone){if(spirit="string"==typeof klass?gui.Object.lookup(klass,this.context):klass,!gui.Type.isFunction(spirit))throw"Unknown Spirit for selector: "+select;this._channels.push([select,spirit])}else this._configs||(this._configs=[]),this._configs.push({select:select,klass:klass})},portal:function(sub){if(sub!==this.context){var subgui=sub.gui=new this.constructor(sub),indexes=[];subgui.portalled=!0,subgui._spaces=this._spaces.slice(),this._spaces.forEach(function(ns){var external=sub,internal=this.context;ns.split(".").forEach(function(part){gui.Type.isDefined(external[part])||(external[part]=internal[part]),external=external[part],internal=internal[part]}),this._index(internal,external,this._channels).forEach(function(i){indexes.push(i)})},this),gui.Object.each(this._modules,function(name,module){module.$setupcontext(subgui.context),subgui._modules[name]=module},this),indexes.sort(function(a,b){return a-b}).forEach(function(i){subgui._channels.push(this._channels[i])},this),gui.Guide.observe(sub)}},kickstart:function(){switch(document.readyState){case"interactive":case"complete":gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_KICKSTART)}},namespace:function(ns,nsobject){if(!gui.Type.isString(ns))throw new TypeError("Expected a string: gui.namespace");return this._spaces.push(ns),nsobject},namespaces:function(){return this._spaces.slice()},evaluate:function(element){var res=null;if(element.nodeType===Node.ELEMENT_NODE){var doc=element.ownerDocument,win=doc.defaultView,att=element.getAttribute("gui");gui.Type.isString(att)&&!att.startsWith("[")?""!==att&&(res=win.gui._inlines[att],gui.Type.isDefined(res)||(res=gui.Object.lookup(att,win)),res?win.gui._inlines[att]=res:console.error(att+" is not defined.")):win.gui._channels.every(function(def){var select=def[0],spirit=def[1];return gui.CSSPlugin.matches(element,select)&&(res=spirit),null===res},this)}return res},broadcastGlobal:function(msg,arg){gui.Type.isEvent(arg)&&(arg=new gui.EventSummary(arg)),gui.Broadcast.dispatchGlobal(this,msg,arg)},debugchannels:function(){var out=""+this.document.location;this._channels.forEach(function(channel){out+="\n"+channel[0]+" : "+channel[1]}),console.debug(out+"\n\n")},destruct:function(spirit){var all=this._spirits,key=spirit.$instanceid;delete all.inside[key],delete all.outside[key],this._jensen(spirit)},inside:function(spirit){var all=this._spirits,key=spirit.$instanceid;all.inside[key]||(all.outside[key]&&delete all.outside[key],all.inside[key]=spirit,all.incoming.push(spirit),gui.Tick.dispatch(gui.$TICK_INSIDE,4,this.$contextid))},outside:function(spirit){var all=this._spirits,key=spirit.$instanceid;all.outside[key]||(all.inside[key]&&(delete all.inside[key],this._jensen(spirit)),all.outside[key]=spirit,gui.Tick.dispatch(gui.$TICK_OUTSIDE,0,this.$contextid))},_jensen:function(spirit){var incoming=this._spirits.incoming;if(incoming.length){var i=incoming.indexOf(spirit);i>-1&&gui.Array.remove(incoming,i)}},ontick:function(tick){var spirits;switch(tick.type){case gui.$TICK_INSIDE:gui.Guide.afterattach(this._spirits.incoming),this._spirits.incoming=[];break;case gui.$TICK_OUTSIDE:spirits=gui.Object.each(this._spirits.outside,function(key,spirit){return spirit}),spirits.forEach(function(spirit){gui.Spirit.$exit(spirit)}),spirits.forEach(function(spirit){gui.Spirit.$destruct(spirit)}),spirits.forEach(function(spirit){gui.Spirit.$dispose(spirit)}),this._spirits.outside=Object.create(null)}},nameDestructAlreadyUsed:function(){gui.Tick.remove(gui.$TICK_OUTSIDE,this,this.$contextid),gui.Object.each(this._spirits.inside,function(id,spirit){gui.GreatSpirit.$meet(spirit)}),["_spiritualaid","context","document","_channels","_inlines","_spaces","_modules","_spirits"].forEach(function(thing){this[thing]=null},this)},_channels:null,_inlines:null,_spaces:null,_gone:!1,_configs:null,_modules:null,_spirits:null,_spiritualaid:gui.SpiritualAid,_construct:function(context){this._spiritualaid.polyfill(context),this.context=context,this.window=context.document?context:null,this.document=context.document||null,this.hosted=this.window&&this.window!==this.window.parent,this._inlines=Object.create(null),this._modules=Object.create(null),this._arrivals=Object.create(null),this._channels=[],this._spaces=["gui"],this._spirits={incoming:[],inside:Object.create(null),outside:Object.create(null)},this._params(this.document.location.href)},_params:function(url){var id,xhost,param=gui.PARAM_CONTEXTID;if(url.contains(param)){var splits=gui.URL.getParam(url,param).split("/");id=splits.pop(),xhost=splits.join("/")}else id=gui.KeyMaster.generateKey(),xhost=null;this.$contextid=id,this.xhost=xhost},_index:function(internal,external,channels){function index(def){switch(def){case"$contextid":case"context":break;default:var thing=external[def]=internal[def];gui.Type.isSpiritConstructor(thing)&&thing.portals&&channels.forEach(function(channel,index){channel[1]===thing&&indexes.push(index)})}}var indexes=[];for(var def in internal)this.constructor.prototype.hasOwnProperty(def)||def.startsWith("_")||index(def);return indexes}},Object.keys(gui).forEach(function(key){gui.Spiritual.prototype[key]=gui[key]}),gui=new gui.Spiritual(window),gui.Type={of:function(o){var type={}.toString.call(o).match(this._typeexp)[1].toLowerCase();return"domwindow"===type&&"undefined"==typeof o+""&&(type="undefined"),type},isDefined:function(o){return"undefined"!==this.of(o)},isComplex:function(o){switch(this.of(o)){case"undefined":case"boolean":case"number":case"string":case"null":return!1}return!0},isWindow:function(o){return o&&o.document&&o.location&&o.alert&&o.setInterval},isEvent:function(o){return this.of(o).endsWith("event")&&this.isDefined(o.type)},isMethod:function(o){return this.isFunction(o)&&!this.isConstructor(o)},isSpirit:function(o){return o&&o instanceof gui.Spirit},isConstructor:function(what){return this.isFunction(what)&&Object.keys(what.prototype).length>0},isSpiritConstructor:function(what){return this.isFunction(what)&&this.isBoolean(what.portals)},cast:function(string){var result=string+"";switch(result){case"null":result=null;break;case"true":case"false":result="true"===result;break;default:parseInt(result,10)+""===result?result=parseInt(result,10):parseFloat(result)+""===result&&(result=parseFloat(result))}return result},_typeexp:/\s([a-zA-Z]+)/},function(){["array","function","object","string","number","boolean","null","arguments","file"].forEach(function(type){this["is"+type[0].toUpperCase()+type.slice(1)]=function(o){return this.of(o)===type}},this)}.call(gui.Type),gui.Object={create:function(proto,props){var resolved=Object.create(null);return Object.keys(props).forEach(function(prop){resolved[prop]={value:props[prop],writable:!0,enumerable:!0,configurable:!0}}),Object.create(proto,resolved)},extend:function(target,source,loose){return Object.keys(source).forEach(function(name){if(!loose||!gui.Type.isDefined(target[name])){var desc=Object.getOwnPropertyDescriptor(source,name);Object.defineProperty(target,name,desc)}}),target},extendmissing:function(target,source){return this.extend(target,source,!0)},mixin:function(target,key,value,override){return!gui.Type.isDefined(target[key])||override?target[key]=value:console.error("Mixin naming collision in "+target+": "+key),target},copy:function(source){return this.extend(Object.create(null),source)},each:function(object,func,thisp){return Object.keys(object).map(function(key){return func.call(thisp,key,object[key])})},all:function(object,func,thisp){var res=[];for(var key in object)res.push(func.call(thisp,key,object[key]));return res},lookup:function(opath,context){var result,struct=context;if(opath.contains(".")){var parts=opath.split(".");parts.forEach(function(part){struct=struct[part]}),result=struct}else result=struct[opath];return result},assert:function(opath,value,context){var prop,struct=context;if(opath.contains(".")){var parts=opath.split(".");prop=parts.pop(),parts.forEach(function(part){struct=struct[part]})}else prop=opath;return struct[prop]=value,struct},methods:function(object){var result=[];for(var def in object)gui.Type.isMethod(object[def])&&result.push(def);return result},nonmethods:function(object){var result=[];for(var def in object)gui.Type.isFunction(object[def])||result.push(def);return result},toArray:function(object){var result=[];if(gui.Type.isArray(object))result=object;else try{gui.Type.isDefined(object.length)&&"0"in Object(object)&&(result=Array.map(object,function(thing){return thing}))}catch(exception){}return result}},gui.Array={remove:function(array,from,to){return array.splice(from,!to||1+to-from+(!(0>to^from>=0)&&(0>to||-1)*array.length)),array.length},toArray:function(arg){var list;switch(gui.Type.of(arg)){case"array":list=arg;break;case"string":list=arg.split(" ");break;default:list=gui.Object.toArray(arg)}return list.length?list:[arg]}},gui.Arguments={provided:function(){var types=gui.Object.toArray(arguments);return function(action){return function(){return gui.Arguments._match(arguments,types)?action.apply(this,arguments):void 0}}},confirmed:function(){var types=gui.Object.toArray(arguments);return function(action){return function(){return gui.Arguments._validate(arguments,types)?action.apply(this,arguments):void 0}}},_validating:!1,_match:function(args,types){return types.every(function(type,index){return this._matches(type,args[index],index)},this)},_validate:function(args,types){this._validating=!0;var is=this._match(args,types);return this._validating=!1,is},_xtract:function(xpect,optional){return optional?xpect.slice(1,-1):xpect},_matches:function(xpect,arg,index){var needs=!xpect.startsWith("("),split=this._xtract(xpect,!needs).split("|"),input=gui.Type.of(arg),match="*"===xpect||!needs&&"undefined"===input||!needs&&split.indexOf("*")>-1||split.indexOf(input)>-1;return!match&&this._validating&&this._error(index,xpect,input),match},_error:function(index,xpect,input){console.error("Argument "+index+": "+"Expected "+xpect+", got "+input)}},gui.Function={create:function(name,params,body,context){var F=context?context.Function:Function;return name=this.safename(name),params=params?params.join(","):"",body=body||"",new F("return function "+name+" ( "+params+" ) {"+body+"}")()},decorateBefore:gui.Arguments.confirmed("object|function","string","function")(function(target,name,decorator){return this._decorate("before",target,name,decorator)}),decorateAfter:gui.Arguments.confirmed("object|function","string","function")(function(target,name,decorator){return this._decorate("after",target,name,decorator)}),decorateAround:function(){throw Error("TODO")},safename:function(name){return name&&name.contains(".")&&(name=name.split(".").pop()),name||""},_decorate:function(position,target,name,decorator){return target[name]=gui.Combo[position](decorator)(target[name]),target},_decorated:function(target,name,decorator){var result=!0,string=""+decorator,decoed=target.$decorators||function(){return target.$decorators=Object.create(null)}();return(result=decoed[name]!==string)&&(decoed[name]=string),result}},gui.Class={create:function(){var b=this._breakdown_base(arguments),C=this._createclass(null,b.proto,b.name);return gui.Object.extend(C.prototype,b.protos),gui.Object.extend(C,b.statics),b.recurring&&gui.Object.each(b.recurring,function(key,val){C[key]=C.$recurring[key]=val}),this._profiling(C)},breakdown:function(args){return this._breakdown_subs(args)},_classes:Object.create(null),_ANONYMOUS:"Anonymous",_BODY:function($name){var body=(""+$name).trim();return body.slice(body.indexOf("{")+1,-1)}(function $name(){if(this instanceof $name==!1)return $name.extend.apply($name,arguments);var constructor=this.$onconstruct||this.onconstruct,nonenumprop=gui.Property.nonenumerable;window.Object.defineProperties(this,{$instanceid:nonenumprop({value:gui.KeyMaster.generateKey("instance")}),displayName:nonenumprop({value:this.constructor.displayName,writable:!0})}),gui.Type.isFunction(constructor)&&constructor.apply(this,arguments)}),_breakdown_base:function(args){var named=gui.Type.isString(args[0]);return{name:named?args[0]:null,proto:args[named?1:0]||Object.create(null),protos:args[named?2:1]||Object.create(null),recurring:args[named?3:2]||Object.create(null),statics:args[named?4:3]||Object.create(null)}},_breakdown_subs:function(args){var named=gui.Type.isString(args[0]);return{name:named?args[0]:null,protos:args[named?1:0]||Object.create(null),recurring:args[named?2:1]||Object.create(null),statics:args[named?3:2]||Object.create(null)}},_createclass:function(SuperC,proto,name){name=name||gui.Class._ANONYMOUS;var C=gui.Function.create(name,null,this._namedbody(name));return C.$classid=gui.KeyMaster.generateKey("class"),C.prototype=Object.create(proto||null),C.prototype.constructor=C,C=this._internals(C,SuperC),C=this._interface(C),C=this._nameclass(C,name)},_createsubclass:function(SuperC,args){return args=this.breakdown(args),gui.Type.isDefined(args.config)&&console.warn("'config' has been renamed 'attconfig'"),SuperC.$super=SuperC.$super||new gui.Super(SuperC),this._extend_fister(SuperC,args.protos,args.recurring,args.statics,args.name)},_extend_fister:function(SuperC,protos,recurring,statics,name){var C=this._createclass(SuperC,SuperC.prototype,name);return gui.Object.extend(C,statics),gui.Object.extend(C.$recurring,recurring),gui.Object.each(C.$recurring,function(key,val){C[key]=val}),gui.Property.extendall(protos,C.prototype),gui.Super.support(SuperC,C,protos),C=this._nameclass(C,name),this._profiling(C)},_profiling:function(C){var name=C.name||gui.Class._ANONYMOUS;return[C,C.prototype].forEach(function(thing){gui.Object.each(thing,function(key,value){gui.Type.isMethod(value)&&this._displayname(value,name+"."+key)},this)},this),C},_internals:function(C,SuperC){return C.$super=null,C.$subclasses=[],C.$superclass=SuperC||null,C.$recurring=SuperC?gui.Object.copy(SuperC.$recurring):Object.create(null),SuperC&&SuperC.$subclasses.push(C),C},_interface:function(C){return["extend","mixin"].forEach(function(method){C[method]=this[method]},this),C},_nameclass:function(C,name){return name=name||gui.Class._ANONYMOUS,this._namedthing(C,"function",name),this._namedthing(C.prototype,"object",name),C},_namedthing:function(what,type,name){this._displayname(what,name),what.hasOwnProperty("toString")||(what.toString=function(){return"["+type+" "+name+"]"})},_namedbody:function(name){return this._BODY.replace(RegExp("\\$name","gm"),gui.Function.safename(name))},_displayname:function(thing,name){return gui.Type.isDefined(thing.displayName)||Object.defineProperty(thing,"displayName",gui.Property.nonenumerable({writable:!0,value:name})),thing}},gui.Object.each({extend:function(){return gui.Class._createsubclass(this,arguments)},mixin:function(name,value,override){!gui.Type.isDefined(this.prototype[name])||override?(this.prototype[name]=value,gui.Class.descendantsAndSelf(this,function(C){C.$super&&gui.Super.generateStub(C.$super,C.prototype,name)})):console.error("Mixin naming collision in "+this+": "+name)}},function(name,method){gui.Class[name]=method}),gui.Object.each({children:function(C,action,thisp){var results=[];return action=action||gui.Combo.identity,C.$subclasses.forEach(function(sub){results.push(action.call(thisp,sub))},thisp),results},descendants:function(C,action,thisp,results){return results=results||[],action=action||gui.Combo.identity,C.$subclasses.forEach(function(sub){results.push(action.call(thisp,sub)),gui.Class.descendants(sub,action,thisp,results)},thisp),results},descendantsAndSelf:function(C,action,thisp){var results=[];return action=action||gui.Combo.identity,results.push(action.call(thisp,C)),this.descendants(C,action,thisp,results)},parent:function(C,action,thisp){return action=action||gui.Combo.identity,action.call(thisp,C.$superclass)},ancestors:function(C,action,thisp,results){return results=results||[],action=action||gui.Combo.identity,C.$superclass&&(results.push(action.call(thisp,C.$superclass)),gui.Class.ancestors(C.$superclass,action,thisp,results)),results},ancestorsAndSelf:function(C,action,thisp){var results=[];return action=action||gui.Combo.identity,results.push(action.call(thisp,C)),this.ancestors(C,action,thisp,results)}},function(name,method){gui.Class[name]=method}),gui.Property={extendall:function(source,target){return Object.keys(source).forEach(function(key){this.extend(source,target,key)},this),target},extend:function(source,target,key){var desc=Object.getOwnPropertyDescriptor(source,key);return desc=this._accessor(target,key,desc),Object.defineProperty(target,key,desc),target},nonenumerable:function(desc){return gui.Object.extendmissing({configurable:!0,enumerable:!1},desc)},accessor:function(object,key,def){if(this._isaccessor(def))return Object.defineProperty(object,key,{enumerable:!0,configurable:!0,get:def.getter||this._NOGETTER,set:def.setter||this._NOSETTER});throw new TypeError("Expected getter and/or setter method")},_isaccessor:function(obj){return Object.keys(obj).every(function(key){var is=!1;switch(key){case"getter":case"setter":is=gui.Type.isFunction(obj[key])}return is})},_accessor:function(proto,key,desc){var val=desc.value;return gui.Type.isObject(val)&&(val.getter||val.setter)&&this._isactive(val)&&(desc=this._activeaccessor(proto,key,val)),desc},_isactive:function(obj){return Object.keys(obj).every(function(key){var is=!1;switch(key){case"getter":case"setter":is=gui.Type.isFunction(obj[key])}return is})},_activeaccessor:function(proto,key,def){var desc;return["getter","setter"].forEach(function(name,set){for(;proto&&!gui.Type.isDefined(def[name]);)proto=Object.getPrototypeOf(proto),desc=Object.getOwnPropertyDescriptor(proto,key),desc&&(def[name]=desc[set?"set":"get"])}),{enumerable:!0,configurable:!0,get:def.getter||this._NOGETTER,set:def.setter||this._NOSETTER}},_NOGETTER:function(){throw Error("Getting a property that has only a setter")},_NOSETTER:function(){throw Error("Setting a property that has only a getter")}},gui.Interface={validate:function(interfais,object){var is=!0,expected=""+interfais,type=gui.Type.of(object);switch(type){case"null":case"string":case"number":case"boolean":case"undefined":throw Error("Expected "+expected+", got "+type+": "+object);default:try{var missing=null,t=null;if(is=Object.keys(interfais).every(function(name){return missing=name,t=gui.Type.of(interfais[name]),gui.Type.of(object[name])===t}),!is)throw Error("Expected "+expected+". A required "+type+' "'+missing+'" is missing')}catch(exception){throw Error("Expected "+expected)}}return is}},gui.Combo={before:function(decoration){return function(base){return function(){return decoration.apply(this,arguments),base.apply(this,arguments)}}},after:function(decoration){return function(base){return function(){var result=base.apply(this,arguments);return decoration.apply(this,arguments),result}}},around:function(decoration){return function(base){return function(){var argv,callback,result,that=this,slice=gui.Combo._slice;return argv=arguments.length>=1?slice.call(arguments,0):[],result=void 0,callback=function(){return result=base.apply(that,argv)},decoration.apply(this,[callback].concat(argv)),result}}},provided:function(condition){return function(base,otherwise){return function(){return condition.apply(this,arguments)?base.apply(this,arguments):otherwise?otherwise.apply(this,arguments):void 0}}},chained:function(base){return function(){var result=base.apply(this,arguments);return void 0===result?this:result}},identity:function(subject){return subject},_slice:[].slice},gui.Super=function(C){gui.Super.generateStubs(this,C.prototype)
},gui.Super.prototype=Object.create(null),gui.Object.each({$subject:null,toString:function(){return"[function gui.Super]"},generateStubs:function(suber,proto){gui.Object.methods(proto).forEach(function(name){gui.Super.generateStub(suber,proto,name)},this)},generateStub:function(suber,proto,name){var func=suber[name]=function(){return proto[name].apply(gui.Super.$subject,arguments)};func.displayName=name},support:function(SuperC,C,protos){var proto=C.prototype,combo=this._decorator(SuperC);gui.Object.each(protos,function(key,base){gui.Type.isMethod(base)&&(proto[key]=combo(base),proto[key].toString=function(){var original=(""+base).replace(/\t/g,"  ");return gui.Super._DISCLAIMER+original})},this)},_DISCLAIMER:"/**\n  * Method was overloaded by the framework. \n  * This is an approximation of the code :) \n  */\n",_decorator:function(SuperC){return function(base){return function(){var sub=gui.Super.$subject;gui.Super.$subject=this,this._super=SuperC.$super;var result=base.apply(this,arguments);return gui.Super.$subject=sub,result}}}},function(name,value){gui.Super[name]=value}),gui.Position=function(x,y){this.x=x||0,this.y=y||0},gui.Position.prototype={x:0,y:0,toString:function(){return"[object gui.Position("+this.x+","+this.y+")]"},clone:function(){return new gui.Position(this.x,this.y)}},gui.Position.isEqual=function(p1,p2){return p1.x===p2.x&&p1.y===p2.y},gui.Dimension=function(w,h){this.w=w||0,this.h=h||0},gui.Dimension.prototype={w:0,h:0,toString:function(){return"[object gui.Dimension("+this.w+","+this.h+")]"}},gui.Dimension.isEqual=function(dim1,dim2){return dim1.w===dim2.w&&dim1.h===dim2.h},gui.Geometry=function(x,y,w,h){this.x=x||0,this.y=y||0,this.w=w||0,this.h=h||0},gui.Geometry.prototype={x:0,y:0,w:0,h:0,toString:function(){return"[object gui.Geometry("+this.x+","+this.y+","+this.w+","+this.h+")]"},hitTest:function(geo){return gui.Geometry.hitTest(this,geo)}},gui.Geometry.isEqual=function(geo1,geo2){return geo1.x===geo2.x&&geo1.y===geo2.y&&geo1.w===geo2.w&&geo1.h===geo2.h},gui.Geometry.hitTest=function(geo1,geo2){function x(g1,g2){return g1.x>=g2.x&&g1.x<=g2.x+g2.w}function y(g1,g2){return g1.y>=g2.y&&g1.y<=g2.y+g2.h}var hitx=x(geo1,geo2)||x(geo2,geo1),hity=y(geo1,geo2)||y(geo2,geo1);return hitx&&hity},gui.Then=function(){},gui.Then.prototype={toString:function(){return"[object gui.Then]"},then:function(callback,thisp){this._callback=callback?callback:null,this._pointer=thisp?thisp:null,this._now&&this.now()},now:function(){var c=this._callback,p=this._pointer;c?(this.then(null,null),c.apply(p,arguments)):this._now=!0},_callback:null,_pointer:null,_now:!1},gui.HTMLParser=function(doc){if(!doc||!doc.nodeType)throw new TypeError("Document expected");this._document=doc},gui.HTMLParser.prototype={_document:null,parse:function(html,element){var match,fix,temp,fixes=gui.HTMLParser._fixes,comments=gui.HTMLParser._comments,firsttag=gui.HTMLParser._firsttag,doc=this._document;html=html.trim().replace(comments,""),(match=html.match(firsttag))&&(fix=fixes.get(match[1]))&&(html=fix.replace("${html}",html)),temp=doc.createElement("div"),temp.innerHTML=html;var nodes=temp.childNodes;if(fix&&element){var name=element.localName;if(fixes.has(name))for(var node=temp;node;)node=node.firstElementChild,node.localName===name&&(nodes=node.childNodes,node=null)}return Array.map(nodes,function(node){return node})}},gui.HTMLParser._comments=/<!--[\s\S]*?-->/g,gui.HTMLParser._firsttag=/^<([a-z]+)/i,gui.HTMLParser._fixes=new Map,function(){gui.Object.each({td:"<table><tbody><tr>${html}</tr></tbody></table>",tr:"<table><tbody>${html}</tbody></table>",tbody:"<table>${html}</table>",col:"<table><colgroup>${html}</colgroup></table>",option:"<select><option>a</option>${html}</select>"},function(tag,fix){gui.HTMLParser._fixes.set(tag,fix)})}(),function(){var fixes=gui.HTMLParser._fixes;fixes.set("th",fixes.get("td")),["thead","tfoot","caption","colgroup"].forEach(function(tag){gui.HTMLParser._fixes.set(tag,fixes.get("tbody"))})}(),gui.DOMSerializer=function(){},gui.DOMSerializer.prototype={serialize:function(element){var context=element.ownerDocument.defaultView,serializer=new context.XMLSerializer;return serializer.serializeToString(element)},subserialize:function(element){var html=this.serialize(element);return html.contains("</")&&(html=html.slice(html.indexOf(">")+1,html.lastIndexOf("<"))),html}},gui.FileLoader=gui.Class.create("gui.FileLoader",Object.prototype,{onconstruct:function(doc){this._cache=gui.FileLoader._cache,this._document=doc},load:function(src,callback,thisp){var url=new gui.URL(this._document,src);this._cache.has(url.location)?this._cached(url,callback,thisp):this._request(url,callback,thisp)},onload:function(text,url,callback,thisp){callback.call(thisp,text)},_cache:null,_document:null,_request:function(url,callback,thisp){this._cache.set(url.location,null),new gui.Request(url.href).get(function(status,text){this.onload(text,url,callback,thisp),this._cache.set(url.location,text),gui.FileLoader.unqueue(url.location)},this)},_cached:function(url,callback,thisp){var cached=this._cache.get(url.location);if(null!==cached)this.onload(cached,url,callback,thisp);else{var that=this;gui.FileLoader.queue(url.location,function(text){that.onload(text,url,callback,thisp)})}},$onconstruct:function(doc){if(!doc||doc.nodeType!==Node.DOCUMENT_NODE)throw new TypeError("Document expected");this.onconstruct(doc)}},{},{_cache:new Map,_queue:new Map,queue:function(src,action){this._queue[src]=this._queue[src]||[],this._queue[src].push(action)},unqueue:function(src){var text=this._cache.get(src);if(this._queue[src])for(;this._queue[src][0];)this._queue[src].shift()(text)}}),gui.BlobLoader={loadScript:function(doc,source,callback,thisp){var blob=new Blob([source],{type:"text/javascript"}),script=doc.createElement("script");script.src=this._URL.createObjectURL(blob);var head=doc.querySelector("head");gui.Observer.suspend(head,function(){head.appendChild(script)}),callback&&(script.onload=function(){callback.call(thisp)})},_URL:window.URL||window.webkitURL},gui.EventSummary=function(e){this._construct(e)},gui.EventSummary.prototype={event:null,window:null,document:null,documentspirit:null,toString:function(){return"[object gui.EventSummary]"},_construct:function(e){var win=null,doc=null,target=e.target,type=target.nodeType;gui.Type.isDefined(type)?(doc=type===Node.DOCUMENT_NODE?target:target.ownerDocument,win=doc.defaultView):(win=target,doc=win.document),this.event=e,this.window=win,this.document=doc,this.documentspirit=doc.documentElement.spirit}},gui.Crawler=gui.Class.create("gui.Crawler",{type:null,direction:null,global:!1,toString:function(){return"[object gui.Crawler]"},onconstruct:function(type){this.type=type||null},ascend:function(start,handler){this.direction=gui.Crawler.ASCENDING;var win,elm=start instanceof gui.Spirit?start.element:start;do if(elm.nodeType===Node.DOCUMENT_NODE&&(this.global?(win=elm.defaultView,win.parent!==win?win.gui.xhost?(elm=null,gui.Type.isFunction(handler.transcend)&&handler.transcend(win.parent,win.gui.xhost,win.gui.$contextid)):elm=win.frameElement:elm=null):elm=null),elm){var directive=this._handleElement(elm,handler);switch(directive){case gui.Crawler.STOP:elm=null;break;default:elm=elm.parentNode}}while(elm)},ascendGlobal:function(start,handler){this.global=!0,this.ascend(start,handler),this.global=!1},descend:function(start,handler,arg){this.direction=gui.Crawler.DESCENDING;var elm=start instanceof gui.Spirit?start.element:start;elm.nodeType===Node.DOCUMENT_NODE&&(elm=elm.documentElement),this._descend(elm,handler,arg,!0)},descendGlobal:function(start,handler,arg){this.global=!0,this.descend(start,handler,arg),this.global=!1},_descend:function(elm,handler,arg,start){var win,spirit,directive=this._handleElement(elm,handler,arg);switch(directive){case gui.Crawler.CONTINUE:case gui.Crawler.SKIP_CHILDREN:if(directive!==gui.Crawler.SKIP_CHILDREN)if(elm.childElementCount)this._descend(elm.firstElementChild,handler,arg,!1);else if(this.global&&"iframe"===elm.localName&&(spirit=elm.spirit)&&spirit instanceof gui.IframeSpirit)if(spirit.xguest)win=elm.ownerDocument.defaultView,gui.Type.isFunction(handler.transcend)&&handler.transcend(spirit.contentWindow,spirit.xguest,spirit.$instanceid);else{var root=elm.contentDocument.documentElement;root&&this._descend(root,handler,arg,!1)}if(!start){var next=elm.nextElementSibling;null!==next&&this._descend(next,handler,arg,!1)}}},_handleElement:function(element,handler,arg){var directive=gui.Crawler.CONTINUE,spirit=element.spirit;return spirit&&(directive=spirit.oncrawler(this)),directive||handler&&(gui.Type.isFunction(handler.handleElement)&&(directive=handler.handleElement(element,arg)),directive!==gui.Crawler.STOP&&spirit&&gui.Type.isFunction(handler.handleSpirit)&&(directive=this._handleSpirit(spirit,handler))),directive||(directive=gui.Crawler.CONTINUE),directive},_handleSpirit:function(spirit,handler){return handler.handleSpirit(spirit)}},{},{ASCENDING:"ascending",DESCENDING:"descending",CONTINUE:0,STOP:1,SKIP:2,SKIP_CHILDREN:4}),gui.Request=function(url,doc){url&&this.url(url,doc)},gui.Request.prototype={url:function(url,doc){return this._url=doc?new gui.URL(doc,url).href:url,this},sync:function(){return this._async=!1,this},async:function(){return this._async=!0,this},accept:function(mimetype){return this._accept=mimetype,this},acceptJSON:function(){return this.accept("application/json")},acceptXML:function(){return this.accept("text/xml")},acceptText:function(){return this.accept("text/plain")},format:function(mimetype){return this._format=mimetype,this},header:function(){return console.warn("@TODO request headers"),this},get:function(callback,thisp){var that=this,request=new XMLHttpRequest;request.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&callback.call(thisp,200,that._parse(this.responseText),this.responseText)},request.overrideMimeType(this._accept),request.open("get",this._url,!0),request.send(null)},post:function(){},put:function(){},del:function(){},_async:!0,_url:null,_accept:"text/plain",_format:"application/x-www-form-urlencoded",_parse:function(text){var result=text;try{switch(this._accept){case"application/json":result=JSON.parse(text);break;case"text/xml":result=(new DOMParser).parseFromString(text,"text/xml")}}catch(exception){throw console.error(this._accept+" dysfunction at "+this._url),exception}return result}},gui.Spirit=gui.Class.create("gui.Spirit",Object.prototype,{$instanceid:null,$contextid:null,element:null,document:null,window:null,toString:function(){return"[object gui.Spirit]"},onconstruct:function(){},onconfigure:function(){},onenter:function(){},onattach:function(){},onready:function(){},ondetach:function(){},onexit:function(){},ondestruct:function(){},onasync:function(){},oncrawler:function(){},$onconstruct:function(elm,doc,win,sig){this.element=elm,this.document=doc,this.window=win,this.$contextid=sig,gui.Spirit.$construct(this)},$ondestruct:function(){},$pluginplugins:function(){var Plugin,plugins=this.constructor.$plugins;this.life=new gui.LifePlugin(this),this.attconfig=new gui.AttConfigPlugin(this),Object.keys(plugins).filter(function(prefix){return"life"!==prefix&&"attconfig"!==prefix}).sort().forEach(function(prefix){Plugin=plugins[prefix],(this.life.plugins[prefix]=!Plugin.lazy)?this[prefix]=new Plugin(this):gui.Plugin.runonaccessor(this,prefix,Plugin)},this)},$debug:function(constructing){var val,elm=this.element;constructing?elm.hasAttribute("gui")||(val="["+this.displayName+"]",elm.setAttribute("gui",val)):(val=elm.getAttribute("gui"),val&&val.startsWith("[")&&elm.removeAttribute("gui"))}},{portals:!0,infuse:function(){var C=gui.Class.extend.apply(this,arguments);C.$plugins=gui.Object.copy(this.$plugins);var b=gui.Class.breakdown(arguments);return gui.Object.each(C.$plugins,function(prefix,plugin){var def=b.protos[prefix];switch(gui.Type.of(def)){case"object":var mutant=plugin.extend(def);C.plugin(prefix,mutant,!0);break;case"undefined":break;default:throw new TypeError(C+": Bad definition: "+prefix)}},this),C},summon:function(doc){return this.possess((doc||document).createElement("div"))},possess:function(element){return gui.Guide.possess(element,this)},extend:function(){throw Error('Spirits must use the "infuse" method and not "extend".\nThis method extends both the spirit and it\'s plugins.')},plugin:function(prefix,plugin,override){var plugins=this.$plugins,proto=this.prototype;!proto.hasOwnProperty(prefix)||null===proto.prefix||override?(!plugins[prefix]||override)&&(plugins[prefix]=plugin,proto.prefix=null,gui.Class.children(this,function(child){child.plugin(prefix,plugin,override)})):console.error("Plugin naming crash in "+this+": "+prefix)},$plugins:Object.create(null)},{$construct:function(spirit){spirit.$pluginplugins(),spirit.$debug(!0),spirit.life.constructed=!0,spirit.onconstruct(),spirit.life.dispatch(gui.LIFE_CONSTRUCT)},$configure:function(spirit){spirit.attconfig.configureall(),spirit.life.configured=!0,spirit.onconfigure(),spirit.life.dispatch(gui.LIFE_CONFIGURE)},$enter:function(spirit){spirit.window.gui.inside(spirit),spirit.life.entered=!0,spirit.onenter(),spirit.life.dispatch(gui.LIFE_ENTER)},$attach:function(spirit){spirit.window.gui.inside(spirit),spirit.life.attached=!0,spirit.onattach(),spirit.life.dispatch(gui.LIFE_ATTACH)},$ready:function(spirit){spirit.life.ready=!0,spirit.onready(),spirit.life.dispatch(gui.LIFE_READY)},$detach:function(spirit){spirit.window.gui.outside(spirit),spirit.life.detached=!0,spirit.life.visible=!1,spirit.life.dispatch(gui.LIFE_DETACH),spirit.life.dispatch(gui.LIFE_INVISIBLE),spirit.ondetach()},$exit:function(spirit){spirit.life.exited=!0,spirit.life.dispatch(gui.LIFE_EXIT),spirit.onexit()},$async:function(spirit){spirit.life.async=!0,spirit.onasync(),spirit.life.dispatch(gui.LIFE_ASYNC)},$destruct:function(spirit){spirit.window.gui.destruct(spirit),spirit.$debug(!1),spirit.life.destructed=!0,spirit.life.dispatch(gui.LIFE_DESTRUCT),spirit.ondestruct()},$dispose:function(spirit){spirit.$ondestruct(),gui.GreatSpirit.$meet(spirit)}}),gui.Plugin=gui.Class.create("gui.Plugin",Object.prototype,{spirit:null,context:null,onconstruct:function(){},ondestruct:function(){},handleEvent:function(e){gui.Type.isFunction(this.onevent)&&this.onevent(e)},$onconstruct:function(spirit){this.spirit=spirit||null,this.context=spirit?spirit.window:null,this.onconstruct()},$ondestruct:function(){gui.GreatSpirit.$nukeallofit(this,this.spirit.window)}},{lazy:!0,infuse:function(){throw Error('Plugins must use the "extend" method and not "infuse".')}},{runonaccessor:function(spirit,prefix,Plugin){Object.defineProperty(spirit,prefix,{enumerable:!0,configurable:!0,get:function(){var plugin=new Plugin(this);return this.life.plugins[prefix]=!0,Object.defineProperty(this,prefix,{enumerable:!0,configurable:!0,get:function(){return plugin}}),plugin}})}}),gui.Tracker=gui.Plugin.extend("gui.Tracker",{_xxx:null,_sig:null,onconstruct:function(){this._super.onconstruct(),this._xxx=Object.create(null),this.spirit&&(this._sig=this.spirit.window.gui.$contextid)},ondestruct:function(){this._super.ondestruct(),gui.Object.each(this._xxx,function(type,list){list.slice(0).forEach(function(checks){this._cleanup(type,checks)},this)},this)},toggle:function(){console.error("@TODO SpiritTracker#toggle")},contains:function(arg){return this._breakdown(arg).every(function(type){return this._xxx[type]},this)},_global:!1,_globalize:function(operation){this._global=!0;var res=operation.call(this);return this._global=!1,res},_addchecks:function(type,checks){var result=!1,list=this._xxx[type];return list?result=!this._haschecks(list,checks):(list=this._xxx[type]=[],result=!0),result&&list.push(checks),result},_removechecks:function(type,checks){var result=!1,list=this._xxx[type];if(list){var index=this._checksindex(list,checks);index>-1&&(result=!0,0===gui.Array.remove(list,index)&&delete this._xxx[type])}return result},_containschecks:function(type,checks){var result=!1,list=this._xxx[type];return list&&(result=this._haschecks(list,checks)),result},_haschecks:function(list,checks){var result=!1;return list.every(function(a){return a.every(function(b,i){return b===checks[i]})&&(result=!0),!result}),result},_hashandlers:function(){return Object.keys(this._xxx).length>0},_checksindex:function(list,checks){var result=-1;return list.every(function(a,index){return a.every(function(b,i){return b===checks[i]})&&(result=index),-1===result}),result},_breakdown:function(arg){var result=null;switch(gui.Type.of(arg)){case"array":result=arg;break;case"string":result=arg.split(" ")}return result},_cleanup:function(type,checks){this._removechecks(type,checks)}}),gui.Module=gui.Class.create("gui.Module",Object.prototype,{plugins:null,mixins:null,channels:null,oncontextinitialize:function(){},onbeforespiritualize:function(){},onafterspiritualize:function(){},oncontextload:function(){},oncontextunload:function(){},$onconstruct:function(context){var base=context.gui.Spirit;gui.Type.isObject(this.mixins)&&gui.Object.each(this.mixins,function(name,value){base.mixin(name,value)}),gui.Type.isObject(this.plugins)&&gui.Object.each(this.plugins,function(prefix,plugin){gui.Type.isDefined(plugin)?base.plugin(prefix,plugin):console.error("Undefined plugin for prefix: "+prefix)}),gui.Type.isArray(this.channels)&&this.channels.forEach(function(channel){var query=channel[0],klass=channel[1];context.gui.channel(query,klass)},this),this.$setupcontext(context)},$setupcontext:function(context){var that=this,msg1=gui.BROADCAST_WILL_SPIRITUALIZE,msg2=gui.BROADCAST_DID_SPIRITUALIZE;this.oncontextinitialize&&this.oncontextinitialize(context),gui.Broadcast.addGlobal([msg1,msg2],{onbroadcast:function(b){if(b.data===context.gui.$contextid)switch(gui.Broadcast.removeGlobal(b.type,this),b.type){case msg1:gui.Type.isFunction(that.onbeforespiritualize)&&that.onbeforespiritualize(context);break;case msg2:gui.Type.isFunction(that.onafterspiritualize)&&that.onafterspiritualize(context)}}})}}),gui.GreatSpirit={DENIAL:"Attempt to handle destructed spirit",toString:function(){return"[object gui.GreatSpirit]"},$meet:function(spirit){var prefixes=[],plugins=spirit.life.plugins;gui.Object.each(plugins,function(prefix,instantiated){instantiated?"life"!==prefix&&prefixes.push(prefix):Object.defineProperty(spirit,prefix,{enumerable:!0,configurable:!0,get:function(){},set:function(){}})}),this.$nukeplugins(spirit,prefixes.sort()),this.$nukeplugins(spirit,["life"]),this.$nukeelement(spirit),this.$nukeallofit(spirit,spirit.window)},$nukeplugins:function(spirit,prefixes){var plugins=prefixes.map(function(key){return spirit[key]},this);plugins.forEach(function(plugin){plugin.ondestruct()}),plugins.forEach(function(plugin){plugin.$ondestruct()})},$nukeelement:function(spirit){try{spirit.element.spirit=null}catch(denied){}},$nukeallofit:function(thing,context){var nativeprops=context.Object.prototype;for(var prop in thing)if(void 0===nativeprops[prop]){var desc=Object.getOwnPropertyDescriptor(thing,prop);(!desc||desc.configurable)&&Object.defineProperty(thing,prop,this.DENIED)}},DENIED:{enumerable:!0,configurable:!0,get:function(){gui.GreatSpirit.DENY()},set:function(){gui.GreatSpirit.DENY()}},DENY:function(){var stack,e=Error(gui.Spirit.DENIAL);throw!gui.Client.isExplorer&&(stack=e.stack)?(stack=gui.Client.isWebKit?stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@").split("\n"):stack.split("\n"),stack.shift(),stack.shift(),Error(e.message+"\n"+stack)):e}},gui.Life=function(target,type){this.target=target,this.type=type},gui.Life.prototype={target:null,type:null,toString:function(){return"[object gui.Life]"}},gui.LifePlugin=gui.Tracker.extend("gui.LifePlugin",{constructed:!1,configured:!1,entered:!1,attached:!1,detached:!0,ready:!1,exited:!1,destructed:!1,visible:void 0,plugins:null,onconstruct:function(){this._super.onconstruct(),this._handlers=Object.create(null),this.plugins=Object.create(null)},add:function(arg,handler){return handler=handler?handler:this.spirit,this._breakdown(arg).forEach(function(type){this._addchecks(type,[handler])&&(this._handlers[type]||(this._handlers[type]=[]),this._handlers[type].push(handler))},this),this.spirit},remove:function(arg,handler){return handler=handler?handler:this.spirit,this._breakdown(arg).forEach(function(type){if(this._removechecks(type,[handler])){var index=this._handlers[type].indexOf(type);this._handlers[type].remove(index),0===this._handlers[type].length&&delete this._handlers[type]}},this),this.spirit},dispatch:function(type){var list=this._handlers[type];if(void 0!==list){var life=new gui.Life(this.spirit,type);switch(list.forEach(function(handler){handler.onlife(life)}),type){case gui.Life.CONSTRUCT:case gui.Life.CONFIGURE:case gui.Life.ENTER:case gui.Life.READY:case gui.Life.DETACH:case gui.Life.EXIT:case gui.Life.DESTRUCT:delete this._handlers[type]}}},_handlers:null,_cleanup:function(type,checks){var handler=checks[0];this.remove(type,handler)}}),gui.AttConfigPlugin=gui.Plugin.extend("gui.AttConfigPlugin",{map:null,configureall:function(){var atts=this.spirit.element.attributes;Array.forEach(atts,function(att){this.configureone(att.name,att.value)},this)},configureone:function(name,value){name.startsWith(gui.AttConfigPlugin.PREFIX)&&this._evaluate(this._lookup(name),value)},_evaluate:function(name,value){var prefix=gui.AttConfigPlugin.PREFIX,didconfigure=!1,struct=this.spirit,success=!0,prop=null,cuts=null;name=prop=name.split(prefix)[1],name.indexOf(".")>-1&&(cuts=name.split("."),cuts.forEach(function(cut,i){gui.Type.isDefined(struct)?cuts.length-1>i?struct=struct[cut]:prop=cut:success=!1})),success&&gui.Type.isDefined(struct[prop])?(value=gui.Type.cast(value),gui.Type.isFunction(struct[prop])?struct[prop](value):struct[prop]=value,didconfigure=!0):console.error('No definition for "'+name+'": '+(""+this.spirit))},_lookup:function(name){var prefix=gui.AttConfigPlugin.PREFIX;return this.map&&this.map.hasOwnProperty(name)&&(name=this.map[name],name.startsWith(prefix)||(name=prefix+name)),name}},{PREFIX:"gui.",lazy:!1}),gui.Action=function(target,type,data,direction,global){this.target=target,this.type=type,this.data=data,this.direction=direction||gui.Action.ASCEND,this.global=global||!1},gui.Action.prototype={target:null,type:null,data:null,direction:null,global:!1,$instanceid:null,isConsumed:!1,isCancelled:!1,consumer:null,consume:function(consumer){this.isConsumed=!0,this.consumer=consumer},cancel:function(consumer){this.isCancelled=!0,this.consume(consumer)},toString:function(){return"[object gui.Action]"}},gui.Action.DESCEND="descend",gui.Action.ASCEND="ascend",gui.Action.dispatch=function(target,type,data,direction,global){var action=new gui.Action(target,type,data,direction,global),crawler=new gui.Crawler(gui.CRAWLER_ACTION);return crawler.global=global||!1,crawler[direction||"ascend"](target,{handleSpirit:function(spirit){var directive=gui.Crawler.CONTINUE;return spirit.action.contains(type)&&(spirit.action.$onaction(action),action.isConsumed&&(directive=gui.Crawler.STOP,action.consumer=spirit)),directive},transcend:function(win,uri,key){var msg=gui.Action.stringify(action,key);win.postMessage(msg,uri)}}),action},gui.Action.stringify=function(a,key){var prefix="spiritual-action:";return prefix+function(){return a.target=null,a.data=function(d){if(gui.Type.isComplex(d))if(gui.Type.isFunction(d.stringify))d=d.stringify();else try{JSON.stringify(d)}catch(jsonexception){d=null}return d}(a.data),a.$instanceid=key||null,JSON.stringify(a)}()},gui.Action.parse=function(msg){var prefix="spiritual-action:";return msg.startsWith(prefix)?JSON.parse(msg.split(prefix)[1]):void 0},gui.ActionPlugin=function(confirmed,chained){return gui.Tracker.extend("gui.ActionPlugin",{type:null,data:null,add:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.IActionHandler,handler)&&this._breakdown(arg).forEach(function(type){this._addchecks(type,[handler,this._global])},this)})),remove:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.IActionHandler,handler)&&this._breakdown(arg).forEach(function(type){this._removechecks(type,[handler,this._global])},this)})),addGlobal:function(arg,handler){return this._globalize(function(){return this.add(arg,handler)})},removeGlobal:function(arg,handler){return this._globalize(function(){return this.remove(arg,handler)})},dispatch:confirmed("string","(*)","(string)")(function(type,data,direction){return gui.Action.dispatch(this.spirit,type,data,direction||"ascend",this._global)}),ascend:function(arg,data){return this.dispatch(arg,data,"ascend")},descend:function(arg,data){return this.dispatch(arg,data,"descend")},dispatchGlobal:function(arg,data){return this._globalize(function(){return this.dispatch(arg,data)})},ascendGlobal:function(arg,data){return this._globalize(function(){return this.ascend(arg,data)})},descendGlobal:function(arg,data){return this._globalize(function(){return this.descend(arg,data)})},_cleanup:function(type,checks){var handler=checks[0],global=checks[1];global?this.removeGlobal(type,handler):this.remove(type,handler)},$handleownaction:!1,$onaction:function(action){var list=this._xxx[action.type];list&&list.forEach(function(checks){var handler=checks[0],matches=checks[1]===action.global,hacking=handler===this.spirit&&this.$handleownaction;matches&&(handler!==action.target||hacking)&&handler.onaction(action)},this)}})}(gui.Arguments.confirmed,gui.Combo.chained),gui.IActionHandler={toString:function(){return"[object IActionHandler]"},onaction:function(){}},gui.Att=function(name,value){this.value=gui.Type.cast(value),this.name=this.type=name},gui.Att.prototype={name:null,type:null,value:null},gui.AttPlugin=function(confirmed,chained){return gui.Tracker.extend("gui.AttPlugin",{get:function(name){return gui.AttPlugin.get(this.spirit.element,name)},set:chained(function(name,value){this.$suspended||gui.AttPlugin.set(this.spirit.element,name,value)}),has:function(name){return gui.AttPlugin.has(this.spirit.element,name)},del:chained(function(name){this.$suspended||gui.AttPlugin.del(this.spirit.element,name)}),all:function(){return gui.AttPlugin.all(this.spirit.element)},getmap:function(){return gui.AttPlugin.getmap(this.spirit.element)},setmap:function(map){gui.AttPlugin.setmap(this.spirit.element,map)},add:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.IAttHandler,handler)&&this._breakdown(arg).forEach(function(type){this._addchecks(type,[handler]),this._onadd(type)},this)})),remove:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.IAttHandler,handler)&&this._breakdown(arg).forEach(function(type){this._removechecks(type,[handler])},this)})),$suspended:!1,$suspend:function(action){this.$suspended=!0;var res=action();return this.$suspended=!1,res},$onatt:function(name,value){var list,att,handler;name.startsWith(gui.AttConfigPlugin.PREFIX)?this.spirit.attconfig.configureone(name,value):(list=this._xxx[name])&&(att=new gui.Att(name,value),list.forEach(function(checks){handler=checks[0],handler.onatt(att)},this))},_onadd:function(name){if(this.has(name)){var value=this.get(name);name.startsWith(gui.AttConfigPlugin.PREFIX)?this.spirit.attconfig.configureone(name,value):this.$onatt(name,value)}}},{},{get:function(elm,name){return gui.Type.cast(elm.getAttribute(name))},set:chained(function(elm,name,value){var spirit=elm.spirit;null===value?this.del(elm,name):(value+="",elm.getAttribute(name)!==value&&(spirit?(spirit.att.$suspend(function(){elm.setAttribute(name,value)}),spirit.att.$onatt(name,value)):elm.setAttribute(name,value)))}),has:function(elm,name){return elm.hasAttribute(name)},del:chained(function(elm,name){var spirit=elm.spirit;spirit?(spirit.att.$suspend(function(){elm.removeAttribute(name)}),spirit.attconfig.configureone(name,null)||spirit.att.$onatt(name,null)):elm.removeAttribute(name)}),all:function(elm){return gui.Object.toArray(elm.attributes)},getmap:function(elm){var map=Object.create(null);return this.all(elm).forEach(function(att){map[att.name]=gui.Type.cast(att.value)}),map},setmap:chained(function(elm,map){gui.Object.each(map,function(name,value){this.set(elm,name,value)},this)})})}(gui.Arguments.confirmed,gui.Combo.chained),gui.IAttHandler={toString:function(){return"[object IAttHandler]"},onatt:function(){}},gui.BoxPlugin=gui.Plugin.extend("gui.BoxPlugin",{width:0,height:0,localX:0,localY:0,pageX:0,pageY:0,clientX:0,clientY:0,_scrollroot:function(){return function(doc){return"html"===gui.Client.scrollRoot.localName?doc.documentElement:doc.body}(this.spirit.document)}}),Object.defineProperties(gui.BoxPlugin.prototype,{width:{get:function(){return this.spirit.element.offsetWidth}},height:{get:function(){return this.spirit.element.offsetHeight}},localX:{get:function(){return this.spirit.element.offsetLeft}},localY:{get:function(){return this.spirit.element.offsetTop}},pageX:{get:function(){return this.clientX+this._scrollroot().scrollLeft}},pageY:{get:function(){return this.clientY+this._scrollroot().scrollTop}},clientX:{get:function(){return this.spirit.element.getBoundingClientRect().left}},clientY:{get:function(){return this.spirit.element.getBoundingClientRect().top}}}),function(confirmed,chained){gui.Broadcast=function(target,type,data,global,sig){this.target=target,this.type=type,this.data=data,this.isGlobal=global,this.$contextids=[],this.$contextid=sig||gui.$contextid},gui.Broadcast.prototype={target:null,type:null,data:null,isGlobal:!1,$contextid:null,$contextids:null,toString:function(){return"[object gui.Broadcast]"}},gui.Broadcast._globals=Object.create(null),gui.Broadcast._locals=Object.create(null),gui.Broadcast.add=chained(function(message,handler,sig){this._add(message,handler,sig||gui.$contextid)}),gui.Broadcast.remove=chained(function(message,handler,sig){this._remove(message,handler,sig||gui.$contextid)}),gui.Broadcast.dispatch=function(target,type,data,sig){return this._dispatch(target,type,data,sig||gui.$contextid)},gui.Broadcast.addGlobal=chained(function(message,handler){this._add(message,handler)}),gui.Broadcast.removeGlobal=chained(function(message,handler){this._remove(message,handler)}),gui.Broadcast.dispatchGlobal=function(target,type,data){return this._dispatch(target,type,data)},gui.Broadcast.stringify=function(b){var prefix="spiritual-broadcast:";return prefix+function(){return b.target=null,b.data=function(d){if(gui.Type.isComplex(d))if(gui.Type.isFunction(d.stringify))d=d.stringify();else try{JSON.stringify(d)}catch(jsonexception){d=null}return d}(b.data),JSON.stringify(b)}()},gui.Broadcast.parse=function(msg){var prefix="spiritual-broadcast:";return msg.startsWith(prefix)?JSON.parse(msg.split(prefix)[1]):void 0},gui.Broadcast._add=confirmed("array|string","object|function","(string)")(function(type,handler,sig){if(gui.Interface.validate(gui.IBroadcastHandler,handler))if(gui.Type.isArray(type))type.forEach(function(t){this._add(t,handler,sig)},this);else{var map;sig?(map=this._locals[sig],map||(map=this._locals[sig]=Object.create(null))):map=this._globals,map[type]||(map[type]=[]);var array=map[type];-1===array.indexOf(handler)&&array.push(handler)}}),gui.Broadcast._remove=function(message,handler,sig){if(gui.Interface.validate(gui.IBroadcastHandler,handler))if(gui.Type.isArray(message))message.forEach(function(msg){this._remove(msg,handler,sig)},this);else{var index,array=function(locals,globals){return sig?locals[sig]?locals[sig][message]:void 0:globals[message]}(this._locals,this._globals);array&&(index=array.indexOf(handler),index>-1&&gui.Array.remove(array,index))}},gui.Broadcast._dispatch=function(target,type,data,sig){var global=!gui.Type.isString(sig),map=global?this._globals:this._locals[sig],b=new gui.Broadcast(target,type,data,global,sig);
if(map){var handlers=map[type];handlers&&handlers.slice().forEach(function(handler){handler.onbroadcast(b)})}if(global){var root=document.documentElement.spirit;root&&root.propagateBroadcast(b)}return b}}(gui.Arguments.confirmed,gui.Combo.chained),gui.BroadcastPlugin=function(chained){return gui.Tracker.extend("gui.BroadcastPlugin",{add:chained(function(arg,handler){handler=handler?handler:this.spirit;var sig=this._global?null:this._sig;this._breakdown(arg).forEach(function(type){this._addchecks(type,[handler,this._global])&&(this._global?gui.Broadcast.addGlobal(type,handler):gui.Broadcast.add(type,handler,sig))},this)}),remove:chained(function(arg,handler){handler=handler?handler:this.spirit;var sig=this._global?null:this._sig;this._breakdown(arg).forEach(function(type){this._removechecks(type,[handler,this._global])&&(this._global?gui.Broadcast.removeGlobal(type,handler):gui.Broadcast.remove(type,handler,sig))},this)}),dispatch:function(arg,data){var result=null,sig=this._global?null:this._sig;return this._breakdown(arg).forEach(function(type){result=this._global?gui.Broadcast.dispatchGlobal(this.spirit,type,data):gui.Broadcast.dispatch(this.spirit,type,data,sig)},this),result},addGlobal:function(arg,handler){return this._globalize(function(){return this.add(arg,handler)})},removeGlobal:function(arg,handler){return this._globalize(function(){return this.remove(arg,handler)})},dispatchGlobal:function(arg,data){return this._globalize(function(){return this.dispatch(arg,data)})},_cleanup:function(type,checks){var handler=checks[0],global=checks[1];global?null:this._sig,global?gui.Broadcast.removeGlobal(type,handler):gui.Broadcast.remove(type,handler,this._sig)}})}(gui.Combo.chained),gui.IBroadcastHandler={toString:function(){return"[object IBroadcastHandler]"},onbroadcast:function(){}},gui.CSSPlugin=function(chained){return gui.Plugin.extend("gui.CSSPlugin",{add:chained(function(name){gui.CSSPlugin.add(this.spirit.element,name)}),remove:chained(function(name){gui.CSSPlugin.remove(this.spirit.element,name)}),toggle:chained(function(name){gui.CSSPlugin.toggle(this.spirit.element,name)}),contains:function(name){return gui.CSSPlugin.contains(this.spirit.element,name)},set:chained(function(prop,val){gui.CSSPlugin.set(this.spirit.element,prop,val)}),style:chained(function(map){gui.CSSPlugin.style(this.spirit.element,map)}),get:function(prop){return gui.CSSPlugin.get(this.spirit.element,prop)},compute:function(prop){return gui.CSSPlugin.compute(this.spirit.element,prop)},name:chained(function(name){var result=this.spirit.element.className;return void 0!==name&&(this.spirit.element.className=name,result=this.spirit),result}),matches:function(selector){return gui.CSSPlugin.matches(this.spirit.element,selector)}},{},{add:chained(function(element,name){if(name.indexOf(" ")>-1&&(name=name.split(" ")),gui.Type.isArray(name))name.forEach(function(n){this.add(element,n)},this);else if(this._supports)element.classList.add(name);else{var now=element.className.split(" ");-1===now.indexOf(name)&&(now.push(name),element.className=now.join(" "))}}),remove:chained(function(element,name){if(name.indexOf(" ")>-1&&(name=name.split(" ")),gui.Type.isArray(name))name.forEach(function(n){this.remove(element,n)},this);else if(this._supports)element.classList.remove(name);else{var now=element.className.split(" "),idx=now.indexOf(name);idx>-1&&gui.Array.remove(now,idx),element.className=now.join(" ")}}),toggle:chained(function(element,name){this._supports?element.classList.toggle(name):this.contains(element,name)?this.remove(element,name):this.add(element,name)}),contains:function(element,name){if(this._supports)return element.classList.contains(name);var classnames=element.className.split(" ");return classnames.indexOf(name)>-1},set:chained(function(element,prop,value){gui.Type.isNumber(value)&&(value=(this._shorthands[prop]||"@").replace("@",value)),value+="","float"===prop?prop="cssFloat":(value=this.jsvalue(value),prop=this.jsproperty(prop)),element.style[prop]=value}),get:function(element,prop){return prop=this.jsproperty(prop),this.jsvalue(element.style[prop])},style:function(thing,styles){var element=thing instanceof gui.Spirit?thing.element:thing;return gui.Object.each(styles,function(prop,value){this.set(element,prop,value)},this),thing},compute:function(thing,prop){var element=thing instanceof gui.Spirit?thing.element:thing,doc=element.ownerDocument,win=doc.defaultView;return prop=this._standardcase(this.jsproperty(prop)),win.getComputedStyle(element,null).getPropertyValue(prop)},matches:function(node,selector){return node[this._matchmethod](selector)},jsproperty:function(prop){var vendors=this._vendors,fixt=prop,element=document.documentElement;return prop+="",prop.startsWith("-beta-")?vendors.every(function(vendor){var test=this._camelcase(prop.replace("-beta-",vendor));return void 0!==element.style[test]?(fixt=test,!1):!0},this):fixt=this._camelcase(fixt),fixt},jsvalue:function(value){var vendors=this._vendors,element=document.documentElement;if(value+="",value&&value.contains("-beta-")){var parts=[];value.split(", ").forEach(function(part){(part=part.trim()).startsWith("-beta-")?vendors.every(function(vendor){var test=this._camelcase(part.replace("-beta-",vendor));return void 0!==element.style[test]?(parts.push(part.replace("-beta-",vendor)),!1):!0},this):parts.push(part)},this),value=parts.join(",")}return value},cssproperty:function(prop){return this._standardcase(this.jsproperty(prop))},cssvalue:function(value){return this._standardcase(this.jsvalue(value))},_vendors:["","-webkit-","-moz-","-ms-","-o-"],_supports:void 0!==document.documentElement.classList,_camelcase:function(string){return string.replace(/-([a-z])/gi,function(all,letter){return letter.toUpperCase()})},_standardcase:function(string){return string.replace(/[A-Z]/g,function(all,letter){return"-"+string.charAt(letter).toLowerCase()})},_shorthands:{top:"@px",right:"@px",bottom:"@px",left:"@px",width:"@px",height:"@px",maxWidth:"@px",maxHeight:"@px",minWidth:"@px",minHeight:"@px",textIndent:"@px",fontWeight:"@",opacity:"@",zIndex:"@",position:"@",display:"@",visibility:"@"},_matchmethod:function(){var match=null,root=document.documentElement;return["mozMatchesSelector","webkitMatchesSelector","msMatchesSelector","oMatchesSelector","matchesSelector"].every(function(method){return gui.Type.isDefined(root[method])&&(match=method),null===match}),match}()})}(gui.Combo.chained),function(){function getset(prop){Object.defineProperty(gui.CSSPlugin.prototype,prop,{enumerable:!0,configurable:!0,get:function(){return parseInt(this.get(prop),10)},set:function(val){this.set(prop,val)}})}var shorts=gui.CSSPlugin._shorthands;for(var prop in shorts)shorts.hasOwnProperty(prop)&&getset(prop)}(),gui.DOMPlugin=function(chained){return gui.Plugin.extend("gui.DOMPlugin",{id:chained(function(id){return id?(this.spirit.element.id=id,void 0):this.spirit.element.id||null}),title:chained(function(title){var element=this.spirit.element;return gui.Type.isDefined(title)?(element.title=title?title:"",void 0):element.title}),html:chained(function(html,position){var element=this.spirit.element;return gui.Type.isString(html)?(position?element.insertAdjacentHTML(position,html):gui.DOMPlugin.html(element,html),void 0):element.innerHTML}),empty:chained(function(){this.html("")}),text:chained(function(text){var elm=this.spirit.element;return gui.Type.isString(text)?(elm.textContent=text,this):elm.textContent}),hide:chained(function(){this.spirit.css.contains(gui.CLASS_HIDDEN)||(this.spirit.css.add(gui.CLASS_HIDDEN),this.spirit.visibility.off())}),show:chained(function(){this.spirit.css.contains(gui.CLASS_HIDDEN)&&(this.spirit.css.remove(gui.CLASS_HIDDEN),this.spirit.visibility.on())}),tag:function(name,text){var res=null,doc=this.spirit.document,elm=this.spirit.element;return name?(res=doc.createElement(name),gui.Type.isString(text)&&res.appendChild(doc.createTextNode(text))):res=elm.localName,res},embedded:function(){return gui.DOMPlugin.embedded(this.spirit.element)},remove:function(){var parent=this.spirit.element.parentNode;parent.removeChild(this.spirit.element)},clone:function(){return this.spirit.element.cloneNode(!0)},ordinal:function(){return gui.DOMPlugin.ordinal(this.spirit.element)},compare:function(other){return gui.DOMPlugin.compare(this.spirit.element,other)}},{},{html:function(element,markup){var guide=gui.Guide;if(element.nodeType===Node.ELEMENT_NODE&&gui.Type.isString(markup)){var nodes=new gui.HTMLParser(element.ownerDocument).parse(markup,element);guide.materializeSub(element),guide.suspend(function(){gui.Observer.suspend(element,function(){for(;element.firstChild;)element.removeChild(element.firstChild);nodes.forEach(function(node){element.appendChild(node)})})}),guide.spiritualizeSub(element)}return element.innerHTML},outerHtml:function(element,markup){var res=element.outerHTML,guide=gui.Guide;if(!element.nodeType)throw new TypeError;if(gui.Type.isString(markup)){var nodes=new gui.HTMLParser(element.ownerDocument).parse(markup,element),parent=element.parentNode;guide.materialize(element),guide.suspend(function(){gui.Observer.suspend(parent,function(){for(;nodes.length;)parent.insertBefore(nodes.pop(),element);parent.removeChild(element)})}),guide.spiritualizeSub(parent),res=element}return res},ordinal:function(element){for(var result=0,node=element.parentNode.firstElementChild;null!==node&&node!==element;)node=node.nextElementSibling,result++;return result},compare:function(node1,node2){return node1=node1 instanceof gui.Spirit?node1.element:node1,node2=node2 instanceof gui.Spirit?node2.element:node2,node1.compareDocumentPosition(node2)},contains:function(node,othernode){var check=Node.DOCUMENT_POSITION_CONTAINS+Node.DOCUMENT_POSITION_PRECEDING;return this.compare(othernode,node)===check},follows:function(node,othernode){return this.compare(othernode,node)===Node.DOCUMENT_POSITION_FOLLOWING},precedes:function(node,othernode){return this.compare(othernode,node)===Node.DOCUMENT_POSITION_PRECEDING},embedded:function(node){return node=node instanceof gui.Spirit?node.element:node,this.contains(node.ownerDocument,node)},group:function(nodes){function containedby(target,others){return others.some(function(other){return gui.DOMPlugin.contains(other,target)})}for(var node,groups=[];node=nodes.pop();)containedby(node,nodes)||groups.push(node);return groups},q:function(node,selector,type){var result=null;return this._qualify(node,selector)(function(node,selector){return result=type?this.qall(node,selector,type)[0]||null:node.querySelector(selector)})},qall:function(node,selector,type){var result=[];return this._qualify(node,selector)(function(node,selector){return result=gui.Array.toArray(node.querySelectorAll(selector)),type&&(result=result.filter(function(el){return el.spirit&&el.spirit instanceof type}).map(function(el){return el.spirit})),result})},_qualify:function(node,selector){var id,hadid=!0,regexp=this._thiskeyword;return node.nodeType===Node.ELEMENT_NODE&&regexp.test(selector)&&(hadid=node.id,id=node.id=node.id||gui.KeyMaster.generateKey(),selector=selector.replace(regexp,"#"+id),node=node.ownerDocument),function(action){var res=action.call(gui.DOMPlugin,node,selector);return hadid||(node.id=""),res}},_thiskeyword:/^this|,this/g})}(gui.Combo.chained),gui.Object.each({q:function(selector,type){return gui.DOMPlugin.q(this.spirit.element,selector,type)},qall:function(selector,type){return gui.DOMPlugin.qall(this.spirit.element,selector,type)},qdoc:function(){var root=this.spirit.document.documentElement;return root.spirit.dom.q.apply(root.spirit.dom,arguments)},qdocall:function(){var root=this.spirit.document.documentElement;return root.spirit.dom.qall.apply(root.spirit.dom,arguments)}},function(name,method){gui.DOMPlugin.mixin(name,function(){var selector=arguments[0],type=arguments[1];if(gui.Type.isString(selector)){if(1===arguments.length||gui.Type.isFunction(type))return method.apply(this,arguments);throw type=gui.Type.of(type),new TypeError("Unknown spirit for query: "+name+"("+selector+","+type+")")}throw new TypeError("Bad selector for query: "+name+"("+selector+")")})}),gui.Object.each({preceding:function(){console.error("TODO")},following:function(){console.error("TODO")},next:function(type){var result=null,spirit=null,el=this.spirit.element;if(type){for(;null!==(el=el.nextElementSibling);)if(spirit=el.spirit,null!==spirit&&spirit instanceof type){result=spirit;break}}else result=el.nextElementSibling;return result},previous:function(type){var result=null,spirit=null,el=this.spirit.element;if(type){for(;null!==(el=el.previousElementSibling);)if(spirit=el.spirit,null!==spirit&&spirit instanceof type){result=spirit;break}}else result=el.previousElementSibling;return result},first:function(type){var result=null,spirit=null,el=this.spirit.element.firstElementChild;if(type)for(;null===result&&null!==el;)spirit=el.spirit,null!==spirit&&spirit instanceof type&&(result=spirit),el=el.nextElementSibling;else result=el;return result},last:function(type){var result=null,spirit=null,el=this.spirit.element.lastElementChild;if(type)for(;null===result&&null!==el;)spirit=el.spirit,null!==spirit&&spirit instanceof type&&(result=spirit),el=el.previoustElementSibling;else result=el;return result},parent:function(type){var result=this.spirit.element.parentNode;if(type){var spirit=result.spirit;result=spirit&&spirit instanceof type?spirit:null}return result},child:function(type){var result=this.spirit.element.firstElementChild;return type&&(result=this.children(type)[0]||null),result},children:function(type){var result=gui.Object.toArray(this.spirit.element.children);return type&&(result=result.filter(function(elm){return elm.spirit&&elm.spirit instanceof type}).map(function(elm){return elm.spirit})),result},ancestor:function(type){var result=this.parent();return type&&(result=null,(new gui.Crawler).ascend(this.spirit.element,{handleSpirit:function(spirit){return spirit instanceof type?(result=spirit,gui.Crawler.STOP):void 0}})),result},ancestors:function(type){var result=[],crawler=new gui.Crawler;return type?crawler.ascend(this.element,{handleSpirit:function(spirit){spirit instanceof type&&result.push(spirit)}}):crawler.ascend(this.element,{handleElement:function(el){result.push(el)}}),result},descendant:function(type){var result=this.child(),me=this.spirit.element;return type&&(new gui.Crawler).descend(me,{handleSpirit:function(spirit){return spirit instanceof type&&spirit.element!==me?(result=spirit,gui.Crawler.STOP):void 0}}),result},descendants:function(type){var result=[],me=this.spirit.element;return(new gui.Crawler).descend(me,{handleElement:function(element){type||element===me||result.push(element)},handleSpirit:function(spirit){type&&spirit instanceof type&&spirit.element!==me&&result.push(spirit)}}),result}},function(name,method){gui.DOMPlugin.mixin(name,function(type){if(!gui.Type.isDefined(type)||gui.Type.isFunction(type))return method.apply(this,arguments);throw new TypeError("Unknown spirit for query: "+name+"("+gui.Type.of(type)+")")})}),gui.Object.each({append:function(things){var els=things,element=this.spirit.element;els.forEach(function(el){element.appendChild(el)})},prepend:function(things){var els=things,element=this.spirit.element,first=element.firstChild;els.reverse().forEach(function(el){element.insertBefore(el,first)})},before:function(things){var els=things,target=this.spirit.element,parent=target.parentNode;els.reverse().forEach(function(el){parent.insertBefore(el,target)})},after:function(things){var els=things,target=this.spirit.element,parent=target.parentNode;els.forEach(function(el){parent.insertBefore(el,target.nextSibling)})},replace:function(things){this.after(things),this.remove()}},function(name,method){gui.DOMPlugin.mixin(name,function(things){var elms=Array.map(gui.Array.toArray(things),function(thing){return thing&&thing instanceof gui.Spirit?thing.element:thing}).filter(function(thing){return thing&&gui.Type.isNumber(thing.nodeType)});return elms.length&&method.call(this,elms),things})}),gui.EventPlugin=function(chained){return gui.Tracker.extend("gui.EventPlugin",{add:chained(function(arg,target,handler,capture){if(target=target?target:this.spirit.element,handler=handler?handler:this.spirit,capture=capture?capture:!1,target instanceof gui.Spirit&&(target=target.element),gui.Interface.validate(gui.IEventHandler,handler)){var checks=[target,handler,capture];this._breakdown(arg).forEach(function(type){this._addchecks(type,checks)&&target.addEventListener(type,handler,capture)},this)}}),remove:chained(function(arg,target,handler,capture){if(target=target?target:this.spirit.element,handler=handler?handler:this.spirit,capture=capture?capture:!1,target instanceof gui.Spirit&&(target=target.element),gui.Interface.validate(gui.IEventHandler,handler)){var checks=[target,handler,capture];this._breakdown(arg).forEach(function(type){this._removechecks(type,checks)&&target.removeEventListener(type,handler,capture)},this)}}),toggle:chained(function(arg,target,handler,capture){target=target?target:this.spirit.element,handler=handler?handler:this.spirit,capture=capture?capture:!1,target instanceof gui.Spirit&&(target=target.element);var checks=[target,handler,capture];this._breakdown(arg).forEach(function(type){this._contains(type,checks)?this.add(type,target,handler,capture):this.remove(type,target,handler,capture)},this)}),_cleanup:function(type,checks){var target=checks[0],handler=checks[1],capture=checks[2];this.remove(type,target,handler,capture)}})}(gui.Combo.chained),gui.IEventHandler={toString:function(){return"[object IEventHandler]"},handleEvent:function(){},onevent:function(){}},function(confirmed){gui.Tick=function(type){this.type=type},gui.Tick.prototype={type:null,toString:function(){return"[object gui.Tick]"}},gui.Tick.toString=function(){return"[function gui.Tick]"},gui.Tick._global={types:Object.create(null),handlers:Object.create(null)},gui.Tick._local=Object.create(null),gui.Tick.add=confirmed("string|array","object|function","(string)")(function(type,handler,sig){return this._add(type,handler,!1,sig||gui.$contextid)}),gui.Tick.one=confirmed("string|array","object|function","(string)")(function(type,handler,sig){return this._add(type,handler,!0,sig||gui.$contextid)}),gui.Tick.next=function(action,thisp){setImmediate(function(){action.call(thisp)})},gui.Tick.remove=function(type,handler,sig){return sig||console.error("SIG REQUIRED for tick of type: "+type),this._remove(type,handler,sig)},gui.Tick.start=function(){console.error("@TODO gui.Tick.start")},gui.Tick.stop=function(){console.error("@TODO gui.Tick#stop")},gui.Tick.dispatch=function(type,time,sig){return sig||console.error("SIG REQUIRED for tick of type: "+type),this._dispatch(type,time,sig)},gui.Tick.addGlobal=confirmed("string|array","object|function")(function(type,handler){return this._add(type,handler,!1,null)}),gui.Tick.oneGlobal=function(type,handler){return this.add(type,handler,!0,null)},gui.Tick.removeGlobal=function(type,handler){return this._remove(type,handler,null)},gui.Tick.dispatchGlobal=function(type,time){return this._dispatch(type,time,null)},gui.Tick._add=function(type,handler,one,sig){if(gui.Type.isArray(type))type.forEach(function(t){this._add(t,handler,one,sig)},this);else{var list,index,map=sig?this._local[sig]:this._global;map||(map=this._local[sig]={types:Object.create(null),handlers:Object.create(null)}),list=map.handlers[type],list||(list=map.handlers[type]=[]),index=list.indexOf(handler),0>index&&(index=list.push(handler)-1),one&&(list._one=list._one||Object.create(null),list._one[index]=!0)}return this},gui.Tick._remove=function(type,handler,sig){if(gui.Type.isArray(type))type.forEach(function(t){this.remove(t,handler,sig)},this);else{var map=sig?this._local[sig]:this._global,list=map.handlers[type];if(list){var index=list.indexOf(handler);0===gui.Array.remove(list,index)&&delete map.handlers[type]}}return this},gui.Tick._dispatch=function(type,time,sig){var map=sig?this._local[sig]:this._global,types=map.types,tick=new gui.Tick(type);if(gui.Type.isDefined(time)){if(!types[type]){var that=this,id=null;id=0===time?setImmediate(function(){that._dispatch(type,void 0,sig),delete types[type]}):setTimeout(function(){that._dispatch(type,void 0,sig),delete types[type]},time),types[type]=id}}else{var list=map.handlers[type];list&&list.slice().forEach(function(handler){handler.ontick(tick)})}return tick}}(gui.Arguments.confirmed),gui.TickPlugin=function(chained){return gui.Tracker.extend("gui.TickPlugin",{add:chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.ITickHandler,handler)&&this._breakdown(arg).forEach(function(type){this._addchecks(type,[handler,this._global])&&this._add(type,handler,!1)},this)}),remove:chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.ITickHandler,handler)&&this._breakdown(arg).forEach(function(type){this._removechecks(type,[handler,this._global])&&this._remove(type,handler)},this)}),one:chained(function(arg,handler){this.add(arg,handler,!0)}),next:chained(function(action,thisp){gui.Tick.next(action,thisp||this.spirit)}),dispatch:function(type,time){return this._dispatch(type,time||0)},_global:!1,_add:function(type,handler,one){var sig=this.spirit.$contextid;one?this._global?gui.Tick.oneGlobal(type,handler):gui.Tick.one(type,handler,sig):this._global?gui.Tick.addGlobal(type,handler):gui.Tick.add(type,handler,sig)},_remove:function(type,handler){var sig=this.spirit.$contextid;this._global?gui.Tick.removeGlobal(type,handler):gui.Tick.remove(type,handler,sig)},_dispatch:function(type,time){var tick,sig=this.spirit.$contextid;return tick=this._global?gui.Tick.dispatchGlobal(type,time):gui.Tick.dispatch(type,time,sig)},_cleanup:function(type,checks){var handler=checks[0],bglobal=checks[1];this._remove(type,[handler])&&(bglobal?gui.Tick.removeGlobal(type,handler):gui.Tick.remove(type,handler,this.$contextid))}})}(gui.Combo.chained),gui.ITickHandler={toString:function(){return"[object ITickHandler]"},ontick:function(){}},gui.Tween=function(type,data){this.type=type,this.data=data},gui.Tween.prototype={type:null,data:null,value:0,done:!1,toString:function(){return"[object gui.Tween]"}},gui.Tween.dispatchGlobal=function(type,data){function step(){var time=Date.now(),value=1,progress=time-start;if(duration>progress&&(value=progress/duration,"none"!==timing))switch(value=90*value*Math.PI/180,timing){case"ease-in":value=1-Math.cos(value);break;case"ease-out":value=Math.sin(value)}1===value?(tween.value=1,tween.done=!0):(tween.value=value,requestAnimationFrame(step)),gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_TWEEN,tween)}var start=Date.now(),tween=new gui.Tween(type,data),duration=data?data.duration||200:200,timing=data?data.timing||"none":"none";return step(start),tween},gui.TweenPlugin=function(chained){return gui.Tracker.extend("gui.TweenPlugin",{add:chained(function(arg){var sig=this._global?null:this._sig,message=gui.BROADCAST_TWEEN;this._breakdown(arg).forEach(function(type){this._addchecks(type,[this._global])&&(this._global?gui.Broadcast.addGlobal(message,this):gui.Broadcast.add(message,this,sig))},this)}),remove:chained(function(arg){var sig=this._global?null:this._sig,message=gui.BROADCAST_TWEEN;this._breakdown(arg).forEach(function(type){this._removechecks(type,[this._global])&&(this._global?gui.Broadcast.removeGlobal(message,this):gui.Broadcast.remove(message,this,sig))},this)}),dispatch:function(arg,data){var result=null,sig=this._global?null:this._sig;return this._breakdown(arg).forEach(function(type){result=this._global?gui.Tween.dispatchGlobal(type,data):gui.Tween.dispatch(type,data,sig)},this),result},addGlobal:function(arg){return this._globalize(function(){return this.add(arg)})},removeGlobal:function(arg){return this._globalize(function(){return this.remove(arg)})},dispatchGlobal:function(arg,data){return this._globalize(function(){return this.dispatch(arg,data)})},onbroadcast:function(b){switch(b.type){case gui.BROADCAST_TWEEN:var tween=b.data;this._containschecks(tween.type,[b.isGlobal])&&this.spirit.ontween(tween)}},_cleanup:function(type,checks){var message=gui.BROADCAST_TWEEN,global=checks[0];global?null:this._sig,global?gui.Broadcast.removeGlobal(message,this):gui.Broadcast.remove(message,this,this._sig)}})}(gui.Combo.chained),gui.TransitionPlugin=gui.Plugin.extend("gui.TransitionPlugin",{onevent:function(e){e.type===this._endevent&&e.target===this.spirit.element&&this._transitionend(e)},property:function(props){return props&&this.spirit.css.set("-beta-transition-property",props),this._init()},duration:function(time){return time&&(time=gui.Type.isNumber(time)?this._convert(time):time,this.spirit.css.set("-beta-transition-duration",time)),this._init()},timing:function(timing){return timing&&this.spirit.css.set("-beta-transition-timing-function",timing),this._init()},easeIn:function(){return this.timing("ease-in")},easeOut:function(){return this.timing("ease-out")},easeInOut:function(){return this.timing("ease-in-out")},cubicBezier:function(n1,n2,n3,n4){return this.timing("cubic-bezier("+n1+","+n2+","+n3+","+n4+")")},none:function(){return this.property("none")},run:function(config){var css=Object.create(null);this._count=0,gui.Object.each(config,function(key,value){gui.Type.isFunction(this[key])?this[key](value):css[key]=value},this);var now="none"===this.spirit.css.compute("-beta-transition-property"),then=this._then=new gui.Then,spirit=this.spirit;return(this._count=Object.keys(css).length)&&setImmediate(function(){spirit.css.style(css),now&&then&&setImmediate(function(){then.now(null)})}),then},_default:1e3,_endevent:null,_count:0,_init:function(){if(null===this._endevent){var names={webkit:"webkitTransitionEnd",explorer:"MSTransitionEnd",gecko:"transitionend",opera:"oTransitionEnd"};this._endevent=names[gui.Client.agent]||"transitionend",this.spirit.event.add(this._endevent,this.spirit.element,this)}return this},_transitionend:function(e){var t=new gui.Transition(e.propertyName,e.elapsedTime);this._ontransition(t),this.spirit.ontransition(t)},_ontransition:function(){0===--this._count&&this._now()},_now:function(){var then=this._then;then&&then.now(null)},_convert:function(ms){return ms=ms?ms:this._default,ms/1e3+"s"}}),gui.Transition=function(propertyName,elapsedTime){this.duration=Math.round(elapsedTime/1e3),this.type=propertyName},gui.Transition.prototype={type:null,duration:0},gui.AttentionPlugin=function(chained){return gui.Plugin.extend("gui.AttentionPlugin",{trap:chained(function(){this._trapping||(this._trapping=!0,this._listen(!0),this._setup())}),enter:chained(function(){this._focused||(this._latest?this._latest.focus():this._first())}),exit:chained(function(){this._focused&&this._latest&&this._latest.blur(),this._exit()}),handleEvent:function(e){switch(e.type){case"blur":case"focusout":this._onblur(e.target);break;case"focus":case"focusin":this._onfocus(e.target)}},onbroadcast:function(b){b.type===gui.BROADCAST_ATTENTION_MOVE&&b.data===this.spirit.$instanceid&&this.enter()},ondestruct:function(){this._super.ondestruct(),this._trapping&&this._listen(!1)},_trapping:null,_latest:null,_entered:!1,_setup:function(){["before","after"].forEach(function(pos){var elm=this._input(pos),dom=this.spirit.dom;"before"===pos?dom.prepend(elm):dom.append(elm)},this)},_listen:function(listen){var element=this.spirit.element,action1=listen?"addEventListener":"removeEventListener",action2=listen?"addGlobal":"removeGlobal";element[action1]("focus",this,!0),element[action1]("blur",this,!0),gui.Broadcast[action2](gui.BROADCAST_ATTENTION_MOVE,this)},_input:function(pos){this.spirit.dom;var doc=this.spirit.document,elm=gui.CSSPlugin.style(doc.createElement("input"),{position:"absolute",opacity:0,height:10,width:10,top:-5e3});return elm.className="_gui-focus_"+pos,elm},_first:function(){return this._find(!0)},_last:function(){return this._find(!1)},_find:function(isfirst){var elm=null,all=this._elements();return all.length&&(elm=all[isfirst?0:all.length-1],elm.focus()),elm},_elements:function(){return this.spirit.dom.descendants().filter(function(elm){return this._focusable(elm)},this)},_focusable:function(elm){var is=!1;switch(elm.localName){case"input":case"textarea":case"select":case"button":case"a":elm.tabIndex>-1&&"image"!==elm.type&&(elm.className.startsWith("_gui-focus")||(is=!0))}return is},_onfocus:function(elm){this._focused=!0,this._latest=elm,this._entered||(this._entered=!0,this._enter());var klas=elm.className;klas.startsWith("_gui-focus")&&(klas.contains("after")?this._first():this._last())},_onblur:function(){var that=this;this._focused=!1,setTimeout(function(){that._focused||(that._entered=!1)})},_enter:function(){gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_ENTER,this.spirit.$instanceid)},_exit:function(){gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_EXIT,this.spirit.$instanceid)}},{_queue:[],_last:function(){var q=this._queue;return q[q.length-1]},onbroadcast:function(b){var q=this._queue,id=b.data;switch(b.type){case gui.BROADCAST_ATTENTION_ENTER:this._last()!==id&&q.push(id);break;case gui.BROADCAST_ATTENTION_EXIT:var that=this;setTimeout(function(){that._update(id)},0)}},_update:function(id){var q=this._queue;this._last()===id&&(q=this._queue=q.filter(function(i){return i!==id})),q.length&&gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_MOVE,this._last())}})}(gui.Combo.chained),function(){gui.Broadcast.addGlobal([gui.BROADCAST_ATTENTION_ENTER,gui.BROADCAST_ATTENTION_EXIT],gui.AttentionPlugin)}(),gui.VisibilityPlugin=function(chained){return gui.Plugin.extend("gui.VisibilityPlugin",{on:chained(function(){gui.VisibilityPlugin.on(this.spirit)}),off:chained(function(){gui.VisibilityPlugin.off(this.spirit)})},{},{on:function(spirit){var classname=gui.CLASS_INVISIBLE;(void 0===spirit.life.visible||spirit.css.contains(classname))&&(spirit.css.remove(classname),this._go(spirit,!0))},off:function(spirit){var classname=gui.CLASS_INVISIBLE;switch(spirit.life.visible){case!0:case void 0:spirit.css.add(classname),this._go(spirit,!1)}},$init:function(spirit){this._go(spirit,!this._invisible(spirit))},_invisible:function(spirit){return spirit.css.contains(gui.CLASS_INVISIBLE)||spirit.css.matches("."+gui.CLASS_INVISIBLE+" *")},_go:function(first,visible){var type=visible?gui.CRAWLER_VISIBLE:gui.CRAWLER_INVISIBLE;new gui.Crawler(type).descendGlobal(first,{handleSpirit:function(spirit){var init=void 0===spirit.life.visible;return spirit!==first&&spirit.css.contains(gui.CLASS_INVISIBLE)?gui.Crawler.STOP:(visible?(!spirit.life.visible||init)&&(spirit.life.visible=!0,spirit.life.dispatch(gui.LIFE_VISIBLE),spirit.onvisible()):(spirit.life.visible||init)&&(spirit.life.visible=!1,spirit.life.dispatch(gui.LIFE_INVISIBLE),spirit.oninvisible()),void 0)}})}})}(gui.Combo.chained),gui.Client=new function(){function supports(feature){var root=document.documentElement,fixt=feature[0].toUpperCase()+feature.substring(1);return!["","Webkit","Moz","O","ms"].every(function(prefix){return void 0===root.style[prefix?prefix+fixt:feature]})}function extras(){var win=window,doc=document,html=doc.documentElement,body=doc.body,root=null,temp=body.appendChild(gui.CSSPlugin.style(doc.createElement("div"),{position:"absolute",height:"10px",width:"10px",top:"100%"}));win.scrollBy(0,10),root=body.scrollTop?body:html,this.scrollRoot=root,gui.CSSPlugin.style(temp,{position:"fixed",top:"10px"});var has=10===temp.getBoundingClientRect().top;this.hasPositionFixed=has,body.removeChild(temp),win.scrollBy(0,-10);var inner=gui.CSSPlugin.style(document.createElement("p"),{width:"100%",height:"200px"}),outer=gui.CSSPlugin.style(document.createElement("div"),{position:"absolute",top:"0",left:"0",visibility:"hidden",width:"200px",height:"150px",overflow:"hidden"});outer.appendChild(inner),html.appendChild(outer);var w1=inner.offsetWidth;outer.style.overflow="scroll";var w2=inner.offsetWidth;w1===w2&&(w2=outer.clientWidth),html.removeChild(outer),this.scrollBarSize=w1-w2,this.isExplorer&&(this.scrollBarSize=17)
}var agent=navigator.userAgent.toLowerCase();document.documentElement,this.isExplorer=agent.contains("msie"),this.isExplorer9=this.isExplorer&&agent.contains("msie 9"),this.isOpera=agent.contains("opera"),this.isWebKit=agent.contains("webkit"),this.isChrome=this.isWebKit&&agent.contains("chrome"),this.isSafari=this.isWebKit&&!this.isChrome&&agent.contains("safari"),this.isGecko=!this.isWebKit&&!this.isOpera&&agent.contains("gecko"),this.agent=function(){var agent="explorer";return this.isWebKit?agent="webkit":this.isGecko?agent="gecko":this.isOpera&&(agent="opera"),agent}.call(this),this.system=function(){var os=null;return["window mobile","windows","ipad","iphone","haiku","os x","linux"].every(function(test){return agent.contains(test)&&(os=test.match(/ipad|iphone/)?"ios":test.replace(/ /g,"")),null===os}),os}(),this.hasTouch=void 0!==window.ontouchstart||this.isChrome,this.hasBlob=window.Blob&&(window.URL||window.webkitURL),this.hasHistory=window.history&&window.history.pushState?!0:!1,this.isMobile=function(){var shortlist=["android","webos","iphone","ipad","ipod","blackberry","windows phone"];return!shortlist.every(function(system){return!agent.contains(system)})}(),this.hasTransitions=supports("transition"),this.has3D=supports("perspective"),this.hasFlexBox=supports("flex"),this.hasAnimationFrame=function(){var win=window;return win.requestAnimationFrame||win.webkitRequestAnimationFrame||win.mozRequestAnimationFrame||win.msRequestAnimationFrame||win.oRequestAnimationFrame?!0:!1}(),this.hasMutations=function(){return!["","WebKit","Moz","O","Ms"].every(function(vendor){return!gui.Type.isDefined(window[vendor+"MutationObserver"])})}(),this.STABLETIME=200,this.scrollRoot=null,this.scrollBarSize=0,this.hasPositionFixed=!1,this.onbroadcast=function(b){var type=gui.BROADCAST_WILL_SPIRITUALIZE;b.type===type&&b.target===gui&&(gui.Broadcast.removeGlobal(type,this),extras.call(this))}},function(){gui.Broadcast.addGlobal(gui.BROADCAST_WILL_SPIRITUALIZE,gui.Client)}(),gui.DocumentSpirit=gui.Spirit.infuse("gui.DocumentSpirit",{onconstruct:function(){this._super.onconstruct(),this._dimension=new gui.Dimension,this.event.add("message",this.window),this.action.addGlobal(gui.ACTION_DOC_FIT),this._broadcastevents(),this.document===document&&this._constructTop(),this.action.dispatchGlobal(gui.ACTION_DOC_ONCONSTRUCT)},onready:function(){this._super.onready(),(this.waiting=this.window.gui.hosted)&&this.action.addGlobal(gui.$ACTION_XFRAME_VISIBILITY),this.action.dispatchGlobal(gui.ACTION_DOC_ONSPIRITUALIZED),"complete"!==this.document.readyState||this._loaded||this.onload()},onevent:function(e){switch(this._super.onevent(e),e.type){case"orientationchange":this._onorientationchange();break;default:switch(e.type){case"resize":try{if(parent===window)try{this._onresize()}catch(normalexception){throw normalexception}}catch(explorerexception){}break;case"load":e.stopPropagation(),this._loaded||this._onload();break;case"message":this._onmessage(e.data)}var message=gui.DocumentSpirit.broadcastevents[e.type];gui.Type.isDefined(message)&&this._broadcastevent(e,message)}},onaction:function(a){switch(this._super.onaction(a),this.action.$handleownaction=!1,a.type){case gui.ACTION_DOC_FIT:a.consume(),this.fit(a.data===!0);break;case gui.$ACTION_XFRAME_VISIBILITY:this._waiting=!1,a.data===!0?this.visibility.on():this.visibility.off(),a.consume(),this.window.gui.hasModule("flex")&&this.flex.reflex()}},oncrawler:function(crawler){var dir=this._super.oncrawler(crawler);if(dir===gui.Crawler.CONTINUE)switch(crawler.type){case gui.CRAWLER_VISIBLE:case gui.CRAWLER_INVISIBLE:this._waiting&&(dir=gui.Crawler.STOP)}return dir},onvisible:function(){this.css.remove(gui.CLASS_INVISIBLE),this._super.onvisible()},oninvisible:function(){this.css.add(gui.CLASS_INVISIBLE),this._super.onvisible()},ondom:function(){this.action.dispatchGlobal(gui.ACTION_DOC_ONDOMCONTENT)},onload:function(){if(this._loaded)console.warn("@TODO loaded twice...");else{this._loaded=!0,this.action.dispatchGlobal(gui.ACTION_DOC_ONLOAD);var that=this;setTimeout(function(){that.fit()},gui.Client.STABLETIME)}},onunload:function(){this.action.dispatchGlobal(gui.ACTION_DOC_UNLOAD)},fit:function(force){if(this._loaded||force){var dim=this._getDimension();gui.Dimension.isEqual(this._dimension,dim)||(this._dimension=dim,this._dispatchFit())}},propagateBroadcast:function(b){b.$contextids.push(this.$contextid);var msg=gui.Broadcast.stringify(b),win=this.window,sup=win.parent;win!==sup&&(this.dom.qall("iframe",gui.IframeSpirit).forEach(function(iframe){iframe.xhost&&iframe.contentWindow.postMessage(msg,"*")}),sup!==win&&sup.postMessage(msg,"*"))},_loaded:!1,_waiting:!1,_dimension:null,_timeout:null,_broadcastevents:function(){Object.keys(gui.DocumentSpirit.broadcastevents).forEach(function(type){var target=this.document;switch(type){case"scroll":case"resize":case"popstate":case"hashchange":var win=this.window;target=win===top?win:null}target&&this.event.add(type,target)},this)},_broadcastevent:function(e,message){switch(e.type){case"mousemove":case"touchmove":try{gui.broadcastGlobal(message,e)}catch(exception){throw this.event.remove(e.type,e.target),exception}break;default:gui.broadcastGlobal(message,e)}},_onmessage:function(msg){var pattern="spiritual-broadcast";if(msg.startsWith(pattern)){var b=gui.Broadcast.parse(msg);0>b.$contextids.indexOf(this.$contextid)&&gui.Broadcast.dispatchGlobal(b.target,b.type,b.data)}else if(pattern="spiritual-action",msg.startsWith(pattern)){var a=gui.Action.parse(msg);a.direction===gui.Action.DESCEND&&a.$instanceid===this.window.gui.$contextid&&(this.action.$handleownaction=!0,this.action.descendGlobal(a.type,a.data))}},_dispatchFit:function(){var dim=this._dimension;this.action.dispatchGlobal(gui.ACTION_DOC_FIT,{width:dim.w,height:dim.h});var win=this.window;gui.Client.isWebKit&&(win.scrollBy(0,1),win.scrollBy(0,-1))},_getDimension:function(){var rect=this.document.body.getBoundingClientRect();return new gui.Dimension(rect.width,rect.height)},_constructTop:function(){parent===window&&(this._onorientationchange(),this.event.add("orientationchange",window))},_onresize:function(){this.window.clearTimeout(this._timeout),this._timeout=this.window.setTimeout(function(){gui.broadcastGlobal(gui.BROADCAST_RESIZE_END)},gui.TIMEOUT_RESIZE_END)},_onorientationchange:function(){gui.orientation=window.innerWidth>window.innerHeight?1:0,gui.broadcastGlobal(gui.BROADCAST_ORIENTATIONCHANGE)}},{},{broadcastevents:{click:gui.BROADCAST_MOUSECLICK,mousedown:gui.BROADCAST_MOUSEDOWN,mouseup:gui.BROADCAST_MOUSEUP,scroll:gui.BROADCAST_SCROLL,resize:gui.BROADCAST_RESIZE,hashchange:gui.BROADCAST_HASHCHANGE,popstate:gui.BROADCAST_POPSTATE}}),gui.IframeSpirit=gui.Spirit.infuse("gui.IframeSpirit",{spiritualized:!1,cover:!1,fit:!1,xguest:null,contentWindow:{getter:function(){return this.element?this.element.contentWindow:null},setter:function(){}},contentDocument:{getter:function(){return this.element?this.element.contentDocument:null},setter:function(){}},onenter:function(){this._super.onenter(),this.event.add("message",this.window,this),this.action.addGlobal([gui.ACTION_DOC_ONCONSTRUCT,gui.ACTION_DOC_ONDOMCONTENT,gui.ACTION_DOC_ONLOAD,gui.ACTION_DOC_ONSPIRITUALIZED,gui.ACTION_DOC_UNLOAD,gui.ACTION_DOC_FIT]),this.fit&&(this.css.height=0),this.cover&&this._coverup();var src=this.element.src;src&&src!==gui.IframeSpirit.SRC_DEFAULT&&this.src(src)},onaction:function(a){switch(this._super.onaction(a),this.action.$handleownaction=!1,a.type){case gui.ACTION_DOC_ONCONSTRUCT:this.life.dispatch(gui.LIFE_IFRAME_CONSTRUCT),this.action.remove(a.type),a.consume();break;case gui.ACTION_DOC_ONDOMCONTENT:this.life.dispatch(gui.LIFE_IFRAME_DOMCONTENT),this.action.remove(a.type),a.consume();break;case gui.ACTION_DOC_ONLOAD:this.life.dispatch(gui.LIFE_IFRAME_ONLOAD),this.action.remove(a.type),a.consume();break;case gui.ACTION_DOC_ONSPIRITUALIZED:this._onspiritualized(),this.life.dispatch(gui.LIFE_IFRAME_SPIRITUALIZED),this.action.remove(a.type),a.consume();break;case gui.ACTION_DOC_UNLOAD:this._onunload(),this.life.dispatch(gui.LIFE_IFRAME_UNLOAD),this.action.add([gui.ACTION_DOC_ONCONSTRUCT,gui.ACTION_DOC_ONDOMCONTENT,gui.ACTION_DOC_ONLOAD,gui.ACTION_DOC_ONSPIRITUALIZED]),a.consume();break;case gui.ACTION_DOC_FIT:this._onfit(a.data.height),a.consume()}},onevent:function(e){this._super.onevent(e),"message"===e.type&&this.xguest&&this._onmessage(e.data)},onvisible:function(){this._super.onvisible(),this.spiritualized&&this._visibility()},oninvisible:function(){this._super.oninvisible(),this.spiritualized&&this._visibility()},src:function(src){var doc=this.document;if(!gui.Type.isString(src))return this.element.src;if(gui.URL.external(src,doc)){var url=new gui.URL(doc,src);this.xguest=url.protocol+"//"+url.host,src=gui.IframeSpirit.sign(src,doc,this.$instanceid)}this.element.src=src},_cover:null,_onspiritualized:function(){this.spiritualized=!0,this._visibility(),this.cover&&!this.fit&&this._coverup(!1)},_onfit:function(height){this.fit&&(this.css.height=height,this.action.dispatchGlobal(gui.ACTION_DOC_FIT)),this.cover&&this._coverup(!1)},_onunload:function(){this.spiritualized=!1,this.fit&&(this.css.height=0),this.cover&&this._coverup(!0)},_onmessage:function(msg){if(this.xguest&&msg.startsWith("spiritual-action:")){var a=gui.Action.parse(msg);a.direction===gui.Action.ASCEND&&a.$instanceid===this.$instanceid&&(this.action.$handleownaction=!0,this.action.ascendGlobal(a.type,a.data))}},_visibility:function(){gui.Type.isDefined(this.life.visible)&&this.action.descendGlobal(gui.$ACTION_XFRAME_VISIBILITY,this.life.visible)},_xguest:function(src){return this.att.get("sandbox")||gui.URL.external(src,this.document)},_coverup:function(cover){var box=this.box;this._cover=this._cover||this.dom.after(gui.CoverSpirit.summon(this.document)),cover?(this._cover.position(new gui.Geometry(box.localX,box.localY,box.width,box.height)),this._cover.dom.show()):this._cover.dom.hide()}},{summon:function(doc,src){var iframe=doc.createElement("iframe"),spirit=this.possess(iframe);if(spirit.css.add("gui-iframe"),src){if(gui.URL.external(src,doc)){var url=new gui.URL(doc,src);spirit.xguest=url.protocol+"//"+url.host,src=this.sign(src,doc,spirit.$instanceid)}}else src=this.SRC_DEFAULT;return iframe.src=src,spirit}},{SRC_DEFAULT:"javascript:void(false);",sign:function(url,doc,contextid){var loc=doc.location,uri=loc.protocol+"//"+loc.host,sig=uri+"/"+contextid;return url=gui.URL.setParam(url,gui.PARAM_CONTEXTID,sig),console.log("IframeSpirit",url),url},unsign:function(url){return gui.URL.setParam(url,gui.PARAM_CONTEXTID,null)}}),gui.StyleSheetSpirit=gui.Spirit.infuse("gui.StyleSheetSpirit",{onenter:function(){this._super.onenter(),this._rules&&(this.addRules(this._rules),this._rules=null)},disable:function(){this.element.disabled=!0},enable:function(){this.element.disabled=!1},addRules:function(rules){var sheet=this.element.sheet,index=sheet.cssRules.length;gui.Object.each(rules,function(selector,declarations){sheet.insertRule(selector+this._ruleout(declarations),index++)},this)},_rules:null,_ruleout:function(declarations){var body="",plugin=gui.CSSPlugin;return gui.Object.each(declarations,function(property,value){body+=plugin.cssproperty(property)+":"+plugin.cssvalue(value)+";"}),"{"+body+"}"}},{summon:function(doc,href,rules,disabled){var elm=href?this._createlink(doc,href):this._createstyle(doc),spirit=this.possess(elm);return rules&&(href?elm.addEventListener("load",function(){spirit.addRules(rules)},!1):spirit._rules=rules),disabled&&spirit.disable(),spirit},_createlink:function(doc,href){var link=doc.createElement("link");return link.className="gui-stylesheet",link.rel="stylesheet",link.href=href,link},_createstyle:function(doc){var style=doc.createElement("style");return style.className="gui-stylesheet",style.appendChild(doc.createTextNode("")),style}}),gui.ActionSpirit=gui.Spirit.infuse("gui.ActionSpirit",{onenter:function(){this._super.onenter(),this.event.add("click")},onevent:function(e){switch(this._super.onevent(e),e.type){case"click":var onaction=this.att.get("onaction");if(gui.Type.isString(onaction)){var Invokable=this.window.Function;new Invokable(onaction).call(this)}}}}),gui.CoverSpirit=gui.Spirit.infuse("gui.CoverSpirit",{show:function(){return this.dom.show(),this},hide:function(){return this.dom.hide(),this},position:function(geo){this.css.style({top:geo.y,left:geo.x,width:geo.w,height:geo.h})},fadeIn:function(duration){gui.Client.hasTransitions?(this.transition.none(),this.css.opacity=0,this.show(),this.transition.run({duration:duration||250,property:"opacity",opacity:1})):this.show()},fadeOut:function(duration){gui.Client.hasTransitions?(this.transition.none(),this.css.opacity=1,this.show(),this.transition.run({duration:duration||250,property:"opacity",opacity:0}).then(function(){this.hide()},this)):this.hide()}},{summon:function(doc,geo){var spirit=this.possess(doc.createElement("div"));return spirit.css.add(gui.CLASS_COVER),geo&&spirit.position(geo),spirit}}),gui.module("core",{channels:[["html",gui.DocumentSpirit],[".gui-styles",gui.StyleSheetSpirit],[".gui-iframe",gui.IframeSpirit],[".gui-action",gui.ActionSpirit],[".gui-cover",gui.CoverSpirit],[".gui-spirit",gui.Spirit]],plugins:{action:gui.ActionPlugin,att:gui.AttPlugin,attconfig:gui.AttConfigPlugin,attention:gui.AttentionPlugin,box:gui.BoxPlugin,broadcast:gui.BroadcastPlugin,css:gui.CSSPlugin,dom:gui.DOMPlugin,event:gui.EventPlugin,life:gui.LifePlugin,tick:gui.TickPlugin,tween:gui.TweenPlugin,transition:gui.TransitionPlugin,visibility:gui.VisibilityPlugin},mixins:{onaction:function(){},onatt:function(){},onbroadcast:function(){},onevent:function(){},onlife:function(){},ontick:function(){},ontween:function(){},ontransition:function(){},onvisible:function(){},oninvisible:function(){},handleEvent:function(e){this.onevent(e)}}}),gui.module("jquery",{oncontextinitialize:function(context){context===top&&this._spiritualdom()},onbeforespiritualize:function(context){var root=context.document.documentElement;if(context.gui.mode===gui.MODE_JQUERY){var jq=context.jQuery;jq.__rootnode=root,this._instance(jq),this._expandos(jq),this._overload(jq,context)}},_expandos:function(jq){gui.Guide,jq.__suspend=!1,["spiritualize","spiritualizeSub","spiritualizeOne","materialize","materializeSub","materializeOne","detach"].forEach(function(method){jq.fn["__"+method]=function(){return gui.DOMPlugin.group(Array.map(this,function(elm){return elm})).forEach(function(elm){gui.Guide[method](elm)}),this}})},_instance:function(jq){var Init=jq.fn.init,home=jq.__rootnode.ownerDocument.defaultView;home.gui.debug&&(jq.fn.init=function(selector,context,rootjQuery){var inst=new Init(selector,context,rootjQuery),test=inst[0];if(test&&test.nodeType===Node.ELEMENT_NODE&&test.ownerDocument!==home.document)throw Error("JQuery was used to handle elements in another window. Please use a locally loaded version of JQuery.");return inst})},_overload:function(jq,context){var module=this,naive=Object.create(null);["attr","removeAttr"].forEach(function(name){naive[name]=jq.fn[name],jq.fn[name]=function(){var nam=arguments[0],val=arguments[1],del="removeAttr"===name;return val=del?null:val,(void 0!==val||del)&&this.each(function(i,elm){elm.spirit&&(void 0!==val||del)&&elm.spirit.att.set(nam,val)}),naive[name].apply(this,arguments)}}),["after","append","appendTo","before","detach","empty","html","text","insertAfter","insertBefore","prepend","prependTo","remove","replaceAll","replaceWith","unwrap","wrap","wrapAll","wrapInner"].forEach(function(name){naive[name]=jq.fn[name],jq.fn[name]=function(){function suber(){return gui.Observer.suspend(jq.__rootnode,function(){return naive[name].apply(that,args)},that)}var res,that=this,args=arguments,set=arguments.length>0;if(context.gui.mode!==gui.MODE_JQUERY)res=suber();else if(jq.__suspend)res=suber();else if("text"===name)set&&this.__materializeSub(),res=suber();else{var arg=function(){return set?jq(args[0]):void 0};switch(gui.Guide,jq.__suspend=!0,name){case"append":case"prepend":res=module._append_prepend.call(this,"append"===name,suber,jq);break;case"after":case"before":res=module._after_before.call(this,"after"===name,suber,jq);break;case"appendTo":res=suber(),arg().each(function(i,m){jq(m).last().__spiritualize()});break;case"prependTo":res=suber(),arg().each(function(i,m){jq(m).first().__spiritualize()});break;case"insertAfter":res=suber(),arg().next().__spiritualize();break;case"insertBefore":res=suber(),arg().prev().__spiritualize();break;case"detach":case"remove":this.__detach(),res=suber();break;case"replaceAll":res=module._replaceall_replacewith(this,arg(),suber);break;case"replaceWith":res=module._replaceall_replacewith(arg(),this,suber);break;case"empty":this.__materializeSub(),res=suber();break;case"html":set&&this.__materializeSub(),res=suber(),set&&this.__spiritualizeSub();break;case"unwrap":this.parent().__materializeOne(),res=suber();break;case"wrap":case"wrapAll":res=suber(),this.parent().__spiritualizeOne();break;case"wrapInner":res=suber(),this.__spiritualize()}jq.__suspend=!1}return res}})},_spiritualdom:function(){function breakdown(spirit){var elm=spirit.element,doc=elm.ownerDocument,win=doc.defaultView,dom=spirit.dom.embedded(),is$=win.gui.mode===gui.MODE_JQUERY;return{elm:elm,doc:doc,win:win,dom:dom,is$:is$}}var plugin=gui.DOMPlugin.prototype;["html","empty","text"].forEach(function(method){var old=plugin[method];plugin[method]=function(){var res,args=arguments,b=breakdown(this.spirit);return b.is$?(b.dom&&gui.Guide.materializeSub(b.elm),res=gui.Observer.suspend(b.elm,function(){return old.apply(this,args)},this),b.dom&&"html"===method&&gui.Guide.spiritualizeSub(b.elm)):res=old.apply(this,args),res}}),["remove"].forEach(function(method){var old=plugin[method];plugin[method]=function(){var res,args=arguments,b=breakdown(this.spirit);return b.is$?(b.dom&&gui.Guide.detach(b.elm),res=gui.Observer.suspend(b.elm,function(){return old.apply(this,args)},this)):res=old.apply(this,args),res}}),["append","prepend","before","after"].forEach(function(method){var old=plugin[method];plugin[method]=function(things){var res,b=breakdown(this.spirit);if(b.is$){if(res=gui.Observer.suspend(b.elm,function(){return old.call(this,things)},this),b.dom){things=gui.Array.toArray(things);var els=Array.map(things,function(thing){return thing&&thing instanceof gui.Spirit?thing.element:thing});els.forEach(function(el){gui.Guide.spiritualize(el)})}}else res=old.call(this,things);return res}})},_append_prepend:function(append,suber){var old,last="lastElementChild",fist="firstElementChild",next="nextElementSibling",prev="previousElementSibling",current=Array.map(this,function(elm){return elm[append?last:fist]}),res=suber();return this.each(function(index,elm){for(elm=(old=current[index])?old[append?next:prev]:elm.firstElementChild;elm;)gui.Guide.spiritualize(elm),elm=elm[append?next:prev]}),res},_after_before:function(after,suber){function sibling(node){for(node=node[target];node&&node.nodeType!==Node.ELEMENT_NODE;)node=node[target];return node}var res,sib,current=[],target=after?"nextSibling":"previousSibling";return this.each(function(i,elm){for(;elm&&-1===current.indexOf(elm);)current.push(elm),elm=sibling(elm)}),res=suber(),this.each(function(i,elm){for(sib=sibling(elm);sib&&-1===current.indexOf(sib);)gui.Guide.spiritualize(sib),sib=sibling(sib)}),res},_replaceall_replacewith:function(source,target,suber){var parent,parents=[],current=[];target.each(function(i,elm){gui.Guide.materialize(elm),parent=elm.parentNode,-1===parents.indexOf(parent)&&(parents.push(parent),current=current.concat(Array.map(parent.children,function(child){return child})))});var res=suber();return parents.forEach(function(parent){parent&&Array.forEach(parent.children,function(elm){-1===current.indexOf(elm)&&gui.Guide.spiritualize(elm)})}),res}}),gui.DOMChanger={jquery:!1,innerhtml:{global:!1,local:!1,missing:!1},change:function(win){var element=win.Element.prototype;if(gui.Type.isDefined(element.spirit))throw Error("Spiritual loaded twice?");switch(element.spirit=null,win.gui.mode){case gui.MODE_MANAGED:case gui.MODE_NATIVE:case gui.MODE_OPTIMIZE:this.upgrade(win,gui.DOMCombos.getem());break;case gui.MODE_JQUERY:this._jquery(win)}},upgrade:function(win,combos){this._change(win,combos)},_jquery:function(win){var ok=!1;if(!(ok=gui.Type.isDefined(win.jQuery)))throw Error("Spiritual runs in JQuery mode: Expected JQuery to be loaded first");if(!(ok=win.gui.hasModule("jquery")))throw Error('Spiritual runs in JQuery mode: Expected the "jquery" module');return ok},_change:function(win,combos){var did=[],doc=win.document;this._canchange(win.Element.prototype,win,combos)||win.HTMLElement&&this._canchange(win.HTMLElement.prototype,win)||this._tags().forEach(function(tag){var e=doc.createElement(tag),p=e.constructor.prototype;p!==win.Object.prototype&&-1===did.indexOf(p)&&(this._dochange(p,win,combos),did.push(p))},this)},_tags:function(){return"a abbr address area article aside audio b base bdi bdo blockquote body br button canvas caption cite code col colgroup command datalist dd del details device dfn div dl dt em fieldset figcaption figure footer form h1 h2 h3 h4 h5 h6 head header hgroup hr html i iframe img input ins kbd keygen label legend li link main map menu meta meter nav noscript ol optgroup option output p param pre progress q rp rt ruby s samp script section select small source span strong style submark summary sup table tbody td textarea tfoot th thead time title tr track ul unknown var video wbr".split(" ")},_canchange:function(proto,win,combos){var result=!1,test="it appears to work",cache=proto.hasChildNodes;proto.hasChildNodes=function(){return test};var root=win.document.documentElement;return root.hasChildNodes()===test&&(proto.hasChildNodes=cache,this._dochange(proto,win,combos),result=!0),result},_dochange:function(proto,win,combos){switch(gui.Client.agent){case"explorer":this.innerhtml.global=!0;break;case"gecko":case"opera":this.innerhtml.global=!0;break;case"webkit":gui.DOMPatcher.canpatch(win)?(this.innerhtml.local=!0,gui.DOMPatcher.patch(win.document)):(this.innerhtml.local=!1,this.innerhtml.missing=!0)}var title=win.document.title;switch(win.gui.mode){case gui.MODE_NATIVE:if(this.innerhtml.missing)throw Error("Spiritual native mode is not supported on this device.");break;case gui.MODE_OPTIMIZE:this.innerhtml.missing?(win.gui.mode=gui.MODE_JQUERY,this._jquery(win)&&win.gui.debug&&console.debug(title+": Spiritual runs in JQuery mode. To keep spirits "+"in synch, use JQuery or Spiritual to perform DOM updates.")):(win.gui.mode=gui.MODE_NATIVE,win.gui.debug&&console.debug(title+": Spiritual runs in native mode"))}if(win.gui.mode===gui.MODE_NATIVE){var root=win.document.documentElement;gui.Object.each(combos,function(name,combo){this._docombo(proto,name,combo,root)},this)}},_docombo:function(proto,name,combo,root){if(this._ismethod(name))this._domethod(proto,name,combo);else switch(gui.Client.agent){case"opera":case"gecko":this._doboth(proto,name,combo,root);break;case"explorer":this._doie(proto,name,combo);break;case"webkit":}},_ismethod:function(name){var is=!1;switch(name){case"appendChild":case"removeChild":case"insertBefore":case"replaceChild":case"setAttribute":case"removeAttribute":is=!0}return is},_domethod:function(proto,name,combo){var base=proto[name];proto[name]=combo(function(){return base.apply(this,arguments)})},_doie:function(proto,name,combo){var base=Object.getOwnPropertyDescriptor(proto,name);Object.defineProperty(proto,name,{get:function(){return base.get.call(this)},set:combo(function(){base.apply(this,arguments)})})},_doboth:function(proto,name,combo,root){var getter=root.__lookupGetter__(name),setter=root.__lookupSetter__(name);if(!getter)throw Error("Can't lookup getter for "+name);proto.__defineGetter__(name,function(){return getter.apply(this,arguments)}),proto.__defineSetter__(name,combo(function(){setter.apply(this,arguments)}))}},gui.DOMCombos={getem:function(){return this._creation||(this._creation=this._create())},_creation:null,_create:function(){var combo=gui.Combo,guide=gui.Guide,ifEmbedded=combo.provided(function(){return gui.DOMPlugin.embedded(this)}),ifSpirit=combo.provided(function(){return!gui.Type.isNull(this.spirit)}),spiritualizeAfter=combo.after(function(node){guide.spiritualize(node)}),spiritualizeNewAfter=combo.after(function(newnode){guide.spiritualize(newnode)});combo.before(function(node){guide.materialize(node)});var materializeOldBefore=combo.before(function(newnode,oldnode){guide.materialize(oldnode)}),detachBefore=combo.before(function(node){guide.detach(node)}),setAttBefore=combo.before(function(name,value){this.spirit.att.set(name,value)}),delAttBefore=combo.before(function(name){this.spirit.att.del(name)}),suspending=combo.around(function(action){return gui.Observer.suspend(this,function(){return action()},this)}),materializeSubBefore=combo.before(function(){guide.materializeSub(this)}),spiritualizeSubAfter=combo.after(function(){guide.spiritualizeSub(this)}),parent=null,materializeThisBefore=combo.before(function(){parent=this.parentNode,guide.materialize(this)}),spiritualizeParentAfter=combo.after(function(){guide.spiritualize(parent)}),patchAfter=combo.after(function(node){gui.Client.isWebKit&&gui.DOMPatcher.patch(node)}),ifEnabled=combo.provided(function(){return this.ownerDocument.defaultView.gui.mode!==gui.MODE_MANAGED}),otherwise=function(action){return action};return{appendChild:function(base){return ifEnabled(ifEmbedded(spiritualizeAfter(patchAfter(suspending(base))),otherwise(base)),otherwise(base))},removeChild:function(base){return ifEnabled(ifEmbedded(detachBefore(suspending(base)),otherwise(base)),otherwise(base))},insertBefore:function(base){return ifEnabled(ifEmbedded(spiritualizeAfter(patchAfter(suspending(base))),otherwise(base)),otherwise(base))},replaceChild:function(base){return ifEnabled(ifEmbedded(materializeOldBefore(spiritualizeNewAfter(patchAfter(suspending(base)))),otherwise(base)),otherwise(base))},setAttribute:function(base){return ifEnabled(ifEmbedded(ifSpirit(setAttBefore(base),otherwise(base)),otherwise(base)),otherwise(base))},removeAttribute:function(base){return ifEnabled(ifEmbedded(ifSpirit(delAttBefore(base),otherwise(base)),otherwise(base)),otherwise(base))},innerHTML:function(base){return ifEnabled(ifEmbedded(materializeSubBefore(spiritualizeSubAfter(suspending(base))),otherwise(base)),otherwise(base))},outerHTML:function(base){return ifEnabled(ifEmbedded(materializeThisBefore(spiritualizeParentAfter(suspending(base))),otherwise(base)),otherwise(base))},textContent:function(base){return ifEnabled(ifEmbedded(materializeSubBefore(suspending(base)),otherwise(base)),otherwise(base))}}}},gui.DOMPatcher={canpatch:function(win){var root=win.document.documentElement;try{return Object.defineProperty(root,"innerHTML",this._innerHTML),!0}catch(iosexception){return!1}},patch:function(node){if(!gui.DOMChanger.innerhtml.local)throw Error("Somehow JQuery mode should have handled this :(");new gui.Crawler(gui.CRAWLER_DOMPATCHER).descend(node,this)},handleElement:function(elm){["innerHTML","outerHTML","textContent"].forEach(function(descriptor){Object.defineProperty(elm,descriptor,this["_"+descriptor])},this)},_innerHTML:{get:function(){return(new gui.DOMSerializer).subserialize(this)},set:function(html){gui.DOMPlugin.html(this,html)}},_outerHTML:{get:function(){return(new gui.DOMSerializer).serialize(this)},set:function(html){gui.DOMPlugin.outerHtml(this,html)}},_textContent:{get:function(){var node=this,res="";for(node=node.firstChild;node;node=node.nextSibling)switch(node.nodeType){case Node.TEXT_NODE:res+=node.data;break;case Node.ELEMENT_NODE:res+=node.textContent}return res},set:function(html){gui.DOMPlugin.html(this,html.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot"))}}},gui.Observer={observes:!1,fails:!1,observe:function(win){var sig=win.gui.$contextid,doc=win.document,obs=this._observers[sig];if(this.observes&&win.gui.debug){if(!gui.Type.isDefined(obs)){var Observer=this._mutationobserver();obs=this._observers[sig]=new Observer(function(mutations){mutations.forEach(function(mutation){gui.Observer._handleMutation(mutation)})})}this._connect(doc,!0)}},suspend:function(node,action,thisp){var res;if(!node.nodeType)throw new TypeError;return this.observes&&1===++this._suspend&&this._connect(node,!1),gui.Type.isFunction(action)&&(res=action.call(thisp)),this.observes&&this.resume(node),res},resume:function(node){if(!node.nodeType)throw new TypeError;this.observes&&0===--this._suspend&&this._connect(node,!0)},_suspend:0,_observers:Object.create(null),_mutationobserver:function(){return window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver},_connect:function(node,connect){var doc=node.ownerDocument||node,win=doc.defaultView,sig=win.gui.$contextid,obs=this._observers[sig];obs&&(connect?obs.observe(doc,{childList:!0,subtree:!0}):obs.disconnect())},_handleMutation:function(mutation){var action=!1;Array.forEach(mutation.removedNodes,function(node){node.nodeType===Node.ELEMENT_NODE&&(console.warn("Bad remove:",node),action=!0)}),Array.forEach(mutation.addedNodes,function(node){node.nodeType===Node.ELEMENT_NODE&&(console.warn("Bad append:",node),action=!0)}),action&&mutation.target.ownerDocument.defaultView.gui.debug&&console[this.fails?"error":"warn"]("Action required: DOM mutation not intercepted, Spiritual may be out of synch.")}},gui.Guide={toString:function(){return"[object gui.Guide]"},observe:function(win){win.document.addEventListener("DOMContentLoaded",this,!1),win.addEventListener("load",this,!1),win.addEventListener("unload",this,!1)},handleEvent:function(e){var sum=new gui.EventSummary(e);switch(e.type){case"DOMContentLoaded":this._ondom(sum);break;case"load":this._onload(sum);break;case"unload":this._unload(sum)}e.currentTarget.removeEventListener(e.type,this,!1),e.stopPropagation()},onbroadcast:function(b){var sig=b.data,spirit=null,spirits=this._windows[sig];switch(b.type){case gui.BROADCAST_KICKSTART:gui.Broadcast.removeGlobal(b.type,this),this._step1(document);break;case gui.BROADCAST_LOADING_CHANNELS:spirits||(spirits=this._windows[sig]=[],spirits.$loading=0),spirits.push(b.target),spirits.$loading++;break;case gui.BROADCAST_CHANNELS_LOADED:if(0===--spirits.$loading){for(;spirit=spirits.shift();)spirit.channel();this._step2(b.target.document)}}},spiritualize:function(target){target=target instanceof gui.Spirit?target.element:target,this._maybespiritualize(target,!1,!1)},spiritualizeSub:function(target){this._maybespiritualize(target,!0,!1)},spiritualizeOne:function(target){this._maybespiritualize(target,!1,!0)},materialize:function(target){this._maybematerialize(target,!1,!1)},materializeSub:function(target){this._maybematerialize(target,!0,!1)},materializeOne:function(target){this._maybematerialize(target,!1,!0)},detach:function(target){this._maybedetach(target)},possess:function(elm,Spirit){var doc=elm.ownerDocument,win=doc.defaultView,sig=win.gui.$contextid;if(elm.spirit)throw Error("Cannot repossess element with spirit "+elm.spirit+" (exorcise first)");return elm.spirit=new Spirit(elm,doc,win,sig)},exorcise:function(spirit){spirit.life.destructed||(gui.Spirit.$destruct(spirit),gui.Spirit.$dispose(spirit))},suspend:function(operation,thisp){this._suspended=!0;var res=operation.call(thisp);return this._suspended=!1,res},afterattach:function(spirits){spirits.forEach(function(spirit){gui.Spirit.$async(spirit)}),this._visibility(spirits)},_windows:Object.create(null),_suspended:!1,_handles:function(node){return node&&!this._suspended&&gui.DOMPlugin.embedded(node)&&node.nodeType===Node.ELEMENT_NODE},_ondom:function(sum){if(sum.documentspirit&&sum.documentspirit.ondom(),gui.autostart){var meta=sum.document.querySelector("meta[name='gui.autostart']");meta&&gui.Type.cast(meta.getAttribute("content"))===!1||this._step1(sum.document)}},_onload:function(sum){sum.documentspirit&&sum.documentspirit.onload()},_unload:function(sum){sum.documentspirit&&sum.documentspirit.onunload(),sum.window.gui.nameDestructAlreadyUsed()
},_step1:function(doc){var win=doc.defaultView,sig=win.gui.$contextid;this._metatags(win),win.gui.go(),this._stylesheets(win),this._windows[sig]||this._step2(doc)},_step2:function(doc){var win=doc.defaultView,sig=win.gui.$contextid;this.spiritualizeOne(doc.documentElement),win.gui.mode!==gui.MODE_MANAGED&&(gui.broadcastGlobal(gui.BROADCAST_WILL_SPIRITUALIZE,sig),this.spiritualizeSub(doc.documentElement),gui.broadcastGlobal(gui.BROADCAST_DID_SPIRITUALIZE,sig))},_metatags:function(win){var doc=win.document,spaces=win.gui.namespaces(),metas=doc.querySelectorAll("meta[name]");Array.forEach(metas,function(meta){var prop=meta.getAttribute("name");spaces.forEach(function(ns){if(prop.startsWith(ns+".")){var value=gui.Type.cast(meta.getAttribute("content"));gui.Object.assert(prop,value,win)}})})},_stylesheets:function(win){var doc=win.document,xpr=".gui-styles",css=doc.querySelectorAll(xpr);Array.forEach(css,function(elm){this.spiritualizeOne(elm)},this)},_collect:function(node,skip,id){var list=[];return new gui.GuideCrawler(id).descend(node,{handleSpirit:function(spirit){skip&&spirit.element===node||spirit.life.destructed||list.push(spirit)}}),list},_maybespiritualize:function(node,skip,one){node=node instanceof gui.Spirit?node.element:node,node=node.nodeType===Node.DOCUMENT_NODE?node.documentElement:node,this._handles(node)&&this._spiritualize(node,skip,one)},_spiritualize:function(element,skip,one){var attach=[],readys=[];new gui.GuideCrawler(gui.CRAWLER_SPIRITUALIZE).descend(element,{handleElement:function(elm){if(!skip||elm!==element){var spirit=elm.spirit;spirit||(spirit=gui.Guide._evaluate(elm)),null!==spirit&&(spirit.life.attached||attach.push(spirit))}return one?gui.Crawler.STOP:gui.Crawler.CONTINUE}}),attach.forEach(function(spirit){spirit.life.configured||gui.Spirit.$configure(spirit),spirit.life.entered||gui.Spirit.$enter(spirit),gui.Spirit.$attach(spirit),spirit.life.ready||readys.push(spirit)},this),readys.reverse().forEach(function(spirit){gui.Spirit.$ready(spirit)})},_maybematerialize:function(node,skip,one,force){node=node instanceof gui.Spirit?node.element:node,node=node.nodeType===Node.DOCUMENT_NODE?node.documentElement:node,(force||this._handles(node))&&this._materialize(node,skip,one)},_materialize:function(element,skip){this._collect(element,skip,gui.CRAWLER_MATERIALIZE).filter(function(spirit){return spirit.life.attached&&!spirit.life.destructed?(gui.Spirit.$destruct(spirit),!0):!1}).forEach(function(spirit){gui.Spirit.$dispose(spirit)})},_maybedetach:function(element){element=element instanceof gui.Spirit?element.element:element,this._handles(element)&&this._collect(element,!1,gui.CRAWLER_DETACH).forEach(function(spirit){gui.Spirit.$detach(spirit)})},_evaluate:function(element){if(!element.spirit){var doc=element.ownerDocument,win=doc.defaultView,hit=win.gui.evaluate(element);hit&&this.possess(element,hit)}return element.spirit},_visibility:function(spirits){gui.DOMPlugin.group(spirits).forEach(function(spirit){gui.VisibilityPlugin.$init(spirit)},this)}},function(){gui.Guide.observe(window),gui.Broadcast.addGlobal([gui.BROADCAST_LOADING_CHANNELS,gui.BROADCAST_CHANNELS_LOADED,gui.BROADCAST_KICKSTART],gui.Guide)}(),gui.GuideCrawler=gui.Crawler.extend("gui.GuideCrawler",{descend:function(start,handler,arg){if(start.nodeType!==Node.DOCUMENT_NODE){var sig=start.ownerDocument.defaultView.gui.$contextid;gui.Tick.add(this._TICK,this,sig).dispatch(this._TICK,0,sig),this._stamp(this._startelement=start,!0)}this._super.descend(start,handler,arg)},ontick:function(tick){tick.type===this._TICK&&this._stamp(this._startelement,!1)},_ATTRIBUTE:"data-gui-crawler",_TICK:"gui-tick-crawler-done",_startelement:null,_stamp:function(elm,doit){elm=elm instanceof gui.Spirit?elm.element:elm;var name=this._ATTRIBUTE,type=this.type;doit?elm.setAttribute(name,type):elm.removeAttribute(name,type)},_handleElement:function(elm,handler,arg){var type=elm.getAttribute(this._ATTRIBUTE);return elm!==this._startelement&&type&&type.contains(this.type)?gui.Crawler.SKIP_CHILDREN:this._super._handleElement(elm,handler,arg)}},{},{}),gui.Key=function(down,type,isglobal){this.down=down,this.type=type,this.global=isglobal},gui.Key.prototype={down:!1,type:null,global:!1},function(){gui.Object.each({shiftDown:!1,ctrlDown:!1,altDown:!1,metaDown:!1,accelDown:!1,accessDown:!1},function(key,value){gui.Key[key]=value})}(),function(){gui.Key.$key=gui.Object.extend({38:"Up",40:"Down",37:"Left",39:"Right",18:"Alt",17:"Control",16:"Shift",32:"Space"},Object.create(null))}(),function(){gui.Object.each(gui.Key.$key,function(key,value){gui.Key[value.toUpperCase()]=value})}(),gui.KeyPlugin=function(confirmed,chained){return gui.Tracker.extend("gui.KeyPlugin",{add:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.IKeyHandler,handler)&&this._breakdown(arg).forEach(function(a){this._addchecks(a+"",[handler,this._global])&&this._setupbroadcast(!0)},this)})),remove:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.IKeyHandler,handler)&&this._breakdown(arg).forEach(function(a){this._removechecks(a+"",[handler,this._global])&&(this._hashandlers()||this._setupbroadcast(!1))},this)})),addGlobal:function(arg,handler){return this._globalize(function(){return this.add(arg,handler)})},removeGlobal:function(arg,handler){return this._globalize(function(){return this.remove(arg,handler)})},onbroadcast:function(b){var list,handler,isglobal;if(b.type===gui.BROADCAST_KEYEVENT){var down=b.data.down,type=b.data.type;(list=this._xxx[type])&&list.forEach(function(checks){handler=checks[0],isglobal=checks[1],isglobal===b.isGlobal&&handler.onkey(new gui.Key(down,type,isglobal))})}},_setupbroadcast:function(add){var act,sig=this.context.gui.$contextid,type=gui.BROADCAST_KEYEVENT;this._global?(act=add?"addGlobal":"removeGlobal",gui.Broadcast[act](type,this)):(act=add?"add":"remove",gui.Broadcast[act](type,this,sig))},_cleanup:function(type,checks){var handler=checks[0],global=checks[1];global?this.removeGlobal(type,handler):this.remove(type,handler)}})}(gui.Arguments.confirmed,gui.Combo.chained),gui.IKeyHandler={toString:function(){return"[object IKeyHandler]"},onkey:function(){}},gui.KeySpirit=gui.Spirit.infuse("gui.KeySpirit",{onready:function(){this._super.onready(),this._map=Object.create(null),this._setup()},onkey:function(key){this._super.onkey(key),console.log(key.type);var map=this._map;map[key.type]=key.down,Object.keys(map).every(function(type){return map[type]===!0})&&console.log("fis!")},_map:null,_setup:function(){var key=this.att.get("key");key&&key.split(" ").forEach(function(token){token=token.trim(),this.key.addGlobal(token),this._map[token]=!1},this)}}),gui.KeysModule=gui.module("keys",{channels:[[".gui-key",gui.KeySpirit]],plugins:{key:gui.KeyPlugin},mixins:{onkey:function(){}},oncontextinitialize:function(context){this._keymap=Object.create(null),["keydown","keypress","keyup"].forEach(function(type){context.document.addEventListener(type,this,!1)},this)},handleEvent:function(e){this._modifiers(e),this._oldschool(e)},_keymap:null,_snapshot:null,_newschool:function(){},_oldschool:function(e){var n=e.keyCode,c=this._keymap[n];gui.BROADCAST_KEYEVENT;var id=e.currentTarget.defaultView.gui.$contextid;switch(e.type){case"keydown":void 0===c&&(this._keycode=n,this._keymap[n]=null,this._keymap[n]=String.fromCharCode(e.which).toLowerCase(),gui.Tick.next(function(){c=this._keymap[n],this._broadcast(!0,null,c,n,id),this._keycode=null},this));break;case"keypress":this._keycode&&(c=this._keychar(e.keyCode,e.charCode,e.which),this._keymap[this._keycode]=c);break;case"keyup":void 0!==c&&(this._broadcast(!1,null,c,n,id),delete this._keymap[n])}},_broadcast:function(down,key,c,code,sig){var type,msg,arg;type=gui.Key.$key[code]||c,type=" "===type?gui.Key.SPACE:type,msg=gui.BROADCAST_KEYEVENT,arg={down:down,type:type};var snapshot=JSON.stringify(arg);snapshot!==this._snapshot&&(gui.Broadcast.dispatch(null,msg,arg,sig),gui.Broadcast.dispatchGlobal(null,msg,arg),this._snapshot=snapshot)},_modifiers:function(e){gui.Key.ctrlDown=e.ctrlKey,gui.Key.shiftDown=e.shiftKey,gui.Key.altDown=e.altKey,gui.Key.metaDown=e.metaKey},_keychar:function(n,c,which){return null===which||void 0===which?String.fromCharCode(n):0!==which&&c?String.fromCharCode(which):null}}),gui.BROADCAST_KEYEVENT="gui-broadcast-keyevent",gui.FlexPlugin=gui.Plugin.extend("gui.FlexPlugin",{reflex:function(){gui.FlexPlugin.reflex(this.spirit.element)},unflex:function(){gui.FlexPlugin.unflex(this.spirit.element)},enable:function(){gui.FlexPlugin.enable(this.spirit.element)},disable:function(){gui.FlexPlugin.disable(this.spirit.element)}},{},{reflex:function(elm){this._emulated(elm)&&this._crawl(elm,"flex")},unflex:function(elm,hotswap){(this._emulated(elm)||hotswap)&&this._crawl(elm,"unflex")},enable:function(elm){this._crawl(elm,"enable"),this._emulated(elm)&&this.reflex(elm)},disable:function(elm){this._emulated(elm)&&this.unflex(elm),this._crawl(elm,"disable")},_emulated:function(elm){var doc=elm.ownerDocument,win=doc.defaultView;return win.gui.flexmode===gui.FLEXMODE_EMULATED},_crawl:function(elm,action){var disabled="enable"===action;if(this._shouldflex(elm,disabled)){var boxes=this._getflexboxes(elm,disabled);boxes.forEach(function(box){box[action]()})}},_shouldflex:function(elm,disabled){return elm.nodeType===Node.ELEMENT_NODE&&this._isflex(elm,disabled)||this._hasflex(elm,disabled)},_isflex:function(elm,disabled){return["flexrow","flexcol"].some(function(name){return name+=disabled?"-disabled":"",gui.CSSPlugin.contains(elm,name)})},_hasflex:function(elm,disabled){return["flexrow","flexcol"].some(function(name){return name+=disabled?"-disabled":"",elm.querySelector("."+name)})},_getflexboxes:function(elm,disabled){var display,boxes=[];return new gui.Crawler("flexcrawler").descend(elm,{handleElement:function(elm){try{display=gui.CSSPlugin.compute(elm,"display")}catch(geckoexception){return gui.Crawler.STOP}return"none"===display?gui.Crawler.SKIP_CHILDREN:(gui.FlexPlugin._isflex(elm,disabled)&&boxes.push(new gui.FlexBox(elm)),void 0)}}),boxes}}),gui.FlexBox=function(elm){this._onconstruct(elm)},gui.FlexBox.prototype={toString:function(){return"[object gui.FlexBox]"},flex:function(){this._flexself(),this._flexchildren(),this._flexcorrect()},unflex:function(){this._element.removeAttribute("style"),this._children.forEach(function(child){child.unflex()})},disable:function(){this._enable(!1)},enable:function(){this._enable(!0)},_element:null,_children:null,_flexcol:!1,_flexlax:!1,_onconstruct:function(elm){this._element=elm,this._flexcol=this._hasclass("flexcol"),this._flexlax=this._hasclass("flexlax"),this._children=this._collectchildren(elm)},_collectchildren:function(elm){return Array.filter(elm.children,function(child){return this._shouldflex(child)},this).map(function(child){return new gui.FlexChild(child)})},_flexself:function(){var elm=this._element;this._flexcol&&this._flexlax&&(this._relaxflex(elm),gui.Tick.next(function(){this._relaxflex(elm)},this))},_relaxflex:function(elm){var style=elm.style,given=style.height,above=elm.parentNode,avail=above.offsetHeight;style.height="auto",avail>elm.offsetHeight&&(style.height=given||"100%")},_flexchildren:function(){var flexes=this._childflexes(),factor=this._computefactor(flexes);if(flexes.length){var unit=100/flexes.reduce(function(a,b){return a+b});this._children.forEach(function(child,i){if(flexes[i]>0){var percentage=flexes[i]*unit*factor;child.setoffset(percentage,this._flexcol)}},this)}},_flexcorrect:function(){this._flexcol||this._children.forEach(function(child,i){i>0&&child.flexcorrect()})},_childflexes:function(){return this._children.map(function(child){return child.getflex()},this)},_computefactor:function(flexes){var all,cut,factor=1;return flexes.indexOf(0)>-1&&(all=cut=this._getoffset(),this._children.forEach(function(child,i){cut-=flexes[i]?0:child.getoffset(this._flexcol)},this),factor=cut/all),factor},_getoffset:function(){var elm=this._element;return this._flexcol?elm.offsetHeight:elm.offsetWidth},_enable:function(enable){var name,next,elm=this._element,css=gui.CSSPlugin;["flexrow","flexcol"].forEach(function(klass){name=enable?klass+"-disabled":klass,next=enable?klass:klass+"-disabled",css.contains(elm,name)&&css.remove(elm,name).add(elm,next)})},_shouldflex:function(elm){return"none"!==gui.CSSPlugin.compute(elm,"display")},_hasclass:function(name){return gui.CSSPlugin.contains(this._element,name)}},gui.FlexChild=function(elm){this._element=elm},gui.FlexChild.prototype={toString:function(){return"[object gui.FlexChild]"},getflex:function(){var flex=0;return this._element.className.split(" ").forEach(function(name){gui.FlexChild._FLEXNAME.test(name)&&(flex=gui.FlexChild._FLEXRATE.exec(name)||1)}),gui.Type.cast(flex)},getoffset:function(vertical){var elm=this._element;return vertical?elm.offsetHeight:elm.offsetWidth},setoffset:function(pct,vertical){var prop=vertical?"height":"width";this._element.style[prop]=pct+"%"},unflex:function(){this._element.removeAttribute("style")},flexcorrect:function(){var elm=this._element;elm.previousSibling.nodeType===Node.TEXT_NODE&&gui.CSSPlugin.add(elm,gui.FlexChild._FLEXCORRECT)},_element:null,_enable:function(enable){var name,next,elm=this._element,css=gui.CSSPlugin;this._element.className.split(" ").forEach(function(klass){name=enable?klass+"-disabled":klass,next=enable?klass:klass+"-disabled",gui.FlexChild._FLEXNAME.test(klass)&&css.contains(elm,name)&&css.remove(elm,name).add(elm,next)})}},gui.FlexChild._FLEXCORRECT="_flexcorrect",gui.FlexChild._FLEXNAME=/^flex\d*$/,gui.FlexChild._FLEXRATE=/\d/,gui.FlexCSS={injected:!0,maxflex:10,toString:function(){return"[object gui.FlexCSS]"},load:function(context,mode){if(this.injected){var sheets=this._getsheets(context.gui.$contextid);if(sheets&&sheets.mode&&sheets[sheets.mode].disable(),sheets&&sheets[mode])sheets[mode].enable();else{var doc=context.document,ruleset=this[mode],css=sheets[mode]=gui.StyleSheetSpirit.summon(doc,null,ruleset);doc.querySelector("head").appendChild(css.element)}sheets.mode=mode,context.gui.flexloaded=!0}},unload:function(context){delete this._sheets[context.gui.$contextid]},_sheets:Object.create(null),_getsheets:function(sig){var sheets=this._sheets;return sheets[sig]||(sheets[sig]={emulated:null,"native":null,mode:null}),sheets[sig]}},gui.FlexCSS.emulated={".flexrow, .flexcol":{display:"block",width:"100%",height:"100%"},".flexrow":{"white-space":"nowrap"},".flexrow > *":{display:"inline-block","vertical-align":"top","white-space":"normal",height:"100%"},".flexrow > ._flexcorrect":{margin:"0 0 0 -4px !important"},".flexcol > *":{display:"block",width:"100%"},".flexlax > .flexrow":{display:"table"},".flexlax > .flexrow > *":{display:"table-cell"}},gui.FlexCSS["native"]=function(){function declare(n){rules[".flexrow > .flex"+n+", .flexcol > .flex"+n]={"-beta-flex-grow":n||1},rules[".flexrow:not(.flexlax) > .flex"+n]={width:"0"},rules[".flexcol:not(.flexlax) > .flex"+n]={height:"0"}}for(var rules={".flexrow, .flexcol":{display:"-beta-flex","-beta-flex-wrap":"nowrap"},".flexcol":{"-beta-flex-direction":"column","min-height":"100%"},".flexrow":{"-beta-flex-direction":"row","min-width":"100%"},".flexrow:not(.flexlax) > *, .flexcol:not(.flexlax) > *":{"-beta-flex-basis":1},".flexrow > .flexrow":{"min-width":"auto"}},n=-1,max=gui.FlexCSS.maxflex;max>=++n;)declare(n||"");return rules}(),gui.FlexMode=function(nonenumerable){return{flexloaded:nonenumerable({value:!1}),flexmode:nonenumerable({get:function(){var best=gui.Client.hasFlexBox?gui.FLEXMODE_NATIVE:gui.FLEXMODE_EMULATED;return this._flexmode===gui.FLEXMODE_OPTIMIZED?best:this._flexmode},set:function(next){this._flexmode=next;var best=gui.Client.hasFlexBox?gui.FLEXMODE_NATIVE:gui.FLEXMODE_EMULATED,mode=next===gui.FLEXMODE_OPTIMIZED?best:next;if(gui.FlexCSS.load(this.window,mode),this.document.documentElement.spirit)switch(mode){case gui.FLEXMODE_EMULATED:this.reflex();break;case gui.FLEXMODE_NATIVE:this.unflex()}}}),reflex:nonenumerable({value:function(elm){this.flexmode===this.FLEXMODE_EMULATED&&gui.FlexPlugin.reflex(elm||this.document.body)}}),unflex:nonenumerable({value:function(elm){gui.FlexPlugin.unflex(elm||this.document.body,!0)}})}}(gui.Property.nonenumerable),gui.FLEXMODE_NATIVE="native",gui.FLEXMODE_EMULATED="emulated",gui.FLEXMODE_OPTIMIZED="optimized",gui.module("flex",{plugins:{flex:gui.FlexPlugin},oncontextinitialize:function(context){context.gui._flexmode=gui.FLEXMODE_OPTIMIZED,context.Object.defineProperties(context.gui,gui.FlexMode),this._edbsetup(context)},onbeforespiritualize:function(context){context.gui.flexloaded||gui.FlexCSS.load(context,context.gui.flexmode)},onafterspiritualize:function(context){var root=context.document.documentElement.spirit;if(context.gui.flexmode===gui.FLEXMODE_EMULATED)try{gui.CSSPlugin.compute(root,"display"),context.gui.reflex()}catch(geckoexception){}gui.Broadcast.addGlobal(gui.BROADCAST_RESIZE_END,{onbroadcast:function(){context.gui.flexmode===gui.FLEXMODE_EMULATED&&context.gui.reflex()}})},oncontextunload:function(context){gui.FlexCSS.unload(context)},_edbsetup:function(context){if(context.gui.hasModule("edb")){var script=context.edb.ScriptPlugin.prototype;gui.Function.decorateAfter(script,"write",function(){this.spirit.window.gui.flexmode===gui.FLEXMODE_EMULATED&&this.spirit.flex.reflex()})}}}),function(guide){function flexparent(child){var doc,win;child=child instanceof gui.Spirit?child.element:child,doc=child.ownerDocument,win=doc.defaultView,win.gui.flexmode===gui.FLEXMODE_EMULATED&&gui.DOMPlugin.embedded(child)&&(child=child===doc.documentElement?child:child.parentNode,gui.Tick.next(function(){gui.FlexPlugin.reflex(child)}))}["_spiritualize","_materialize"].forEach(function(method){gui.Function.decorateAfter(guide,method,flexparent)})}(gui.Guide);