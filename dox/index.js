window.gui={version:"0.0.5",MODE_NATIVE:"native",MODE_JQUERY:"jquery",MODE_OPTIMIZE:"optimize",MODE_MANAGED:"managed",BROADCAST_KICKSTART:"gui-broadcast-kickstart",BROADCAST_DOMCONTENT:"gui-broadcast-document-domcontentloaded",BROADCAST_ONLOAD:"gui-broadcast-window-onload",BROADCAST_UNLOAD:"gui-broadcast-window-unload",BROADCAST_WILL_SPIRITUALIZE:"gui-broadcast-will-spiritualize",BROADCAST_DID_SPIRITUALIZE:"gui-broadcast-did-spiritualize",BROADCAST_MOUSECLICK:"gui-broadcast-mouseevent-click",BROADCAST_MOUSEMOVE:"gui-broadcast-mouseevent-mousemove",BROADCAST_MOUSEDOWN:"gui-broadcast-mouseevent-mousedown",BROADCAST_MOUSEUP:"gui-broadcast-mouseevent-mouseup",BROADCAST_SCROLL:"gui-broadcast-window-scroll",BROADCAST_RESIZE:"gui-broadcast-window-resize",BROADCAST_RESIZE_END:"gui-broadcast-window-resize-end",BROADCAST_POPSTATE:"gui-broadcast-window-popstate",BROADCAST_HASHCHANGE:"gui-broadcast-window-hashchange",BROADCAST_LOADING_CHANNELS:"gui-broadcast-loading-channels",BROADCAST_CHANNELS_LOADED:"gui-broadcast-channels-loaded",BROADCAST_TWEEN:"gui-broadcast-tween",BROADCAST_ORIENTATIONCHANGE:"gui-broadcast-orientationchange",BROADCAST_TOUCHSTART:"gui-broadcast-touchstart",BROADCAST_TOUCHEND:"gui-broadcast-touchend",BROADCAST_TOUCHCANCEL:"gui-broadcast-touchcancel",BROADCAST_TOUCHLEAVE:"gui-broadcast-touchleave",BROADCAST_TOUCHMOVE:"gui-broadcast-touchmove",BROADCAST_DRAG_START:"gui-broadcast-drag-start",BROADCAST_DRAG_END:"gui-broadcast-drag-end",BROADCAST_DRAG_DROP:"gui-broadcast-drag-drop",BROADCAST_COMMAND:"gui-broadcast-command",BROADCAST_ATTENTION_ON:"gui-broadcast-attention-on",BROADCAST_ATTENTION_OFF:"gui-broadcast-attention-off",BROADCAST_ATTENTION_GO:"gui-broadcast-attention-go",ACTION_DOCUMENT_CONSTRUCT:"gui-action-document-construct",ACTION_DOCUMENT_READY:"gui-action-document-ready",ACTION_DOCUMENT_ONLOAD:"gui-action-document-onload",ACTION_DOCUMENT_UNLOAD:"gui-action-document-unload",ACTION_DOCUMENT_FIT:"gui-action-document-fit",ACTION_DOCUMENT_DONE:"gui-action-document-done",ACTION_WINDOW_LOADING:"gui-action-window-loading",ACTION_WINDOW_LOADED:"gui-action-window-loaded",LIFE_CONSTRUCT:"gui-life-construct",LIFE_CONFIGURE:"gui-life-configure",LIFE_ENTER:"gui-life-enter",LIFE_ATTACH:"gui-life-attach",LIFE_READY:"gui-life-ready",LIFE_SHOW:"gui-life-show",LIFE_HIDE:"gui-life-hide",LIFE_DETACH:"gui-life-detach",LIFE_EXIT:"gui-life-exit",LIFE_DESTRUCT:"life-destruct",TICK_DESTRUCT_DETACHED:"gui-tick-destruct-detached",TICK_SPIRIT_NULL:"gui-tick-spirit-null",TICK_FIT:"gui-tick-fit",CRAWLER_ATTACH:"gui-crawler-attach",CRAWLER_DETACH:"gui-crawler-detach",CRAWLER_DISPOSE:"gui-crawler-dispose",CRAWLER_ACTION:"gui-crawler-action",CRAWLER_VISIBLE:"gui-crawler-visible",CRAWLER_INVISIBLE:"gui-crawler-invisible",CLASS_INVISIBLE:"_gui-invisible",CLASS_HIDDEN:"_gui-hidden",orientation:0,ORIENTATION_PORTRAIT:0,ORIENTATION_LANDSCAPE:1},gui.URL=function(doc,href){if(!doc||doc.nodeType!==Node.DOCUMENT_NODE)throw new TypeError("Document expected");var link=doc.createElement("a");link.href=href,Object.keys(gui.URL.prototype).forEach(function(key){gui.Type.isString(link[key])&&(this[key]=link[key])},this),this.id=this.hash?this.hash.substring(1):null,this.location=this.href.split("#")[0],this.external=this.location!==(doc.location+"").split("#")[0]},gui.URL.prototype={hash:null,host:null,hostname:null,href:null,pathname:null,port:null,protocol:null,search:null,id:null,external:!1},gui.URL.absolute=function(doc,href){return new gui.URL(doc,href).href},gui.URL.getParam=function(url,name){name=name.replace(/(\[|\])/g,"\\$1");var results=RegExp("[\\?&]"+name+"=([^&#]*)").exec(url);return null===results?null:results[1]},gui.URL.setParam=function(url,name,value){var cut,params=[],index=-1;return url.indexOf("?")>-1&&(cut=url.split("?"),url=cut[0],params=cut[1].split("&"),params.every(function(param,i){var x=param.split("=");return x[0]===name&&(index=i,null!==value&&(x[1]=value,params[i]=x.join("="))),0>index})),null===value?index>-1&&params.remove(index,index):0>index&&(params[params.length]=[name,value].join("=")),url+(params.length>0?"?"+params.join("&"):"")},gui.KeyMaster={generateKey:function(prefix){prefix="key";var ran=""+Math.random(),key=(prefix||"key")+ran.slice(2,11);return this._keys[key]?key=this.generateKey(prefix):this._keys[key]=!0,key},generateGUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=0|16*Math.random(),v="x"===c?r:8|3&r;return v.toString(16)}).toUpperCase()},isKey:function(string){var hit=null,looks=!1;return gui.Type.isString(string)&&(hit=this.extractKey(string),looks=hit&&hit[0]===string),looks},extractKey:function(string){return/key\d{9}/.exec(string)},_keys:Object.create(null)},gui.SpiritualAid={polyfill:function(win,worker){"use strict";this._strings(win),this._arrays(win),this._functions(win),this._globals(win),this._extras(win),worker||this._effects(win)},_extend:function(what,whit){Object.keys(whit).forEach(function(key){var def=whit[key];void 0===what[key]&&(def.get&&def.set||(what[key]=def))})},_strings:function(win){this._extend(win.String.prototype,{trim:function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")},repeat:function(n){return new win.Array(n+1).join(this)},startsWith:function(sub){return 0===this.indexOf(sub)},endsWith:function(sub){sub+="";var i=this.lastIndexOf(sub);return i>=0&&i===this.length-sub.length},contains:function(sub){return this.indexOf(sub)>-1},toArray:function(){return this.split("")}})},_arrays:function(win){this._extend(win.Array.prototype,{remove:function(from,to){return console.warn("Array.prototype.remove is deprecated. Use gui.Array.remove(array,from,to);"),gui.Array.remove(this,from,to)}}),this._extend(win.Array,{every:function(array,fun,thisp){for(var res=!0,len=array.length>>>0,i=0;len>i;i++)if(void 0!==array[i]&&!fun.call(thisp,array[i],i,array)){res=!1;break}return res},forEach:function(array,fun,thisp){for(var len=array.length>>>0,i=0;len>i;i++)void 0!==array[i]&&fun.call(thisp,array[i],i,array)},map:function(array,fun,thisp){for(var m=[],len=array.length>>>0,i=0;len>i;i++)void 0!==array[i]&&m.push(fun.call(thisp,array[i],i,array));return m},isArray:function(o){return"[object Array]"===win.Object.prototype.toString.call(o)},concat:function(a1,a2){function map(e){return e}return this.map(a1,map).concat(this.map(a2,map))}})},_functions:function(win){this._extend(win.Function.prototype,{bind:function(oThis){if("function"!=typeof this)throw new win.TypeError("Function bind not callable");var fSlice=win.Array.prototype.slice,aArgs=fSlice.call(arguments,1),fToBind=this,Fnop=function(){},fBound=function(){return fToBind.apply(this instanceof Fnop?this:oThis||win,aArgs.concat(fSlice.call(arguments)))};return Fnop.prototype=this.prototype,fBound.prototype=new Fnop,fBound}})},_globals:function(win){this._extend(win,{console:{log:function(){},debug:function(){},warn:function(){},error:function(){}},Map:function(){function Map(){this._map=Object.create(null)}return Map.prototype={isNative:!1,get:function(key){return this._map[key]},set:function(key,val){this._map[key]=val},has:function(key){return void 0!==this._map[key]},"delete":function(key){delete this._map[key]},size:function(){return Object.keys(this._map).length}},Map}(),Set:function(){function Set(){this._map=Object.create(null)}return Set.prototype={isNative:!1,add:function(key){this._map[key]=!0},has:function(key){return this._map[key]===!0},"delete":function(key){delete this._map[key]},size:function(){return Object.keys(this._map).length}},Set}(),WeakMap:function(){function WeakMap(){function del(key){return has(key)&&(keys.splice(i,1),values.splice(i,1)),i>-1}function get(key,d3fault){return has(key)?values[i]:d3fault}function has(key){return i=indexOf.call(keys,key),i>-1}function set(key,value){has(key)?values[i]=value:values[keys.push(key)-1]=value}var keys=[],values=[];return create(WeakMapPrototype,{isNative:{value:!1},"delete":{value:del},del:{value:del},get:{value:get},has:{value:has},set:{value:set}})}function WeakMapInstance(){}var i,Object=win.Object,WeakMapPrototype=WeakMap.prototype,create=Object.create,indexOf=[].indexOf;return WeakMap.prototype=WeakMapInstance.prototype=WeakMapPrototype=new WeakMap,WeakMap}()})},_effects:function(win){this._extend(win,{requestAnimationFrame:function(){var func=win.requestAnimationFrame||win.webkitRequestAnimationFrame||win.mozRequestAnimationFrame||win.oRequestAnimationFrame||win.msRequestAnimationFrame||function(){var lastTime=0;return function(callback){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}}();return func}(),setImmediate:function(){var list=[],handle=1,name="spiritual:emulated:setimmediate";return win.addEventListener("message",function(e){e.data===name&&list.length&&(list.shift().apply(win),e.stopPropagation())},!1),function(func){return list.push(func),win.postMessage(name,"*"),handle++}}()})},_extras:function(win){this._extend(win.Map.prototype,{del:function(key){return this["delete"](key)}}),this._extend(win.Set.prototype,{del:function(key){return this["delete"](key)}}),this._extend(win.console,{debug:win.console.log}),this._extend(XMLHttpRequest.prototype,{overrideMimeType:function(){}}),this._extend(win.XMLHttpRequest,{UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4})}},gui.Spiritual=function(win){this._construct(win)},gui.Spiritual.prototype={constructor:gui.Spiritual,signature:null,context:null,mode:"optimize",debug:!1,autostart:!0,toString:function(){return"[namespace gui]"},go:function(){if(this._gone=!0,this.debug)switch(this.mode){case gui.MODE_JQUERY:gui.Tick.next(function(){gui.Observer.observe(this.context)},this);break;default:gui.Observer.observe(this.context)}switch(this.mode){case gui.MODE_NATIVE:case gui.MODE_JQUERY:case gui.MODE_OPTIMIZE:case gui.MODE_MANAGED:gui.DOMChanger.change(this.context)}gui.Tick.add(gui.TICK_DESTRUCT_DETACHED,this,this.signature),null!==this._configs&&this._configs.forEach(function(config){this.channel(config.select,config.klass)},this)},get:function(arg){var spirit=null,inside=this._spirits.inside,outside=this._spirits.outside;switch(gui.Type.of(arg)){case"string":if(gui.KeyMaster.isKey(arg))spirit=inside[arg]||outside[arg]||null;else{var element=this._document.querySelector(arg);spirit=element?element.spirit:null}break;case"TODO":}return spirit},module:function(name,module){if(!gui.Type.isString(name))throw Error("Module requires a name");var base=this.context.gui.Spirit;if(gui.Type.isObject(module.mixins)&&gui.Object.each(module.mixins,function(name,value){base.mixin(name,value)},this),gui.Type.isObject(module.addins))throw Error("Deprecated");gui.Type.isObject(module.plugins)&&gui.Object.each(module.plugins,function(prefix,plugin){gui.Type.isDefined(plugin)?base.plugin(prefix,plugin):console.error("Undefined plugin for prefix: "+prefix)},this),gui.Type.isArray(module.channels)&&module.channels.forEach(function(channel){var query=channel[0],klass=channel[1];this.channel(query,klass)},this),this._modulelife(module,this.context),this._modules[name]=module},hasModule:function(name){return gui.Type.isDefined(this._modules[name])},channel:function(select,klass){var spirit=null;if(this._gone){if(spirit="string"==typeof klass?gui.Object.lookup(klass,this.context):klass,!gui.Type.isFunction(spirit))throw"Unknown Spirit for selector: "+select;this._channels.push([select,spirit])}else this._configs||(this._configs=[]),this._configs.push({select:select,klass:klass})},portal:function(sub){if(sub!==this.context){var subgui=sub.gui=new this.constructor(sub),indexes=[];subgui._spaces=this._spaces.slice(),this._spaces.forEach(function(ns){var external=sub,internal=this.context;ns.split(".").forEach(function(part){gui.Type.isDefined(external[part])||(external[part]=internal[part]),external=external[part],internal=internal[part]}),this._index(internal,external,this._channels).forEach(function(i){indexes.push(i)})},this),gui.Object.each(this._modules,function(name,module){this._modulelife(module,subgui.context),subgui._modules[name]=module},this),indexes.sort(function(a,b){return a-b}).forEach(function(i){subgui._channels.push(this._channels[i])},this),gui.Guide.observe(sub)}},kickstart:function(){switch(document.readyState){case"interactive":case"complete":gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_KICKSTART)}},namespace:function(ns,nsobject){if(!gui.Type.isString(ns))throw new TypeError("Expected a string: gui.namespace");return this._spaces.push(ns),nsobject},namespaces:function(){return this._spaces.slice()},evaluate:function(element){var res=null;if(element.nodeType===Node.ELEMENT_NODE){var doc=element.ownerDocument,win=doc.defaultView,att=element.getAttribute("gui");gui.Type.isString(att)&&!att.startsWith("[")?""!==att&&(res=win.gui._inlines[att],gui.Type.isDefined(res)||(res=gui.Object.lookup(att,win)),res?win.gui._inlines[att]=res:console.error(att+" is not defined.")):win.gui._channels.every(function(def){var select=def[0],spirit=def[1];return gui.CSSPlugin.matches(element,select)&&(res=spirit),null===res},this)}return res},broadcastGlobal:function(msg,arg){gui.Type.isEvent(arg)&&(arg=new gui.EventSummary(arg)),gui.Broadcast.dispatchGlobal(this,msg,arg)},debugchannels:function(){var out=""+this._document.location;this._channels.forEach(function(channel){out+="\n"+channel[0]+" : "+channel[1]}),console.debug(out+"\n\n")},destruct:function(spirit){var all=this._spirits,key=spirit.$instanceid;delete all.inside[key],delete all.outside[key]},inside:function(spirit){var all=this._spirits,key=spirit.$instanceid;all.inside[key]||(all.outside[key]&&delete all.outside[key],all.inside[key]=spirit)},outside:function(spirit){var all=this._spirits,key=spirit.$instanceid;all.outside[key]||(all.inside[key]&&delete all.inside[key],all.outside[key]=spirit,gui.Tick.dispatch(gui.TICK_DESTRUCT_DETACHED,0,this.signature))},ontick:function(tick){tick.type===gui.TICK_DESTRUCT_DETACHED&&(gui.Object.each(this._spirits.outside,function(key,spirit){spirit.onexit()!==!1&&spirit.ondestruct()},this),this._spirits.outside=Object.create(null))},nameDestructAlreadyUsed:function(){gui.Tick.remove(gui.TICK_DESTRUCT_DETACHED,this,this.signature),["_spiritualaid","context","_document","_channels","_inlines","_spaces","_modules","_spirits"].forEach(function(thing){delete this[thing]},this)},_document:null,_channels:null,_inlines:null,_spaces:null,_gone:!1,_configs:null,_modules:null,_spirits:null,_spiritualaid:gui.SpiritualAid,_construct:function(win){this._spiritualaid.polyfill(win),this.signature=function(){var url=location.href,key="spiritual-signature";return url.contains(key)?gui.URL.getParam(url,key).split("/").pop():gui.KeyMaster.generateKey()}(),this.context=win,this._document=win.document,this._inlines=Object.create(null),this._modules=Object.create(null),this._channels=[],this._spaces=["gui"],this._spirits={inside:Object.create(null),outside:Object.create(null)}},_index:function(internal,external,channels){function index(def){switch(def){case"signature":case"context":break;default:var thing=external[def]=internal[def];gui.Type.isSpiritConstructor(thing)&&thing.portals&&channels.forEach(function(channel,index){channel[1]===thing&&indexes.push(index)})}}var indexes=[];for(var def in internal)this.constructor.prototype.hasOwnProperty(def)||def.startsWith("_")||index(def);return indexes},_modulelife:function(module,context){gui.Type.isFunction(module.init)&&module.init(context),gui.Type.isFunction(module.ready)&&gui.Broadcast.addGlobal(gui.BROADCAST_WILL_SPIRITUALIZE,{onbroadcast:function(b){b.data===context.gui.signature&&(module.ready(context),gui.Broadcast.removeGlobal(gui.BROADCAST_WILL_SPIRITUALIZE,this))}})}},Object.keys(gui).forEach(function(key){gui.Spiritual.prototype[key]=gui[key]}),gui=new gui.Spiritual(window),gui.Type={of:function(o){var type={}.toString.call(o).match(this._typeexp)[1].toLowerCase();return"domwindow"===type&&"undefined"==typeof o+""&&(type="undefined"),type},isDefined:function(o){return"undefined"!==this.of(o)},isComplex:function(o){switch(this.of(o)){case"undefined":case"boolean":case"number":case"string":case"null":return!1}return!0},isWindow:function(o){return o&&o.document&&o.location&&o.alert&&o.setInterval},isEvent:function(o){return this.of(o).endsWith("event")&&this.isDefined(o.type)},isMethod:function(o){return this.isFunction(o)&&!this.isConstructor(o)},isSpirit:function(o){return o&&o instanceof gui.Spirit},isConstructor:function(what){return this.isFunction(what)&&Object.keys(what.prototype).length>0},isSpiritConstructor:function(what){return this.isFunction(what)&&this.isBoolean(what.portals)},cast:function(string){var result=string+"";switch(result){case"null":result=null;break;case"true":case"false":result="true"===result;break;default:parseInt(result,10)+""===result?result=parseInt(result,10):parseFloat(result)+""===result&&(result=parseFloat(result))}return result},_typeexp:/\s([a-zA-Z]+)/},function(){["array","function","object","string","number","boolean","null","arguments","file"].forEach(function(type){this["is"+type[0].toUpperCase()+type.slice(1)]=function(o){return this.of(o)===type}},this)}.call(gui.Type),gui.Object={create:function(proto,props){var resolved=Object.create(null);return Object.keys(props).forEach(function(prop){resolved[prop]={value:props[prop],writable:!0,enumerable:!0,configurable:!0}}),Object.create(proto,resolved)},extend:function(target,source){return Object.keys(source).forEach(function(name){var desc=Object.getOwnPropertyDescriptor(source,name);Object.defineProperty(target,name,desc)}),target},copy:function(source){return this.extend(Object.create(null),source)},each:function(object,func,thisp){Object.keys(object).forEach(function(key){func.call(thisp,key,object[key])})},all:function(object,func,thisp){for(var key in object)func.call(thisp,key,object[key])},isEmpty:function(object){return 0===Object.keys(object).length},lookup:function(opath,context){var result,struct=context;if(opath.contains(".")){var parts=opath.split(".");parts.forEach(function(part){struct=struct[part]}),result=struct}else result=struct[opath];return result},assert:function(opath,value,context){var prop,struct=context;if(opath.contains(".")){var parts=opath.split(".");prop=parts.pop(),parts.forEach(function(part){struct=struct[part]})}else prop=opath;return struct[prop]=value,struct},methods:function(object){var result=[];for(var def in object)gui.Type.isMethod(object[def])&&result.push(def);return result},nonmethods:function(object){var result=[];for(var def in object)gui.Type.isFunction(object[def])||result.push(def);return result},toArray:function(object){var result=[];if(gui.Type.isArray(object))result=object;else try{void 0!==object.length&&"0"in Object(object)&&(result=Array.map(object,function(thing){return thing}))}catch(exception){}return result}},gui.Array={remove:function(array,from,to){return array.splice(from,!to||1+to-from+(!(0>to^from>=0)&&(0>to||-1)*array.length)),array.length},toArray:function(arg){var list;switch(gui.Type.of(arg)){case"array":list=arg;break;case"string":list=arg.split(" ");break;default:list=gui.Object.toArray(arg)}return list.length?list:[arg]}},gui.Function={create:function(name,params,body,context){var F=context?context.Function:Function;return name=this.safename(name),params=params?params.join(","):"",body=body||"",new F("return function "+name+" ( "+params+" ) {"+body+"}")()},safename:function(name){return name&&name.contains(".")&&(name=name.split(".").pop()),name||""}},gui.Class={create:function(){var b=this._breakdown_base(arguments),C=this._createclass(null,b.proto,b.name);return gui.Object.extend(C.prototype,b.protos),gui.Object.extend(C,b.statics),b.recurring&&gui.Object.each(b.recurring,function(key,val){C[key]=C.__recurring__[key]=val}),this._profiling(C)},breakdown:function(args){return this._breakdown_subs(args)},_classes:Object.create(null),_ANONYMOUS:"Anonymous",_BODY:function($name){var body=(""+$name).trim();return body.slice(body.indexOf("{")+1,-1)}(function $name(){if(this instanceof $name==!1)return $name.extend.apply($name,arguments);this.$instanceid=gui.KeyMaster.generateKey("id");var constructor=this.$onconstruct||this.onconstruct;gui.Type.isFunction(constructor)&&constructor.apply(this,arguments)}),_breakdown_base:function(args){var named=gui.Type.isString(args[0]);return{name:named?args[0]:null,proto:args[named?1:0]||{},protos:args[named?2:1]||{},recurring:args[named?3:2]||{},statics:args[named?4:3]||{}}},_breakdown_subs:function(args){var named=gui.Type.isString(args[0]);return{name:named?args[0]:null,protos:args[named?1:0]||Object.create(null),recurring:args[named?2:1]||Object.create(null),statics:args[named?3:2]||Object.create(null)}},_createclass:function(SuperC,proto,name){name=name||gui.Class._ANONYMOUS;var C=gui.Function.create(name,null,this._namedbody(name));return C.$classid=gui.KeyMaster.generateKey("class"),C.prototype=Object.create(proto||null),C.prototype.constructor=C,C=this._internals(C,SuperC),C=this._interface(C),C=this._nameclass(C,name)},_createsubclass:function(SuperC,args){return args=this.breakdown(args),SuperC.__super__=SuperC.__super__||new gui.Super(SuperC),this._extend_fister(SuperC,args.protos,args.recurring,args.statics,args.name)},_extend_fister:function(SuperC,protos,recurring,statics,name){var C=this._createclass(SuperC,SuperC.prototype,name);return gui.Object.extend(C,statics),gui.Object.extend(C.__recurring__,recurring),gui.Object.each(C.__recurring__,function(key,val){C[key]=val}),gui.Accessors.support(C,protos),gui.Super.support(SuperC,C,protos),C=this._nameclass(C,name),this._profiling(C)},_profiling:function(C){var name=C.name||gui.Class._ANONYMOUS;return[C,C.prototype].forEach(function(thing){gui.Object.each(thing,function(key,value){gui.Type.isMethod(value)&&(value.displayName=value.displayName||name+"."+key)})}),C},_internals:function(C,SuperC){return C.__super__=null,C.__subclasses__=[],C.__superclass__=SuperC||null,C.__recurring__=SuperC?gui.Object.copy(SuperC.__recurring__):Object.create(null),SuperC&&SuperC.__subclasses__.push(C),C},_interface:function(C){return["extend","mixin"].forEach(function(method){C[method]=this[method]},this),C},_nameclass:function(C,name){return name=name||gui.Class._ANONYMOUS,this._namedthing(C,"function",name),this._namedthing(C.prototype,"object",name),C},_namedthing:function(what,type,name){what.displayName=name,what.hasOwnProperty("toString")||(what.toString=function(){return"["+type+" "+name+"]"})},_namedbody:function(name){return this._BODY.replace(RegExp("\\$name","gm"),gui.Function.safename(name))}},gui.Object.each({extend:function(){return gui.Class._createsubclass(this,arguments)},mixin:function(name,value,override){!gui.Type.isDefined(this.prototype[name])||override?(this.prototype[name]=value,gui.Class.descendantsAndSelf(this,function(C){C.__super__&&gui.Super.generateStub(C.__super__,C.prototype,name)})):console.error("Addin naming collision in "+this+": "+name)}},function(name,method){gui.Class[name]=method}),gui.Object.each({children:function(C,action,thisp){var results=[];return action=action||gui.Combo.identity,C.__subclasses__.forEach(function(sub){results.push(action.call(thisp,sub))},thisp),results},descendants:function(C,action,thisp,results){return results=results||[],action=action||gui.Combo.identity,C.__subclasses__.forEach(function(sub){results.push(action.call(thisp,sub)),gui.Class.descendants(sub,action,thisp,results)},thisp),results},descendantsAndSelf:function(C,action,thisp){var results=[];return action=action||gui.Combo.identity,results.push(action.call(thisp,C)),this.descendants(C,action,thisp,results)},parent:function(C,action,thisp){return action=action||gui.Combo.identity,action.call(thisp,C.__superclass__)},ancestors:function(C,action,thisp,results){return results=results||[],action=action||gui.Combo.identity,C.__superclass__&&(results.push(action.call(thisp,C.__superclass__)),gui.Class.ancestors(C.__superclass__,action,thisp,results)),results},ancestorsAndSelf:function(C,action,thisp){var results=[];return action=action||gui.Combo.identity,results.push(action.call(thisp,C)),this.ancestors(C,action,thisp,results)}},function(name,method){gui.Class[name]=method}),gui.Arguments={provided:function(){var types=gui.Object.toArray(arguments);return function(action){return function(){return gui.Arguments._match(arguments,types)?action.apply(this,arguments):void 0}}},confirmed:function(){var types=gui.Object.toArray(arguments);return function(action){return function(){return gui.Arguments._validate(arguments,types)?action.apply(this,arguments):void 0}}},_validating:!1,_match:function(args,types){return types.every(function(type,index){return this._matches(type,args[index],index)},this)},_validate:function(args,types){this._validating=!0;var is=this._match(args,types);return this._validating=!1,is},_xtract:function(xpect,optional){return optional?xpect.slice(1,-1):xpect},_matches:function(xpect,arg,index){var needs=!xpect.startsWith("("),split=this._xtract(xpect,!needs).split("|"),input=gui.Type.of(arg),match="*"===xpect||!needs&&"undefined"===input||!needs&&split.indexOf("*")>-1||split.indexOf(input)>-1;return!match&&this._validating&&this._error(index,xpect,input),match},_error:function(index,xpect,input){console.error("Argument "+index+": "+"Expected "+xpect+", got "+input)}},gui.Accessors={support:function(C,protos){this._accessors(protos,C.prototype)},_accessors:function(protos,proto){Object.keys(protos).forEach(function(key){var desc=Object.getOwnPropertyDescriptor(protos,key);desc=this._accessor(proto,key,desc),Object.defineProperty(proto,key,desc)},this)},_accessor:function(proto,key,desc){var val=desc.value;return gui.Type.isObject(val)&&(val.getter||val.setter)&&this._isactive(val)&&(desc=this._activeaccessor(proto,key,val)),desc},_isactive:function(obj){return Object.keys(obj).every(function(key){var is=!1;switch(key){case"getter":case"setter":is=gui.Type.isFunction(obj[key])}return is})},_activeaccessor:function(proto,key,def){var desc;return["getter","setter"].forEach(function(name,set){for(;proto&&!gui.Type.isDefined(def[name]);)proto=Object.getPrototypeOf(proto),desc=Object.getOwnPropertyDescriptor(proto,key),desc&&(def[name]=desc[set?"set":"get"])}),{enumerable:!0,configurable:!0,get:def.getter||this._NOGETTER,set:def.setter||this._NOSETTER}},_NOGETTER:function(){throw Error("Getting a property that has only a setter")},_NOSETTER:function(){throw Error("Setting a property that has only a getter")}},gui.Interface={validate:function(interfais,object){var is=!0,expected=""+interfais,type=gui.Type.of(object);switch(type){case"null":case"string":case"number":case"boolean":case"undefined":throw Error("Expected "+expected+", got "+type+": "+object);default:try{var missing=null,t=null;if(is=Object.keys(interfais).every(function(name){return missing=name,t=gui.Type.of(interfais[name]),gui.Type.of(object[name])===t}),!is)throw Error("Expected "+expected+". A required "+type+' "'+missing+'" is missing')}catch(exception){throw Error("Expected "+expected)}}return is}},gui.Combo={before:function(decoration){return function(base){return function(){return decoration.apply(this,arguments),base.apply(this,arguments)}}},after:function(decoration){return function(base){return function(){var result=base.apply(this,arguments);return decoration.apply(this,arguments),result}}},around:function(decoration){return function(base){return function(){var argv,callback,result,that=this,slice=gui.Combo._slice;return argv=arguments.length>=1?slice.call(arguments,0):[],result=void 0,callback=function(){return result=base.apply(that,argv)},decoration.apply(this,[callback].concat(argv)),result}}},provided:function(condition){return function(base,otherwise){return function(){return condition.apply(this,arguments)?base.apply(this,arguments):otherwise?otherwise.apply(this,arguments):void 0}}},chained:function(base){return function(){var result=base.apply(this,arguments);return void 0===result?this:result}},identity:function(subject){return subject},_slice:[].slice},gui.Super=function(C){gui.Super.generateStubs(this,C.prototype)},gui.Super.prototype=Object.create(null),gui.Object.each({__subject__:null,toString:function(){return"[function gui.Super]"},generateStubs:function(suber,proto){gui.Object.methods(proto).forEach(function(name){gui.Super.generateStub(suber,proto,name)},this)},generateStub:function(suber,proto,name){var func=suber[name]=function(){return proto[name].apply(gui.Super.__subject__,arguments)};func.displayName=name},support:function(SuperC,C,protos){var proto=C.prototype,combo=this._decorator(SuperC);gui.Object.each(protos,function(key,base){gui.Type.isMethod(base)&&(proto[key]=combo(base),proto[key].toString=function(){var original=(""+base).replace(/\t/g,"  ");return gui.Super._DISCLAIMER+original})},this)},_DISCLAIMER:"/**\n  * Method was overloaded by the framework. \n  * This is an approximation of the code :) \n  */\n",_decorator:function(SuperC){return function(base){return function(){var sub=gui.Super.__subject__;gui.Super.__subject__=this,this._super=SuperC.__super__;var result=base.apply(this,arguments);return gui.Super.__subject__=sub,result}}}},function(name,value){gui.Super[name]=value}),gui.Position=function(x,y){this.x=x||0,this.y=y||0},gui.Position.prototype={x:0,y:0,toString:function(){return"[object gui.Position("+this.x+","+this.y+")]"},clone:function(){return new gui.Position(this.x,this.y)}},gui.Position.isEqual=function(p1,p2){return p1.x===p2.x&&p1.y===p2.y},gui.Dimension=function(w,h){this.w=w||0,this.h=h||0},gui.Dimension.prototype={w:0,h:0,toString:function(){return"[object gui.Dimension("+this.w+","+this.h+")]"}},gui.Dimension.isEqual=function(dim1,dim2){return dim1.w===dim2.w&&dim1.h===dim2.h},gui.Geometry=function(x,y,w,h){this.x=x||0,this.y=y||0,this.w=w||0,this.h=h||0},gui.Geometry.prototype={x:0,y:0,w:0,h:0,toString:function(){return"[object gui.Geometry("+this.x+","+this.y+","+this.w+","+this.h+")]"},hitTest:function(geo){return gui.Geometry.hitTest(this,geo)}},gui.Geometry.isEqual=function(geo1,geo2){return geo1.x===geo2.x&&geo1.y===geo2.y&&geo1.w===geo2.w&&geo1.h===geo2.h},gui.Geometry.hitTest=function(geo1,geo2){function x(g1,g2){return g1.x>=g2.x&&g1.x<=g2.x+g2.w}function y(g1,g2){return g1.y>=g2.y&&g1.y<=g2.y+g2.h}var hitx=x(geo1,geo2)||x(geo2,geo1),hity=y(geo1,geo2)||y(geo2,geo1);return hitx&&hity},gui.Then=function(){},gui.Then.prototype={toString:function(){return"[object gui.Then]"},then:function(callback,thisp){this._callback=callback?callback:null,this._pointer=thisp?thisp:null},now:function(){var c=this._callback,p=this._pointer;c&&(this.then(null,null),c.apply(p,arguments))},_callback:null,_pointer:null},gui.HTMLParser=function(doc){if(!doc||!doc.nodeType)throw new TypeError("Document expected");this._document=doc},gui.HTMLParser.prototype={_document:null,parse:function(html,element){var match,fix,temp,fixes=gui.HTMLParser._fixes,comments=gui.HTMLParser._comments,firsttag=gui.HTMLParser._firsttag,doc=this._document;html=html.trim().replace(comments,""),(match=html.match(firsttag))&&(fix=fixes.get(match[1]))&&(html=fix.replace("${html}",html)),temp=doc.createElement("div"),temp.innerHTML=html;var nodes=temp.childNodes;if(fix&&element){var name=element.localName;if(fixes.has(name))for(var node=temp;node;)node=node.firstElementChild,node.localName===name&&(nodes=node.childNodes,node=null)}return Array.map(nodes,function(node){return node})}},gui.HTMLParser._comments=/<!--[\s\S]*?-->/g,gui.HTMLParser._firsttag=/^<([a-z]+)/i,gui.HTMLParser._fixes=new Map,function(){gui.Object.each({td:"<table><tbody><tr>${html}</tr></tbody></table>",tr:"<table><tbody>${html}</tbody></table>",tbody:"<table>${html}</table>",col:"<table><colgroup>${html}</colgroup></table>",option:"<select><option>a</option>${html}</select>"},function(tag,fix){gui.HTMLParser._fixes.set(tag,fix)})}(),function(){var fixes=gui.HTMLParser._fixes;
fixes.set("th",fixes.get("td")),["thead","tfoot","caption","colgroup"].forEach(function(tag){gui.HTMLParser._fixes.set(tag,fixes.get("tbody"))})}(),gui.DOMSerializer=function(){},gui.DOMSerializer.prototype={serialize:function(element){var context=element.ownerDocument.defaultView,serializer=new context.XMLSerializer;return serializer.serializeToString(element)},subserialize:function(element){var html=this.serialize(element);return html.contains("</")&&(html=html.slice(html.indexOf(">")+1,html.lastIndexOf("<"))),html}},gui.FileLoader=gui.Class.create("gui.FileLoader",Object.prototype,{onconstruct:function(doc){this._cache=gui.FileLoader._cache,this._document=doc},load:function(src,callback,thisp){var url=new gui.URL(this._document,src);this._cache.has(url.location)?this._cached(url,callback,thisp):this._request(url,callback,thisp)},onload:function(text,url,callback,thisp){callback.call(thisp,text)},_cache:null,_document:null,_request:function(url,callback,thisp){this._cache.set(url.location,null),new gui.Request(url.href).get(function(status,text){this.onload(text,url,callback,thisp),this._cache.set(url.location,text),gui.FileLoader.unqueue(url.location)},this)},_cached:function(url,callback,thisp){var cached=this._cache.get(url.location);if(null!==cached)this.onload(cached,url,callback,thisp);else{var that=this;gui.FileLoader.queue(url.location,function(text){that.onload(text,url,callback,thisp)})}},$onconstruct:function(doc){if(!doc||doc.nodeType!==Node.DOCUMENT_NODE)throw new TypeError("Document expected");this.onconstruct(doc)}},{},{_cache:new Map,_queue:new Map,queue:function(src,action){this._queue[src]=this._queue[src]||[],this._queue[src].push(action)},unqueue:function(src){var text=this._cache.get(src);if(this._queue[src])for(;this._queue[src][0];)this._queue[src].shift()(text)}}),gui.BlobLoader={loadScript:function(doc,source,callback,thisp){var blob=new Blob([source],{type:"text/javascript"}),script=doc.createElement("script");script.src=this._URL.createObjectURL(blob);var head=doc.querySelector("head");gui.Observer.suspend(head,function(){head.appendChild(script)}),callback&&(script.onload=function(){callback.call(thisp)})},_URL:window.URL||window.webkitURL},gui.EventSummary=function(e){this._construct(e)},gui.EventSummary.prototype={event:null,window:null,document:null,documentspirit:null,toString:function(){return"[object gui.EventSummary]"},_construct:function(e){var win=null,doc=null,target=e.target,type=target.nodeType;gui.Type.isDefined(type)?(doc=type===Node.DOCUMENT_NODE?target:target.ownerDocument,win=doc.defaultView):(win=target,doc=win.document),this.event=e,this.window=win,this.document=doc,this.documentspirit=doc.documentElement.spirit}},gui.Crawler=function(type){return this.type=type||null,this},gui.Crawler.prototype={CONTINUE:0,STOP:1,type:null,direction:null,global:!1,ascend:function(start,handler){this.direction=gui.Crawler.ASCENDING;var win,elm=start instanceof gui.Spirit?start.element:start;do if(elm.nodeType===Node.DOCUMENT_NODE&&(this.global?(win=elm.defaultView,win.parent!==win?win.location.search.contains(gui.IframeSpirit.KEY_SIGNATURE)?(elm=null,gui.Type.isFunction(handler.transcend)&&this._transcend(win,win.parent,handler)):elm=win.frameElement:elm=null):elm=null),elm){var directive=this._handleElement(elm,handler);if(directive)switch(directive){case gui.Crawler.STOP:elm=null}else elm=elm.parentNode}while(elm)},descend:function(start,handler){this.direction=gui.Crawler.DESCENDING;var elm=start instanceof gui.Spirit?start.element:start;elm.nodeType===Node.DOCUMENT_NODE?elm=elm.documentElement:"iframe"===elm.localName&&this.global&&console.log("@TODO descend into iframes"),this._descend(elm,handler,!0)},_descend:function(elm,handler,start){var win,spirit,directive=this._handleElement(elm,handler);switch(directive){case 0:if(elm.childElementCount>0)this._descend(elm.firstElementChild,handler,!1);else if(this.global&&"iframe"===elm.localName&&(spirit=elm.spirit))if(spirit.external)win=elm.ownerDocument.defaultView,gui.Type.isFunction(handler.transcend)&&this._transcend(win,spirit.contentWindow,handler);else{var root=elm.contentDocument.documentElement;this._descend(root,handler,!1)}if(!start){var next=elm.nextElementSibling;null!==next&&this._descend(next,handler,!1)}}},_handleElement:function(element,handler){var directive=gui.Crawler.CONTINUE,spirit=element.spirit;if(spirit&&(directive=spirit.oncrawler(this)),!directive&&handler)switch(gui.Type.isFunction(handler.handleElement)&&(directive=handler.handleElement(element)),directive){case 1:break;default:gui.Type.isFunction(handler.handleSpirit)&&spirit&&(directive=this._handleSpirit(spirit,handler))}return directive||(directive=gui.Crawler.CONTINUE),directive},_handleSpirit:function(spirit,handler){return handler.handleSpirit(spirit)},_transcend:function(thiswin,thatwin,handler){var uri,key,cut,url=thiswin.location.href,sig=gui.URL.getParam(url,gui.IframeSpirit.KEY_SIGNATURE);sig?(cut=sig.split("/"),key=cut.pop(),uri=cut.join("/")):(uri="*",key=thiswin.gui.signature),handler.transcend(thatwin,uri,key)}},gui.Crawler.ASCENDING="ascending",gui.Crawler.DESCENDING="descending",gui.Crawler.CONTINUE=0,gui.Crawler.STOP=1,gui.Request=function(url,doc){url&&this.url(url,doc)},gui.Request.prototype={url:function(url,doc){return this._url=doc?new gui.URL(doc,url).href:url,this},sync:function(){return this._async=!1,this},async:function(){return this._async=!0,this},accept:function(mimetype){return this._accept=mimetype,this},acceptJSON:function(){return this.accept("application/json")},acceptXML:function(){return this.accept("text/xml")},acceptText:function(){return this.accept("text/plain")},format:function(mimetype){return this._format=mimetype,this},header:function(){return console.warn("@TODO request headers"),this},get:function(callback,thisp){var that=this,request=new XMLHttpRequest;request.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&callback.call(thisp,200,that._parse(this.responseText),this.responseText)},request.overrideMimeType(this._accept),request.open("get",this._url,!0),request.send(null)},post:function(){},put:function(){},del:function(){},_async:!0,_url:null,_accept:"text/plain",_format:"application/x-www-form-urlencoded",_parse:function(text){var result=text;try{switch(this._accept){case"application/json":result=JSON.parse(text);break;case"text/xml":result=(new DOMParser).parseFromString(text,"text/xml")}}catch(exception){throw console.error(this._accept+" dysfunction at "+this._url),exception}return result}},gui.Spirit=gui.Class.create("gui.Spirit",Object.prototype,{element:null,document:null,window:null,$instanceid:null,signature:null,toString:function(){return"[object gui.Spirit]"},onconstruct:function(){this.__plugin__(),this.window.gui.debug&&this.__debug__(!0),this.life.goconstruct()},onconfigure:function(){this.life.goconfigure()},onenter:function(){this.window.gui.inside(this),this.life.goenter()},onattach:function(){this.window.gui.inside(this),this.life.goattach()},onready:function(){this.life.goready()},onvisible:function(){this.life.govisible()},oninvisible:function(){this.life.goinvisible()},ondetach:function(){this.window.gui.outside(this),this.life.godetach()},onexit:function(){return this.life.goexit(),void 0},ondestruct:function(now){this.window.gui.destruct(this),this.window.gui.debug&&this.__debug__(!1),this.life.godestruct(),this.__destruct__(now)},oncrawler:function(){return gui.Crawler.CONTINUE},onlife:function(){},invisible:function(){return gui.Spirit.invisible(this)},visible:function(){return gui.Spirit.visible(this)},dispose:function(keep){keep||this.dom.remove(),this.ondestruct()},$onconstruct:function(){},__lazyplugins__:null,__plugin__:function(){this.life=new gui.LifePlugin(this),this.config=new gui.ConfigPlugin(this),this.__lazyplugins__=Object.create(null);var prefixes=[],plugins=this.constructor.__plugins__;gui.Object.each(plugins,function(prefix,Plugin){switch(Plugin){case gui.LifePlugin:case gui.ConfigPlugin:break;default:Plugin.lazy?gui.Plugin.later(Plugin,prefix,this,this.__lazyplugins__):this[prefix]=new Plugin(this),prefixes.push(prefix)}},this),this.life.onconstruct(),this.config.onconstruct(),prefixes.forEach(function(prefix){this.__lazyplugins__[prefix]||this[prefix].onconstruct()},this)},__debug__:function(constructing){var val,elm=this.element;constructing?elm.hasAttribute("gui")||(val="["+this.displayName+"]",elm.setAttribute("gui",val)):(val=elm.getAttribute("gui"),val&&val.startsWith("[")&&elm.removeAttribute("gui"))},__destruct__:function(now){var map=this.__lazyplugins__;if(gui.Object.each(map,function(prefix){map[prefix]===!0&&delete this[prefix]},this),gui.Object.each(this,function(prop){var thing=this[prop];switch(gui.Type.of(thing)){case"object":thing instanceof gui.Plugin&&thing!==this.life&&thing.__destruct__(now)}},this),this.life.__destruct__(),now)this.__null__();else{var that=this,tick=gui.TICK_SPIRIT_NULL;this.document.title,gui.Tick.one(tick,{ontick:function(){try{that.__null__()}catch(exception){}}},this.signature).dispatch(tick,0,this.signature)}},__null__:function(){var myelm=this.element,debug=this.window.gui.debug,ident=""+this;if(myelm)try{myelm.spirit=null}catch(denied){}Object.keys(this).forEach(function(prop){var desc=debug?gui.Spirit.denial(ident,prop):gui.Spirit.DENIED;Object.defineProperty(this,prop,desc)},this)}},{portals:!0,infuse:function(){var C=gui.Class.extend.apply(this,arguments);C.__plugins__=gui.Object.copy(this.__plugins__);var b=gui.Class.breakdown(arguments);return gui.Object.each(C.__plugins__,function(prefix,plugin){var def=b.protos[prefix];switch(gui.Type.of(def)){case"object":var mutant=plugin.extend(def);C.plugin(prefix,mutant,!0);break;case"undefined":break;default:throw new TypeError(C+": Bad definition: "+prefix)}},this),C},summon:function(doc){return this.possess((doc||document).createElement("div"))},possess:function(element){return gui.Guide.possess(element,this)},extend:function(){throw Error('Spirits must use the "infuse" method and not "extend".\nThis method extends both the spirit and it\'s plugins.')},parse:function(doc,html){if(doc.nodeType===Node.DOCUMENT_NODE)return new gui.HTMLParser(doc).parse(html)[0];throw new TypeError(this+".parse() expects a Document")},plugin:function(prefix,plugin,override){var plugins=this.__plugins__,proto=this.prototype;!proto.hasOwnProperty(prefix)||null===proto.prefix||override?(!plugins[prefix]||override)&&(plugins[prefix]=plugin,proto.prefix=null,gui.Class.children(this,function(child){child.plugin(prefix,plugin,override)})):console.error("Plugin naming crash in "+this+": "+prefix)},__plugins__:Object.create(null)},{visible:function(spirit){return spirit.life.invisible&&(this._setvisibility(spirit,!0,spirit.life.entered),spirit.css.remove(gui.CLASS_INVISIBLE)),spirit},invisible:function(spirit){return spirit.life.visible&&(this._setvisibility(spirit,!1,spirit.life.entered),spirit.css.add(gui.CLASS_INVISIBLE)),spirit},_setvisibility:function(spirit,show,subtree){var crawler=new gui.Crawler(show?gui.CRAWLER_VISIBLE:gui.CRAWLER_INVISIBLE);crawler.global=!0,crawler.descend(spirit,{handleSpirit:function(s){return show?s.onvisible():s.oninvisible(),subtree?gui.Crawler.CONTINUE:gui.Crawler.STOP}})},denial:function(name,prop){return{enumerable:!0,configurable:!0,get:function(){throw Error(gui.Spirit.DENIAL+": "+name+":"+prop)},set:function(){throw Error(gui.Spirit.DENIAL+": "+name+":"+prop)}}},DENIED:{enumerable:!0,configurable:!0,get:function(){throw Error(gui.Spirit.DENIAL)},set:function(){throw Error(gui.Spirit.DENIAL)}},DENIAL:"Attempt to handle destructed spirit"}),gui.Plugin=gui.Class.create("gui.Plugin",Object.prototype,{spirit:null,context:null,onconstruct:function(){},destruct:function(){},handleEvent:function(e){gui.Type.isFunction(this.onevent)&&this.onevent(e)},$onconstruct:function(spirit){this.spirit=spirit||null,this.context=spirit?spirit.window:null},__destruct__:function(){this.destruct(),null!==this.spirit&&Object.defineProperty(this,"spirit",gui.Spirit.DENIED)}},{lazy:!0,infuse:function(){throw Error('Plugins must use the "extend" method and not "infuse".')}},{later:function(Plugin,prefix,spirit,map){map[prefix]=!0,Object.defineProperty(spirit,prefix,{enumerable:!0,configurable:!0,get:function(){return map[prefix]===!0&&(map[prefix]=new Plugin(spirit),map[prefix].onconstruct()),map[prefix]},set:function(x){map[prefix]=x}})}}),gui.Tracker=gui.Plugin.extend("gui.Tracker",{_xxx:null,_sig:null,onconstruct:function(){this._super.onconstruct(),this._xxx=Object.create(null),this.spirit&&(this._sig=this.spirit.window.gui.signature)},toggle:function(){console.error("@TODO SpiritTracker#toggle")},contains:function(arg){return this._breakdown(arg).every(function(type){return this._xxx[type]},this)},destruct:function(){this._super.destruct(),gui.Object.each(this._xxx,function(type,list){list.slice(0).forEach(function(checks){this._cleanup(type,checks)},this)},this)},_cleanup:function(type,checks){this._removechecks(type,checks)},_addchecks:function(type,checks){var result=!1,list=this._xxx[type];return list?result=!this._haschecks(list,checks):(list=this._xxx[type]=[],result=!0),result&&list.push(checks),result},_removechecks:function(type,checks){var result=!1,list=this._xxx[type];if(list){var index=this._checksindex(list,checks);index>-1&&(result=!0,0===gui.Array.remove(list,index)&&delete this._xxx[type])}return result},_containschecks:function(type,checks){var result=!1,list=this._xxx[type];return list&&(result=this._haschecks(list,checks)),result},_haschecks:function(list,checks){var result=!1;return list.every(function(a){return a.every(function(b,i){return b===checks[i]})&&(result=!0),!result}),result},_checksindex:function(list,checks){var result=-1;return list.every(function(a,index){return a.every(function(b,i){return b===checks[i]})&&(result=index),-1===result}),result},_breakdown:function(arg){var result=null;switch(gui.Type.of(arg)){case"array":result=arg;break;case"string":result=arg.split(" ")}return result}}),gui.Life=function(target,type){this.target=target,this.type=type},gui.Life.prototype={target:null,type:null,toString:function(){return"[object gui.Life]"}},gui.LifePlugin=gui.Tracker.extend("gui.LifePlugin",{constructed:!1,configured:!1,entered:!1,attached:!1,detached:!0,ready:!1,visible:!0,invisible:!1,exited:!1,destructed:!1,onconstruct:function(){this._super.onconstruct(),this._handlers=Object.create(null)},add:function(arg,handler){return handler=handler?handler:this.spirit,this._breakdown(arg).forEach(function(type){this._addchecks(type,[handler])&&(this._handlers[type]||(this._handlers[type]=[]),this._handlers[type].push(handler))},this),this.spirit},remove:function(arg,handler){return handler=handler?handler:this.spirit,this._breakdown(arg).forEach(function(type){if(this._removechecks(type,[handler])){var index=this._handlers[type].indexOf(type);this._handlers[type].remove(index),0===this._handlers[type].length&&delete this._handlers[type]}},this),this.spirit},dispatch:function(type){var list=this._handlers[type];if(void 0!==list){var life=new gui.Life(this.spirit,type);switch(list.forEach(function(handler){handler.onlife(life)}),type){case gui.Life.CONSTRUCT:case gui.Life.CONFIGURE:case gui.Life.ENTER:case gui.Life.READY:case gui.Life.DETACH:case gui.Life.EXIT:case gui.Life.DESTRUCT:delete this._handlers[type]}}},_handlers:null}),function(){var states={construct:gui.LIFE_CONSTRUCT,configure:gui.LIFE_CONFIGURE,enter:gui.LIFE_ENTER,attach:gui.LIFE_ATTACH,ready:gui.LIFE_READY,visible:gui.LIFE_VISIBLE,invisible:gui.LIFE_INVISIBLE,detach:gui.LIFE_DETACH,exit:gui.LIFE_EXIT,destruct:gui.LIFE_DESTRUCT};gui.Object.each(states,function(state,event){gui.LifePlugin.mixin("go"+state,function(){var prop=state;switch(state){case"ready":case"visible":case"invisible":break;default:prop+="ed"}switch(this[prop]=!0,state){case"enter":case"attach":this.detached=!1;break;case"detach":this.attached=!1;break;case"visible":this.invisible=!1;break;case"invisible":this.visible=!1}this.dispatch(event)})})}(),gui.ConfigPlugin=gui.Plugin.extend("gui.ConfigPlugin",{map:null,onconstruct:function(){this.spirit.att.all().forEach(function(att){this._evaluate(this._lookup(att.name),att.value)},this)},_evaluate:function(name,value){var prefix="gui.",struct=this.spirit,success=!0,prop=null,cuts=null;name.startsWith(prefix)&&(name=name.split(prefix)[1],prop=name,name.indexOf(".")>-1&&(cuts=name.split("."),cuts.forEach(function(cut,i){gui.Type.isDefined(struct)?cuts.length-1>i?struct=struct[cut]:prop=cut:success=!1})),success&&gui.Type.isDefined(struct[prop])?(value=gui.Type.cast(value),gui.Type.isFunction(struct[prop])?struct[prop](value):struct[prop]=value):console.error('No definition for "'+name+'": '+(""+this.spirit)))},_lookup:function(name){var prefix="gui.";return this.map&&this.map.hasOwnProperty(name)&&(name=this.map[name],name.startsWith(prefix)||(name=prefix+name)),name}},{lazy:!1}),gui.Action=function(target,type,data,direction,global){this.target=target,this.type=type,this.data=data,this.direction=direction||gui.Action.ASCEND,this.global=global||!1},gui.Action.prototype={target:null,type:null,data:null,direction:null,global:!1,$instanceid:null,isConsumed:!1,isCancelled:!1,consumer:null,consume:function(consumer){this.isConsumed=!0,this.consumer=consumer},cancel:function(consumer){this.isCancelled=!0,this.consume(consumer)},toString:function(){return"[object gui.Action]"}},gui.Action.DESCEND="descend",gui.Action.ASCEND="ascend",gui.Action.dispatch=function(target,type,data,direction,global){var action=new gui.Action(target,type,data,direction,global),crawler=new gui.Crawler(gui.CRAWLER_ACTION);return crawler.global=global||!1,crawler[direction||"ascend"](target,{handleSpirit:function(spirit){var directive=gui.Crawler.CONTINUE;return spirit.action.contains(type)&&(spirit.action.handleAction(action),action.isConsumed&&(directive=gui.Crawler.STOP,action.consumer=spirit)),directive},transcend:function(win,uri,key){var msg=gui.Action.stringify(action,key);win.postMessage(msg,uri)}}),action},gui.Action.stringify=function(a,key){var prefix="spiritual-action:";return prefix+function(){return a.target=null,a.data=function(d){if(gui.Type.isComplex(d))if(gui.Type.isFunction(d.stringify))d=d.stringify();else try{JSON.stringify(d)}catch(jsonexception){d=null}return d}(a.data),a.$instanceid=key||null,JSON.stringify(a)}()},gui.Action.parse=function(msg){var prefix="spiritual-action:";return msg.startsWith(prefix)?JSON.parse(msg.split(prefix)[1]):void 0},function(confirmed,chained){gui.ActionPlugin=gui.Tracker.extend("gui.ActionPlugin",{type:null,data:null,add:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.IActionHandler,handler)&&this._breakdown(arg).forEach(function(type){this._addchecks(type,[handler,this._global])},this)})),remove:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.IActionHandler,handler)&&this._breakdown(arg).forEach(function(type){this._removechecks(type,[handler,this._global])},this)})),addGlobal:function(arg,handler){return this._globalize(function(){return this.add(arg,handler)})},removeGlobal:function(arg,handler){return this._globalize(function(){return this.remove(arg,handler)})},dispatch:confirmed("string","(*)","(string)")(function(type,data,direction){return gui.Action.dispatch(this.spirit,type,data,direction||"ascend",this._global)}),ascend:function(arg,data){return this.dispatch(arg,data,"ascend")},descend:function(arg,data){return this.dispatch(arg,data,"descend")},dispatchGlobal:function(arg,data){return this._globalize(function(){return this.dispatch(arg,data)})},ascendGlobal:function(arg,data){return this._globalize(function(){return this.ascend(arg,data)})},descendGlobal:function(arg,data){return this._globalize(function(){return this.descend(arg,data)})},handleAction:function(action){var list=this._xxx[action.type];list&&list.forEach(function(checks){var handler=checks[0],matches=checks[1]===action.global;matches&&handler!==action.target&&handler.onaction(action)})},_global:!1,_globalize:function(operation){this._global=!0;var res=operation.call(this);return this._global=!1,res},_cleanup:function(type,checks){if(this._removechecks(type,checks)){var handler=checks[0],global=checks[1];global?this.removeGlobal(type,handler):this.remove(type,handler)}}})}(gui.Arguments.confirmed,gui.Combo.chained),gui.IActionHandler={toString:function(){return"[object IActionHandler]"},onaction:function(){}},gui.AttPlugin=gui.Plugin.extend("gui.AttPlugin",{get:function(name){return gui.AttPlugin.get(this.spirit.element,name)},set:function(name,value){return this.__suspended__||gui.AttPlugin.set(this.spirit.element,name,value),this},has:function(name){gui.AttPlugin.has(this.spirit.element,name)},del:function(name){return this.__suspended__||gui.AttPlugin.del(this.spirit.element,name),this},all:function(){return gui.AttPlugin.all(this.spirit.element)},getmap:function(){return gui.AttPlugin.getmap(this.spirit.element)},setmap:function(map){gui.AttPlugin.setmap(this.spirit.element,map)},__suspended__:!1,__suspend__:function(action){this.__suspended__=!0;var res=action.apply(this,arguments);return this.__suspended__=!1,res}},{},{get:function(elm,name){return gui.Type.cast(elm.getAttribute(name))},set:function(elm,name,value){null===value?this.del(elm,name):(value+="",elm.getAttribute(name)!==value&&elm.setAttribute(name,value))},has:function(elm,name){return elm.hasAttribute(name)},del:function(elm,name){elm.removeAttribute(name)},all:function(elm){return gui.Object.toArray(elm.attributes)},getmap:function(elm){var map=Object.create(null);return this.all(elm).forEach(function(att){map[att.name]=gui.Type.cast(att.value)}),map},setmap:function(elm,map){gui.Object.each(map,function(name,value){this.set(elm,name,value)},this)}}),gui.BoxPlugin=gui.Plugin.extend("gui.BoxPlugin",{width:0,height:0,localX:0,localY:0,pageX:0,pageY:0,clientX:0,clientY:0}),Object.defineProperties(gui.BoxPlugin.prototype,{width:{get:function(){return this.spirit.element.offsetWidth}},height:{get:function(){return this.spirit.element.offsetHeight}},localX:{get:function(){return this.spirit.element.offsetLeft}},localY:{get:function(){return this.spirit.element.offsetTop}},pageX:{get:function(){return this.clientX+gui.Client.scrollRoot.scrollLeft}},pageY:{get:function(){return this.clientY+gui.Client.scrollRoot.scrollTop}},clientX:{get:function(){return this.spirit.element.getBoundingClientRect().left}},clientY:{get:function(){return this.spirit.element.getBoundingClientRect().top}}}),function(confirmed){gui.Broadcast=function(target,type,data,global){this.target=target,this.type=type,this.data=data,this.isGlobal=global,this.signatures=[]},gui.Broadcast.prototype={target:null,type:null,data:null,isGlobal:!1,signatures:null,toString:function(){return"[object gui.Broadcast]"}},gui.Broadcast._globals=Object.create(null),gui.Broadcast._locals=Object.create(null),gui.Broadcast.add=function(message,handler,sig){return this._add(message,handler,sig||gui.signature)},gui.Broadcast.remove=function(message,handler,sig){return this._remove(message,handler,sig||gui.signature)},gui.Broadcast.dispatch=function(target,type,data,sig){return this._dispatch(target,type,data,sig||gui.signature)},gui.Broadcast.addGlobal=function(message,handler){return this._add(message,handler)},gui.Broadcast.removeGlobal=function(message,handler){return this._remove(message,handler)},gui.Broadcast.dispatchGlobal=function(target,type,data){return this._dispatch(target,type,data)},gui.Broadcast.stringify=function(b){var prefix="spiritual-broadcast:";return prefix+function(){return b.target=null,b.data=function(d){if(gui.Type.isComplex(d))if(gui.Type.isFunction(d.stringify))d=d.stringify();else try{JSON.stringify(d)}catch(jsonexception){d=null}return d}(b.data),JSON.stringify(b)}()},gui.Broadcast.parse=function(msg){var prefix="spiritual-broadcast:";return msg.startsWith(prefix)?JSON.parse(msg.split(prefix)[1]):void 0},gui.Broadcast._add=confirmed("array|string","object|function","(string)")(function(type,handler,sig){if(gui.Interface.validate(gui.IBroadcastHandler,handler))if(gui.Type.isArray(type))type.forEach(function(t){this._add(t,handler,sig)},this);else{var map;sig?(map=this._locals[sig],map||(map=this._locals[sig]=Object.create(null))):map=this._globals,map[type]||(map[type]=[]);var array=map[type];-1===array.indexOf(handler)&&array.push(handler)}return this}),gui.Broadcast._remove=function(message,handler,sig){if(gui.Interface.validate(gui.IBroadcastHandler,handler))if(gui.Type.isArray(message))message.forEach(function(msg){this._remove(msg,handler,sig)},this);else{var index,array=function(locals,globals){return sig?locals[sig]?locals[sig][message]:void 0:globals[message]}(this._locals,this._globals);array&&(index=array.indexOf(handler),index>-1&&gui.Array.remove(array,index))}return this},gui.Broadcast._dispatch=function(target,type,data,sig){var global=!gui.Type.isString(sig),map=global?this._globals:this._locals[sig],b=new gui.Broadcast(target,type,data,global);if(map){var handlers=map[type];handlers&&handlers.slice().forEach(function(handler){handler.onbroadcast(b)})}if(global){var root=document.documentElement.spirit;root&&root.propagateBroadcast(b)}}}(gui.Arguments.confirmed),gui.BroadcastPlugin=gui.Tracker.extend("gui.BroadcastPlugin",{add:function(arg,handler){handler=handler?handler:this.spirit;var sig=this._global?null:this._sig;return this._breakdown(arg).forEach(function(type){this._addchecks(type,[handler,this._global])&&(this._global?gui.Broadcast.addGlobal(type,handler):gui.Broadcast.add(type,handler,sig))},this),this},remove:function(arg,handler){handler=handler?handler:this.spirit;var sig=this._global?null:this._sig;return this._breakdown(arg).forEach(function(type){this._removechecks(type,[handler,this._global])&&(this._global?gui.Broadcast.removeGlobal(type,handler):gui.Broadcast.remove(type,handler,sig))},this),this},dispatch:function(arg,data){var result=null,sig=this._global?null:this._sig;return this._breakdown(arg).forEach(function(type){result=this._global?gui.Broadcast.dispatchGlobal(this.spirit,type,data):gui.Broadcast.dispatch(this.spirit,type,data,sig)},this),result},addGlobal:function(arg,handler){return this._globalize(function(){return this.add(arg,handler)})},removeGlobal:function(arg,handler){return this._globalize(function(){return this.remove(arg,handler)})},dispatchGlobal:function(arg,data){return this._globalize(function(){return this.dispatch(arg,data)})},_global:!1,_globalize:function(operation){this._global=!0;var res=operation.call(this);return this._global=!1,res},_cleanup:function(type,checks){if(this._removechecks(type,checks)){var handler=checks[0],global=checks[1];global?null:this._sig,global?gui.Broadcast.removeGlobal(type,handler):gui.Broadcast.remove(type,handler,this._sig)}}}),gui.IBroadcastHandler={toString:function(){return"[object IBroadcastHandler]"},onbroadcast:function(){}},gui.CSSPlugin=gui.Plugin.extend("gui.CSSPlugin",{set:function(prop,val){return gui.CSSPlugin.set(this.spirit.element,prop,val),this},get:function(prop){return gui.CSSPlugin.get(this.spirit.element,prop)},compute:function(prop){return gui.CSSPlugin.compute(this.spirit.element,prop)},style:function(map){return gui.CSSPlugin.style(this.spirit.element,map),this},name:function(name){var result=this.spirit.element.className;return void 0!==name&&(this.spirit.element.className=name,result=this.spirit),result},add:function(name){return gui.CSSPlugin.add(this.spirit.element,name),this},remove:function(name){return gui.CSSPlugin.remove(this.spirit.element,name),this},toggle:function(name){return gui.CSSPlugin.toggle(this.spirit.element,name),this},contains:function(name){return gui.CSSPlugin.contains(this.spirit.element,name)},matches:function(selector){return gui.CSSPlugin.matches(this.spirit.element,selector)}},{},{add:function(element,name){if(name.indexOf(" ")>-1&&(name=name.split(" ")),gui.Type.isArray(name))name.forEach(function(n){this.add(element,n)},this);else if(this._supports)element.classList.add(name);else{var now=element.className.split(" ");-1===now.indexOf(name)&&(now.push(name),element.className=now.join(" "))}},remove:function(element,name){if(name.indexOf(" ")>-1&&(name=name.split(" ")),gui.Type.isArray(name))name.forEach(function(n){this.remove(element,n)},this);else if(this._supports)element.classList.remove(name);else{var now=element.className.split(" "),idx=now.indexOf(name);idx>-1&&now.remove(idx),element.className=now.join(" ")}},toggle:function(element,name){this._supports?element.classList.toggle(name):this.contains(element,name)?this.remove(element,name):this.add(element,name)},contains:function(element,name){var result=!1;if(this._supports)result=element.classList.contains(name);else{var classnames=element.className.split(" ");result=classnames.indexOf(name)>-1}return result},set:function(element,prop,value){switch(gui.Type.isNumber(value)&&(value=(this._shorthands[prop]||"@").replace("@",value)),value+="",prop){case"float":prop="cssFloat";break;default:value=this._normval(element,value),prop=this._normprop(element,prop)}return element.style[prop]=value,this},get:function(element,prop){return this._normval(element.style[this._normprop(element,prop)])},style:function(thing,styles){var element=thing instanceof gui.Spirit?thing.element:thing;return gui.Object.each(styles,function(prop,value){this.set(element,prop,value)},this),thing},compute:function(thing,prop){var element=thing instanceof gui.Spirit?thing.element:thing,doc=element.ownerDocument,win=doc.defaultView;return prop=this._standardcase(this._normprop(element,prop)),win.getComputedStyle(element,null).getPropertyValue(prop)},matches:function(node,selector){return node[this._matchmethod](selector)},_vendors:["","-webkit-","-moz-","-ms-","-o-"],_supports:void 0!==document.documentElement.classList,_camelcase:function(string){return string.replace(/-([a-z])/gi,function(all,letter){return letter.toUpperCase()})},_standardcase:function(string){return string.replace(/[A-Z]/g,function(all,letter){return"-"+string.charAt(letter).toLowerCase()})},_shorthands:{top:"@px",right:"@px",bottom:"@px",left:"@px",width:"@px",height:"@px",maxWidth:"@px",maxHeight:"@px",minWidth:"@px",minHeight:"@px",textIndent:"@px",fontWeight:"@",opacity:"@",zIndex:"@",position:"@",display:"@",visibility:"@"},_normval:function(element,value){var vendors=this._vendors;if(value&&value.contains("-beta-")){var parts=[];value.split(", ").forEach(function(part){(part=part.trim()).startsWith("-beta-")?vendors.every(function(vendor){var test=this._camelcase(part.replace("-beta-",vendor));return void 0!==element.style[test]?(vendors.length>2&&(this._vendors=["",vendor]),parts.push(part.replace("-beta-",vendor)),!1):!0},this):parts.push(part)},this),value=parts.join(",")}return value},_normprop:function(element,prop){var vendors=this._vendors,fixt=prop;return prop.startsWith("-beta-")?vendors.every(function(vendor){var test=this._camelcase(prop.replace("-beta-",vendor));return void 0!==element.style[test]?(vendors.length>2&&(this._vendors=["",vendor]),fixt=test,!1):!0},this):fixt=this._camelcase(fixt),fixt},_matchmethod:function(){var match=null,root=document.documentElement;return["mozMatchesSelector","webkitMatchesSelector","msMatchesSelector","oMatchesSelector","matchesSelector"].every(function(method){return gui.Type.isDefined(root[method])&&(match=method),null===match}),match}()}),function(){function getset(prop){Object.defineProperty(gui.CSSPlugin.prototype,prop,{enumerable:!0,configurable:!0,get:function(){return parseInt(this.get(prop),10)},set:function(val){this.set(prop,val)}})}var shorts=gui.CSSPlugin._shorthands;for(var prop in shorts)shorts.hasOwnProperty(prop)&&getset(prop)}(),function(chained){gui.DOMPlugin=gui.Plugin.extend("gui.DOMPlugin",{id:chained(function(id){return id?(this.spirit.element.id=id,void 0):this.spirit.element.id||null
}),tag:function(name,text){var res=null,doc=this.spirit.document,elm=this.spirit.element;return name?(res=doc.createElement(name),gui.Type.isString(text)&&res.appendChild(doc.createTextNode(text))):res=elm.localName,res},title:chained(function(title){var element=this.spirit.element;return gui.Type.isDefined(title)?(element.title=title?title:"",void 0):element.title}),embedded:function(){return gui.DOMPlugin.embedded(this.spirit.element)},html:chained(function(html,position){var element=this.spirit.element;return gui.Type.isString(html)?(position?element.insertAdjacentHTML(position,html):gui.DOMPlugin.html(element,html),void 0):element.innerHTML}),empty:chained(function(){this.html("")}),text:chained(function(text){var elm=this.spirit.element;return gui.Type.isString(text)?(elm.textContent=text,this):elm.textContent}),clone:function(){return this.spirit.element.cloneNode(!0)},show:chained(function(){this.spirit.css.remove("_gui-invisible"),this.spirit.visible()}),hide:chained(function(){this.spirit.css.add("_gui-invisible"),this.spirit.invisible()}),_qualify:function(selector){return gui.DOMPlugin._qualify(selector,this.spirit.element)}},{},{_thiskeyword:/^this|,this/g,html:function(element,markup){var guide=gui.Guide;if(element.nodeType===Node.ELEMENT_NODE&&gui.Type.isString(markup)){var nodes=new gui.HTMLParser(element.ownerDocument).parse(markup,element);guide.materializeSub(element),guide.suspend(function(){gui.Observer.suspend(element,function(){for(;element.firstChild;)element.removeChild(element.firstChild);nodes.forEach(function(node){element.appendChild(node)})})}),guide.spiritualizeSub(element)}return element.innerHTML},outerHtml:function(element,markup){var res=element.outerHTML,guide=gui.Guide;if(!element.nodeType)throw new TypeError;if(gui.Type.isString(markup)){var nodes=new gui.HTMLParser(element.ownerDocument).parse(markup,element),parent=element.parentNode;guide.materialize(element),guide.suspend(function(){gui.Observer.suspend(parent,function(){for(;nodes.length;)parent.insertBefore(nodes.pop(),element);parent.removeChild(element)})}),guide.spiritualizeSub(parent),res=element}return res},ordinal:function(element){for(var result=0,node=element.parentNode.firstElementChild;null!==node&&node!==element;)node=node.nextElementSibling,result++;return result},embedded:function(node){node=node instanceof gui.Spirit?node.element:node;var check=Node.DOCUMENT_POSITION_CONTAINS+Node.DOCUMENT_POSITION_PRECEDING;return node.compareDocumentPosition(node.ownerDocument)===check},qall:function(node,selector,type){selector=gui.DOMPlugin._qualify(selector,node);var result=gui.Array.toArray(node.querySelectorAll(selector));return type&&(result=result.filter(function(el){return el.spirit&&el.spirit instanceof type}).map(function(el){return el.spirit})),result},_qualify:function(selector,node){var result=selector.trim();switch(node.nodeType){case Node.ELEMENT_NODE:result=selector.replace(gui.DOMPlugin._thiskeyword,node.localName);break;case Node.DOCUMENT_NODE:}return result}}),gui.Object.each({q:function(selector,type){var result=null;return selector=this._qualify(selector),result=type?this.qall(selector,type)[0]||null:this.spirit.element.querySelector(selector)},qall:function(selector,type){return selector=this._qualify(selector),gui.DOMPlugin.qall(this.spirit.element,selector,type)},qdoc:function(){var root=this.spirit.document.documentElement;return root.spirit.dom.q.apply(root.spirit.dom,arguments)},qdocall:function(){var root=this.spirit.document.documentElement;return root.spirit.dom.qall.apply(root.spirit.dom,arguments)}},function(name,method){gui.DOMPlugin.mixin(name,function(){var selector=arguments[0],type=arguments[1];if(gui.Type.isString(selector)){if(1===arguments.length||gui.Type.isFunction(type))return method.apply(this,arguments);throw type=gui.Type.of(type),new TypeError("Unknown spirit for query: "+name+"("+selector+","+type+")")}throw new TypeError("Bad selector for query: "+name+"("+selector+")")})}),gui.Object.each({next:function(type){var result=null,spirit=null,el=this.spirit.element;if(type){for(;null!==(el=el.nextElementSibling);)if(spirit=el.spirit,null!==spirit&&spirit instanceof type){result=spirit;break}}else result=el.nextElementSibling;return result},previous:function(type){var result=null,spirit=null,el=this.spirit.element;if(type){for(;null!==(el=el.previousElementSibling);)if(spirit=el.spirit,null!==spirit&&spirit instanceof type){result=spirit;break}}else result=el.previousElementSibling;return result},first:function(type){var result=null,spirit=null,el=this.spirit.element.firstElementChild;if(type)for(;null===result&&null!==el;)spirit=el.spirit,null!==spirit&&spirit instanceof type&&(result=spirit),el=el.nextElementSibling;else result=el;return result},last:function(type){var result=null,spirit=null,el=this.spirit.element.lastElementChild;if(type)for(;null===result&&null!==el;)spirit=el.spirit,null!==spirit&&spirit instanceof type&&(result=spirit),el=el.previoustElementSibling;else result=el;return result},parent:function(type){var result=this.spirit.element.parentNode;if(type){var spirit=result.spirit;result=spirit&&spirit instanceof type?spirit:null}return result},child:function(type){var result=null,spirit=null,el=this.spirit.element.firstElementChild;if(el&&type)for(;null!==el&&null===result;)spirit=el.spirit,spirit&&spirit instanceof type&&(result=spirit),el=el.nextElementSibling;else result=el;return result},children:function(type){var result=[],me=this.spirit.element,el=me.firstElementChild;if(el){for(;null!==el;)result.push(el),el=el.nextElementSibling;type&&(result=result.filter(function(el){return el.spirit&&el.spirit instanceof type}).map(function(el){return el.spirit}))}return result},ancestor:function(type){var result=this.parent();return type&&(result=null,(new gui.Crawler).ascend(this.spirit.element,{handleSpirit:function(spirit){return spirit instanceof type?(result=spirit,gui.Crawler.STOP):void 0}})),result},ancestors:function(type){var result=[],crawler=new gui.Crawler;return type?crawler.ascend(this.element,{handleSpirit:function(spirit){spirit instanceof type&&result.push(spirit)}}):crawler.ascend(this.element,{handleElement:function(el){result.push(el)}}),result},descendant:function(type){var result=this.child(),me=this.spirit.element;return type&&(new gui.Crawler).descend(me,{handleSpirit:function(spirit){return spirit instanceof type&&spirit.element!==me?(result=spirit,gui.Crawler.STOP):void 0}}),result},descendants:function(type){var result=[],me=this.spirit.element;return(new gui.Crawler).descend(me,{handleElement:function(element){type||element===me||result.push(element)},handleSpirit:function(spirit){type&&spirit instanceof type&&spirit.element!==me&&result.push(spirit)}}),result}},function(name,method){gui.DOMPlugin.mixin(name,function(type){if(!gui.Type.isDefined(type)||gui.Type.isFunction(type))return method.apply(this,arguments);throw new TypeError("Unknown spirit for query: "+name+"("+gui.Type.of(type)+")")})}),gui.Object.each({append:function(things){var els=things,element=this.spirit.element;els.forEach(function(el){element.appendChild(el)})},prepend:function(things){var els=things,element=this.spirit.element,first=element.firstChild;els.reverse().forEach(function(el){element.insertBefore(el,first)})},before:function(things){var els=things,target=this.spirit.element,parent=target.parentNode;els.reverse().forEach(function(el){parent.insertBefore(el,target)})},after:function(things){var els=things,target=this.spirit.element,parent=target.parentNode;els.forEach(function(el){parent.insertBefore(el,target.nextSibling)})},remove:function(){var parent=this.spirit.element.parentNode;parent.removeChild(this.spirit.element)},replace:function(things){this.after(things),this.remove()}},function(name,method){gui.DOMPlugin.mixin(name,function(things){var elms=Array.map(gui.Array.toArray(things),function(thing){return thing&&thing instanceof gui.Spirit?thing.element:thing});if(elms.every(function(elm){return gui.Type.isNumber(elm.nodeType)}))return method.call(this,elms),things;throw new TypeError("Bad input for method: "+name+"("+things+")")})})}(gui.Combo.chained),gui.EventPlugin=gui.Tracker.extend("gui.EventPlugin",{add:function(arg,target,handler,capture){if(target=target?target:this.spirit.element,handler=handler?handler:this.spirit,capture=capture?capture:!1,target instanceof gui.Spirit&&(target=target.element),gui.Interface.validate(gui.IEventHandler,handler)){var checks=[target,handler,capture];this._breakdown(arg).forEach(function(type){this._addchecks(type,checks)&&target.addEventListener(type,handler,capture)},this)}return this},remove:function(arg,target,handler,capture){if(target=target?target:this.spirit.element,handler=handler?handler:this.spirit,capture=capture?capture:!1,target instanceof gui.Spirit&&(target=target.element),gui.Interface.validate(gui.IEventHandler,handler)){var checks=[target,handler,capture];this._breakdown(arg).forEach(function(type){this._removechecks(type,checks)&&target.removeEventListener(type,handler,capture)},this)}return this},toggle:function(arg,target,handler,capture){target=target?target:this.spirit.element,handler=handler?handler:this.spirit,capture=capture?capture:!1,target instanceof gui.Spirit&&(target=target.element);var checks=[target,handler,capture];return this._breakdown(arg).forEach(function(type){this._contains(type,checks)?this.add(type,target,handler,capture):this.remove(type,target,handler,capture)},this),this},_cleanup:function(type,checks){if(this._removechecks(type,checks)){var target=checks[0],handler=checks[1],capture=checks[2];target.removeEventListener(type,handler,capture)}}}),gui.IEventHandler={toString:function(){return"[object IEventHandler]"},handleEvent:function(){}},function(confirmed){gui.Tick=function(type){this.type=type},gui.Tick.prototype={type:null,toString:function(){return"[object gui.Tick]"}},gui.Tick.toString=function(){return"[function gui.Tick]"},gui.Tick._global={types:Object.create(null),handlers:Object.create(null)},gui.Tick._local=Object.create(null),gui.Tick.add=confirmed("string|array","object|function","(string)")(function(type,handler,sig){return this._add(type,handler,!1,sig||gui.signature)}),gui.Tick.one=confirmed("string|array","object|function","(string)")(function(type,handler,sig){return this._add(type,handler,!0,sig||gui.signature)}),gui.Tick.next=function(action,thisp){setImmediate(function(){action.call(thisp)})},gui.Tick.remove=function(type,handler,sig){return sig||console.error("SIG REQUIRED for tick of type: "+type),this._remove(type,handler,sig)},gui.Tick.start=function(){console.error("@TODO gui.Tick.start")},gui.Tick.stop=function(){console.error("@TODO gui.Tick#stop")},gui.Tick.dispatch=function(type,time,sig){return sig||console.error("SIG REQUIRED for tick of type: "+type),this._dispatch(type,time,sig)},gui.Tick.addGlobal=confirmed("string|array","object|function")(function(type,handler){return this._add(type,handler,!1,null)}),gui.Tick.oneGlobal=function(type,handler){return this.add(type,handler,!0,null)},gui.Tick.removeGlobal=function(type,handler){return this._remove(type,handler,null)},gui.Tick.dispatchGlobal=function(type,time){return this._dispatch(type,time,null)},gui.Tick._add=function(type,handler,one,sig){if(gui.Type.isArray(type))type.forEach(function(t){this._add(t,handler,one,sig)},this);else{var list,index,map=sig?this._local[sig]:this._global;map||(map=this._local[sig]={types:Object.create(null),handlers:Object.create(null)}),list=map.handlers[type],list||(list=map.handlers[type]=[]),index=list.indexOf(handler),0>index&&(index=list.push(handler)-1),one&&(list._one=list._one||Object.create(null),list._one[index]=!0)}return this},gui.Tick._remove=function(type,handler,sig){if(gui.Type.isArray(type))type.forEach(function(t){this.remove(t,handler,sig)},this);else{var map=sig?this._local[sig]:this._global,list=map.handlers[type];if(list){var index=list.indexOf(handler);0===gui.Array.remove(list,index)&&delete map.handlers[type]}}return this},gui.Tick._dispatch=function(type,time,sig){var map=sig?this._local[sig]:this._global,types=map.types,tick=new gui.Tick(type);if(gui.Type.isDefined(time)){if(!types[type]){var that=this,id=null;id=0===time?setImmediate(function(){that._dispatch(type,void 0,sig),delete types[type]}):setTimeout(function(){that._dispatch(type,void 0,sig),delete types[type]},time),types[type]=id}}else{var list=map.handlers[type];list&&list.slice().forEach(function(handler){handler.ontick(tick)})}return tick}}(gui.Arguments.confirmed),gui.TickPlugin=gui.Tracker.extend("gui.TickPlugin",{add:function(arg,handler){return handler=handler?handler:this.spirit,gui.Interface.validate(gui.ITickHandler,handler)&&this._breakdown(arg).forEach(function(type){this._addchecks(type,[handler,this._global])&&this._add(type,handler,!1)},this),this},one:function(arg,handler){return this.add(arg,handler,!0)},next:function(action){gui.Tick.next(action,this.spirit)},remove:function(arg,handler){return handler=handler?handler:this.spirit,gui.Interface.validate(gui.ITickHandler,handler)&&this._breakdown(arg).forEach(function(type){this._removechecks(type,[handler,this._global])&&this._remove(type,handler)},this),this},dispatch:function(type,time){return this._dispatch(type,time||0)},_global:!1,_add:function(type,handler,one){var sig=this.spirit.signature;one?this._global?gui.Tick.oneGlobal(type,handler):gui.Tick.one(type,handler,sig):this._global?gui.Tick.addGlobal(type,handler):gui.Tick.add(type,handler,sig)},_remove:function(type,handler){var sig=this.spirit.signature;this._global?gui.Tick.removeGlobal(type,handler):gui.Tick.remove(type,handler,sig)},_dispatch:function(type,time){var tick,sig=this.spirit.signature;return tick=this._global?gui.Tick.dispatchGlobal(type,time):gui.Tick.dispatch(type,time,sig)},_cleanup:function(type,checks){var handler=checks[0],bglobal=checks[1];this._remove(type,[handler])&&(bglobal?gui.Tick.removeGlobal(type,handler):gui.Tick.remove(type,handler,this.signature))}}),gui.ITickHandler={toString:function(){return"[object ITickHandler]"},ontick:function(){}},gui.Tween=function(type,data){this.type=type,this.data=data},gui.Tween.prototype={type:null,data:null,value:0,done:!1},gui.Tween.dispatchGlobal=function(type,data){function step(){var time=(new Date).getTime(),value=1,progress=time-start;if(duration>progress&&(value=progress/duration,"none"!==timing))switch(value=90*value*Math.PI/180,timing){case"ease-in":value=1-Math.cos(value);break;case"ease-out":value=Math.sin(value)}1===value?(tween.value=1,tween.done=!0):(tween.value=value,requestAnimationFrame(step)),gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_TWEEN,tween)}var start=(new Date).getTime(),tween=new gui.Tween(type,data),duration=data?data.duration||200:200,timing=data?data.timing||"none":"none";return step(start),tween},gui.TweenPlugin=gui.Tracker.extend("gui.TweenPlugin",{add:function(arg){var sig=this._global?null:this._sig,message=gui.BROADCAST_TWEEN;return this._breakdown(arg).forEach(function(type){this._addchecks(type,[this._global])&&(this._global?gui.Broadcast.addGlobal(message,this):gui.Broadcast.add(message,this,sig))},this),this},remove:function(arg){return this._global?null:this._sig,gui.BROADCAST_TWEEN,this._breakdown(arg).forEach(function(type){this._removechecks(type,[this._global])},this),this},dispatch:function(arg,data){var result=null,sig=this._global?null:this._sig;return this._breakdown(arg).forEach(function(type){result=this._global?gui.Tween.dispatchGlobal(type,data):gui.Tween.dispatch(type,data,sig)},this),result},addGlobal:function(arg){return this._globalize(function(){return this.add(arg)})},removeGlobal:function(arg){return this._globalize(function(){return this.remove(arg)})},dispatchGlobal:function(arg,data){return this._globalize(function(){return this.dispatch(arg,data)})},onbroadcast:function(b){switch(b.type){case gui.BROADCAST_TWEEN:var tween=b.data;this._containschecks(tween.type,[b.isGlobal])&&this.spirit.ontween(tween)}},_global:!1,_globalize:function(operation){this._global=!0;var res=operation.call(this);return this._global=!1,res},_cleanup:function(type,checks){var message=gui.BROADCAST_TWEEN;if(this._removechecks(type,checks)){var global=checks[0];global?null:this._sig,global?gui.Broadcast.removeGlobal(message,this):gui.Broadcast.remove(message,this,this._sig)}}}),gui.TransitionPlugin=gui.Plugin.extend("gui.TransitionPlugin",{onevent:function(e){e.type===this._endevent&&e.target===this.spirit.element&&this._transitionend(e)},property:function(props){return props&&this.spirit.css.set("-beta-transition-property",props),this._init()},duration:function(time){return time&&(time=gui.Type.isNumber(time)?this._convert(time):time,this.spirit.css.set("-beta-transition-duration",time)),this._init()},timing:function(timing){return timing&&this.spirit.css.set("-beta-transition-timing-function",timing),this._init()},easeIn:function(){return this.timing("ease-in")},easeOut:function(){return this.timing("ease-out")},easeInOut:function(){return this.timing("ease-in-out")},cubicBezier:function(n1,n2,n3,n4){return this.timing("cubic-bezier("+n1+","+n2+","+n3+","+n4+")")},none:function(){return this.property("none")},run:function(config){var css=Object.create(null);this._count=0,gui.Object.each(config,function(key,value){gui.Type.isFunction(this[key])?this[key](value):css[key]=value},this);var now="none"===this.spirit.css.compute("-beta-transition-property"),then=this._then=new gui.Then,spirit=this.spirit;return(this._count=Object.keys(css).length)&&setImmediate(function(){spirit.css.style(css),now&&then&&setImmediate(function(){then.now(null)})}),then},_default:1e3,_endevent:null,_count:0,_init:function(){if(null===this._endevent){var names={webkit:"webkitTransitionEnd",explorer:"MSTransitionEnd",gecko:"transitionend",opera:"oTransitionEnd"};this._endevent=names[gui.Client.agent]||"transitionend",this.spirit.event.add(this._endevent,this.spirit.element,this)}return this},_transitionend:function(e){var t=new gui.Transition(e.propertyName,e.elapsedTime);this._ontransition(t),this.spirit.ontransition(t)},_ontransition:function(){0===--this._count&&this._now()},_now:function(){var then=this._then;then&&then.now(null)},_convert:function(ms){return ms=ms?ms:this._default,ms/1e3+"s"}}),gui.Transition=function(propertyName,elapsedTime){this.duration=Math.round(elapsedTime/1e3),this.type=propertyName},gui.Transition.prototype={type:null,duration:0},gui.AttentionPlugin=gui.Plugin.extend("gui.AttentionPlugin",{trap:function(){return this._trapping||(this._trapping=!0,this._listen(),this._setup()),this},focus:function(){return this._focused||(this._latest?this._latest.focus():this._first()),this},blur:function(){return gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_OFF,this.spirit.$instanceid),this._focused&&this._latest&&this._latest.blur(),this},handleEvent:function(e){switch(e.type){case"blur":case"focusout":this._onblur(e.target);break;case"focus":case"focusin":this._onfocus(e.target)}},onbroadcast:function(b){b.type===gui.BROADCAST_ATTENTION_GO&&b.data===this.spirit.$instanceid&&this.focus()},onlife:function(life){switch(life.type){case gui.LIFE_DESTRUCT:gui.Broadcast.removeGlobal(gui.BROADCAST_ATTENTION_GO,this),gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_OFF,this.spirit.$instanceid)}},_trapping:null,_latest:null,_flag:!1,_setup:function(){["before","after"].forEach(function(pos){var elm=this._input(pos),dom=this.spirit.dom;"before"===pos?dom.prepend(elm):dom.append(elm)},this)},_listen:function(){var elm=this.spirit.element;elm.addEventListener("focus",this,!0),elm.addEventListener("blur",this,!0),this.spirit.life.add(gui.LIFE_DESTRUCT,this),gui.Broadcast.addGlobal(gui.BROADCAST_ATTENTION_GO,this)},_input:function(pos){this.spirit.dom;var doc=this.spirit.document,elm=gui.CSSPlugin.style(doc.createElement("input"),{position:"absolute",opacity:0,top:-5e3});return elm.className="_gui-focus_"+pos,elm},_first:function(){return this._find(!0)},_last:function(){return this._find(!1)},_find:function(isfirst){var elm=null,all=this._elements();return all.length&&(elm=all[isfirst?0:all.length-1],elm.focus()),elm},_elements:function(){return this.spirit.dom.descendants().filter(function(elm){return this._focusable(elm)?elm:void 0},this)},_focusable:function(elm){var is=!1;switch(elm.localName){case"input":case"textarea":case"select":case"button":case"a":elm.tabIndex>-1&&"image"!==elm.type&&(elm.className.startsWith("_gui-focus")||(is=!0))}return is},_onfocus:function(elm){this._focused=!0,this._latest=elm,this._flag||(this._didcatch(),this._flat=!0);var klas=elm.className;klas.startsWith("_gui-focus")&&(klas.contains("after")?this._first():this._last())},_onblur:function(){this._focused=!1,gui.Tick.next(function(){this._focused||this._didescape()},this)},_didcatch:function(){gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_ON,this.spirit.$instanceid)},_didescape:function(){this._flag=!1,gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_OFF,this.spirit.$instanceid)}},{_queue:[],_next:function(){var q=this._queue;return q[q.length-1]},onbroadcast:function(b){var q=this._queue;switch(b.type){case gui.BROADCAST_ATTENTION_ON:this._next()!==b.data&&q.push(b.data);break;case gui.BROADCAST_ATTENTION_OFF:q=this._queue=q.filter(function(key){return key!==b.data?key:void 0}),q.length&&gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_ATTENTION_GO,this._next())}}}),function(){gui.Broadcast.addGlobal([gui.BROADCAST_ATTENTION_ON,gui.BROADCAST_ATTENTION_OFF],gui.AttentionPlugin)}(),gui.module("core",{channels:[["html","gui.DocumentSpirit"],[".gui-styles","gui.StyleSheetSpirit"],[".gui-iframe","gui.IframeSpirit"],[".gui-window","gui.WindowSpirit"],[".gui-action","gui.ActionSpirit"],[".gui-cover","gui.CoverSpirit"],[".gui-spirit","gui.Spirit"]],plugins:{action:gui.ActionPlugin,att:gui.AttPlugin,attention:gui.AttentionPlugin,box:gui.BoxPlugin,broadcast:gui.BroadcastPlugin,config:gui.ConfigPlugin,css:gui.CSSPlugin,dom:gui.DOMPlugin,event:gui.EventPlugin,lif:gui.LifePlugin,tick:gui.TickPlugin,tween:gui.TweenPlugin,transition:gui.TransitionPlugin},mixins:{onaction:function(){},onbroadcast:function(){},ontick:function(){},ontween:function(){},ontransition:function(){},onevent:function(){},handleEvent:function(event){this.onevent(event)}}}),gui.Client=new function(){function extras(){var win=window,doc=document,html=doc.documentElement,body=doc.body,root=null,temp=body.appendChild(gui.CSSPlugin.style(doc.createElement("div"),{position:"absolute",height:"10px",width:"10px",top:"100%"}));win.scrollBy(0,10),root=body.scrollTop?body:html,this.scrollRoot=root,gui.CSSPlugin.style(temp,{position:"fixed",top:"10px"});var has=10===temp.getBoundingClientRect().top;this.hasPositionFixed=has,body.removeChild(temp),win.scrollBy(0,-10);var inner=gui.CSSPlugin.style(document.createElement("p"),{width:"100%",height:"200px"}),outer=gui.CSSPlugin.style(document.createElement("div"),{position:"absolute",top:"0",left:"0",visibility:"hidden",width:"200px",height:"150px",overflow:"hidden"});outer.appendChild(inner),html.appendChild(outer);var w1=inner.offsetWidth;outer.style.overflow="scroll";var w2=inner.offsetWidth;w1===w2&&(w2=outer.clientWidth),html.removeChild(outer),this.scrollBarSize=w1-w2}var agent=navigator.userAgent.toLowerCase(),root=document.documentElement;this.isExplorer=agent.contains("msie"),this.isOpera=agent.contains("opera"),this.isWebKit=agent.contains("webkit"),this.isChrome=this.isWebKit&&agent.contains("chrome"),this.isSafari=this.isWebKit&&!this.isChrome&&agent.contains("safari"),this.isGecko=!this.isWebKit&&!this.isOpera&&agent.contains("gecko"),this.agent=function(){var agent="explorer";return this.isWebKit?agent="webkit":this.isGecko?agent="gecko":this.isOpera&&(agent="opera"),agent}.call(this),this.system=function(){var os=null;return["window mobile","windows","ipad","iphone","haiku","os x","linux"].every(function(test){return agent.contains(test)&&(os=test.match(/ipad|iphone/)?"ios":test.replace(/ /g,"")),null===os}),os}(),this.hasTouch=void 0!==window.ontouchstart||this.isChrome,this.hasBlob=window.Blob&&(window.URL||window.webkitURL),this.isMobile=function(){var shortlist=["android","webos","iphone","ipad","ipod","blackberry","windows phone"];return!shortlist.every(function(system){return!agent.contains(system)})}(),this.hasTransitions=function(){return!["transition","WebkitTransition","MozTransition","OTransition","msTransition"].every(function(test){return void 0===root.style[test]})}(),this.has3D=function(){return!["perspective","WebkitPerspective","MozPerspective","OPerspective","msPerspective"].every(function(test){return void 0===root.style[test]})}(),this.hasAnimationFrame=function(){var win=window;return win.requestAnimationFrame||win.webkitRequestAnimationFrame||win.mozRequestAnimationFrame||win.msRequestAnimationFrame||win.oRequestAnimationFrame?!0:!1}(),this.hasMutations=function(){return!["","WebKit","Moz","O","Ms"].every(function(vendor){return!gui.Type.isDefined(window[vendor+"MutationObserver"])})}(),this.STABLETIME=200,this.scrollRoot=null,this.scrollBarSize=0,this.hasPositionFixed=!1,this.onbroadcast=function(b){var type=gui.BROADCAST_WILL_SPIRITUALIZE;b.type===type&&b.target===gui&&(gui.Broadcast.removeGlobal(type,this),extras.call(this))}},function(){gui.Broadcast.addGlobal(gui.BROADCAST_WILL_SPIRITUALIZE,gui.Client)}(),gui.DocumentSpirit=gui.Spirit.infuse("gui.DocumentSpirit",{onconstruct:function(){this._super.onconstruct(),this._dimension=new gui.Dimension(0,0),this.action.addGlobal(gui.ACTION_DOCUMENT_FIT),this.event.add("message",this.window),Object.keys(this._messages).forEach(function(type){var target=this.document;switch(type){case"scroll":case"resize":target=this.window;break;case"popstate":case"hashchange":var win=this.window;target=win===top?win:null}target&&this.event.add(type,target)},this),this.document===document&&this._constructTop(),gui.Type.isDefined(this.touch)&&this.touch.add(gui.SpiritTouch.FINGER_START),this.action.dispatchGlobal(gui.ACTION_DOCUMENT_CONSTRUCT)},onready:function(){this._super.onready(),this.action.dispatchGlobal(gui.ACTION_DOCUMENT_READY),"complete"!==this.document.readyState||this._isLoaded||this.onload()},onevent:function(e){switch(this._super.onevent(e),e.type){case"orientationchange":this._onorientationchange();break;default:switch(e.type){case"resize":parent===window&&this._onresize();break;case"load":this._isLoaded||this._onload();break;case"message":this._onmessage(e.data)}var message=this._messages[e.type];gui.Type.isDefined(message)&&this._broadcastEvent(e,message)}},onaction:function(a){switch(this._super.onaction(a),a.type){case gui.ACTION_DOCUMENT_FIT:a.consume(),this.fit(a.data===!0)}},onvisible:function(){this.css.remove(gui.CLASS_INVISIBLE),this._super.onvisible()},oninvisible:function(){this.css.add(gui.CLASS_INVISIBLE),this._super.onvisible()},onload:function(){if(this._isLoaded)console.warn("@TODO loaded twice...");else{this._isLoaded=!0,this.action.dispatchGlobal(gui.ACTION_DOCUMENT_ONLOAD);var that=this;setTimeout(function(){that.fit(),that.tick.add(gui.TICK_FIT),that.action.dispatchGlobal(gui.ACTION_DOCUMENT_DONE)},gui.Client.STABLETIME)}},onunload:function(){this.action.dispatchGlobal(gui.ACTION_DOCUMENT_UNLOAD)},ontick:function(tick){switch(this._super.ontick(tick),tick.type){case gui.TICK_FIT:console.log("Fit "+this.document.title+" : "+Math.random()),this.fit(!0)}},fit:function(force){if(this._isLoaded||force){var dim=this._getDimension();gui.Dimension.isEqual(this._dimension,dim)||(this._dimension=dim,this._dispatchFit())}},propagateBroadcast:function(b){b.signatures.push(this.signature);var msg=gui.Broadcast.stringify(b),win=this.window,parent=win.parent;this.dom.qall("iframe",gui.IframeSpirit).forEach(function(iframe){iframe.external&&iframe.contentWindow.postMessage(msg,"*")}),parent!==win&&parent.postMessage(msg,"*")},_isLoaded:!1,_broadcastEvent:function(e,message){switch(e.type){case"mousemove":case"touchmove":try{gui.broadcastGlobal(message,e)}catch(x){throw this.event.remove(e.type,e.target),x}break;default:gui.broadcastGlobal(message,e)}},_onmessage:function(msg){var pattern="spiritual-broadcast";if(msg.startsWith(pattern)){var b=gui.Broadcast.parse(msg);0>b.signatures.indexOf(this.signature)&&gui.Broadcast.dispatchGlobal(b.target,b.type,b.data)}else if(pattern="spiritual-action",msg.startsWith(pattern)){var a=gui.Action.parse(msg);a.direction===gui.Action.DESCEND&&this.action.descendGlobal(a.type,a.data)}},_messages:{click:gui.BROADCAST_MOUSECLICK,mousedown:gui.BROADCAST_MOUSEDOWN,mouseup:gui.BROADCAST_MOUSEUP,scroll:gui.BROADCAST_SCROLL,resize:gui.BROADCAST_RESIZE,touchstart:gui.BROADCAST_TOUCHSTART,touchend:gui.BROADCAST_TOUCHEND,touchcancel:gui.BROADCAST_TOUCHCANCEL,touchleave:gui.BROADCAST_TOUCHLEAVE,touchmove:gui.BROADCAST_TOUCHMOVE,hashchange:gui.BROADCAST_HASHCHANGE,popstate:gui.BROADCAST_POPSTATE},_dimension:null,_timeout:null,_dispatchFit:function(){var dim=this._dimension;this.action.dispatchGlobal(gui.ACTION_DOCUMENT_FIT,{width:dim.w,height:dim.h});var win=this.window;gui.Client.isWebKit&&(win.scrollBy(0,1),win.scrollBy(0,-1))},_getDimension:function(){var rect=this.document.body.getBoundingClientRect();return new gui.Dimension(rect.width,rect.height)},_constructTop:function(){parent===window&&(this._onorientationchange(),this.event.add("orientationchange",window))},_onresize:function(){this.window.clearTimeout(this._timeout),this._timeout=this.window.setTimeout(function(){gui.broadcastGlobal(gui.BROADCAST_RESIZE_END)},gui.DocumentSpirit.TIMEOUT_RESIZE_END)},_onorientationchange:function(){gui.orientation=window.innerWidth>window.innerHeight?1:0,gui.broadcastGlobal(gui.BROADCAST_ORIENTATIONCHANGE)}},{},{TIMEOUT_RESIZE_END:50}),gui.WindowSpirit=gui.Spirit.infuse("gui.WindowSpirit",{cover:"fit",fit:!0,style:!0,onenter:function(){this._super.onenter(),this._cover=this.dom.prepend(gui.CoverSpirit.summon(this.document)),this._frame=this.dom.prepend(gui.IframeSpirit.summon(this.document,this._src)),this.action.addGlobal([gui.ACTION_DOCUMENT_DONE,gui.ACTION_DOCUMENT_FIT]),this._frame.att.set("sandbox",this.att.get("sandbox")),this.style&&this._style()},src:function(src){var result=null;return this.life.entered?(gui.Type.isString(src)&&this._loading(),result=this._frame.src(src)):result=this._src=src,result},onaction:function(action){switch(this._super.onaction(action),action.type){case gui.ACTION_DOCUMENT_DONE:this._loaded(),action.consume();break;case gui.ACTION_DOCUMENT_FIT:if(this.fit){this.css.height=action.data.height,this.action.dispatchGlobal(action.type,action.data.height),this._height=action.data.height;var tick="TICK-TEMP";this.tick.one(tick).dispatch(tick,0)}action.consume()}},ontick:function(tick){this._super.ontick(tick),"TICK-TEMP"===tick.type&&(this.css.height=this._height)},_frame:null,_src:null,_cover:null,_height:0,_loading:function(){this.life.entered&&this.cover&&this._cover.dom.show(),this.action.dispatch(gui.ACTION_WINDOW_LOADING)},_loaded:function(){this.life.entered&&this.cover&&this._cover.dom.hide(),this.action.dispatch(gui.ACTION_WINDOW_LOADED)},_style:function(){"static"===this.css.compute("position")&&(this.css.position="relative"),this.fit&&(this.css.height=0),[this._frame,this._cover].forEach(function(child){child.css.style({position:"absolute",width:"100%",height:"100%"})})}},{summon:function(doc,src){var div=doc.createElement("div"),spirit=this.possess(div);return src&&spirit.src(src),spirit}}),gui.IframeSpirit=gui.Spirit.infuse("gui.IframeSpirit",{external:!1,contentWindow:{getter:function(){return this.element?this.element.contentWindow:null},setter:function(){}},contentDocument:{getter:function(){return this.element?this.element.contentDocument:null},setter:function(){}},onready:function(){this._super.onready(),this.event.add("message",this.window,this)},onevent:function(e){this._super.onevent(e),"message"===e.type&&this.external&&this._onmessage(e.data)},src:function(src){return gui.Type.isString(src)?(gui.IframeSpirit.isExternal(src)&&(src=gui.IframeSpirit.sign(src,this.document,this.$instanceid),this.external=!0),this.element.src=src,void 0):this.element.src
},_onmessage:function(msg){if(this.external&&msg.startsWith("spiritual-action:")){var a=gui.Action.parse(msg);a.direction===gui.Action.ASCEND&&a.$instanceid===this.$instanceid&&this.action.ascendGlobal(a.type,a.data)}}},{summon:function(doc,src){var iframe=doc.createElement("iframe"),spirit=this.possess(iframe);return spirit.css.add("gui-iframe"),src?gui.IframeSpirit.isExternal(src)&&(src=this.sign(src,doc,spirit.$instanceid),spirit.external=!0):src=this.SRC_DEFAULT,iframe.src=src,spirit}},{SRC_DEFAULT:"javascript:void(false);",KEY_SIGNATURE:"spiritual-signature",sign:function(url,doc,key){var loc=doc.location,uri=loc.protocol+"//"+loc.host,sig=uri+"/"+key;return gui.URL.setParam(url,this.KEY_SIGNATURE,sig)},unsign:function(url){return gui.URL.setParam(url,this.KEY_SIGNATURE,null)},isExternal:function(url){var a=document.createElement("a");return a.href=url,a.host!==location.host}}),gui.StyleSheetSpirit=gui.Spirit.infuse("gui.StyleSheetSpirit",{_ATSTATEMENTS:/\@.+\n/g,_channels:null,onconstruct:function(){if(this._super.onconstruct(),this._channels=[],!this.element.disabled){var href=this.element.href;void 0!==href?this._parseExternal(href):(this._parse(this.element.textContent),this.channel())}},_parseExternal:function(href){this._done(!1),new gui.Request(href).get(function(status,css){200===status&&this._parse(css),this._done(!0)},this)},_done:function(isDone){this.broadcast.dispatchGlobal(isDone?gui.BROADCAST_CHANNELS_LOADED:gui.BROADCAST_LOADING_CHANNELS)},_parse:function(text){var channels=[],cssprop="-ui-spirit";if(text.indexOf(cssprop)>-1){var sane=[],coms=text.split("*/");coms.forEach(function(part){sane.push(part.split("/*")[0])}),sane=sane.join("").replace(this._ATSTATEMENTS,""),sane.split("}").forEach(function(part){var split=part.split("{"),selector=split[0],defs=split[1];defs&&defs.split(";").forEach(function(def){var last=def.split(":"),prop=last[0];if(prop.trim()===cssprop){var constructors=last[1].trim();constructors.split(" ").reverse().forEach(function(constructor){channels.push([selector.trim(),constructor.trim()])})}})}),this._channels=channels.reverse()}},channel:function(){this._channels.forEach(function(channel){this.window.gui.channel(channel[0],channel[1])},this)}},{summon:function(doc,href){var link=doc.createElement("link");return link.className="gui-styles",link.rel="stylesheet",link.href=href?href:"",this.possess(link)}}),gui.ActionSpirit=gui.Spirit.infuse("gui.ActionSpirit",{onenter:function(){this._super.onenter(),this.event.add("click")},onevent:function(e){switch(this._super.onevent(e),e.type){case"click":var onaction=this.att.get("onaction");if(gui.Type.isString(onaction)){var Invokable=this.window.Function;new Invokable(onaction).call(this)}}}}),gui.CoverSpirit=gui.Spirit.infuse("gui.CoverSpirit",{show:function(){return this.dom.show(),this},hide:function(){return this.dom.hide(),this},fadeIn:function(duration){gui.Client.hasTransitions?(this.transition.none(),this.css.opacity=0,this.show(),this.transition.run({duration:duration||250,property:"opacity",opacity:1})):this.show()},fadeOut:function(duration){gui.Client.hasTransitions?(this.transition.none(),this.css.opacity=1,this.show(),this.transition.run({duration:duration||250,property:"opacity",opacity:0}).then(function(){this.hide()},this)):this.hide()}},{summon:function(doc){var spirit=this.possess(doc.createElement("div"));return spirit.css.add("gui-cover"),spirit}}),gui.module("jquery",{init:function(context){context===top&&this._spiritualdom()},ready:function(context){var root=context.document.documentElement;if(context.gui.mode===gui.MODE_JQUERY){var jq=context.jQuery;jq.__rootnode=root,this._instance(jq),this._expandos(jq),this._overload(jq,context)}},_expandos:function(jq){gui.Guide,jq.__suspend=!1,["spiritualize","spiritualizeSub","spiritualizeOne","materialize","materializeSub","materializeOne"].forEach(function(method){jq.fn["__"+method]=function(){return this.each(function(i,el){gui.Guide[method](el)})}})},_instance:function(jq){var Init=jq.fn.init,home=jq.__rootnode.ownerDocument.defaultView;home.gui.debug&&(jq.fn.init=function(selector,context,rootjQuery){var inst=new Init(selector,context,rootjQuery),test=inst[0];if(test&&test.nodeType===Node.ELEMENT_NODE&&test.ownerDocument!==home.document)throw Error("JQuery was used to handle elements in another window. Please use a locally loaded version of JQuery.");return inst})},_overload:function(jq,context){var module=this,naive=Object.create(null);["attr","removeAttr"].forEach(function(name){naive[name]=jq.fn[name],jq.fn[name]=function(){var nam=arguments[0],val=arguments[1],res=naive[name].apply(this,arguments),del="removeAttr"===name;return val=del?null:val,this.each(function(i,elm){elm.spirit&&(void 0!==val||del?elm.spirit.att.set(nam,val):res=elm.spirit.att.get(nam))}),res}}),["after","append","appendTo","before","detach","empty","html","text","insertAfter","insertBefore","prepend","prependTo","remove","replaceAll","replaceWith","unwrap","wrap","wrapAll","wrapInner"].forEach(function(name){naive[name]=jq.fn[name],jq.fn[name]=function(){function suber(){return gui.Observer.suspend(jq.__rootnode,function(){return naive[name].apply(that,args)},that)}var res,that=this,args=arguments,set=arguments.length>0;if(context.gui.mode!==gui.MODE_JQUERY)res=suber();else if(jq.__suspend)res=suber();else if("text"===name)set&&this.__materializeSub(),res=suber();else{var arg=function(){return set?jq(args[0]):void 0};switch(gui.Guide,jq.__suspend=!0,name){case"append":case"prepend":res=module._append_prepend.call(this,"append"===name,suber,jq);break;case"after":case"before":res=module._after_before.call(this,"after"===name,suber,jq);break;case"appendTo":res=suber(),arg().each(function(i,m){jq(m).last().__spiritualize()});break;case"prependTo":res=suber(),arg().each(function(i,m){jq(m).first().__spiritualize()});break;case"insertAfter":res=suber(),arg().next().__spiritualize();break;case"insertBefore":res=suber(),arg().prev().__spiritualize();break;case"detach":case"remove":this.__materialize(),res=suber();break;case"replaceAll":res=module._replaceall_replacewith(this,arg(),suber);break;case"replaceWith":res=module._replaceall_replacewith(arg(),this,suber);break;case"empty":this.__materializeSub(),res=suber();break;case"html":set&&this.__materializeSub(),res=suber(),set&&this.__spiritualizeSub();break;case"unwrap":this.parent().__materializeOne(),res=suber();break;case"wrap":case"wrapAll":res=suber(),this.parent().__spiritualizeOne();break;case"wrapInner":res=suber(),this.__spiritualize()}jq.__suspend=!1}return res}})},_spiritualdom:function(){function breakdown(spirit){var elm=spirit.element,doc=elm.ownerDocument,win=doc.defaultView,dom=spirit.dom.embedded(),is$=win.gui.mode===gui.MODE_JQUERY;return{elm:elm,doc:doc,win:win,dom:dom,is$:is$}}var plugin=gui.DOMPlugin.prototype;["html","empty","text"].forEach(function(method){var old=plugin[method];plugin[method]=function(){var res,args=arguments,b=breakdown(this.spirit);return b.is$?(b.dom&&gui.Guide.materializeSub(b.elm),res=gui.Observer.suspend(b.elm,function(){return old.apply(this,args)},this),b.dom&&"html"===method&&gui.Guide.spiritualizeSub(b.elm)):res=old.apply(this,args),res}}),["remove"].forEach(function(method){var old=plugin[method];plugin[method]=function(){var res,args=arguments,b=breakdown(this.spirit);return b.is$?(b.dom&&gui.Guide.materialize(b.elm),res=gui.Observer.suspend(b.elm,function(){return old.apply(this,args)},this)):res=old.apply(this,args),res}}),["append","prepend","before","after"].forEach(function(method){var old=plugin[method];plugin[method]=function(things){var res,b=breakdown(this.spirit);if(b.is$){if(res=gui.Observer.suspend(b.elm,function(){return old.call(this,things)},this),b.dom){things=gui.Array.toArray(things);var els=Array.map(things,function(thing){return thing&&thing instanceof gui.Spirit?thing.element:thing});els.forEach(function(el){gui.Guide.spiritualize(el)})}}else res=old.call(this,things);return res}})},_append_prepend:function(append,suber){var old,last="lastElementChild",fist="firstElementChild",next="nextElementSibling",prev="previousElementSibling",current=Array.map(this,function(elm){return elm[append?last:fist]}),res=suber();return this.each(function(index,elm){for(elm=(old=current[index])?old[append?next:prev]:elm.firstElementChild;elm;)gui.Guide.spiritualize(elm),elm=elm[append?next:prev]}),res},_after_before:function(after,suber){function sibling(node){for(node=node[target];node&&node.nodeType!==Node.ELEMENT_NODE;)node=node[target];return node}var res,sib,current=[],target=after?"nextSibling":"previousSibling";return this.each(function(i,elm){for(;elm&&-1===current.indexOf(elm);)current.push(elm),elm=sibling(elm)}),res=suber(),this.each(function(i,elm){for(sib=sibling(elm);sib&&-1===current.indexOf(sib);)gui.Guide.spiritualize(sib),sib=sibling(sib)}),res},_replaceall_replacewith:function(source,target,suber){var parent,parents=[],current=[];target.each(function(i,elm){gui.Guide.materialize(elm),parent=elm.parentNode,-1===parents.indexOf(parent)&&(parents.push(parent),current=current.concat(Array.map(parent.children,function(child){return child})))});var res=suber();return parents.forEach(function(parent){parent&&Array.forEach(parent.children,function(elm){-1===current.indexOf(elm)&&gui.Guide.spiritualize(elm)})}),res}}),gui.DOMChanger={jquery:!1,innerhtml:{global:!1,local:!1,missing:!1},change:function(win){var element=win.Element.prototype;if(gui.Type.isDefined(element.spirit))throw Error("Spiritual loaded twice?");switch(element.spirit=null,win.gui.mode){case gui.MODE_MANAGED:case gui.MODE_NATIVE:case gui.MODE_OPTIMIZE:this.upgrade(win,gui.DOMCombos.getem());break;case gui.MODE_JQUERY:this._jquery(win)}},upgrade:function(win,combos){this._change(win,combos)},_jquery:function(win){var ok=!1;if(!(ok=gui.Type.isDefined(win.jQuery)))throw Error("Spiritual runs in JQuery mode: Expected JQuery to be loaded first");if(!(ok=win.gui.hasModule("jquery")))throw Error('Spiritual runs in JQuery mode: Expected the "jquery" module');return ok},_change:function(win,combos){var did=[],doc=win.document;this._canchange(win.Element.prototype,win,combos)||win.HTMLElement&&this._canchange(win.HTMLElement.prototype,win)||this._tags().forEach(function(tag){var e=doc.createElement(tag),p=e.constructor.prototype;p!==win.Object.prototype&&-1===did.indexOf(p)&&(this._dochange(p,win,combos),did.push(p))},this)},_tags:function(){return"a abbr address area article aside audio b base bdi bdo blockquote body br button canvas caption cite code col colgroup command datalist dd del details device dfn div dl dt em fieldset figcaption figure footer form h1 h2 h3 h4 h5 h6 head header hgroup hr html i iframe img input ins kbd keygen label legend li link main map menu meta meter nav noscript ol optgroup option output p param pre progress q rp rt ruby s samp script section select small source span strong style submark summary sup table tbody td textarea tfoot th thead time title tr track ul unknown var video wbr".split(" ")},_canchange:function(proto,win,combos){var result=!1,test="it appears to work",cache=proto.hasChildNodes;proto.hasChildNodes=function(){return test};var root=win.document.documentElement;return root.hasChildNodes()===test&&(proto.hasChildNodes=cache,this._dochange(proto,win,combos),result=!0),result},_dochange:function(proto,win,combos){switch(gui.Client.agent){case"explorer":this.innerhtml.global=!0;break;case"gecko":case"opera":this.innerhtml.global=!0;break;case"webkit":gui.DOMPatcher.canpatch(win)?(this.innerhtml.local=!0,gui.DOMPatcher.patch(win.document)):(this.innerhtml.local=!1,this.innerhtml.missing=!0)}var title=win.document.title;switch(win.gui.mode){case gui.MODE_NATIVE:if(this.innerhtml.missing)throw Error("Spiritual native mode is not supported on this device.");break;case gui.MODE_OPTIMIZE:this.innerhtml.missing?(win.gui.mode=gui.MODE_JQUERY,this._jquery(win)&&win.gui.debug&&console.debug(title+": Spiritual runs in JQuery mode. To keep spirits "+"in synch, use JQuery or Spiritual to perform DOM updates.")):(win.gui.mode=gui.MODE_NATIVE,win.gui.debug&&console.debug(title+": Spiritual runs in native mode"))}if(win.gui.mode===gui.MODE_NATIVE){var root=win.document.documentElement;gui.Object.each(combos,function(name,combo){this._docombo(proto,name,combo,root)},this)}},_docombo:function(proto,name,combo,root){if(this._ismethod(name))this._domethod(proto,name,combo);else switch(gui.Client.agent){case"opera":case"gecko":this._doboth(proto,name,combo,root);break;case"explorer":this._doie(proto,name,combo);break;case"webkit":}},_ismethod:function(name){var is=!1;switch(name){case"appendChild":case"removeChild":case"insertBefore":case"replaceChild":case"setAttribute":case"removeAttribute":is=!0}return is},_domethod:function(proto,name,combo){var base=proto[name];proto[name]=combo(function(){return base.apply(this,arguments)})},_doie:function(proto,name,combo){var base=Object.getOwnPropertyDescriptor(proto,name);Object.defineProperty(proto,name,{get:function(){return base.get.call(this)},set:combo(function(){base.apply(this,arguments)})})},_doboth:function(proto,name,combo,root){var getter=root.__lookupGetter__(name),setter=root.__lookupSetter__(name);if(!getter)throw Error("Can't lookup getter for "+name);proto.__defineGetter__(name,function(){return getter.apply(this,arguments)}),proto.__defineSetter__(name,combo(function(){setter.apply(this,arguments)}))}},gui.DOMCombos={getem:function(){return this._creation||(this._creation=this._create())},_creation:null,_create:function(){var combo=gui.Combo,guide=gui.Guide,ifEmbedded=combo.provided(function(){return gui.DOMPlugin.embedded(this)}),ifSpirit=combo.provided(function(){return!gui.Type.isNull(this.spirit)}),spiritualizeAfter=combo.after(function(node){guide.spiritualize(node)}),materializeBefore=combo.before(function(node){guide.materialize(node)}),spiritualizeNewAfter=combo.after(function(newnode){guide.spiritualize(newnode)}),materializeOldBefore=combo.before(function(newnode,oldnode){guide.materialize(oldnode)}),setAttAfter=combo.after(function(att,val){this.spirit.att.__suspend__(function(){this.set(att,val)})}),delAttAfter=combo.after(function(att){this.spirit.att.__suspend__(function(){this.del(att)})}),suspending=combo.around(function(action){return gui.Observer.suspend(this,function(){return action()},this)}),materializeSubBefore=combo.before(function(){guide.materializeSub(this)}),spiritualizeSubAfter=combo.after(function(){guide.spiritualizeSub(this)}),parent=null,materializeThisBefore=combo.before(function(){parent=this.parentNode,guide.materialize(this)}),spiritualizeParentAfter=combo.after(function(){guide.spiritualize(parent)}),patchAfter=combo.after(function(node){gui.Client.isWebKit&&gui.DOMPatcher.patch(node)}),ifEnabled=combo.provided(function(){return this.ownerDocument.defaultView.gui.mode!==gui.MODE_MANAGED}),otherwise=function(action){return action};return{appendChild:function(base){return ifEnabled(ifEmbedded(spiritualizeAfter(patchAfter(suspending(base))),otherwise(base)),otherwise(base))},removeChild:function(base){return ifEnabled(ifEmbedded(materializeBefore(suspending(base)),otherwise(base)),otherwise(base))},insertBefore:function(base){return ifEnabled(ifEmbedded(spiritualizeAfter(patchAfter(suspending(base))),otherwise(base)),otherwise(base))},replaceChild:function(base){return ifEnabled(ifEmbedded(materializeOldBefore(spiritualizeNewAfter(patchAfter(suspending(base)))),otherwise(base)),otherwise(base))},setAttribute:function(base){return ifEnabled(ifEmbedded(ifSpirit(setAttAfter(base),otherwise(base)),otherwise(base)),otherwise(base))},removeAttribute:function(base){return ifEnabled(ifEmbedded(ifSpirit(delAttAfter(base),otherwise(base)),otherwise(base)),otherwise(base))},innerHTML:function(base){return ifEnabled(ifEmbedded(materializeSubBefore(spiritualizeSubAfter(suspending(base))),otherwise(base)),otherwise(base))},outerHTML:function(base){return ifEnabled(ifEmbedded(materializeThisBefore(spiritualizeParentAfter(suspending(base))),otherwise(base)),otherwise(base))},textContent:function(base){return ifEnabled(ifEmbedded(materializeSubBefore(suspending(base)),otherwise(base)),otherwise(base))}}}},gui.DOMPatcher={canpatch:function(win){var root=win.document.documentElement;try{return Object.defineProperty(root,"innerHTML",this._innerHTML),!0}catch(iosexception){return!1}},patch:function(node){if(!gui.DOMChanger.innerhtml.local)throw Error("Somehow JQuery mode should have handled this :(");new gui.Crawler("crawler-webkit-patch").descend(node,this)},handleElement:function(elm){["innerHTML","outerHTML","textContent"].forEach(function(descriptor){Object.defineProperty(elm,descriptor,this["_"+descriptor])},this)},_innerHTML:{get:function(){return(new gui.DOMSerializer).subserialize(this)},set:function(html){gui.DOMPlugin.html(this,html)}},_outerHTML:{get:function(){return(new gui.DOMSerializer).serialize(this)},set:function(html){gui.DOMPlugin.outerHtml(this,html)}},_textContent:{get:function(){var node=this,res="";for(node=node.firstChild;node;node=node.nextSibling)switch(node.nodeType){case Node.TEXT_NODE:res+=node.data;break;case Node.ELEMENT_NODE:res+=node.textContent}return res},set:function(html){gui.DOMPlugin.html(this,html.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot"))}}},gui.Observer={observes:!1,fails:!1,observe:function(win){var sig=win.gui.signature,doc=win.document,obs=this._observers[sig];if(this.observes&&win.gui.debug){if(!gui.Type.isDefined(obs)){var Observer=this._mutationobserver();obs=this._observers[sig]=new Observer(function(mutations){mutations.forEach(function(mutation){gui.Observer._handleMutation(mutation)})})}this._connect(doc,!0)}},suspend:function(node,action,thisp){var res;if(!node.nodeType)throw new TypeError;return this.observes&&1===++this._suspend&&this._connect(node,!1),gui.Type.isFunction(action)&&(res=action.call(thisp)),this.observes&&this.resume(node),res},resume:function(node){if(!node.nodeType)throw new TypeError;this.observes&&0===--this._suspend&&this._connect(node,!0)},_suspend:0,_observers:Object.create(null),_mutationobserver:function(){return window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver},_connect:function(node,connect){var doc=node.ownerDocument||node,win=doc.defaultView,sig=win.gui.signature,obs=this._observers[sig];obs&&(connect?obs.observe(doc,{childList:!0,subtree:!0}):obs.disconnect())},_handleMutation:function(mutation){var action=!1;Array.forEach(mutation.removedNodes,function(node){node.nodeType===Node.ELEMENT_NODE&&(console.warn("Bad remove:",node),action=!0)}),Array.forEach(mutation.addedNodes,function(node){node.nodeType===Node.ELEMENT_NODE&&(console.warn("Bad append:",node),action=!0)}),action&&mutation.target.ownerDocument.defaultView.gui.debug&&console[this.fails?"error":"warn"]("Action required: DOM mutation not intercepted, Spiritual may be out of synch.")}},gui.Guide={toString:function(){return"[object gui.Guide]"},observe:function(win){win.document.addEventListener("DOMContentLoaded",this,!1),win.addEventListener("load",this,!1),win.addEventListener("unload",this,!1)},handleEvent:function(e){var sum=new gui.EventSummary(e);switch(e.type){case"DOMContentLoaded":this._ondom(sum);break;case"load":this._onload(sum);break;case"unload":this._unload(sum)}e.currentTarget.removeEventListener(e.type,this,!1),e.stopPropagation()},onbroadcast:function(b){var sig=b.data,spirit=null,spirits=this._windows[sig];switch(b.type){case gui.BROADCAST_KICKSTART:gui.Broadcast.removeGlobal(b.type,this),this._step1(document);break;case gui.BROADCAST_LOADING_CHANNELS:spirits||(spirits=this._windows[sig]=[],spirits.__loading__=0),spirits.push(b.target),spirits.__loading__++;break;case gui.BROADCAST_CHANNELS_LOADED:if(0===--spirits.__loading__){for(;spirit=spirits.shift();)spirit.channel();this._step2(b.target.document)}}},spiritualize:function(elm){this._spiritualize(elm,!1,!1)},spiritualizeSub:function(elm){this._spiritualize(elm,!0,!1)},spiritualizeOne:function(elm){this._spiritualize(elm,!1,!0)},materialize:function(elm){this._materialize(elm,!1,!1)},materializeSub:function(elm){this._materialize(elm,!0,!1)},materializeOne:function(elm){this._materialize(elm,!1,!0)},possess:function(element,C){var spirit=new C;if(spirit.element=element,spirit.document=element.ownerDocument,spirit.window=spirit.document.defaultView,spirit.signature=spirit.window.gui.signature,element.spirit=spirit,spirit.life&&!spirit.life.constructed)throw"Constructed twice: "+(""+spirit);return spirit.onconstruct(),spirit},exorcise:function(node){this._collect(node,!1,gui.CRAWLER_DISPOSE).forEach(function(spirit){spirit.life.destructed||spirit.ondestruct(!0)},this)},suspend:function(operation,thisp){this._suspended=!0;var res=operation.call(thisp);return this._suspended=!1,res},_windows:Object.create(null),_suspended:!1,_handles:function(node){return!this._suspended&&gui.Type.isDefined(node)&&gui.DOMPlugin.embedded(node)&&node.nodeType===Node.ELEMENT_NODE},_ondom:function(sum){if(gui.broadcastGlobal(gui.BROADCAST_DOMCONTENT,sum),gui.autostart){var meta=sum.document.querySelector("meta[name='gui.autostart']");meta&&gui.Type.cast(meta.getAttribute("content"))===!1||this._step1(sum.document)}},_onload:function(sum){sum.documentspirit&&sum.documentspirit.onload(),gui.broadcastGlobal(gui.BROADCAST_ONLOAD,sum)},_unload:function(sum){sum.documentspirit&&sum.documentspirit.onunload(),gui.broadcastGlobal(gui.BROADCAST_UNLOAD,sum),this.exorcise(sum.document),sum.window.gui.nameDestructAlreadyUsed()},_step1:function(doc){var win=doc.defaultView,sig=win.gui.signature;this._metatags(win),win.gui.go(),this._stylesheets(win),this._windows[sig]||this._step2(doc)},_step2:function(doc){var win=doc.defaultView,sig=win.gui.signature;this.spiritualizeOne(doc.documentElement),win.gui.mode!==gui.MODE_MANAGED&&(gui.broadcastGlobal(gui.BROADCAST_WILL_SPIRITUALIZE,sig),this.spiritualizeSub(doc.documentElement),gui.broadcastGlobal(gui.BROADCAST_DID_SPIRITUALIZE,sig))},_metatags:function(win){var doc=win.document,spaces=win.gui.namespaces(),metas=doc.querySelectorAll("meta[name]");Array.forEach(metas,function(meta){var prop=meta.getAttribute("name");spaces.forEach(function(ns){if(prop.startsWith(ns+".")){var value=gui.Type.cast(meta.getAttribute("content"));gui.Object.assert(prop,value,win)}})})},_stylesheets:function(win){var doc=win.document,xpr=".gui-styles",css=doc.querySelectorAll(xpr);Array.forEach(css,function(elm){this.spiritualizeOne(elm)},this)},_collect:function(node,skip,id){var list=[];return new gui.Crawler(id).descend(node,{handleSpirit:function(spirit){skip&&spirit.element===node||spirit.life.destructed||list.push(spirit)}}),list},_spiritualize:function(node,skip,one){if(node=node.nodeType===Node.DOCUMENT_NODE?node.documentElement:node,this._handles(node)){var attach=[],readys=[];new gui.Crawler(gui.CRAWLER_ATTACH).descend(node,{handleElement:function(elm){if(!skip||elm!==node){var spirit=elm.spirit;spirit||(spirit=gui.Guide._evaluate(elm)),null!==spirit&&(spirit.life.attached||attach.push(spirit))}return one?gui.Crawler.STOP:gui.Crawler.CONTINUE}}),attach.forEach(function(spirit){spirit.life.configured||spirit.onconfigure(),this._invisible(spirit)?spirit.life.visible&&spirit.oninvisible():spirit.life.invisible&&spirit.onvisible(),spirit.life.entered||spirit.onenter(),spirit.onattach(),spirit.life.ready||readys.push(spirit)},this),readys.reverse().forEach(function(spirit){spirit.onready()},this)}},_materialize:function(node,skip){node=node.nodeType===Node.DOCUMENT_NODE?node.documentElement:node,this._handles(node)&&this._collect(node,skip,gui.CRAWLER_DETACH).forEach(function(spirit){spirit.life.attached&&!spirit.life.destructed&&spirit.ondetach()},this)},_evaluate:function(element){if(!element.spirit){var doc=element.ownerDocument,win=doc.defaultView,hit=win.gui.evaluate(element);hit&&this.possess(element,hit)}return element.spirit},_invisible:function(spirit){return spirit.css.contains(gui.CLASS_INVISIBLE)||spirit.css.matches("."+gui.CLASS_INVISIBLE+" *")}},function(){gui.Guide.observe(window),gui.Broadcast.addGlobal([gui.BROADCAST_LOADING_CHANNELS,gui.BROADCAST_CHANNELS_LOADED,gui.BROADCAST_KICKSTART],gui.Guide)}(),window.edb=gui.namespace("edb",{BROADCAST_GETTER:"edb-broadcast-getter",BROADCAST_SETTER:"edb-broadcast-setter",BROADCAST_OUTPUT:"edb-broadcast-output",BROADCAST_FUNCTION_LOADED:"edb-broadcast-function-loaded",BROADCAST_TAG_LOADED:"edb-broadcast-tag-loaded",BROADCAST_SCRIPT_INVOKE:"edb-broadcast-spiritscript-invoke",LIFE_SCRIPT_WILL_RUN:"edb-life-script-will-run",LIFE_SCRIPT_DID_RUN:"edb-life-script-did-run",TICK_SCRIPT_UPDATE:"edb-tick-spiritscript-update",TICK_COLLECT_INPUT:"edb-tick-collect-input",toString:function(){return"[namespace edb]"}}),edb.Type=function(){},edb.Type.prototype={$primarykey:"id",_instanceid:null,onconstruct:function(){},$init:function(){},$sub:function(){gui.Broadcast.dispatchGlobal(null,edb.BROADCAST_GETTER,this._instanceid)},$pub:function(){gui.Broadcast.dispatchGlobal(null,edb.BROADCAST_SETTER,this._instanceid)},$serialize:function(pretty){var clone=JSON.parse(JSON.stringify(this));return Object.keys(clone).forEach(function(key){switch(key.charAt(0)){case"$":case"_":delete clone[key]}}),JSON.stringify(clone,null,pretty?"	":"")}},edb.Type.getter=gui.Combo.before(function(){gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_GETTER,this._instanceid)}),edb.Type.setter=gui.Combo.after(function(){gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_SETTER,this._instanceid)}),edb.Type.decorateGetters=function(proto,methods){return methods.forEach(function(method){proto[method]=edb.Type.getter(proto[method])}),proto},edb.Type.decorateSetters=function(proto,methods){return methods.forEach(function(method){proto[method]=edb.Type.setter(proto[method])}),proto},edb.Object=gui.Class.create("edb.Object",Object.prototype,{$onconstruct:function(data){this._instanceid=this.$instanceid;var type=gui.Type.of(data);switch(type){case"object":case"undefined":edb.Object.approximate(this,data),this.onconstruct();break;default:throw new TypeError("Unexpected argument of type "+type.toUpperCase()+":\n"+data)}}},{},{approximate:function(handler,proxy){var def=null;proxy=proxy||{};var instance=Object.create(null);this._definitions(handler).forEach(function(key){switch(def=handler[key],gui.Type.of(def)){case"function":if(gui.Type.isConstructor(def)){var C=def;instance[key]=new C(proxy[key])}break;case"object":console.warn("TODO: approximate object: "+key),console.warn(JSON.stringify(def));break;case"array":console.warn("TODO: approximate array: "+key),console.warn(JSON.stringify(def));break;default:gui.Type.isDefined(proxy[key])||(proxy[key]=handler[key])}}),gui.Object.nonmethods(proxy).forEach(function(key){Object.defineProperty(handler,key,{enumerable:!0,configurable:!0,get:edb.Type.getter(function(){return instance[key]||proxy[key]}),set:edb.Type.setter(function(value){var target=instance[key]?instance:proxy;target[key]=value})})})},_definitions:function(handler){var keys=[];return gui.Object.all(handler,function(key){gui.Type.isDefined(Object.prototype[key])||gui.Type.isDefined(edb.Type.prototype[key])||key.startsWith("_")||keys.push(key)}),keys}}),function(){gui.Object.extend(edb.Object.prototype,edb.Type.prototype)}(),edb.Array=gui.Class.create("edb.Array",Array.prototype,{$of:null,$onconstruct:function(){if(this._instanceid=this.$instanceid,arguments.length){var args=[];gui.Type.isArray(arguments[0])?args=arguments[0]:Array.forEach(arguments,function(arg){args.push(arg)});var type=this.$of;gui.Type.isFunction(type)&&(args=args.map(function(o){if(void 0!==o&&!o._instanceid){var Type=type;gui.Type.isConstructor(Type)||(Type=type(o)),o=new Type(o)}return o})),args.forEach(function(arg){Array.prototype.push.call(this,arg)},this)}edb.Array.approximate(this,{}),this.onconstruct.call(this,arguments)}},{},{approximate:function(handler,proxy){var def=null;proxy=proxy||{},this._definitions(handler).forEach(function(key){switch(def=handler[key],gui.Type.of(def)){case"function":break;case"object":case"array":console.warn("TODO: complex stuff on edb.Array :)");break;default:gui.Type.isDefined(proxy[key])||(proxy[key]=handler[key])}}),gui.Object.nonmethods(proxy).forEach(function(key){Object.defineProperty(handler,key,{enumerable:!0,configurable:!0,get:function(){return this.$sub(),proxy[key]},set:function(value){proxy[key]=value,this.$pub()}})})},_definitions:function(handler){function fix(key){gui.Type.isNumber(gui.Type.cast(key))||gui.Type.isDefined(Array.prototype[key])||gui.Type.isDefined(edb.Type.prototype[key])||key.startsWith("_")||keys.push(key)}var keys=[];for(var key in handler)fix(key);return keys}}),function(proto){"use strict";gui.Object.extend(proto,edb.Type.prototype),edb.Type.decorateGetters(proto,["filter","forEach","every","map","some","indexOf","lastIndexOf"]),edb.Type.decorateSetters(proto,["push","pop","shift","unshift","splice","reverse"]),proto.concat=function(other){var clone=new this.constructor;return this.forEach(function(o){clone.push(o)}),other.forEach(function(o){clone.push(o)}),clone}}(edb.Array.prototype),edb.ScriptPlugin=gui.Plugin.extend("edb.ScriptPlugin",{type:"text/edbml",src:null,loaded:!0,autorun:!0,ran:!1,diff:!0,debug:!1,extras:null,onconstruct:function(){this._super.onconstruct();var spirit=this.spirit;spirit instanceof edb.ScriptSpirit?this.autorun=!1:this.diff&&(this._updater=new edb.UpdateManager(spirit)),this.src&&spirit.life.add(gui.LIFE_ENTER,this)},onlife:function(life){life.type===gui.LIFE_ENTER&&this.load(this.src)},functions:function(){return this._script.functions},input:function(){return this._script.input},load:function(src,type){var context=this.spirit.window;edb.Template.load(context,src,type||this.type,function(script){this._compiled(script)},this)},compile:function(source,type,directives){var context=this.spirit.window;edb.Template.compile(context,source,type||this.type,directives,function(script){this._compiled(script)},this)},run:function(){this._script?(this._script.pointer=this.spirit,this.write(this._script.run.apply(this._script,arguments))):console.warn("Running uncompiled script")},write:function(html){this.diff?this._updater.update(html):this.spirit.dom.html(html),this.ran=!0,this.spirit.life.dispatch(edb.LIFE_SCRIPT_DID_RUN,(this._latest=html)!==this._latest)},_script:null,_updater:null,_compiled:function(script){this._script=script,this.loaded=!0,this.debug&&this._script.debug(),this.autorun&&this.run()}},{lazy:!1}),edb.OutputPlugin=gui.Plugin.extend("edb.OutputPlugin",{dispatch:function(data,Type){var input=this._format(data,Type);if(!(input instanceof edb.Input))throw new TypeError("Not an instance of edb.Input: "+input);if(!input.type)throw Error("edb.Input type is "+input.type);input.type.output=input,gui.Broadcast.dispatchGlobal(this.sandboxed?null:this.spirit,edb.BROADCAST_OUTPUT,input)},_format:function(data,Type){if(data instanceof edb.Input==!1){if(Type)Type=this._lookup(Type),data instanceof Type==!1&&(data=new Type(data));else if(data._instanceid)Type=data.constructor;else{switch(gui.Type.of(data)){case"object":Type=edb.Object.extend();break;case"array":Type=edb.Array.extend()}data=this._format(data,Type)}data=new edb.Input(Type,data)}return data},_lookup:function(arg){var type=null;switch(gui.Type.of(arg)){case"function":type=arg;break;case"string":type=gui.Object.lookup(arg,this.context);break;case"object":console.error(this+": expected edb.Type constructor (not an object)")}if(!type)throw new TypeError('The type "'+arg+'" does not exist');return type}}),edb.InputPlugin=gui.Tracker.extend("edb.InputPlugin",{done:!0,onconstruct:function(){this._super.onconstruct(),gui.Broadcast.addGlobal(edb.BROADCAST_OUTPUT,this),this._watches=[],this._matches=[]},add:gui.Combo.chained(function(arg,handler){this.done=!1,handler=handler?handler:this.spirit,arg=edb.InputPlugin._breakdown(arg,this.context),this._add(arg,handler)}),remove:gui.Combo.chained(function(arg,handler){handler=handler?handler:this.spirit,arg=edb.InputPlugin._breakdown(arg,this.context),this._remove(arg,handler),this.done=this._matches.length===this._watches.length
}),get:function(type){var types=this._matches.map(function(input){return input.data.constructor}),best=edb.InputPlugin._bestmatch(type,types),input=best?this._matches.filter(function(input){return input.type===best}).shift():null;return input?input.data:null},onbroadcast:function(b){b.type===edb.BROADCAST_OUTPUT&&this._maybeinput(b.data)},_watches:null,_matches:null,_add:function(types,handler){types.forEach(function(type){this._watches.push(type),this._addchecks(type.$classid,[handler]),type.output&&gui.Tick.next(function(){this._todoname()},this)},this)},_remove:function(types,handler){types.forEach(function(type){var index=this._watches.indexOf(type);index>-1&&(this._watches.remove(index),this._removechecks(type.$classid,[handler]))},this)},_todoname:function(){this._watches.forEach(function(type){type.output instanceof edb.Input&&this._maybeinput(type.output)},this)},_maybeinput:function(input){var best=edb.InputPlugin._bestmatch(input.type,this._watches);best&&(this._updatematch(input),this.done=this._matches.length===this._watches.length,this._updatehandlers(input))},_updatematch:function(newinput){var matches=this._matches,types=matches.map(function(input){return input.type}),best=edb.InputPlugin._bestmatch(newinput.type,types);if(best){var oldinput=matches.filter(function(input){return input.type===best})[0],index=matches.indexOf(oldinput);matches[index]=newinput}else matches.push(newinput)},_updatehandlers:function(input){gui.Class.ancestorsAndSelf(input.type,function(Type){var list=this._xxx[Type.$classid];list&&list.forEach(function(checks){var handler=checks[0];handler.oninput(input)})},this)}},{},{_breakdown:function(arg,context){switch(gui.Type.of(arg)){case"array":return this._breakarray(arg,context);default:return this._breakother(arg,context)}},_breakarray:function(array,context){return array.map(function(o){switch(gui.Type.of(o)){case"function":return o;case"string":return gui.Object.lookup(o,context);case"object":console.error("Expected function. Got object.")}},this)},_breakother:function(arg,context){switch(gui.Type.of(arg)){case"function":return[arg];case"string":return this._breakarray(arg.split(" "),context);case"object":console.error("Expected function. Got object.")}},_bestmatch:function(target,types){var best=null,rating=Number.MAX_VALUE;return this._rateall(target,types,function(type,rate){rate>-1&&rating>rate&&(best=type)}),best},_rateall:function(target,types,action){types.forEach(function(type){action(type,this._rateone(target,type))},this)},_rateone:function(target,type){if(target===type)return 0;var tops=gui.Class.ancestorsAndSelf(target),subs=gui.Class.descendantsAndSelf(target),itop=tops.indexOf(type),isub=subs.indexOf(type);return 0>itop?isub:itop}}),edb.Input=function(type,data){this.type=type||null,this.data=data||null},edb.Input.prototype={type:null,data:null,toString:function(){return"[object edb.Input]"}},edb.Input.add=function(handler){console.log("deprecated"),gui.Broadcast.addGlobal(edb.BROADCAST_OUTPUT,handler)},edb.Input.remove=function(handler){console.log("deprecated"),gui.Broadcast.removeGlobal(edb.BROADCAST_OUTPUT,handler)},edb.ScriptSpirit=gui.Spirit.infuse("edb.ScriptSpirit",{debug:!1,config:{map:{debug:"debug"}},onenter:function(){this._super.onenter(),this._plainscript()||this.dom.parent(gui.Spirit)&&this._initplugin()},_plainscript:function(){var is=!1;switch(this.att.get("type")){case null:case"text/ecmacript":case"text/javascript":case"application/javascript":case"application/x-javascript":is=!0}return is},_initplugin:function(){var src=this.att.get("src")||this.src,type=this.att.get("type")||this.type,parent=this.dom.parent(),extras=this.att.getmap(),plugin=parent.spirit.script;plugin.extras=extras,plugin.debug=this.debug,src?plugin.load(src,type,extras):plugin.compile(this.dom.text(),type,extras)}}),edb.ServiceSpirit=gui.Spirit.infuse("edb.ServiceSpirit",{onconstruct:function(){this._super.onconstruct();var type=this.att.get("type");if(!type)throw Error("TODO: formalize missing type somehow");var Type=gui.Object.lookup(type,this.window);this.att.get("href")?new gui.Request(this.element.href).acceptJSON().get(function(status,data){this.output.dispatch(new Type(data))},this):this.output.dispatch(new Type)},_pipeline:function(){console.error("TODO: might this be outdated???");var data=new this.output._type(this._arg(0),this._arg(1),this._arg(2),this._arg(3),this._arg(4),this._arg(5),this._arg(6),this._arg(7),this._arg(8),this._arg(9));this.output.dispatch(data)},_arg:function(index){var type=this.input._types[index];return this.input.get(type)}}),edb.Instruction=function(pi){this.atts=Object.create(null),this.type=pi.split("<?")[1].split(" ")[0];for(var hit,atexp=edb.Instruction._ATEXP;hit=atexp.exec(pi);){var n=hit[1],v=hit[2];this.atts[n]=gui.Type.cast(v)}},edb.Instruction.prototype={type:null,atts:null,toString:function(){return"[object edb.Instruction]"}},edb.Instruction.from=function(source){for(var pis=[],hit=null;hit=this._PIEXP.exec(source);)pis.push(new edb.Instruction(hit[0]));return pis},edb.Instruction.clean=function(source){return source.replace(this._PIEXP,"")},edb.Instruction._PIEXP=/<\?.[^>?]+\?>/g,edb.Instruction._ATEXP=/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g,edb.Runner=function(){},edb.Runner.prototype={firstline:!1,lastline:!1,firstchar:!1,lastchar:!1,run:function(compiler,script,status,result){this._runlines(compiler,script.split("\n"),status,result)},ahead:function(string){var line=this._line,index=this._index,i=index+1,l=string.length;return line.length>index+l&&line.substring(i,i+l)===string},behind:function(string){var line=this._line,index=this._index,length=string.length,start=index-length;return start>=0&&line.substr(start,length)===string},_line:null,_index:-1,_runlines:function(compiler,lines,status,result){var stop=lines.length-1;lines.forEach(function(line,i){this._line=line,this.firstline=0===i,this.lastline=i===stop,compiler.online(line,this,status,result),this._runchars(compiler,line.split(""),status,result)},this)},_runchars:function(compiler,chars,status,result){var stop=chars.length-1;chars.forEach(function(c,i){this._index=i,this.firstchar=0===i,this.lastchar=i===stop,compiler.onchar(c,this,status,result)},this)}},edb.Status=function(body){this.body=body||"",this.conf=[]},edb.Status.prototype={mode:edb.Status.MODE_JS,body:null,peek:!1,poke:!1,cont:!1,adds:!1,func:null,conf:null,skip:0,last:0,spot:0,indx:0,refs:!1},edb.Status.MODE_JS="js",edb.Status.MODE_HTML="html",edb.Status.MODE_TAG="tag",edb.Result=function(text){this.body=text||""},edb.Result.prototype={body:null},edb.State=function(body){this.body=body||"",this.conf=[]},edb.State.prototype={mode:edb.State.MODE_JS,body:null,peek:!1,poke:!1,cont:!1,adds:!1,func:null,conf:null,skip:0,last:0,spot:0,indx:0,refs:!1},edb.State.MODE_JS="js",edb.State.MODE_HTML="html",edb.State.MODE_TAG="tag",edb.Template=gui.Class.create("edb.Template",Object.prototype,{readyState:null,onreadystatechange:null,context:null,spirit:null,toString:function(){return"[object edb.Template]"},onconstruct:function(spirit,window,handler){this.spirit=spirit||null,this.context=window||null,this.onreadystatechange=handler||null},compile:function(){},run:function(){},_gostate:function(state){state!==this.readyState&&(this.readyState=state,gui.Type.isFunction(this.onreadystatechange)&&this.onreadystatechange())}},{},{LOADING:"loading",WAITING:"waiting",WORKING:"working",READY:"ready",setImplementation:function(){var args=gui.Object.toArray(arguments),impl=args.shift();args.forEach(function(type){this._implementations.set(type,impl)},this)},getImplementation:function(type){var impl=this._implementations.get(type);if(!impl)throw Error("No implementation for: "+type);return impl},load:function(context,src,type,callback,thisp){new edb.TemplateLoader(context.document).load(src,function(source){var url=new gui.URL(context.document,src),script=edb.Script.get(url.href);script?callback.call(thisp,script):this.compile(context,source,type,null,function(script){edb.Script.set(url.href,script),callback.call(thisp,script)},this)},this)},compile:function(context,source,type,directives,callback,thisp){var Script=this.getImplementation(type),script=new Script(null,context,function(){this.readyState===edb.Template.READY&&callback.call(thisp,this)});script.compile(source,directives)},_implementations:new Map}),edb.TemplateLoader=gui.FileLoader.extend({directives:null,load:function(src,callback,thisp){var url=new gui.URL(this._document,src);this._cache.has(url.location)?this._cached(url,callback,thisp):url.external?this._request(url,callback,thisp):this._lookup(url,callback,thisp)},onload:function(text,url,callback,thisp){url.external&&(text=this._extract(text,url)),callback.call(thisp,text,this.directives),this.directives=null},_lookup:function(url,callback,thisp){var script=this._document.querySelector(url.hash);this.directives=gui.AttPlugin.getmap(script),this.onload(script.textContent,url,callback,thisp)},_extract:function(text,url){var temp=this._document.createElement("div");temp.innerHTML=text;var script=temp.querySelector(url.hash||"script");return script?(this.directives=gui.AttPlugin.getmap(script),script.textContent):(console.error("No script found: "+url.location),void 0)}},{},{_loaders:new Map,set:function(){var args=gui.Object.toArray(arguments),impl=args.shift();args.forEach(function(type){this._loaders.set(type,impl)},this)},get:function(type){var impl=edb.BaseLoader;if(type&&(impl=this._loaders.get(type),!impl))throw Error("No script loader registered for type: "+type);return impl}}),edb.Compiler=gui.Class.create(Object.prototype,{_compile:function(script){var state=new edb.State('"use strict";\n');return script.split("\n").forEach(function(line,index){this._compileline(state,line,index)},this),state.body+=("html"===state.mode?"';":"")+"\nreturn out.write ();",this._format(state.body)},_compileline:function(state,line,index){line=line.trim(),state.last=line.length-1,state.adds="+"===line.charAt(0),state.cont=state.cont||"html"===state.mode&&state.adds,line.length>0&&(index>0&&("html"===state.mode?state.cont||(state.body+="';\n",state.mode="js"):state.body+="\n"),state.cont=!1,Array.forEach(line,function(c,i){this._compilechar(state,c,i,line)},this))},_compilechar:function(state,c,i,line){switch(state.mode){case"tag":this._compiletag(state,c,i,line);break;case"html":this._compilehtml(state,c,i,line);break;default:this._compilescript(state,c,i,line)}0>=state.skip--&&(state.poke?state.func+=c:"tag"!==state.mode&&(state.body+=c))},_compilehtml:function(state,c,i,line){switch(c){case"{":state.peek||state.poke;break;case"}":state.peek&&(state.peek=!1,state.skip=1,state.body+=") + '"),state.poke&&(state.body=this._inject(state.body,state.spot,state.func,state.indx++),state.poke=!1,state.func=null,state.skip=1);break;case"$":state.peek||state.poke||!this._ahead(line,i,"{")||(state.peek=!0,state.skip=2,state.body+="' + (");break;case"#":state.peek||state.poke||!this._ahead(line,i,"{")||(state.poke=!0,state.func="",state.skip=2);break;case"+":switch(i){case 0:state.skip=state.adds?1:0;break;case state.last:state.cont=!0,state.skip=1}break;case"'":state.peek||state.poke||(state.body+="\\");break;case"@":this._htmlatt(state,line,i)}},_compilescript:function(state,c,i,line){switch(c){case"<":if(0===i){var tag;(tag=this._tagstart(line))?(state.mode="tag",this._aaa(state,line,i)):(tag=this._tagstop(line))?(state.mode="tag",this._bbb(state)):(state.mode="html",state.spot=state.body.length-1,state.body+="out.html += '")}break;case"@":this._scriptatt(state,line,i)}},_aaa:function(state,line){state.body+="out.html += Tag.get ( '#ole', window )( function ( out ) {";var elem=new gui.HTMLParser(document).parse(line+"</ole>")[0],json=JSON.stringify(gui.AttPlugin.getmap(elem),null,"	"),atts=this._fixerupper(json);state.conf.push(atts)},_bbb:function(state){state.body+="}, "+state.conf.pop()+");",state.conf=null},_fixerupper:function(json){var state=new edb.State;state.body="";var lines=json.split("\n");return lines.forEach(function(line,index){Array.forEach(line,function(c,i){switch(c){case'"':state.peek||state.poke||(this._ahead(line,i,"${")?(state.peek=!0,state.skip=3):this._ahead(line,i,"#{")&&(state.poke=!0,state.skip=3,state.func=" function () {\n",state.spot=state.body.length-1));break;case"}":(state.peek||state.poke)&&this._skipahead(line,i,'"')&&(state.poke&&(state.func+="\n}",state.body=state.body.substring(0,state.spot)+state.func+state.body.substring(state.spot)),state.peek=!1,state.poke=!1,state.skip=2)}0>=state.skip--&&(state.poke?state.func+=c:state.body+=c)},this),lines.length-1>index&&(state.body+="\n")},this),state.body},_compiletag:function(state,c,i,line){switch(c){case"$":this._ahead(line,i,"{")&&(state.refs=!0,state.skip=2);break;case">":state.mode="js",state.skip=1}},_ahead:function(line,index,string){var i=index+1,l=string.length;return line.length>index+l&&line.substring(i,i+l)===string},_behind:function(line,index,string){var length=string.length,start=index-length;return start>=0&&line.substr(start,length)===string},_skipahead:function(line,index,string){return line=line.substr(index).replace(/ /g,""),this._ahead(line,0,string)},_tagstart:function(line){return this._ahead(line,0,"ole")},_tagstop:function(line){return this._ahead(line,0,"/ole>")},_htmlatt:function(state,line,i){var rest,name,dels,what,attr=edb.Compiler._ATTREXP;this._behind(line,i,"@")||this._behind(line,i,"#{")||(this._ahead(line,i,"@")?(state.body+="' + att._all () + '",state.skip=2):(rest=line.substring(i+1),name=attr.exec(rest)[0],dels=this._behind(line,i,"-"),what=dels?"att._pop":"att._out",state.body=dels?state.body.substring(0,state.body.length-1):state.body,state.body+="' + "+what+" ( '"+name+"' ) + '",state.skip=name.length+1))},_scriptatt:function(state,line,i){var rest,name,attr=edb.Compiler._ATTREXP;if(this._behind(line,i,"@"));else if(this._ahead(line,i,"@"))state.body+="var att = new edb.Att ();",state.skip=2;else{if(rest=line.substring(i+1),name=attr.exec(rest)[0],!name)throw"Bad @name: "+rest;state.body+=rest.replace(name,"att['"+name+"']"),state.skip=rest.length}},_inject:function(body,spot,func,index){var sig=this._signature?", &quot;"+this._signature+"&quot;":"";return body.substring(0,spot)+"\n"+"var __edb__"+index+" = edb.Script.assign ( function ( value, checked ) { \n"+func+";\n"+"}, this );"+body.substring(spot)+"edb.Script.register ( event ).invoke ( &quot;' + __edb__"+index+" + '&quot;"+sig+" );"},_format:function(body){var result="",tabs="	",first=null,last=null,fixt=null,flast=null;return body.split("\n").forEach(function(line){line=line.trim(),first=line.charAt(0),last=line.charAt(line.length-1),fixt=line.split("//")[0].trim(),flast=fixt.charAt(fixt.length-1),"}"!==first&&"]"!==first||""===tabs||(tabs=tabs.slice(0,-1)),result+=tabs+line+"\n",("{"===last||"["===last||"{"===flast||"["===flast)&&(tabs+="	")}),result}},{},{_ATTREXP:/^[^\d][a-zA-Z0-9-_\.]+/}),edb.FunctionCompiler=edb.Compiler.extend("edb.FunctionCompiler",{source:null,params:null,functions:null,tags:null,directives:null,sequence:null,onconstruct:function(source,directives){this.directives=directives||Object.create(null),this.source=source,this.sequence=["_validate","_extract","_direct","_declare","_define","_compile"]},compile:function(scope){var result=null;this.params=[],this.tags=Object.create(null),this.functions=Object.create(null),this._vars=[];var head={declarations:Object.create(null),definitions:[]};this.sequence.forEach(function(step){this.source=this[step](this.source,head)},this);try{result=this._convert(scope,this.source,this.params),this.source=this._source(this.source,this.params)}catch(exception){result=this._fail(scope,exception)}return result},sign:function(signature){return this._signature=signature,this},_signature:null,_instructions:null,_failed:!1,_validate:function(script){if(edb.FunctionCompiler._NESTEXP.test(script))throw"Nested EDBML dysfunction";return script},_direct:function(script){return script},_extract:function(script){return edb.Instruction.from(script).forEach(function(pi){this._instruct(pi)},this),edb.Instruction.clean(script)},_instruct:function(pi){var atts=pi.atts;switch(pi.type){case"param":this.params.push(atts.name);break;case"function":this.functions[atts.name]=atts.src;break;case"tag":var name=atts.src.split("#")[1];if(!name)throw Error("Missing #identifier: "+atts.src);this.tags[name]=atts.src}},_declare:function(script,head){var funcs=[];return gui.Object.each(this.functions,function(name){head.declarations[name]=!0,funcs.push(name+" = functions [ '"+name+"' ];\n")},this),funcs[0]&&head.definitions.push("( function lookup ( functions ) {\n"+funcs.join("")+"})( this.script.functions ());"),script},_define:function(script,head){var vars="";Object.keys(head.declarations).forEach(function(name){vars+=", "+name+" = null"});var html="var Out = edb.Out, Att = edb.Att, Tag = edb.Tag, out = new Out (), att = new Att ()"+vars+";\n";return head.definitions.forEach(function(def){html+=def+"\n"}),html+script},_convert:function(scope,script,params){var args="";return gui.Type.isArray(params)&&(args=params.join(",")),new scope.Function(args,script)},_fail:function(scope,exception){if(this._failed)throw exception;return this._failed=!0,this._debug(scope,this._format(this.source)),this.source='<p class="error">'+exception.message+"</p>",this.compile(scope,!0)},_debug:function(scope,source){if(window.btoa){source=scope.btoa("function debug () {\n"+source+"\n}");var script=scope.document.createElement("script");script.src="data:text/javascript;base64,"+source,scope.document.querySelector("head").appendChild(script),script.onload=function(){this.parentNode.removeChild(this)}}},_source:function(source,params){var lines=source.split("\n");lines.pop();var args=params.length?"( "+params.join(", ")+" )":"()";return"function "+args+" {\n"+lines.join("\n")+"\n}"}},{},{_NESTEXP:/<script.*type=["']?text\/edbml["']?.*>([\s\S]+?)/g}),edb.ScriptCompiler=edb.FunctionCompiler.extend({inputs:null,_instruct:function(pi){this._super._instruct(pi);var atts=pi.atts;switch(pi.type){case"input":this.inputs[atts.name]=atts.type}},compile:function(scope,fallback){return this.inputs=Object.create(null),this._super.compile(scope,fallback)},_declare:function(script,head){this._super._declare(script,head);var defs=[];return gui.Object.each(this.inputs,function(name,type){head.declarations[name]=!0,defs.push(name+" = __input__.get ( "+type+" );\n")},this),defs[0]&&head.definitions.push("( function lookup ( __input__ ) {\n"+defs.join("")+"})( this.script.input ());"),script}}),edb.TagCompiler=edb.FunctionCompiler.extend("edb.TagCompiler",{_direct:function(script){if(this.directives.tag){var content=edb.TagCompiler._CONTENT;this.params.push("content"),this.params.push("attribs"),script="att = new Att ( attribs );\n"+script,script=script.replace(content,"content ( out );")}return this._super._direct(script)}},{},{_CONTENT:/<content(.*)>(.*)<\/content>|<content(.*)(\/?)>/}),edb.Function=edb.Template.extend("edb.Function",{context:null,pointer:null,params:null,functions:null,tags:null,onconstruct:function(pointer,context,handler){this._super.onconstruct(pointer,context,handler),this.pointer=this.spirit,this.context=context,this.spirit=null,this.tags=Object.create(null),this.functions=Object.create(null)},compile:function(source,directives){if(null!==this._function)throw Error("TODO: recompile the script :)");var compiler=this._compiler=new this._Compiler(source,directives);return this._signature&&compiler.sign(this._signature),this._function=compiler.compile(this.context),this._source=compiler.source,this.params=compiler.params,gui.Object.each(compiler.tags,function(name,src){this._tagload(name,src)},this),gui.Object.each(compiler.functions,function(name,src){this._functionload(name,src)},this),this._oncompiled()},debug:function(){console.debug(this._source)},sign:function(signature){return this._signature=signature,this},run:function(){var result=null;if(!this._function)throw Error("Script not compiled");try{this._subscribe(!0),result=this._function.apply(this.pointer,arguments),this._subscribe(!1)}catch(exception){console.error(exception.message+":\n\n"+this._source)}return result},onbroadcast:function(b){switch(b.type){case edb.BROADCAST_FUNCTION_LOADED:this._functionloaded(b.data);break;case edb.BROADCAST_TAG_LOADED:this._tagloaded(b.data)}},_function:null,_signature:null,_Compiler:edb.FunctionCompiler,_compiler:null,_oncompiled:function(){try{this._useblob()?this._loadblob():this._maybeready()}catch(workerexception){this._maybeready()}return this},_useblob:function(){return edb.Function.useblob&&this.context.gui.debug&&gui.Client.hasBlob&&!gui.Client.isExplorer&&!gui.Client.isOpera},_loadblob:function(){var win=this.context,doc=win.document,key=gui.KeyMaster.generateKey("function"),src=this._compiler.source.replace("function","function "+key);this._gostate(edb.Template.LOADING),gui.BlobLoader.loadScript(doc,src,function(){this._gostate(edb.Template.WORKING),this._function=win[key],this._maybeready()},this)},_tagload:function(name,src){src=gui.URL.absolute(this.context.document,src);var tag=edb.Tag.get(src,this.context);tag?this.tags[name]=tag:(this._await(edb.BROADCAST_TAG_LOADED,!0),this.tags[name]=src)},_functionload:function(name,src){src=gui.URL.absolute(this.context.document,src);var func=edb.Function.get(src,this.context);if(gui.Type.isDefined(this.functions[name]))throw Error('var "'+name+'" already used');func?this.functions[name]=func:(this._await(edb.BROADCAST_FUNCTION_LOADED,!0),this.functions[name]=src)},_functionloaded:function(src){gui.Object.each(this.functions,function(name,value){value===src&&(this.functions[name]=edb.Function.get(src,this.context))},this),this._maybeready()},_tagloaded:function(src){gui.Object.each(this.tags,function(name,value){value===src&&(this.tags[name]=edb.Tag.get(src,this.context))},this),this._maybeready()},_await:function(msg,add){var act=add?"add":"remove",sig=this.context.gui.signature;gui.Broadcast[act](msg,this,sig)},_maybeready:function(){this.readyState!==edb.Template.LOADING&&(this._gostate(edb.Template.WORKING),this._done()?(this._await(edb.BROADCAST_TAG_LOADED,!1),this._await(edb.BROADCAST_FUNCTION_LOADED,!1),this._gostate(edb.Template.READY)):this._gostate(edb.Template.WAITING))},_done:function(){return["functions","tags"].every(function(map){return Object.keys(this[map]).every(function(name){return gui.Type.isFunction(this[map][name])},this)},this)},_subscribe:function(isBuilding){gui.Broadcast[isBuilding?"addGlobal":"removeGlobal"](edb.BROADCAST_GETTER,this),gui.Broadcast[isBuilding?"removeGlobal":"addGlobal"](edb.BROADCAST_SETTER,this)}},{get:function(src,win){src=new gui.URL(win.document,src).href;var has=gui.Type.isFunction(this._map[src]);return has?this._map[src]:this._load(src,win)},_broadcast:edb.BROADCAST_FUNCTION_LOADED,_map:Object.create(null),_load:function(src,win){var func=null,Implementation=this,cast=this._broadcast,sig=win.gui.signature;return new edb.TemplateLoader(win.document).load(src,function(source,directives){new Implementation(null,win,function(){this.readyState===edb.Template.READY&&(func=Implementation._map[src]=this._function,directives.debug&&this.debug(),gui.Broadcast.dispatch(null,cast,src,sig))}).compile(source,directives)}),func}},{useblob:!0}),edb.Script=edb.Function.extend("edb.Script",{input:null,onconstruct:function(pointer,context,handler){this._super.onconstruct(pointer,context,handler),this.input=new edb.InputPlugin,this.input.context=this.context,this.input.onconstruct(),console.warn("Bad: onconstruct should autoinvoke"),this._keys=new Set,gui.Broadcast.addGlobal(edb.BROADCAST_SETTER,this)},onbroadcast:function(b){switch(this._super.onbroadcast(b),b.type){case edb.BROADCAST_GETTER:this._keys.add(b.data);break;case edb.BROADCAST_SETTER:if(this._keys.has(b.data)&&this.readyState!==edb.Template.WAITING){var tick=edb.TICK_SCRIPT_UPDATE,sig=this.context.gui.signature;gui.Tick.one(tick,this,sig).dispatch(tick,0,sig),this._gostate(edb.Template.WAITING)}}},ontick:function(tick){switch(tick.type){case edb.TICK_SCRIPT_UPDATE:this._gostate(edb.Template.READY)}},oninput:function(){this._maybeready()},run:function(){if(this._keys=new Set,this.input.done)return this._super.run.apply(this,arguments);throw Error("Script awaits input")},_Compiler:edb.ScriptCompiler,_keys:null,_resolved:!1,_oncompiled:function(){return gui.Object.each(this._compiler.inputs,function(name,type){this.input.add(type,this)},this),this._super._oncompiled()},_done:function(){return this.input.done&&this._super._done()}},{_invokables:new Map,_log:null,assign:function(func,thisp){var key=gui.KeyMaster.generateKey();return edb.Script._invokables.set(key,function(value,checked){func.apply(thisp,[gui.Type.cast(value),checked])}),key},invoke:function(key,sig,log){var func=null;if(log=log||this._log,sig)gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_SCRIPT_INVOKE,{key:key,sig:sig,log:log});else{if(!(func=this._invokables.get(key)))throw Error("Invokable does not exist: "+key);"click"===log.type?setImmediate(function(){func(log.value,log.checked)}):func(log.value,log.checked)}},register:function(e){return this._log={type:e.type,value:e.target.value,checked:e.target.checked},this},get:function(key){return this._scripts[key]},set:function(key,script){this._scripts[key]=script},_scripts:Object.create(null)}),edb.Tag=edb.Function.extend("edb.Tag",{compile:function(source,directives){return directives.tag=!0,this._super.compile(source,directives)},_Compiler:edb.TagCompiler},{_map:Object.create(null),_broadcast:edb.BROADCAST_TAG_LOADED}),edb.Att=function(atts){atts&&gui.Object.extend(this,atts)},edb.Att.prototype=gui.Object.create(null,{toString:function(){return"[object edb.Att]"},_out:function(att){var val,html="";return gui.Type.isDefined(this[att])&&(val=edb.Att.encode(this[att]),html+=att+'="'+val+'" '),html},_pop:function(att){var html=this._out(att);return delete this[att],html},_all:function(){var html="";return gui.Object.nonmethods(this).forEach(function(att){html+=this._out(att)},this),html}}),edb.Att.encode=function(data){var type=gui.Type.of(data);switch(type){case"string":break;case"number":case"boolean":data+="";break;case"object":case"array":try{data=encodeURIComponent(JSON.stringify(data))}catch(jsonex){throw Error("Could not create HTML attribute: "+jsonex)}break;case"date":throw Error("TODO: edb.Att.encode standard date format?");default:throw Error("Could not create HTML attribute for "+type)}return data},edb.Out=function(){this.html=""},edb.Out.prototype={html:null,write:function(){return this.html}},edb.UpdateAssistant={id:function(element){return gui.Type.isDefined(element.id)?element.id||null:element.getAttribute("id")||null},parse:function(doc,markup,id,element){return element=doc.createElement(element.localName),element.innerHTML=markup,element.id=id,Array.forEach(element.querySelectorAll("option"),function(option){switch(option.getAttribute("selected")){case"true":option.setAttribute("selected","selected");break;case"false":option.removeAttribute("selected")}}),Array.forEach(element.querySelectorAll("input[type=checkbox],input[type=radio]"),function(option){switch(option.getAttribute("checked")){case"true":option.setAttribute("checked","checked");break;case"false":option.removeAttribute("checked")}}),element},order:function(nodes){var order=new Map;return Array.forEach(nodes,function(node,index){node.nodeType===Node.ELEMENT_NODE&&order.set(this.id(node),index)},this),order},index:function(nodes){var result=Object.create(null);return Array.forEach(nodes,function(node){node.nodeType===Node.ELEMENT_NODE&&(result[this.id(node)]=node)},this),result}},edb.UpdateManager=function(spirit){this._keyid=spirit.dom.id()||spirit.$instanceid,this._spirit=spirit,this._doc=spirit.document},edb.UpdateManager.prototype={update:function(html){this._updates=new edb.UpdateCollector,null===this._olddom?this._first(html):this._next(html),this._updates.eachRelevant(function(update){update.update(),update.dispose()}),this._updates.dispose(),delete this._updates},_keyid:null,_doc:null,_spirit:null,_olddom:null,_nedwdom:null,_updates:null,_assistant:edb.UpdateAssistant,_first:function(html){this._olddom=this._parse(html),this._updates.collect(new edb.HardUpdate(this._doc).setup(this._keyid,this._olddom))},_next:function(html){this._newdom=this._parse(html),this._crawl(this._newdom,this._olddom,this._newdom,this._keyid,{},null),this._olddom=this._newdom},_parse:function(html){return this._assistant.parse(this._doc,html,this._keyid,this._spirit.element)},_crawl:function(newchild,oldchild,lastnode,id,ids,css){for(var result=!0,n=1;newchild&&oldchild&&!this._updates.hardupdates(id);){switch(newchild.nodeType){case Node.TEXT_NODE:result=this._check(newchild,oldchild,lastnode,id,ids,css,n);break;case Node.ELEMENT_NODE:result=this._scan(newchild,oldchild,lastnode,id,ids,css,n),n++}newchild=newchild.nextSibling,oldchild=oldchild.nextSibling}return result},_scan:function(newnode,oldnode,lastnode,id,ids,css,n){var result=!0,oldid=this._assistant.id(oldnode);return css=css?oldid?"#"+oldid:css+">"+oldnode.localName+":nth-child("+n+")":"this",(result=this._check(newnode,oldnode,lastnode,id,ids,css,n))&&(oldid&&(ids=gui.Object.copy(ids),lastnode=newnode,ids[oldid]=!0,id=oldid),result=this._crawl(newnode.firstChild,oldnode.firstChild,lastnode,id,ids,css)),result},_check:function(newnode,oldnode,lastnode,id,ids,css,n){var result=!0,isSoftUpdate=!1,isPluginUpdate=!1;if(newnode&&!oldnode||!newnode&&oldnode)result=!1;else if(result=newnode.nodeType===oldnode.nodeType)switch(oldnode.nodeType){case Node.TEXT_NODE:newnode.data!==oldnode.data&&(result=!1);break;case Node.ELEMENT_NODE:(result=this._familiar(newnode,oldnode))&&(result=this._checkatts(newnode,oldnode,ids,css))&&(this._maybesoft(newnode,oldnode)?(this._confirmsoft(newnode,oldnode)&&(this._updatesoft(newnode,oldnode,ids,css,n),isSoftUpdate=!0),result=!1):"textarea"!==oldnode.localName&&(result=newnode.childNodes.length===oldnode.childNodes.length))}return result||isSoftUpdate||isPluginUpdate||this._updates.collect(new edb.HardUpdate(this._doc).setup(id,lastnode)),result},_familiar:function(newnode,oldnode){return["namespaceURI","localName"].every(function(prop){return newnode[prop]===oldnode[prop]})},_checkatts:function(newnode,oldnode,ids,css){var result=!0,update=null;if(this._attschanged(newnode.attributes,oldnode.attributes,ids,css)){var newid=this._assistant.id(newnode),oldid=this._assistant.id(oldnode);newid&&newid===oldid?(update=new edb.AttsUpdate(this._doc).setup(oldid,newnode,oldnode),this._updates.collect(update,ids)):result=!1}return result},_attschanged:function(newatts,oldatts){return newatts.length!==oldatts.length||!Array.every(newatts,function(newatt){var oldatt=oldatts.getNamedItem(newatt.name);return oldatt&&oldatt.value===newatt.value})},_maybesoft:function(newnode,oldnode){return newnode&&oldnode?this._maybesoft(newnode)&&this._maybesoft(oldnode):Array.every(newnode.childNodes,function(node){var res=!0;switch(node.nodeType){case Node.TEXT_NODE:res=""===node.data.trim();break;case Node.ELEMENT_NODE:res=null!==this._assistant.id(node)}return res},this)},_confirmsoft:function(newnode,oldnode){var res=!0,prev=null,oldorder=this._assistant.order(oldnode.childNodes);return Array.every(newnode.childNodes,function(node){if(node.nodeType===Node.ELEMENT_NODE){var id=this._assistant.id(node);oldorder.has(id)&&oldorder.has(prev)&&(res=oldorder.get(id)>oldorder.get(prev)),prev=id}return res},this)},_updatesoft:function(newnode,oldnode,ids,css,n){for(var updates=[],news=this._assistant.index(newnode.childNodes),olds=this._assistant.index(oldnode.childNodes),child=newnode.lastElementChild,topid=this._assistant.id(oldnode),oldid=null,newid=null;child;)newid=this._assistant.id(child),olds[newid]?oldid=newid:oldid?updates.push(new edb.InsertUpdate(this._doc).setup(oldid,child)):updates.push(new edb.AppendUpdate(this._doc).setup(topid,child)),child=child.previousElementSibling;
Object.keys(olds).forEach(function(id){if(news[id]){var n1=news[id],n2=olds[id];this._scan(n1,n2,n1,id,ids,css,n)}else updates.push(new edb.RemoveUpdate(this._doc).setup(id))},this),updates.reverse().forEach(function(update){this._updates.collect(update,ids)},this)}},edb.UpdateCollector=function(){this._updates=[],this._hardupdates=new Set},edb.UpdateCollector.prototype={_updates:null,_hardupdates:null,toString:function(){return"[object edb.UpdateCollector]"},collect:function(update,ids){this._updates.push(update),update.type===edb.Update.TYPE_HARD?this._hardupdates.add(update.id):update.ids=ids},hardupdates:function(id){return this._hardupdates.has(id)},eachRelevant:function(action){this._updates.filter(function(update){return update.type===edb.Update.TYPE_HARD||Object.keys(update.ids).every(function(id){return!this.hardupdates(id)},this)},this).forEach(function(update){action(update)})},dispose:function(){delete this._hardupdates,delete this._updates}},edb.Update=gui.Class.create("edb.Update",Object.prototype,{type:null,id:null,window:null,document:null,onconstruct:function(doc){this.window=doc.defaultView,this.document=doc},setup:function(){return this},update:function(){},element:function(){var element=null;if(element=gui.KeyMaster.isKey(this.id)?this.window.gui.get(this.id).element:this.document.getElementById(this.id),!element)throw Error("No element to match: "+this.id);return element},dispose:function(){delete this.window,delete this.document},_beforeUpdate:function(element){var event="x-beforeupdate-"+this.type;return this._dispatch(element,event)},_afterUpdate:function(element){var event="x-aftrerupdate-"+this.type;return this._dispatch(element,event)},_dispatch:function(element,name){var event=this.document.createEvent("UIEvents");return event.initEvent(name,!0,!0),element.dispatchEvent(event)},_report:function(report){this.window.gui.debug&&(gui.KeyMaster.isKey(this.id)&&(report=report.replace(this.id,"(anonymous)")),console.debug(report))}},{},{TYPE_HARD:"hard",TYPE_ATTS:"atts",TYPE_INSERT:"insert",TYPE_APPEND:"append",TYPE_REMOVE:"remove"}),edb.AttsUpdate=edb.Update.extend("edb.AttsUpdate",{type:edb.Update.TYPE_ATTS,_xold:null,_xnew:null,_summary:null,onconstruct:function(doc){this._super.onconstruct(doc),this._summary=[]},setup:function(id,xnew,xold){return this._super.setup(),this.id=id,this._xnew=xnew,this._xold=xold,this},update:function(){this._super.update();var element=this.element();this._beforeUpdate(element)&&(this._update(element),this._afterUpdate(element),this._report())},dispose:function(){this._super.dispose(),delete this._xold,delete this._xnew},_update:function(element){Array.forEach(this._xnew.attributes,function(newatt){var oldatt=this._xold.getAttribute(newatt.name);(null===oldatt||oldatt!==newatt.value)&&(this._set(element,newatt.name,newatt.value),this._summary.push("@"+newatt.name))},this),Array.forEach(this._xold.attributes,function(oldatt){this._xnew.hasAttribute(oldatt.name)||(this._del(element,oldatt.name,null),this._summary.push("@"+oldatt.value))},this)},_set:function(element,name,value){var spirit=element.spirit;if(spirit)spirit.att.set(name,value);else switch(element.setAttribute(name,value),name){case"checked":element.checked||(element.checked=!0);break;case"value":element.value!==value&&(element.value=value+"")}},_del:function(element,name){var spirit=element.spirit;if(spirit)spirit.att.del(name);else switch(name){case"checked":element.checked=!1;break;default:element.removeAttribute(name)}},_report:function(){this._super._report('edb.AttsUpdate "#'+this.id+'" '+this._summary.join(", "))}}),edb.HardUpdate=edb.Update.extend("edb.HardUpdate",{type:edb.Update.TYPE_HARD,xelement:null,setup:function(id,xelement){return this._super.setup(),this.id=id,this.xelement=xelement,this},update:function(){this._super.update();var element=this.element();this._beforeUpdate(element)&&(gui.DOMPlugin.html(element,this._serialize()),this._afterUpdate(element),this._report())},dispose:function(){this._super.dispose(),delete this.xelement},_serialize:function(){var xhtml=(new XMLSerializer).serializeToString(this.xelement);return xhtml.contains("</")&&(xhtml=xhtml.slice(xhtml.indexOf(">")+1,xhtml.lastIndexOf("<"))),xhtml},_report:function(){this._super._report("edb.HardUpdate #"+this.id)}}),edb.SoftUpdate=edb.Update.extend("edb.SoftUpdate",{xelement:null,type:null,dispose:function(){this._super.dispose(),delete this.xelement},_import:function(parent){var temp=this.document.createElement(parent.nodeName);return temp.innerHTML=(new XMLSerializer).serializeToString(this.xelement),temp.firstChild}}),edb.InsertUpdate=edb.SoftUpdate.extend("edb.InsertUpdate",{type:edb.Update.TYPE_INSERT,xelement:null,setup:function(id,xelement){return this.id=id,this.xelement=xelement,this},update:function(){var sibling=this.element(),parent=sibling.parentNode,child=this._import(parent);this._beforeUpdate(parent)&&(parent.insertBefore(child,sibling),this._afterUpdate(child),this._report())},_report:function(){this._super._report("edb.InsertUpdate #"+this.xelement.getAttribute("id"))}}),edb.AppendUpdate=edb.SoftUpdate.extend("edb.AppendUpdate",{type:edb.Update.TYPE_APPEND,setup:function(id,xelement){return this.id=id,this.xelement=xelement,this},update:function(){var parent=this.element(),child=this._import(parent);this._beforeUpdate(parent)&&(parent.appendChild(child),this._afterUpdate(child),this._report())},_report:function(){this._super._report("edb.AppendUpdate #"+this.xelement.getAttribute("id"))}}),edb.RemoveUpdate=edb.SoftUpdate.extend("edb.RemoveUpdate",{type:edb.Update.TYPE_REMOVE,setup:function(id){return this.id=id,this},update:function(){var element=this.element(),parent=element.parentNode;this._beforeUpdate(element)&&(parent.removeChild(element),this._afterUpdate(parent),this._report())},_report:function(){this._super._report("edb.RemoveUpdate #"+this.id)}}),edb.ScriptUpdate=edb.Update.extend("edb.ScriptUpdate",{type:"edbscript",onconstruct:function(doc){this._super.onconstruct(doc),this._summary=[]},setup:function(spirit,selector,name,value,key){return this._super.setup(),this._spirit=spirit,this._selector=selector,this._name=name,this._value=value,this._key=key,this},update:function(){this._super.update();var element=null;try{element=this._spirit.dom.q(this._selector)}catch(domexception){throw Error("Bad selector: "+this._selector)}finally{if(!element)throw Error("No such element: "+this._selector);this._beforeUpdate(element)&&(this._update(element),this._afterUpdate(element),this._report())}},_spirit:null,_selector:null,_name:null,_value:null,_key:null,_update:function(element){var current=element.getAttribute(this._name);current.contains(this._key)?element.spirit?element.spirit.att.set(this._name,this._value):element.setAttribute(this._name,this._value):console.error("Target was moved: "+this._selector)},_report:function(){this._super._report("edb.ScriptUpdate "+this._selector)}}),function(){var method=edb.UpdateManager.prototype._attschanged;edb.UpdateManager.prototype._attschanged=function(newatts,oldatts,ids,css){return method.apply(this,arguments)?!Array.every(newatts,function(newatt){var oldatt=oldatts.getNamedItem(newatt.name),newhit=gui.KeyMaster.extractKey(newatt.value);if("oninput"===newatt.name&&console.error(oldatt.value+"\n "+newatt.value+"\n"+(null!==oldatt&&oldatt.value===newatt.value)),newhit){var oldhit=gui.KeyMaster.extractKey(oldatt.value),update=new edb.ScriptUpdate(this._doc).setup(this._spirit,css,oldatt.name,newatt.value,oldhit[0]);return this._updates.collect(update,ids),!0}return!1},this):!1}}(),gui.module("edb",{mixins:{oninput:function(){}},plugins:{script:edb.ScriptPlugin,input:edb.InputPlugin,output:edb.OutputPlugin},channels:[["script[type='text/edbml']","edb.ScriptSpirit"],["link[rel='service']","edb.ServiceSpirit"]],init:function(context){context===gui.context&&edb.Template&&edb.TemplateLoader&&edb.Template.setImplementation(edb.Script,"application/x-edbml","application/edbml","text/edbml","edbml")}});var Showdown={extensions:{}},forEach=Showdown.forEach=function(a,b){if("function"==typeof a.forEach)a.forEach(b);else{var c,d=a.length;for(c=0;d>c;c++)b(a[c],c,a)}},stdExtName=function(a){return a.replace(/[_-]||\s/g,"").toLowerCase()};Showdown.converter=function(a){var b,c,d,e=0,f=[],g=[];if("undefind"!=typeof module&&"undefined"!=typeof exports&&"undefind"!=typeof require){var h=require("fs");if(h){var i=h.readdirSync((__dirname||".")+"/extensions").filter(function(a){return~a.indexOf(".js")}).map(function(a){return a.replace(/\.js$/,"")});Showdown.forEach(i,function(a){var b=stdExtName(a);Showdown.extensions[b]=require("./extensions/"+a)})}}if(this.makeHtml=function(a){return b={},c={},d=[],a=a.replace(/~/g,"~T"),a=a.replace(/\$/g,"~D"),a=a.replace(/\r\n/g,"\n"),a=a.replace(/\r/g,"\n"),a="\n\n"+a+"\n\n",a=M(a),a=a.replace(/^[ \t]+$/gm,""),Showdown.forEach(f,function(b){a=k(b,a)}),a=z(a),a=m(a),a=l(a),a=o(a),a=K(a),a=a.replace(/~D/g,"$$"),a=a.replace(/~T/g,"~"),Showdown.forEach(g,function(b){a=k(b,a)}),a},a&&a.extensions){var j=this;Showdown.forEach(a.extensions,function(a){if("string"==typeof a&&(a=Showdown.extensions[stdExtName(a)]),"function"!=typeof a)throw"Extension '"+a+"' could not be loaded.  It was either not found or is not a valid extension.";Showdown.forEach(a(j),function(a){a.type?"language"===a.type||"lang"===a.type?f.push(a):("output"===a.type||"html"===a.type)&&g.push(a):g.push(a)})})}var w,k=function(a,b){if(a.regex){var c=RegExp(a.regex,"g");return b.replace(c,a.replace)}return a.filter?a.filter(b):void 0},l=function(a){return a+="~0",a=a.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|(?=~0))/gm,function(a,d,e,f,g){return d=d.toLowerCase(),b[d]=G(e),f?f+g:(g&&(c[d]=g.replace(/"/g,"&quot;")),"")}),a=a.replace(/~0/,"")},m=function(a){return a=a.replace(/\n/g,"\n\n"),a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,n),a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|style|section|header|footer|nav|article|aside)\b[^\r]*?<\/\2>[ \t]*(?=\n+)\n)/gm,n),a=a.replace(/(\n[ ]{0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,n),a=a.replace(/(\n\n[ ]{0,3}<!(--[^\r]*?--\s*)+>[ \t]*(?=\n{2,}))/g,n),a=a.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,n),a=a.replace(/\n\n/g,"\n")},n=function(a,b){var c=b;return c=c.replace(/\n\n/g,"\n"),c=c.replace(/^\n/,""),c=c.replace(/\n+$/g,""),c="\n\n~K"+(d.push(c)-1)+"K\n\n"},o=function(a){a=v(a);var b=A("<hr />");return a=a.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,b),a=a.replace(/^[ ]{0,2}([ ]?\-[ ]?){3,}[ \t]*$/gm,b),a=a.replace(/^[ ]{0,2}([ ]?\_[ ]?){3,}[ \t]*$/gm,b),a=x(a),a=y(a),a=E(a),a=m(a),a=F(a)},p=function(a){return a=B(a),a=q(a),a=H(a),a=t(a),a=r(a),a=I(a),a=G(a),a=D(a),a=a.replace(/  +\n/g," <br />\n")},q=function(a){var b=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--.*?--\s*)+>)/gi;return a=a.replace(b,function(a){var b=a.replace(/(.)<\/?code>(?=.)/g,"$1`");return b=N(b,"\\`*_")})},r=function(a){return a=a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,s),a=a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?(.*?(?:\(.*?\).*?)?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,s),a=a.replace(/(\[([^\[\]]+)\])()()()()()/g,s)},s=function(a,d,e,f,g,h,i,j){void 0==j&&(j="");var k=d,l=e,m=f.toLowerCase(),n=g,o=j;if(""==n)if(""==m&&(m=l.toLowerCase().replace(/ ?\n/g," ")),n="#"+m,void 0!=b[m])n=b[m],void 0!=c[m]&&(o=c[m]);else{if(!(k.search(/\(\s*\)$/m)>-1))return k;n=""}n=N(n,"*_");var p='<a href="'+n+'"';return""!=o&&(o=o.replace(/"/g,"&quot;"),o=N(o,"*_"),p+=' title="'+o+'"'),p+=">"+l+"</a>"},t=function(a){return a=a.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,u),a=a.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,u)},u=function(a,d,e,f,g,h,i,j){var k=d,l=e,m=f.toLowerCase(),n=g,o=j;if(o||(o=""),""==n){if(""==m&&(m=l.toLowerCase().replace(/ ?\n/g," ")),n="#"+m,void 0==b[m])return k;n=b[m],void 0!=c[m]&&(o=c[m])}l=l.replace(/"/g,"&quot;"),n=N(n,"*_");var p='<img src="'+n+'" alt="'+l+'"';return o=o.replace(/"/g,"&quot;"),o=N(o,"*_"),p+=' title="'+o+'"',p+=" />"},v=function(a){function b(a){return a.replace(/[^\w]/g,"").toLowerCase()}return a=a.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(a,c){return A('<h1 id="'+b(c)+'">'+p(c)+"</h1>")}),a=a.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(a,c){return A('<h2 id="'+b(c)+'">'+p(c)+"</h2>")}),a=a.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(a,c,d){var e=c.length;return A("<h"+e+' id="'+b(d)+'">'+p(d)+"</h"+e+">")})},x=function(a){a+="~0";var b=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;return e?a=a.replace(b,function(a,b,c){var d=b,e=c.search(/[*+-]/g)>-1?"ul":"ol";d=d.replace(/\n{2,}/g,"\n\n\n");var f=w(d);return f=f.replace(/\s+$/,""),f="<"+e+">"+f+"</"+e+">\n"}):(b=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g,a=a.replace(b,function(a,b,c,d){var e=b,f=c,g=d.search(/[*+-]/g)>-1?"ul":"ol",f=f.replace(/\n{2,}/g,"\n\n\n"),h=w(f);return h=e+"<"+g+">\n"+h+"</"+g+">\n"})),a=a.replace(/~0/,"")};w=function(a){return e++,a=a.replace(/\n{2,}$/,"\n"),a+="~0",a=a.replace(/(\n)?(^[ \t]*)([*+-]|\d+[.])[ \t]+([^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm,function(a,b,c,d,e){var f=e,g=b;return g||f.search(/\n{2,}/)>-1?f=o(L(f)):(f=x(L(f)),f=f.replace(/\n$/,""),f=p(f)),"<li>"+f+"</li>\n"}),a=a.replace(/~0/g,""),e--,a};var y=function(a){return a+="~0",a=a.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(a,b,c){var d=b,e=c;return d=C(L(d)),d=M(d),d=d.replace(/^\n+/g,""),d=d.replace(/\n+$/g,""),d="<pre><code>"+d+"\n</code></pre>",A(d)+e}),a=a.replace(/~0/,"")},z=function(a){return a+="~0",a=a.replace(/(?:^|\n)```(.*)\n([\s\S]*?)\n```/g,function(a,b,c){var d=b,e=c;return e=C(e),e=M(e),e=e.replace(/^\n+/g,""),e=e.replace(/\n+$/g,""),e="<pre><code"+(d?' class="'+d+'"':"")+">"+e+"\n</code></pre>",A(e)}),a=a.replace(/~0/,"")},A=function(a){return a=a.replace(/(^\n+|\n+$)/g,""),"\n\n~K"+(d.push(a)-1)+"K\n\n"},B=function(a){return a=a.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(a,b,c,d){var f=d;return f=f.replace(/^([ \t]*)/g,""),f=f.replace(/[ \t]*$/g,""),f=C(f),b+"<code>"+f+"</code>"})},C=function(a){return a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=N(a,"*_{}[]\\",!1)},D=function(a){return a=a.replace(/(\*\*|__)(?=\S)([^\r]*?\S[*_]*)\1/g,"<strong>$2</strong>"),a=a.replace(/(\*|_)(?=\S)([^\r]*?\S)\1/g,"<em>$2</em>")},E=function(a){return a=a.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(a,b){var c=b;return c=c.replace(/^[ \t]*>[ \t]?/gm,"~0"),c=c.replace(/~0/g,""),c=c.replace(/^[ \t]+$/gm,""),c=o(c),c=c.replace(/(^|\n)/g,"$1  "),c=c.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(a,b){var c=b;return c=c.replace(/^  /gm,"~0"),c=c.replace(/~0/g,"")}),A("<blockquote>\n"+c+"\n</blockquote>")})},F=function(a){a=a.replace(/^\n+/g,""),a=a.replace(/\n+$/g,"");for(var b=a.split(/\n{2,}/g),c=[],e=b.length,f=0;e>f;f++){var g=b[f];g.search(/~K(\d+)K/g)>=0?c.push(g):g.search(/\S/)>=0&&(g=p(g),g=g.replace(/^([ \t]*)/g,"<p>"),g+="</p>",c.push(g))}e=c.length;for(var f=0;e>f;f++)for(;c[f].search(/~K(\d+)K/)>=0;){var h=d[RegExp.$1];h=h.replace(/\$/g,"$$$$"),c[f]=c[f].replace(/~K\d+K/,h)}return c.join("\n\n")},G=function(a){return a=a.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),a=a.replace(/<(?![a-z\/?\$!])/gi,"&lt;")},H=function(a){return a=a.replace(/\\(\\)/g,O),a=a.replace(/\\([`*_{}\[\]()>#+-.!])/g,O)},I=function(a){return a=a.replace(/<((https?|ftp|dict):[^'">\s]+)>/gi,'<a href="$1">$1</a>'),a=a.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,function(a,b){return J(K(b))})},J=function(a){var b=[function(a){return"&#"+a.charCodeAt(0)+";"},function(a){return"&#x"+a.charCodeAt(0).toString(16)+";"},function(a){return a}];return a="mailto:"+a,a=a.replace(/./g,function(a){if("@"==a)a=b[Math.floor(2*Math.random())](a);else if(":"!=a){var c=Math.random();a=c>.9?b[2](a):c>.45?b[1](a):b[0](a)}return a}),a='<a href="'+a+'">'+a+"</a>",a=a.replace(/">.+:/g,'">')},K=function(a){return a=a.replace(/~E(\d+)E/g,function(a,b){var c=parseInt(b);return String.fromCharCode(c)})},L=function(a){return a=a.replace(/^(\t|[ ]{1,4})/gm,"~0"),a=a.replace(/~0/g,"")},M=function(a){return a=a.replace(/\t(?=\t)/g,"    "),a=a.replace(/\t/g,"~A~B"),a=a.replace(/~B(.+?)~A/g,function(a,b){for(var d=b,e=4-d.length%4,f=0;e>f;f++)d+=" ";return d}),a=a.replace(/~A/g,"    "),a=a.replace(/~B/g,"")},N=function(a,b,c){var d="(["+b.replace(/([\[\]\\])/g,"\\$1")+"])";c&&(d="\\\\"+d);var e=RegExp(d,"g");return a=a.replace(e,O)},O=function(a,b){var c=b.charCodeAt(0);return"~E"+c+"E"}},"undefined"!=typeof module&&(module.exports=Showdown),"function"==typeof define&&define.amd&&define("showdown",function(){return Showdown}),function(){var e=/\blang(?:uage)?-(?!\*)(\w+)\b/i,t=self.Prism={util:{type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},clone:function(e){var n=t.util.type(e);switch(n){case"Object":var r={};for(var i in e)e.hasOwnProperty(i)&&(r[i]=t.util.clone(e[i]));return r;case"Array":return e.slice()}return e}},languages:{extend:function(e,n){var r=t.util.clone(t.languages[e]);for(var i in n)r[i]=n[i];return r},insertBefore:function(e,n,r,i){i=i||t.languages;var s=i[e],o={};for(var u in s)if(s.hasOwnProperty(u)){if(u==n)for(var a in r)r.hasOwnProperty(a)&&(o[a]=r[a]);o[u]=s[u]}return i[e]=o},DFS:function(e,n){for(var r in e)n.call(e,r,e[r]),"Object"===t.util.type(e)&&t.languages.DFS(e[r],n)}},highlightAll:function(e,n){for(var s,r=document.querySelectorAll('code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'),i=0;s=r[i++];)t.highlightElement(s,e===!0,n)},highlightElement:function(r,i,s){for(var o,u,a=r;a&&!e.test(a.className);)a=a.parentNode;if(a&&(o=(a.className.match(e)||[,""])[1],u=t.languages[o]),u){r.className=r.className.replace(e,"").replace(/\s+/g," ")+" language-"+o,a=r.parentNode,/pre/i.test(a.nodeName)&&(a.className=a.className.replace(e,"").replace(/\s+/g," ")+" language-"+o);var f=r.textContent;if(f){f=f.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00a0/g," ");var l={element:r,language:o,grammar:u,code:f};if(t.hooks.run("before-highlight",l),i&&self.Worker){var c=new Worker(t.filename);c.onmessage=function(e){l.highlightedCode=n.stringify(JSON.parse(e.data)),l.element.innerHTML=l.highlightedCode,s&&s.call(l.element),t.hooks.run("after-highlight",l)},c.postMessage(JSON.stringify({language:l.language,code:l.code}))}else l.highlightedCode=t.highlight(l.code,l.grammar),l.element.innerHTML=l.highlightedCode,s&&s.call(r),t.hooks.run("after-highlight",l)}}},highlight:function(e,r){return n.stringify(t.tokenize(e,r))},tokenize:function(e,n){var r=t.Token,i=[e],s=n.rest;if(s){for(var o in s)n[o]=s[o];delete n.rest}e:for(var o in n)if(n.hasOwnProperty(o)&&n[o]){var u=n[o],a=u.inside,f=!!u.lookbehind||0;u=u.pattern||u;for(var l=0;i.length>l;l++){var c=i[l];if(i.length>e.length)break e;if(!(c instanceof r)){u.lastIndex=0;var h=u.exec(c);if(h){f&&(f=h[1].length);var p=h.index-1+f,h=h[0].slice(f),d=h.length,v=p+d,m=c.slice(0,p+1),g=c.slice(v+1),y=[l,1];m&&y.push(m);var b=new r(o,a?t.tokenize(h,a):h);y.push(b),g&&y.push(g),Array.prototype.splice.apply(i,y)}}}}return i},hooks:{all:{},add:function(e,n){var r=t.hooks.all;r[e]=r[e]||[],r[e].push(n)},run:function(e,n){var r=t.hooks.all[e];if(r&&r.length)for(var s,i=0;s=r[i++];)s(n)}}},n=t.Token=function(e,t){this.type=e,this.content=t};if(n.stringify=function(e){if("string"==typeof e)return e;if("[object Array]"==Object.prototype.toString.call(e)){for(var r=0;e.length>r;r++)e[r]=n.stringify(e[r]);return e.join("")}var i={type:e.type,content:n.stringify(e.content),tag:"span",classes:["token",e.type],attributes:{}};"comment"==i.type&&(i.attributes.spellcheck="true"),t.hooks.run("wrap",i);var s="";for(var o in i.attributes)s+=o+'="'+(i.attributes[o]||"")+'"';return"<"+i.tag+' class="'+i.classes.join(" ")+'" '+s+">"+i.content+"</"+i.tag+">"},!self.document)return self.addEventListener("message",function(e){var n=JSON.parse(e.data),r=n.language,i=n.code;self.postMessage(JSON.stringify(t.tokenize(i,t.languages[r]))),self.close()},!1),void 0;var r=document.getElementsByTagName("script");r=r[r.length-1],r&&(t.filename=r.src,document.addEventListener&&!r.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",t.highlightAll))}(),Prism.languages.clike={comment:{pattern:/(^|[^\\])(\/\*[\w\W]*?\*\/|\/\/.*?(\r?\n|$))/g,lookbehind:!0},string:/("|')(\\?.)*?\1/g,keyword:/\b(if|else|while|do|for|return|in|instanceof|function|new|try|catch|finally|null|break|continue)\b/g,"boolean":/\b(true|false)\b/g,number:/\b-?(0x)?\d*\.?[\da-f]+\b/g,operator:/[-+]{1,2}|!|=?&lt;|=?&gt;|={1,2}|(&amp;){1,2}|\|?\||\?|\*|\//g,ignore:/&(lt|gt|amp);/gi,punctuation:/[{}[\];(),.:]/g},Prism.languages.javascript=Prism.languages.extend("clike",{keyword:/\b(var|let|if|else|while|do|for|return|in|instanceof|function|new|with|typeof|try|catch|finally|null|break|continue)\b/g,number:/\b(-?(0x)?\d*\.?[\da-f]+|NaN|-?Infinity)\b/g}),Prism.languages.insertBefore("javascript","keyword",{regex:{pattern:/(^|[^/])\/(?!\/)(\[.+?]|\\.|[^/\r\n])+\/[gim]{0,3}(?=\s*($|[\r\n,.;})]))/g,lookbehind:!0}}),Prism.languages.markup&&Prism.languages.insertBefore("markup","tag",{script:{pattern:/(&lt;|<)script[\w\W]*?(>|&gt;)[\w\W]*?(&lt;|<)\/script(>|&gt;)/gi,inside:{tag:{pattern:/(&lt;|<)script[\w\W]*?(>|&gt;)|(&lt;|<)\/script(>|&gt;)/gi,inside:Prism.languages.markup.tag.inside},rest:Prism.languages.javascript}}}),window.dox=gui.namespace("dox",{}),dox.Node=edb.Object("dox.Node",{name:null}),dox.File=dox.Node.extend("dox.File",{src:null,type:null,what:null,doc:null,matches:function(term){var name=this.name.toLowerCase();return name.contains(term.toLowerCase())}}),dox.Folder=dox.Node.extend("dox.Folder",{open:!1,filenames:null,nodes:edb.Array({$of:function(json){return json.nodes?dox.Folder:dox.File}}),matches:function(term){return this.filenames.contains(term.toLowerCase())}}),dox.Tag=edb.Object("dox.Tag",{text:null,desc:null,name:null,type:null,onconstruct:function(){this.desc="",this.name="",this.type="";var names=[],parts=this.text.split(/ +/);parts.forEach(function(part){switch(part.charAt(0)){case"@":names.push(part);break;case"{":this.type=part;break;default:this.desc+=part+" "}},this),this.name=names.join(" ")}}),dox.Doc=edb.Object("dox.Doc"),dox.Chapter=edb.Object("dox.Chapter",{blocks:edb.Array({$of:dox.Section})}),dox.Section=edb.Object("dox.Section",{line:-1,desc:null,code:null,tags:edb.Array({$of:dox.Tag}),$encode:function(){return this.code.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}}),dox.JSDoc=dox.Doc.extend("dox.JSDoc",{chapters:edb.Array({$of:dox.Chapter}),forEach:function(action,thisp){this.chapters.forEach(function(chapter){chapter.sections.forEach(function(section,index){action.call(thisp,chapter,section,index)})})}}),dox.MDDoc=dox.Doc.extend("dox.MDDoc"),dox.FileServiceSpirit=gui.Spirit.infuse("dox.FolderServiceSpirit",{onconfigure:function(){this._super.onconfigure(),new gui.Request("sources.json").acceptJSON().get(function(status,data){200===status?this.output.dispatch(new dox.Folder(this._maketree(data))):alert("Server responded: "+status+"\nHas the files been indexed?")},this)},_maketree:function(srcs){function step1(srcs){function next(source,parts,map){var part=parts.shift();parts.length?(map[part]=map[part]||Object.create(null),next(source,parts,map[part])):map[part]=source}var map=Object.create(null);return srcs.forEach(function(source){next(source,source.split("/"),map)}),map}function step2(map){var root={name:"/",nodes:[]};return function next(map,parent,level){return gui.Object.each(map,function(key,val){var node={name:key};"object"==typeof val?(node.nodes=[],node.open=2>level,next(val,node,level+1)):node.src=val,parent.nodes.push(node)}),parent}(map,root,0)}function step3(folder){var is,nodes=folder.nodes,alpha=function(n1,n2){return n1.name<n2.name?-1:n1.name>n2.name?1:0};return folder.nodes=nodes.filter(function(node){return(is=node.nodes)?step3(node):!1}).sort(alpha).concat(nodes.filter(function(node){return!node.nodes}).sort(alpha)),folder}function step4(folder){for(;1===folder.nodes.length&&folder.nodes[0].nodes;)folder=folder.nodes[0];return folder}function step5(folder){return folder.filenames=folder.filenames||folder.nodes.map(function(node){return node.nodes?step5(node).filenames:node.name.toLowerCase()}).join(" "),folder}return step5(step4(step3(step2(step1(srcs)))))}}),dox.DocServiceSpirit=gui.Spirit.infuse("dox.DocServiceSpirit",{onready:function(){this._super.onready();var fetch=function(){var hash=window.location.hash;hash&&this._fetch(hash.substring(1))}.bind(this);this.window.addEventListener("hashchange",fetch),fetch()},_showdown:null,_fetch:function(src){var cuts=src.split("/"),name=cuts.pop(),dots=src.split("."),type=dots.pop();new gui.Request(src).get(function(status,data){this._output(name,type,data)},this)},_output:function(name,type,text){this.output.dispatch(this._computedoc(text,type))},_computedoc:function(text,type){switch(type){case"js":return new dox.JSDoc({chapters:this._chapters(text)});case"md":return new dox.MDDoc({markup:this._markup(text)})}},_chapters:function(source){function nextchapter(title){chapter&&(chapter.sections=sections.map(function(section){return section.desc=marker.makeHtml(section.desc),section}),chapters.push(chapter)),chapter=new dox.Chapter({title:title||null}),sections=[]}function nextsection(line){section&&section.code&&sections.push(section),section=new dox.Section({line:line||0,tags:[],desc:"",code:""})}var comment=!1,chapters=[],chapter=null,sections=[],section=null,marker=new Showdown.converter;return nextsection(),nextchapter(),source.split("\n").forEach(function(line,index){var md,trim=line.trim();if(comment)if(trim.startsWith("*/"))comment=!1;else if("*"===trim)section.desc+="\n\n";else switch(md=line.replace(this._REX_GUTTER,""),md[0]){case"@":section.tags.push(new dox.Tag({text:this._encode(md)}));break;case"#":section.desc+="\n"+md+"\n\n";break;default:md.match(this._REX_LETTER)||(section.desc+="\n"),section.desc+=md}else line.match(this._REX_CHAPTER)?(nextsection(index),nextchapter(this._REX_TITLE.exec(line)),section.code+=this._REX_HELLO.exec(line)):trim.startsWith("/**")?(comment=!0,nextsection(index)):section.code+=line+"\n"},this),nextsection(),nextchapter(),chapters},_encode:function(string){return string.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},_markup:function(markdown){return this._showdown=this._showdown||new Showdown.converter,this._showdown.makeHtml(markdown)},_alfnumumeric:{NUMBERS_START:48,NUMBERS_END:57,LETTERS_START:65,LETTERS_END:90},_REX_GUTTER:/^\s+\* +/,_REX_LETTER:/^[A-Za-z]/,_REX_CHAPTER:/^[\s|{|}|,|;]*\/\/\s*[A-Za-z0-9 ]*\s*\.{4,}$/,_REX_TITLE:/[A-Za-z0-9]+ [A-Za-z0-9 ]*/,_REX_HELLO:/^[\s|{|}|,|;]*/}),dox.MainSpirit=gui.Spirit.infuse({onready:function(){this._super.onready(),this.life.add(edb.LIFE_SCRIPT_DID_RUN)},onlife:function(life){if(this._super.onlife(life),life.type===edb.LIFE_SCRIPT_DID_RUN){var desc=this.dom.q(".desc");desc&&!desc.querySelector("h1")&&this._heading(desc,this._filename())}},_heading:function(desc,name){var h1=this.dom.tag("h1",name);desc.insertBefore(h1,desc.firstChild)},_filename:function(){var hash=this.document.location.hash,cuts=hash.split("/"),name=cuts.pop()||"";return(cuts=name.split(".")).length&&cuts.pop(),cuts.join(".")}}),dox.PrismSpirit=gui.Spirit.infuse("dox.PrismSpirit",{onenter:function(){if(this._super.onenter(),this.box.pageY<this.window.innerHeight)this._hilite();else{var that=this;setTimeout(function(){that._hilite()},200)}},ontick:function(tick){this._super.ontick(tick),"tick-prism"===tick.type&&(this._hilite(),console.log(this.dom.text()))},_hilite:function(){var code=this.dom.q("code");Prism.highlightElement(code),this._hotfix(code)},_hotfix:function(code){var text=code.firstChild;text&&(text.data=text.data.substring(1))}}),dox.AsideSpirit=gui.Spirit.infuse("dox.AsideSpirit",{onready:function(){this._super.onready(),this.event.add("click focusin input")},onevent:function(e){switch(this._super.onevent(e),e.type){case"click":e.currentTarget===this.document.body?this._togglefiles():e.stopPropagation();break;case"focusin":"search"===e.target.id&&(this._filesopen||this._togglefiles());break;case"input":var input=e.target;"search"===input.id&&gui.Tick.next(function(){this.script.run(input.value)},this)}},_filesopen:!1,_togglefiles:function(){var root=this.dom.q("#root"),form=this.dom.q("fieldset"),open=this._filesopen=!this._filesopen;open&&(this.css.bottom=0),gui.Tick.next(function(){if(this.event[open?"add":"remove"]("click",this.document.body),root.className=open?"on":"off",form.className=open?"on":"off",!open){var that=this;setTimeout(function(){that.css.bottom="auto"},50)}},this)}}),dox.FormSpirit=gui.Spirit.infuse({onenter:function(){this._super.onenter(),this.element.action="javascript:void(0)",this._scrollbar(gui.Client.scrollBarSize),this._input=this.dom.q("input"),this.event.add("focusin"),this._flexboxerize(this.dom.q("label"),this.dom.q("input"))},onevent:function(e){switch(this._super.onevent(e),e.type){case"focusin":e.target===this._input&&this._input.select()}},_input:null,_scrollbar:function(scrollbar){if(scrollbar>0){var nextwidth=320-scrollbar;this.css.right=scrollbar,this.css.width=nextwidth,this.element.style.clip="rect(0px,"+nextwidth+"px,64px,-20px)"}},_flexboxerize:function(label,input){input.style.width=this.box.width-label.offsetWidth-3+"px"}});